import json
from stix2 import (
    IntrusionSet, Vulnerability, Indicator, AttackPattern, 
    Relationship, Identity, Bundle, ExternalReference, Report
)

def generar_paquete_completo():
    # --- 1. REFERENCIAS EXTERNAS Y REPORTE ---
    ref_google = ExternalReference(
        source_name="Google TAG",
        url="https://blog.google/threat-analysis-group/internet-explorer-0-day-exploited-by-north-korean-actor-apt37/",
        description="Internet Explorer 0-day exploited by North Korean actor APT37"
    )

    # --- 2. ACTOR Y VÍCTIMAS ---
    apt37 = IntrusionSet(
        name="APT37",
        description="Grupo respaldado por el estado de Corea del Norte.",
        first_seen="2022-10-31T00:00:00Z",
        external_references=[ref_google]
    )

    victimas = Identity(
        name="Usuarios en Corea del Sur",
        description="Ciudadanos, desertores, periodistas y activistas de derechos humanos.",
        identity_class="individual"
    )

    # --- 3. VULNERABILIDAD ---
    cve_ie = Vulnerability(
        name="CVE-2022-41128",
        description="Fallo de confusión de tipos en jscript9.dll (Internet Explorer) que permite RCE.",
        external_references=[ExternalReference(source_name="cve", external_id="CVE-2022-41128")]
    )

    # --- 4. TTPs (ATT&CK TECHNIQUES) ---
    phishing = AttackPattern(
        name="Spearphishing Attachment",
        external_references=[ExternalReference(source_name="mitre-attack", external_id="T1566.001")]
    )
    template_inj = AttackPattern(
        name="Template Injection",
        external_references=[ExternalReference(source_name="mitre-attack", external_id="T1221")]
    )
    client_exploit = AttackPattern(
        name="Exploitation for Client Execution",
        external_references=[ExternalReference(source_name="mitre-attack", external_id="T1203")]
    )
    indicator_removal = AttackPattern(
        name="Indicator Removal on Host",
        external_references=[ExternalReference(source_name="mitre-attack", external_id="T1070")]
    )

    # --- 5. INDICADORES (IOCs) ---
    indicadores = []
    
    # Hashes de documentos iniciales
    hashes_docs = [
        "56ca24b57c4559f834c190d50b0fe89dd4a4040a078ca1f267d0bbc7849e9ed7",
        "af5fb99d3ff18bc625fb63f792ed7cd955171ab509c2f8e7c7ee44515e09cebf",
        "926a947ea2b59d3e9a5a6875b4de2bd071b15260370f4da5e2a60ece3517a32f",
        "3bff571823421c013e79cc10793f238f4252f7d7ac91f9ef41435af0a8c09a39",
        "c49b4d370ad0dcd1e28ee8f525ac8e3c12a34cfcf62ebb733ec74cca59b29f82"
    ]
    for h in hashes_docs:
        indicadores.append(Indicator(
            name="Documento Inicial SHA-256",
            pattern=f"[file:hashes.'SHA-256' = '{h}']",
            pattern_type="stix",
            labels=["malicious-activity"]
        ))

    # Hash de plantilla RTF remota
    indicadores.append(Indicator(
        name="Remote RTF template SHA-256",
        pattern="[file:hashes.'SHA-256' = '08f93351d0d3905bee5b0c2b9215d448abb0d3cf49c0f8b666c46df4fcc007cb']",
        pattern_type="stix",
        labels=["malicious-activity"]
    ))

    # Dominios C2
    dominios = ["word-template.net", "openxmlformat.org", "ms-office.services", "ms-offices.com", "template-openxml.com"]
    for d in dominios:
        indicadores.append(Indicator(
            name="C2 Domain",
            pattern=f"[domain-name:value = '{d}']",
            pattern_type="stix"
        ))

    # --- 6. RELACIONES ---
    relaciones = [
        Relationship(relationship_type="targets", source_ref=apt37.id, target_ref=victimas.id),
        Relationship(relationship_type="uses", source_ref=apt37.id, target_ref=cve_ie.id),
        Relationship(relationship_type="uses", source_ref=apt37.id, target_ref=phishing.id),
        Relationship(relationship_type="uses", source_ref=apt37.id, target_ref=template_inj.id),
        Relationship(relationship_type="uses", source_ref=apt37.id, target_ref=client_exploit.id),
        Relationship(relationship_type="uses", source_ref=apt37.id, target_ref=indicator_removal.id)
    ]
    
    # Relacionar indicadores con el actor
    for ind in indicadores:
        relaciones.append(Relationship(relationship_type="indicates", source_ref=ind.id, target_ref=apt37.id))

    # --- 7. BUNDLE Y REPORTE ---
    todos_los_objetos = [apt37, victimas, cve_ie, phishing, template_inj, client_exploit, indicator_removal] + indicadores + relaciones
    
    reporte = Report(
        name="Reporte APT37 - CVE-2022-41128",
        published="2022-12-07T00:00:00Z",
        object_refs=[obj.id for obj in todos_los_objetos]
    )
    
    bundle = Bundle(objects=todos_los_objetos + [reporte])

    # Guardar archivo
    with open('paquete_stix.json', 'w') as f:
        f.write(bundle.serialize(indent=4))
    
    print(f"Éxito: Se ha generado 'paquete_stix.json' con {len(todos_los_objetos)} objetos.")

if __name__ == "__main__":
    generar_paquete_completo()
