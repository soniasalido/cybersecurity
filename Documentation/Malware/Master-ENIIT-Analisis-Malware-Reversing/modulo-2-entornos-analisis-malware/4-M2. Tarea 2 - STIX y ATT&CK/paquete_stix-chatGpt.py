#!/usr/bin/env python3
"""
APT37 (Google TAG) - STIX 2.1 Bundle con:
- ThreatActor + IntrusionSet + Campaign + Vulnerability + Infrastructure + Indicators
- Relaciones forward/reverse como en teoría
- Report con URL en external_references (10.6.5) y published_time como datetime
- Report conectado al grafo vía relationship "refers-to"

Requisitos:
  pip install stix2

Ejecución:
  python3 apt37_stix_full.py --out apt37_ie0day_campaign_stix.json --pretty
"""

from __future__ import annotations

import argparse
from datetime import datetime, timezone
from typing import List, Optional
from uuid import uuid4

from stix2 import (
    AttackPattern,
    Bundle,
    Campaign,
    Identity,
    Indicator,
    Infrastructure,
    IntrusionSet,
    Location,
    Malware,
    Note,
    Relationship,
    Report,
    ThreatActor,
    Tool,
    Vulnerability,
)

# -----------------------------
# Source / report metadata
# -----------------------------
ARTICLE_URL = "https://blog.google/threat-analysis-group/internet-explorer-0-day-exploited-by-north-korean-actor-apt37/"
ARTICLE_TITLE = "Internet Explorer 0-day exploited by North Korean actor APT37"

# Enfoque de apuntes (10.6.5): published_time como datetime
published_time = datetime(year=2022, month=12, day=7, tzinfo=timezone.utc)

# Enfoque de apuntes (10.6.5): URL como external_reference (NO como SDO/SCO)
url_report = {
    "source_name": "google-tag",
    "url": ARTICLE_URL,
}

# Timeline anchors
OBSERVED_FIRST = datetime(2022, 10, 31, 0, 0, 0, tzinfo=timezone.utc)
PATCH_TUESDAY = datetime(2022, 11, 8, 0, 0, 0, tzinfo=timezone.utc)

# -----------------------------
# IOCs from TAG
# -----------------------------
INITIAL_DOC_SHA256 = [
    "56ca24b57c4559f834c190d50b0fe89dd4a4040a078ca1f267d0bbc7849e9ed7",
    "af5fb99d3ff18bc625fb63f792ed7cd955171ab509c2f8e7c7ee44515e09cebf",
    "926a947ea2b59d3e9a5a6875b4de2bd071b15260370f4da5e2a60ece3517a32f",
    "3bff571823421c013e79cc10793f238f4252f7d7ac91f9ef41435af0a8c09a39",
    "c49b4d370ad0dcd1e28ee8f525ac8e3c12a34cfcf62ebb733ec74cca59b29f82",
]

REMOTE_RTF_TEMPLATE_SHA256 = "08f93351d0d3905bee5b0c2b9215d448abb0d3cf49c0f8b666c46df4fcc007cb"

C2_DOMAINS = [
    "word-template.net",
    "openxmlformat.org",
    "ms-office.services",
    "ms-offices.com",
    "template-openxml.com",
]


def utc(dt: datetime) -> str:
    """RFC3339 UTC string (útil para campos que no uses como datetime)."""
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    return dt.astimezone(timezone.utc).isoformat().replace("+00:00", "Z")


def make_file_hash_indicator(sha256: str, name: str, desc: str, created_by_ref: str, valid_from: datetime) -> Indicator:
    return Indicator(
        spec_version="2.1",
        name=name,
        description=desc,
        pattern_type="stix",
        pattern=f"[file:hashes.'SHA-256' = '{sha256}']",
        valid_from=utc(valid_from),
        labels=["file-hash", "malicious-activity"],
        created_by_ref=created_by_ref,
    )


def make_domain_indicator(domain: str, created_by_ref: str, valid_from: datetime) -> Indicator:
    return Indicator(
        spec_version="2.1",
        name=f"C2 domain indicator: {domain}",
        description="Domain reported as command-and-control / campaign infrastructure in the TAG report.",
        pattern_type="stix",
        pattern=f"[domain-name:value = '{domain}']",
        valid_from=utc(valid_from),
        labels=["domain", "c2", "malicious-activity"],
        created_by_ref=created_by_ref,
    )


def rel(
    source_ref: str,
    relationship_type: str,
    target_ref: str,
    created_by_ref: str,
    description: Optional[str] = None,
    confidence: Optional[int] = None,
) -> Relationship:
    kwargs = {}
    if description:
        kwargs["description"] = description
    if confidence is not None:
        kwargs["confidence"] = confidence

    return Relationship(
        spec_version="2.1",
        relationship_type=relationship_type,
        source_ref=source_ref,
        target_ref=target_ref,
        created_by_ref=created_by_ref,
        **kwargs,
    )


def main() -> None:
    ap = argparse.ArgumentParser(description="Generate STIX 2.1 bundle for APT37 IE 0-day campaign (Google TAG).")
    ap.add_argument("--out", default="apt37_ie0day_campaign_stix.json", help="Output JSON file path.")
    ap.add_argument("--pretty", action="store_true", help="Pretty-print JSON.")
    args = ap.parse_args()

    # -----------------------------
    # Producer identity
    # -----------------------------
    google_tag = Identity(
        spec_version="2.1",
        name="Google Threat Analysis Group (TAG)",
        identity_class="organization",
        description="Google Threat Analysis Group; publisher of the referenced report.",
    )

    # -----------------------------
    # Location (must have country/region or lat/long)
    # -----------------------------
    south_korea = Location(
        spec_version="2.1",
        name="South Korea",
        country="South Korea",
        region="eastern-asia",
        description="Primary target geography mentioned in the report.",
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Threat Actor + Intrusion Set
    # -----------------------------
    apt37_ta = ThreatActor(
        spec_version="2.1",
        name="APT37",
        aliases=["APT37"],
        threat_actor_types=["nation-state"],
        description="North Korea-linked threat actor. Google TAG attributes the observed activity to APT37.",
        created_by_ref=google_tag.id,
    )

    apt37_is = IntrusionSet(
        spec_version="2.1",
        name="APT37",
        aliases=["APT37"],
        description="Intrusion set representation for the group activity; linked to Threat Actor via attributed-to.",
        first_seen=utc(OBSERVED_FIRST),
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Campaign
    # -----------------------------
    campaign = Campaign(
        spec_version="2.1",
        name="APT37 IE 0-day via Office remote template (CVE-2022-41128)",
        description=(
            "Observed exploitation chain: Office doc -> remote RTF template -> remote HTML rendered via IE -> "
            "exploitation of CVE-2022-41128 (jscript9.dll)."
        ),
        first_seen=utc(OBSERVED_FIRST),
        last_seen=utc(PATCH_TUESDAY),
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Vulnerability
    # -----------------------------
    vuln = Vulnerability(
        spec_version="2.1",
        name="CVE-2022-41128",
        description=(
            "Internet Explorer JScript (jscript9.dll) 0-day exploited in the wild; JIT optimization issue leading to "
            "type confusion and code execution."
        ),
        external_references=[
            {
                "source_name": "cve",
                "external_id": "CVE-2022-41128",
                "url": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-41128",
            },
            url_report,  # también referencia el post de TAG
        ],
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # ATT&CK Attack Patterns
    # -----------------------------
    ap_template_injection = AttackPattern(
        spec_version="2.1",
        name="Template Injection",
        description="Office uses a remote template (RTF) to load attacker-controlled content.",
        external_references=[{"source_name": "mitre-attack", "external_id": "T1221", "url": "https://attack.mitre.org/techniques/T1221/"}],
        created_by_ref=google_tag.id,
    )

    ap_exploit_client = AttackPattern(
        spec_version="2.1",
        name="Exploitation for Client Execution",
        description="Exploitation of a client-side application vulnerability to execute code.",
        external_references=[{"source_name": "mitre-attack", "external_id": "T1203", "url": "https://attack.mitre.org/techniques/T1203/"}],
        created_by_ref=google_tag.id,
    )

    ap_indicator_removal = AttackPattern(
        spec_version="2.1",
        name="Indicator Removal on Host",
        description="Post-exploitation cleanup such as clearing IE cache/history to reduce forensic artifacts.",
        external_references=[{"source_name": "mitre-attack", "external_id": "T1070", "url": "https://attack.mitre.org/techniques/T1070/"}],
        created_by_ref=google_tag.id,
    )

    ap_spearphish_attach = AttackPattern(
        spec_version="2.1",
        name="Spearphishing Attachment (assessed)",
        description="Assessment: malicious Office doc suggests T1566.001, but TAG does not specify delivery channel.",
        external_references=[{"source_name": "mitre-attack", "external_id": "T1566.001", "url": "https://attack.mitre.org/techniques/T1566/001/"}],
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Infrastructure
    # -----------------------------
    infra = Infrastructure(
        spec_version="2.1",
        name="APT37 campaign infrastructure (C2 / hosting)",
        description=(
            "Infrastructure serving remote templates/HTML and receiving telemetry/C2 beacons; "
            "TAG observed cookie-based gating and beaconing pre/post exploitation."
        ),
        infrastructure_types=["command-and-control", "hosting-malware"],
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Tool (align with 'threat-actor uses tool' examples)
    # -----------------------------
    exploit_tool = Tool(
        spec_version="2.1",
        name="CVE-2022-41128 exploit chain (Office->IE JScript)",
        tool_types=["exploitation"],
        description="Modeled as a Tool to align with 'threat-actor uses tool' relationship examples.",
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Malware (historical association)
    # -----------------------------
    rokrat = Malware(
        spec_version="2.1",
        name="ROKRAT",
        is_family=True,
        description="Historically associated with APT37 per TAG; not confirmed as payload in this campaign.",
        created_by_ref=google_tag.id,
    )
    bluelight = Malware(
        spec_version="2.1",
        name="BLUELIGHT",
        is_family=True,
        description="Historically associated with APT37 per TAG; not confirmed as payload in this campaign.",
        created_by_ref=google_tag.id,
    )
    dolphin = Malware(
        spec_version="2.1",
        name="DOLPHIN",
        is_family=True,
        description="Historically associated with APT37 per TAG; not confirmed as payload in this campaign.",
        created_by_ref=google_tag.id,
    )

    # Placeholder payload (didactic for authored-by)
    unknown_payload = Malware(
        spec_version="2.1",
        name="Unrecovered second-stage payload (modeled)",
        is_family=False,
        description=(
            "Modeled placeholder for unrecovered payload (TAG states final payload not recovered). "
            "Included to demonstrate 'malware authored-by threat-actor' with low confidence."
        ),
        created_by_ref=google_tag.id,
    )

    # -----------------------------
    # Indicators
    # -----------------------------
    indicators: List[Indicator] = []
    for i, h in enumerate(INITIAL_DOC_SHA256, start=1):
        indicators.append(
            make_file_hash_indicator(
                sha256=h,
                name=f"Initial Office document SHA-256 (#{i})",
                desc="SHA-256 for an initial malicious Office document reported by TAG in this campaign.",
                created_by_ref=google_tag.id,
                valid_from=OBSERVED_FIRST,
            )
        )

    indicators.append(
        make_file_hash_indicator(
            sha256=REMOTE_RTF_TEMPLATE_SHA256,
            name="Remote RTF template SHA-256",
            desc="SHA-256 for the remote RTF template used in the Office -> RTF -> HTML chain.",
            created_by_ref=google_tag.id,
            valid_from=OBSERVED_FIRST,
        )
    )

    indicators.extend([make_domain_indicator(d, google_tag.id, OBSERVED_FIRST) for d in C2_DOMAINS])

    # -----------------------------
    # Notes
    # -----------------------------
    note_protected_view = Note(
        spec_version="2.1",
        abstract="Protected View / MOTW dependency",
        content="TAG notes victims typically must disable Protected View (MOTW) to allow remote template retrieval/exploitation.",
        created_by_ref=google_tag.id,
        object_refs=[campaign.id],
    )

    note_cookie_gate = Note(
        spec_version="2.1",
        abstract="Cookie-based gating and double beaconing",
        content="Cookie gate: unique cookie set on remote RTF fetch and required by exploit; beacons before/after success.",
        created_by_ref=google_tag.id,
        object_refs=[campaign.id, infra.id],
    )

    note_authored_by_caveat = Note(
        spec_version="2.1",
        abstract="Caveat: authored-by modeled for teaching purposes",
        content=(
            "The 'malware authored-by threat-actor' relationship is included with low confidence for didactic alignment. "
            "TAG states the final payload was not recovered."
        ),
        created_by_ref=google_tag.id,
        object_refs=[unknown_payload.id, apt37_ta.id],
    )

    # -----------------------------
    # Relationships
    # -----------------------------
    relationships: List[Relationship] = []

    # Reverse towards Threat Actor
    relationships.append(rel(campaign.id, "attributed-to", apt37_ta.id, google_tag.id, confidence=80))
    relationships.append(rel(apt37_is.id, "attributed-to", apt37_ta.id, google_tag.id, confidence=80))

    # Forward from Threat Actor (uses)
    relationships.append(rel(apt37_ta.id, "uses", infra.id, google_tag.id, confidence=70))
    relationships.append(rel(apt37_ta.id, "uses", ap_template_injection.id, google_tag.id, confidence=60))
    relationships.append(rel(apt37_ta.id, "uses", ap_exploit_client.id, google_tag.id, confidence=60))
    relationships.append(rel(apt37_ta.id, "uses", ap_indicator_removal.id, google_tag.id, confidence=50))
    relationships.append(rel(apt37_ta.id, "uses", ap_spearphish_attach.id, google_tag.id, confidence=40))
    relationships.append(rel(apt37_ta.id, "uses", exploit_tool.id, google_tag.id, confidence=60))
    relationships.append(rel(apt37_ta.id, "uses", rokrat.id, google_tag.id, confidence=45))
    relationships.append(rel(apt37_ta.id, "uses", bluelight.id, google_tag.id, confidence=45))
    relationships.append(rel(apt37_ta.id, "uses", dolphin.id, google_tag.id, confidence=45))

    # Didactic reverse: malware authored-by threat-actor
    relationships.append(
        rel(
            unknown_payload.id,
            "authored-by",
            apt37_ta.id,
            google_tag.id,
            description="Didactic; TAG did not recover final payload. Low confidence.",
            confidence=15,
        )
    )

    # Campaign structure
    relationships.append(rel(campaign.id, "targets", south_korea.id, google_tag.id, confidence=70))
    relationships.append(rel(campaign.id, "exploits", vuln.id, google_tag.id, confidence=80))
    relationships.append(rel(campaign.id, "uses", infra.id, google_tag.id, confidence=80))

    # indicator indicates threat-actor (+ campaign/infra enrichment)
    for ind in indicators:
        ta_conf = 60 if "domain" in ind.labels else 50
        relationships.append(rel(ind.id, "indicates", apt37_ta.id, google_tag.id, confidence=ta_conf))
        relationships.append(rel(ind.id, "indicates", campaign.id, google_tag.id, confidence=70))
        if "domain" in ind.labels:
            relationships.append(rel(ind.id, "indicates", infra.id, google_tag.id, confidence=70))

    # ---------------------------------------------------------
    # IMPORTANT: Connect REPORT via explicit SRO "refers-to"
    # Pre-generate report_id so we can build relationships before creating Report object.
    # ---------------------------------------------------------
    report_id = f"report--{uuid4()}"

    relationships.append(rel(report_id, "refers-to", apt37_ta.id, google_tag.id, confidence=80))
    relationships.append(rel(report_id, "refers-to", campaign.id, google_tag.id, confidence=80))
    relationships.append(rel(report_id, "refers-to", vuln.id, google_tag.id, confidence=70))
    relationships.append(rel(report_id, "refers-to", infra.id, google_tag.id, confidence=70))
    relationships.append(rel(report_id, "refers-to", google_tag.id, google_tag.id, confidence=60))  # connect Identity too

    # -----------------------------
    # Report (10.6.5 style + connected)
    # -----------------------------
    report = Report(
        id=report_id,
        spec_version="2.1",
        name=ARTICLE_TITLE,
        published=published_time,                 # <-- como en apuntes
        report_types=["campaign"],                # <-- como en apuntes (si prefieres: ["threat-report", "campaign"])
        external_references=[url_report],         # <-- como en apuntes
        created_by_ref=google_tag.id,
        description=(
            "Google TAG report describing in-the-wild exploitation of CVE-2022-41128 (IE JScript / jscript9.dll) "
            "attributed to APT37. Chain: Office doc -> remote RTF template -> remote HTML rendered via IE."
        ),
        object_refs=[                             # <-- como en apuntes (pero con IDs, forma robusta)
            rokrat.id,            # ejemplos (históricos)
            apt37_ta.id,
            campaign.id,
            vuln.id,
            infra.id,
            *[ind.id for ind in indicators],
            note_protected_view.id,
            note_cookie_gate.id,
            note_authored_by_caveat.id,
        ],
    )

    # -----------------------------
    # Bundle
    # -----------------------------
    all_objects = [
        google_tag,
        south_korea,
        apt37_ta,
        apt37_is,
        campaign,
        vuln,
        infra,
        exploit_tool,
        ap_template_injection,
        ap_exploit_client,
        ap_indicator_removal,
        ap_spearphish_attach,
        rokrat,
        bluelight,
        dolphin,
        unknown_payload,
        note_protected_view,
        note_cookie_gate,
        note_authored_by_caveat,
        report,
        *indicators,
        *relationships,
    ]

    bundle = Bundle(objects=all_objects)

    with open(args.out, "w", encoding="utf-8") as f:
        f.write(bundle.serialize(pretty=args.pretty))

    print(f"STIX bundle written to: {args.out}")
    print("Sanity check ThreatActor present:",
          any(getattr(o, "type", None) == "threat-actor" for o in all_objects))
    print("Sanity check Report connected via refers-to:",
          any(getattr(o, "type", None) == "relationship"
              and getattr(o, "relationship_type", None) == "refers-to"
              and getattr(o, "source_ref", "") == report_id
              for o in all_objects))


if __name__ == "__main__":
    main()

