
https://chatgpt.com/g/g-p-680653de039c8191b7a3c14c407bedf5-malware/c/696bbc30-06c8-8332-ba0c-964c815ea784

# Se pide
- Capturar y analizar tráfico cifrado de un cliente DNS-over-TLS (DoT):
    - Primero analizamoss su comportamiento (aunque el tráfico vaya cifrado).
    - Después interceptamos y desciframos ese tráfico usando dos técnicas distintas del capitulo 7.

- El objetivo es observar cómo la herramienta kdig realiza una consulta DNS segura a un servidor (como el de Cloudflare, 1.1.1.1).

- Incluir evidencias de todos los comandos y pruebas (salidas de terminal, capturas, y ficheros generados como PCAP) y explicar qué hace cada paso. 


# 1) Análisis de la aplicación (cliente DoT)
- Ejecutar un cliente DoT (recomendado: kdig) contra Cloudflare: Cloudflare ofrece DoT en 1.1.1.1:853 (TCP + TLS) y también por hostname one.one.one.one.

- Tenemos que estudiar el programa (cliente) que hace consultas DNS usando DNS-over-TLS (DoT).
    - DoT = DNS tradicional, pero en vez de ir en claro (UDP/53), va cifrado dentro de TLS y normalmente por TCP/853.
    - “Cliente DoT” = la herramienta que tú ejecutas para hacer la consulta DNS cifrada (por ejemplo kdig).
    - Qué buscan con “análisis”:
        - Que demuestres que el programa realmente está usando TCP y el puerto 853.
        - Que identifiques detalles de la sesión TLS (handshake, certificado, etc.).
        - Que dejes evidencia (capturas, comandos, trazas).

- “Ejecutar un cliente DoT (recomendado: kdig) contra Cloudflare”: Te piden que uses un cliente DoT (idealmente kdig) para consultar un servidor DoT real. En el ejemplo te dicen usar Cloudflare porque ofrece DoT públicamente. ¿Qué significa “Cloudflare ofrece DoT en 1.1.1.1:853 y por hostname one.one.one.one”? -->
    - 1.1.1.1 es la IP del resolver DNS de Cloudflare.
    - :853 indica el puerto donde escucha DoT.
    - one.one.one.one es el nombre (hostname) asociado al servicio. En TLS, el hostname es importante porque el certificado del servidor se valida contra ese nombre (no contra la IP).

```
kdig @1.1.1.1 +tls-ca +tls-host=one.one.one.one example.com
```
donde:
- kdig : el programa cliente DNS.
- @1.1.1.1 : le dices “consulta a este servidor DNS” (Cloudflare).
- +tls-ca : “usa TLS y valida el certificado con autoridades de certificación (CA)”.
- +tls-host=one.one.one.one : “cuando valides el certificado, comprueba que corresponde al hostname one.one.one.one” (esto evita que un atacante haga MITM con otro certificado).
- example.com : el dominio que estás consultando.
- Lo que estamos haciendo es: Ejecutar una consulta DNS cifrada (DoT) con kdig contra el servidor DoT de Cloudflare (1.1.1.1 puerto 853), validando correctamente el certificado TLS usando el nombre one.one.one.one, y luego analiza ese tráfico.”


## Instalación de kding
En Debian, kdig viene en el paquete knot-dnsutils.
```
sudo apt update
sudo apt install -y knot-dnsutils ca-certificates
```
donde:
- El ca-certificates es para que la validación de certificados TLS funcione con el almacén del sistema, que es lo que usa +tls-ca.

Comprobamos que está instalado: 
```
kdig -V
kdig, Knot DNS 3.4.6
```



## Hacer una consulta DNS-over-TLS (DoT) a Cloudflare
Cloudflare ofrece DoT en 1.1.1.1 puerto 853 (TCP+TLS) y también por hostname one.one.one.one.

Comando recomendado (con debug y validación TLS):
```
kdig -d @1.1.1.1 +tls-ca +tls-host=one.one.one.one example.com
```
donde:
- `-d`: activa mensajes de depuración (te muestra TCP, puerto 853, y detalles de TLS).
- `@1.1.1.1`: servidor DNS de Cloudflare.
- `+tls-ca`: usa TLS y valida el certificado con CAs (del sistema si no indicas un fichero).
- `+tls-host=one.one.one.one`: le dices qué hostname debe cuadrar con el certificado (es clave para evitar MITM).
- `example.com`: dominio a resolver.


Probar el otro IP de Cloudflare para DoT: Cloudflare también da DoT en 1.0.0.1:853:
```
nc -vz 1.0.0.1 853
```

Ejecuta kdig con DoT contra 1.0.0.1 (Cloudflare). Usa exactamente este comando:
```
$ kdig -d @1.0.0.1 +tls-ca +tls-host=one.one.one.one example.com
;; DEBUG: Querying for owner(example.com.), class(1), type(1), server(1.0.0.1), port(853), protocol(TCP)
;; DEBUG: TLS, imported 151 system certificates
;; DEBUG: TLS, received certificate hierarchy:
;; DEBUG:  #1, C=US,ST=California,L=San Francisco,O=Cloudflare\, Inc.,CN=cloudflare-dns.com
;; DEBUG:      SHA-256 PIN: ltQ6aXy3tqpNZKJdnevMD7oR+IsI5rNWbOssFDrl+Ew=
;; DEBUG:  #2, C=US,ST=Texas,L=Houston,O=SSL Corp,CN=SSL.com SSL Intermediate CA ECC R2
;; DEBUG:      SHA-256 PIN: zGgA4OU4DjJdvpRYUqbi5Vh2g9W5Oc/PgKihy9mkLsE=
;; DEBUG:  #3, C=US,ST=Texas,L=Houston,O=SSL Corporation,CN=SSL.com Root Certification Authority ECC
;; DEBUG:      SHA-256 PIN: oyD01TTXvpfBro3QSZc1vIlcMjrdLTiL/M9mLCPX+Zo=
;; DEBUG: TLS, skipping certificate PIN check
;; DEBUG: TLS, The certificate is trusted. 
;; TLS session (TLS1.3)-(ECDHE-X25519)-(ECDSA-SECP256R1-SHA256)-(AES-256-GCM)
;; ->>HEADER<<- opcode: QUERY; status: NOERROR; id: 33829
;; Flags: qr rd ra; QUERY: 1; ANSWER: 2; AUTHORITY: 0; ADDITIONAL: 1

;; EDNS PSEUDOSECTION:
;; Version: 0; flags: ; UDP size: 1232 B; ext-rcode: NOERROR
;; PADDING: 392 B

;; QUESTION SECTION:
;; example.com.        		IN	A

;; ANSWER SECTION:
example.com.        	101	IN	A	104.18.27.120
example.com.        	101	IN	A	104.18.26.120

;; Received 468 B
;; Time 2026-01-17 18:15:45 CET
;; From 1.0.0.1@853(TLS) in 56.7 ms
```
donde:
- 1) Evidencia de que realmente estás usando DoT (DNS-over-TLS)
    - `;; DEBUG: Querying for owner(example.com.), class(1), type(1), server(1.0.0.1), port(853), protocol(TCP)`
    - `owner(example.com.)`: el nombre consultado.
    - `type(1)`: el tipo A (IPv4). En DNS, el tipo A es el código 1.
    - `class(1)`: clase IN (Internet). En DNS, IN es el código 1.
    - `server(1.0.0.1), port(853), protocol(TCP)`: esto es clave: confirma que la consulta va a 1.0.0.1 por TCP/853, que es el puerto estándar de DoT.
    - En tu informe, esta línea es la prueba directa de “cliente DoT contra Cloudflare” usando TCP + 853.

- 2) Evidencia de validación TLS con CAs del sistema
    - `;; DEBUG: TLS, imported 151 system certificates`
    - `+tls-ca` hace que kdig cargue el almacén de CA del sistema (o el path que corresponda) para validar el certificado del servidor.
    - `“151 system certificates”` es evidencia de que está usando el trust store del sistema para la validación.

- 3) Cadena de certificados (certificate chain) presentada por el servidor
    - `;; DEBUG: TLS, received certificate hierarchy:`
    - Certificado #1 (leaf / servidor): `#1 ... O=Cloudflare, Inc., CN=cloudflare-dns.com`
        - Este es el certificado del servidor (leaf).
        - Ojo: tu comando indica +tls-host=one.one.one.one, pero el CN que imprime kdig es cloudflare-dns.com. Eso no es necesariamente un problema: hoy en día lo que manda para hostname validation suele ser el SAN (Subject Alternative Name), no el CN. Es muy posible que el SAN incluya one.one.one.one y/o nombres del servicio DoT de Cloudflare.
        - Para una evidencia “cerrada” en memoria, conviene añadir una captura complementaria con openssl s_client mostrando SANs (te dejo el comando al final).

        - SHA-256 PIN: ... kdig te muestra el pin (hash) de la clave pública/cert para pinning. Es información útil para “fingerprinting” del certificado, pero no imprescindible salvo que el guion del curso pida pinning.

    - Certificado #2 (intermediate): #2 ... CN=SSL.com SSL Intermediate CA ECC R2
        - Certificado intermedio (CA intermedia) que firma el leaf.
    
    - Certificado #3 (root): #3 ... CN=SSL.com Root Certification Authority ECC
        - Certificado raíz (root CA) del que deriva la confianza (normalmente ya está en el sistema o se valida por cadena hasta un root confiable).

- 4) Pinning y confianza del certificado:
    - `;; DEBUG: TLS, skipping certificate PIN check`: Indica que no se está aplicando pinning (no has configurado un pin esperado). Esto es normal.
    - `;; DEBUG: TLS, The certificate is trusted.`: Esta es la evidencia principal de que la verificación TLS con CA ha sido correcta: el certificado presentado por el servidor es confiable según el almacén del sistema (y la validación que hace kdig con los parámetros que le diste).


- 5) Parámetros criptográficos de la sesión TLS (muy importante para el análisis del handshake)
    - ;; TLS session (TLS1.3)-(ECDHE-X25519)-(ECDSA-SECP256R1-SHA256)-(AES-256-GCM)
    - Esta línea resume lo esencial del canal cifrado:
        - TLS1.3: la sesión negoció TLS 1.3 (moderno; handshake y cifrados distintos a TLS 1.2).
        - ECDHE-X25519: intercambio de claves efímero con curva X25519 (Perfect Forward Secrecy).
        - ECDSA-SECP256R1-SHA256: autenticación/firmas con ECDSA (curva P-256 / secp256r1) y hash SHA-256.
        - AES-256-GCM: cifrado simétrico de la sesión con AES-GCM (AEAD), clave 256 bits.
    - Para tu memoria, esto cubre muy bien la parte de “análisis de TLS”: versión y suite/algoritmos principales.


