
# Requisitos
- Esquema de la Red:
    ![Esquema de la red](capturas/esquema-de-la-red.png)

- El Equipo nuevo se conecta a un Switch Ethernet OT a través de un puerto Fast Ethernet de 100Mbps.
- El Switch Ethernet OT:
    - Tiene un enlace uplink de 10 Gbps con un Router OT-IT que le permite conectarse a la red IT de la organización.
    - No soporta port mirroring.
- Equipos de la red industrial:
    - Obtienen su dirección IPv4 y la configuración de red de un Servidor DHCP que está conectado al Router OT-IT.
    - Algunos equipos de la red industrial requieren que el servidor DHCP les proporcione parámetros de arranque.
    - Algunos equipos de la red industrial acceden a Internet.
- El Router OT-IT:
    - Interconecta las redes IT y OT.
    - Permite que los equipos industriales se comuniquen con un servidor DNS y un Proxy Eeb con conexión a Internet.
    - Soporta port mirroring.
- El Proxy Web:
    - Soporta port mirroring.
    - Debe ser configurado en cada cliente.
    - El cliente debe disponer de un usuario y contraseña.
    - El proxy web es la única forma de salir a Internet desde dentro de la organización.
    - Almacena en un logs las URls a las que se conecta cada cliente
    - No almacena en el log el contenido de los mensajes HTTP que se intercambian.




# Se pide
- Capturar todo el tráfico que envío o recibe el Equipo nuevo con otros equipos de la red.
- Capturar todo el tráfico que envío o recibe el Equipo nuevo con Internet.
- Analizar los protocolos que emplea.
- Analizar la información que se intercambia con el fabricante.
- Tener impacto mínimo en OT.
- No comprometer la fiabilidad. 

- Quedar desplegada en la ventana corta de mantenimiento y no requerir cambios posteriores, incluso si hay incidencias con la captura. 



# Análisis de los mecanismos y técnicas de captura de Tráfico de Red.
Indicando cómo podría emplearse, y si serían recomendables o no en este caso.


## 1. Estrategias de Captura de Tráfico de Red


### 1.1 Captura de tráfico en el propio equipo que ejecuta la aplicación
Este método sería ideal ya que, es lo más completo (incluye loopback, correlación con eventos del sistema, etc.), pero en este caso, queda prácticamente descartada por falta de acceso al host. En enunciado se explica que el equipo tiene SO propietario y “solo panel web”, sin ejecutar comandos. Por tanto, no podremos instalar tcpdump/agents ni instrumentar el host, así que esta vía queda no aplicable como técnica principal. Pudiera ser viable si el panel web permitiese exportar logs/PCAP.


### 1.2 Captura de tráfico a nivel físico o de enlace

#### 1.2.1 Network TAP - Sonda de Red Física
La sonda se conecta el equipo y replica todos los paquetes que envía y recibe el mismo a otros interfaces de red a los que se conecta la estación de captura.


Necesitamos capturar todo lo que el equipo envía/recibe y, además, no podemos permitir que un fallo de la captura afecte a OT una vez en producción. El TAP, bien elegido, es el enfoque más “fail-safe” y de mínimo impacto. 

Dónde se coloca para cumplir R1 (captura completa):
- Entre el nuevo equipo y el puerto del switch OT (100 Mbps). Así garantizamos ver:
    - Tráfico con otros equipos OT (en la misma LAN/switch).
    - Tráfico hacia DNS/proxy (que es la única salida a Internet). 



Es “la siguiente mejor opción” cuando no podemos capturar en el host, y evita depender de funciones del switch.

![Sonda-Tap](capturas/sonda-tap.png)

La Figura muestra el esquema de una sonda de red que captura el tráfico entre un equipo con una interfaz de red Ethernet y su switch. El switch se conecta al interfaz A, el equipo en el interfaz B, y la estación de captura se conecta a los interfaces C y D. La sonda se encarga de reenviar todos los paquetes que se envían por los interfaces A y B entre ellos como si siguiesen conectados a través de un cable, pero también envía una copia de cada paquete que se recibe por los interfaces A y B a la estación de captura a través de los interfaces C y D (que normalmente solo pueden enviar tráfico, pero no recibir). Se necesitan dos interfaces de salida con la misma tasa que los entrantes para garantizar que se pueden recibir todos los paquetes (o un puerto de más capacidad). Esto es, un puerto Gigabit Ethernet es capaz de enviar y recibir tramas a 1 Gbps en cada sentido. Por lo tanto, si el equipo envía a 1 Gbps y recibe datos del switch también a 1 Gbps, se necesitan enviar 1+1=2 Gbps a la estación de captura.


##### A) Sonda/TAP pasivo (captura a nivel físico/enlace)

Recomendable (como mecanismo principal), con consideraciones operativas.
Dado que no es posible capturar en el propio equipo (SO propietario) y el switch OT industrial no dispone de port mirroring, un TAP pasivo instalado entre el nuevo equipo y el switch OT es una solución robusta para cumplir el requisito de capturar todo el tráfico (tanto comunicaciones intra-OT como tráfico hacia DNS/proxy). Además, mantiene la estación de captura como elemento no participante en la red (monitorización pasiva), lo que se alinea con el requisito de impacto mínimo. Como consideraciones, muchos TAP pasivos entregan la copia separando TX y RX, lo que puede requerir dos interfaces de captura o un método de agregación para reconstruir full-duplex en un único PCAP; esta complejidad debe asumirse y validarse durante la ventana de mantenimiento. En cualquier caso, el punto de captura a nivel enlace es el más adecuado para no depender de reconfiguraciones posteriores en la red OT.

##### B) Sonda/TAP activo (captura a nivel físico/enlace)

Recomendable (como mecanismo principal) si se prioriza operativa continua y simplicidad de captura.
Un TAP activo en el enlace del nuevo equipo hacia el switch OT permite igualmente capturar la totalidad del tráfico del equipo sin depender de port mirroring, y puede aportar ventajas prácticas relevantes para un entorno industrial: algunos modelos ofrecen agregación de RX/TX en un único puerto monitor (simplificando la estación de captura a una sola NIC) y funciones orientadas a continuidad de servicio (según el modelo, p. ej., bypass/fail-open). Su principal contrapartida es la dependencia de alimentación y electrónica, por lo que la selección debe justificarse explícitamente bajo el criterio de fiabilidad OT, verificando que el comportamiento ante fallo no compromete el tráfico productivo. Si se elige un modelo con mecanismos de continuidad adecuados, el TAP activo resulta especialmente defendible en este caso porque combina captura completa con una operación más sencilla y estable una vez el sistema entra en producción, donde no se permiten intervenciones posteriores.


#### 1.2.2 Port mirroring (SPAN/RSPAN/ERSPAN) → Útil como complemento, pero no suficiente por sí solo

Limitación crítica del caso: el switch OT no tiene port mirroring. Por tanto, no podemos basarnos en SPAN (replica el comportamiento de una sonda de red física, y que permite copiar todo el tráfico enviado y recibido por uno o más puertos, a otro puerto del mismo switch donde se conecta la estación de captura) en el punto más importante (el puerto del equipo). 


Qué sí podemos hacer (infra IT/router sí tiene mirroring):
- Mirroring en el router OT-IT para ver tráfico que cruza hacia DNS/proxy o hacia IT (si necesitas redundancia/visibilidad adicional).
- Posible ERSPAN si nos interesa transportar la copia a una estación de captura remota (sin estar físicamente en el armario OT).

Pero: capturar en el router no cubre comunicaciones intra-subred OT que no pasen por el router. Por eso, para el objetivo “¿se comunica con otros equipos OT?” necesitas el TAP en el enlace del equipo.

Conclusión de esta sección para tu propuesta:
- TAP en el enlace del equipo = mecanismo principal.
- SPAN/ERSPAN en router = apoyo/backup y para visibilidad agregada, no para sustituir el TAP.


Datos a considerar si se configura port mirroring:
- Los interfaces de red Ethernet que capturen el tráfico deben encontrarse en modo promiscuo, ya que la gran mayoría de las tramas que reciba (excepto las tramas broadcast/multicast) no estarán destinadas a su dirección MAC.
- No se debe configurar una dirección IP en los interfaces de captura, de forma que la estación de captura no pueda enviar tráfico a través dichos interfaces.
- Desactivar el reenvío de paquetes IP (i.e. para que la estación de captura no se comporte como un router).
- No utilizar un hub Ethernet para capturar tráfico ya que los hubs degradan significativamente el rendimiento de Ethernet.


### 1.3 Captura de tráfico a nivel de red
Este método NO es recomendable debido a:
- Este mecanismo se utiliza cuando no hay acceso físico ni al switch, cosa que no es nuetro caso.
- Este mecanismo no cumple con los requisitos del ejercicio:
    - Impacto mínimo.
    - Fiabilidad OT: forzar rutas/gateway o hacer MITM de red introduce dependencia operativa y riesgo.
    - Restricción operativa fuerte: después de la ventana de mantenimiento, no se puede interrumpir ni reconfigurar OT “incluso si hay problemas con el mecanismo de captura”. Eso penaliza cualquier solución que requiera ajustes o que pueda degradar la red si algo falla
- ARP poisoning / DHCP spoofing / ICMP Redirect: el propio capítulo lo trata como “última opción”
    - Además es especialmente inadecuado en OT por ruido, inestabilidad y riesgo.
    - Se debe terner el consentimiento expreso de los responsables de la infraestructura antes de realizarlo.



### 1.4 Captura de tráfico a nivel de aplicación
Muy relevante para “Internet”, pero como telemetría complementaria

Aquí el ejercicio te da una pista directa:
- Funciona en redes empresariales que no permiten la conexión directa de los equipos con Internet.
- La salida a Internet desde OT es solo mediante DNS + proxy, con usuario/contraseña configurado explícitamente en el cliente. 
- El proxy loggea URLs por cliente, pero no guarda contenido HTTP. 


Cómo conectarlo con tu resumen:

Qué sí puedes obtener (y es muy útil para responder al cliente):
- A qué dominios/URLs intenta acceder el equipo (vía logs del proxy y/o DNS).
- Patrones de beaconing, actualizaciones, endpoints del fabricante.

Qué no puedes obtener por defecto:
- El contenido de la comunicación (si hay TLS o si el proxy no registra cuerpos/respuestas).
- Y sobre mitmproxy (de tu resumen): En teoría, mitmproxy ayuda a inspeccionar aplicación y TLS, pero en este caso suele no ser viable porque requeriría:

Reconfigurar el cliente para que use tu proxy, y (si interceptas TLS) instalar una CA en el equipo, lo cual es improbable con SO propietario y además arriesgado para OT.

Veredicto razonable: no como mecanismo principal, y solo planteable en laboratorio/entorno de pruebas si el fabricante lo permite.



## 2 Herramientas de Captura y Análisis de Tráfico

### 2.1. Captura de tráfico con ‘tcpdump’

### 2.2. Análisis de tráfico con ‘Wireshark’

### 2.3. Análisis de tráfico a nivel de aplicación con ‘mitmproxy’




2. Mecanismo o mecanismos de captura de tráfico que cumplen con los requisitos del cliente.

3. Los mecanismos que cumplan los requisitos deben incluir:
    - La configuración necesaria en la estación de captura.
    - Cómo se desplegarían.



