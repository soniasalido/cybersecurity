## 1. Descripci√≥n general de la arquitectura del laboratorio
![](capturas/structure.png)

La arquitectura usada consiste en una **m√°quina f√≠sica (llamada m√°quina host) que ejecuta Ubuntu Linux con instancias de m√°quina virtual Linux (Ubuntu Linux VM) y m√°quina virtual Windows (Windows VM)**. Estas m√°quinas virtuales se configurar√°n para ser parte de la misma red y utilizar√°n el modo de **configuraci√≥n de red de Host-only** para que el malware no pueda comunicarse con Internet y as√≠ el tr√°fico de la red estar√° contenido en el entorno de laboratorio aislado.

La VM de Windows es donde se ejecutar√° el malware durante el an√°lisis, y la VM de Linux se usar√° para monitorear el tr√°fico de red y ser√° configurada para simular servicios de Internet (DNS, HTTP, etc.), para proporcionar una respuesta adecuada cuando el malware solicite estos servicios. Por ejemplo, la m√°quina virtual Linux se configurar√° de manera que cuando el malware solicite un servicio como DNS, la m√°quina virtual Linux proporcione la respuesta DNS adecuada. 

En esta configuraci√≥n, la m√°quina virtual Linux estar√° preconfigurada en la direcci√≥n IP 192.168.1.100 y la direcci√≥n IP de la m√°quina virtual Windows se configurar√° en 192.168.1.x (donde x es cualquier n√∫mero de 1 a 254 excepto 100). La puerta de enlace predeterminada y el DNS de la VM de Windows se configurar√°n en la direcci√≥n IP de la VM de Linux (es decir, 192.168.1.100) para que todo el tr√°fico de la red de Windows se enrute a trav√©s de la VM de Linux.

Tambi√©n es posible configurar un laboratorio compuesto por m√∫ltiples VMs ejecutando diferentes versiones de Windows; esto nos permitir√° analizar la muestra de malware en varias versiones de sistemas operativos Windows.
![](capturas/structure-2.png)


## 2. Configuraci√≥n de las VMs
- Instalaci√≥n de MV Ubuntu & MV Windows.
- Instalaci√≥n de Virtual Guest Additions software en ambas VMs.
  
### 2.1 Configuraci√≥n de Windows VM:
- Deshabilitamos Windows Update.
- Deshabilitamos Windows Defender ü†Æ  Services ü†Æ Windows Defender ü†Æ Boton derecho ü†Æ  Select properties ü†Æ  Stop Service
- Mostrar extensiones de ficheros ü†Æ Opciones de carpeta ü†Æ Ver ü†Æ  Mostrar extensiones para ficheros
- Mostrar ficheros y carpetas ocultos.
- Deshabilitamos ASLR (Address Space Layout Randomization): ASLR (Address Space Layout Randomization) es una t√©cnica de seguridad utilizada para dificultar los ataques de desbordamiento de b√∫fer (buffer overflow) y otras vulnerabilidades de corrupci√≥n de memoria. La idea principal de ASLR es ubicar aleatoriamente en el espacio de direcciones de memoria las √°reas clave de un proceso, como el ejecutable base, la pila, el mont√≥n y las librer√≠as cargadas. Esto hace que las direcciones de memoria sean impredecibles para un atacante, dificultando la ejecuci√≥n de c√≥digo malicioso.
    ü†Æ  Windows + R ü†Æ  regedit ü†Æ Computer\HKEY_LOCAL_MACHINE\SISTEM\CurrentSet\Control\Session Manager\Memory Management ü†Æ  New Key ü†Æ QWORD (32 bits) ü†Æ poner como nombre: MoveImages
- Deshabilitamos Firewall ü†Æ Windows Defender Firewall.
- Creamos un snapshot ü†Æ HOST + T

- Instalamos Flare VM: Es una colecci√≥n de scripts de instalaci√≥n de software para sistemas Windows que permite configurar y mantener f√°cilmente un entorno de ingenier√≠a inversa y an√°lisis de malware en una m√°quina virtual.Las principales caracter√≠sticas de FLARE VM son:
  - Proporciona un conjunto de herramientas expertas para ingenier√≠a inversa, an√°lisis de malware, monitoreo, depuraci√≥n, desensamblado, descompilaci√≥n y m√°s, todas preinstaladas y configuradas. Algunas herramientas incluidas son IDA, Binary Ninja, Radare2, OllyDbg, x64dbg, Ghidra, entre otras. (https://github.com/dnSpy/dnSpy)
  - Utiliza Chocolatey (un administrador de paquetes para Windows) y Boxstarter para automatizar la instalaci√≥n y configuraci√≥n de las herramientas en un entorno Windows virtualizado.
  - Est√° dise√±ado para instalarse √∫nicamente en una m√°quina virtual Windows, no en un host f√≠sico, para permitir un an√°lisis de malware seguro y contenido.
  - Proporciona un proceso de instalaci√≥n, actualizaci√≥n y desinstalaci√≥n simplificado a trav√©s de scripts de PowerShell.
  - Permite personalizar f√°cilmente las herramientas a instalar a trav√©s de una interfaz gr√°fica de usuario.
  - Es un proyecto de c√≥digo abierto mantenido por el equipo FLARE de Mandiant/FireEye, con contribuciones de la comunidad.
  - Enlace: https://github.com/mandiant/flare-vm
  - Video con instruciones para instalar: https://www.youtube.com/watch?v=i8dCyy8WMKY
  - Desactivamos: Windows Defender through Group Policy:
    - gpedit.msc
    - En el Editor de Directiva de Grupo, navegue a la siguiente ruta: Computer Configuration > Administrative Templates > Windows Components > Windows Defender Antivirus
    - Busque la configuraci√≥n "Turn off Windows Defender Antivirus" (o "Desactivar Antivirus Windows Defender" en espa√±ol).
    - Haga doble clic en ella para editarla.
    - Seleccione "Enabled" (Habilitado) y haga clic en "Apply" (Aplicar) y luego en "OK".
    - Cierre el Editor de Directiva de Grupo Local.
  - Computer Configuration > Administrative Templates > Windows Components > Microsoft Defender Antivirus > Real-time Protection > Enable Turn off real-time protection
  - Instalaci√≥n: Desde la carpeta del master, ejecutar con PowerShell como administrador:
    - Set-ExecutionPolicy unrestricted
    - Si falla: Set-ExecutionPolicy -Scope      CurrentUser
      - unresticted
      - ./

- Descargamos Python desde https://www.python.org/downloads/. Aseg√∫rate de descargar la versi√≥n Python 2.7.x (por ejemplo, 2.7.13); la mayor√≠a de los scripts usados en este libro est√°n escritos para ejecutarse con la versi√≥n Python 2.7 y puede que no funcionen correctamente en Python 3.

- Configuramos la m√°quina virtual de Windows para que funcione en modo de red solo-anfitri√≥n (Host-only).

- Configuramos la direcci√≥n IP de la m√°quina virtual de Windows como 192.168.1.x (elegimos cualquier direcci√≥n IP excepto 192.168.1.100, ya que esa la usar√° la m√°quina virtual con Linux) y establecemos la puerta de enlace predeterminada y el servidor DNS a la direcci√≥n IP de la m√°quina virtual con Linux (es decir, 192.168.1.100).

- Nos aseguramos de que ambas m√°quinas puedan comunicarse entre s√≠. Comprobamos la conectividad ejecutando el comando ping.

- Para desactivar Windows Defender:
  - Abrimos el Editor de directivas de grupo local.
  - En el panel izquierdo, navegamos hasta: Configuraci√≥n del equipo | Plantillas administrativas | Componentes de Windows | Windows Defender.
  - En el panel derecho, hacemos doble clic en la directiva Desactivar Windows Defender para editarla.
  - Seleccionamos Habilitada y haz clic en Aceptar.
 

### 2.2 Configuraci√≥n de Linux VM:
- Instalaci√≥n:
  ```
  sudo apt-get install python-pip
  pip install --upgrade pip
  sudo apt-get install python-magic
  sudo apt-get install upx
  sudo pip install pefile
  sudo apt-get install yara
  sudo pip install yara-python
  sudo apt-get install ssdeep
  sudo apt-get install build-essential libffi-dev python python-dev libfuzzy-dev
  sudo pip install ssdeep
  sudo apt-get install wireshark
  sudo apt-get install tshark
  ```
- INetSim (http://www.inetsim.org/index.html) es una herramienta potente que permite simular varios servicios de Internet (como DNS y HTTP).Emula servicios t√≠picos de Internet dentro de una red controlada o aislada (como una sandbox). Esto permite ver c√≥mo se comporta un malware cuando intenta comunicarse con servidores externos, sin que el malware realmente acceda a Internet:
  ```
  sudo su
  echo "deb http://www.inetsim.org/debian/ binary/" >  /etc/apt/sources.list.d/inetsim.list
  wget -O - http://www.inetsim.org/inetsim-archive-signing-key.asc | apt-key add -
  apt update
  apt-get install inetsim
  ```
  
- Ahora podemos aislar la m√°quina virtual de Ubuntu dentro del laboratorio configurando el modo de red "Solo-anfitri√≥n" (Host-only) en el dispositivo virtual. Es importante aislar la m√°quina virtual del acceso a Internet real, para evitar que el malware cause da√±os o se comunique con atacantes reales. El modo de red Host-only en VMware:
    - Crea una red cerrada entre tu m√°quina real (host) y la m√°quina virtual (VM).
    - No permite acceso a Internet ni a otras redes, solo comunicaci√≥n directa entre host y VM.
    - Es ideal para entornos de prueba o an√°lisis seguro.
  
- IP address of 192.168.1.100 to the Ubuntu Linux VM.
  
- Configurar INetSim para que pueda escuchar y simular todos los servicios en la ip 192.168.1.100:
  ```
  sudo gedit /etc/inetsim/inetsim.conf
  # service_bind_address
  #
  # IP address to bind services to
  #
  # Syntax: service_bind_address <IP address>
  #
  # Default: 127.0.0.1
  #
  #service_bind_address 10.10.10.1
  service_bind_address 192.168.1.100
  #
  #dns_default_ip 10.10.10.1
  dns_default_ip 192.168.1.100
  ```
- Arrancar INetSim:
  ```
  sudo inetsim
  ```
- Hacemos una snapshot | instant√°nea: En VirtualBox, se puede hacer haciendo clic en M√°quina | Tomar instant√°nea. ü†Æ Host + T


## 3. Otra posible configuraci√≥n para las MV

### 3.1 Configuraci√≥n Virtual Box

- Instalamos una MV Windows10 Pro y una MV Remnux.
- Instalamos Virtual guest addition.
- Cambiamos a una configuraci√≥n de red tipo 10.0.0.0/24 para evitar posibles saltos a redes usuales como 192.168.X.X. Actualmente en Virtual box s√≥lo se pueden crear redes del rango 192.168.57.... Para crear una red del rango 10.0.0.0/24, tenemos que habilitarlo en el fichero de configuraci√≥n de redes:
```
sudo nano /etc/vbox/networks.conf

A√±adimos:
* 10.0.0.0/24
```

- Creamos en l√≠nea de comandos una red hostonly:
```
VBoxManage hostonly cretate
```
El comando anterior, genera una nueva red y nos indica su nombre, por ejemplo vboxnet1.

- Especificamos el rango de la red:
```
VBoxManage hostonly ipconfig vboxnet1 --ip 10.0.0.1 --netmask 255.255.255.0
```

- Cerramos y abrimos VirtualBox para que actualice este cambio.

- En virtualbox, Vamos a la configuraci√≥n de redes: Red vboxnet1 --> Configuraci√≥n de la red:
```
Direccion IPv4: 10.0.0.1
m√°scara de red: 255.255.255.0
```
- Vamos a la configuraci√≥n de redes: Red vboxnet1 --> Servidor DHCP:
```
Direcci√≥n del Servidor: 10.0.0.2
M√°scara de red: 255.255.255.0
Limite inferior: 10.0.0.3
L√≠mite superior: 10.0.0.254
```
- Verificamos que la VM WIN y la WM Linux tiene s√≥lo un adaptador de red activo: Red vboxnet1


### 3.2 M√°quina virtual Remnux

```
ip: 10.0.0.3/24
Configuraci√≥n inetsim:
nano /etc/inetsim/inetsim.conf
service_bind_addres  0.0.0.0
dns_default_ip       10.0.0.3

Ejecutar inetsim.
```

### 3.3 M√°quina Virtual WIN:
```
ip: 10.0.0.4/24
Download Windows Terminal:
Download the VCLibs package. In a PowerShell window, run: wget https://aka.ms/Microsoft.VCLibs.x64.14.00.Desktop.appx -usebasicparsing -o VCLibs.appx
Download the Windows Terminal MSIX bundle from the provided link: wget https://github.com/microsoft/terminal/releases/download/v1.15.3465.0/Microsoft.WindowsTerminal_Win10_1.15.3465.0_8wekyb3d8bbwe.msixbundle -UseBasicParsing -o winterminal.msixbundle
In a PowerShell admin window, add the VCLibs package: Add-AppxPackage [C:\path\to\downloaded\VCLibs.appx]
In a PowerShell admin window, run: Add-AppxPackage [C:\path\to\downloaded\winterminal.msixbundle]

(Optional) Pin Windows Terminal to the task bar

Disable proxy auto detect setting:
In the Windows search bar, search ‚Äúproxy settings‚Äù,
Switch "Automatically detect settings" button off

Disable Tamper Protection
Search "Defender", open Defender settings and set all Defender Settings to off

Disable AV/Defender in GPO
Si tenemos Windows10 Home y gpedit.msc no est√° instalado:
- cmd ejecutar como administrador
- FOR %F IN ("%SystemRoot%\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientTools-Package~*.mum") DO ( DISM /Online /NoRestart /Add-Package:"%F" )
- FOR %F IN ("%SystemRoot%\servicing\Packages\Microsoft-Windows-GroupPolicy-ClientExtensions-Package~*.mum") DO ( DISM /Online /NoRestart /Add-Package:"%F" )
- Windows+r --> gpedit.msc

In Windows search bar, search "group policy"
In GPO, navigate to ‚Üí Administrative Templates ‚Üí Windows Components ‚Üí Microsoft Defender Antivirus ‚Üí Enable ‚ÄúTurn off Microsoft Defender Antivirus‚Äù
Disable Windows Firewall
GPO ‚Üí Administrative Templates ‚Üí Network ‚Üí Network Connections ‚Üí Windows Defender Firewall ‚Üí Domain Profile ‚Üí Disable ‚ÄúProtect All Network Connections‚Äù
Do the same but for the Standard profile



TAKE A SNAPSHOT!

Download and install FLARE-VM:
In PowerShell Admin prompt, run: (New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")
Change directories to the Desktop

Run: Unblock-File .\install.ps1
Run: Set-ExecutionPolicy Unrestricted
Accept the prompt to set the ExecPol to unrestricted if one appears
Run: .\install.ps1 -customConfig https://raw.githubusercontent.com/HuskyHacks/PMAT-labs/main/config.xml
Follow the rest of the prompts and continue with the installation.

Configuraci√≥n del adaptador de ip IPV/4:
Usar la siguiente direcci√≥n del servidor de DNS: 10.0.0.3


When the installation is done, TAKE ANOTHER SNAPSHOT!
```

Comprobar que todas las m√°quinas se ven con pings.
comprobar que la MV Win, si accede a una web o recurso, recibe respuesta de inetsim.


![Inetsim-setup](capturas/Inetsim-setup.png)


### Interacciones seg√∫n los modos de red
C√≥mo interact√∫an las MVs con el Host f√≠sco que las contiene:
![networking-modes](capturas/networking-modes.png)

**El modo de red Host-Only en entornos virtualizados permite la comunicaci√≥n √∫nicamente entre las m√°quinas virtuales y el host f√≠sico, sin acceso a internet ni a otras m√°quinas de la LAN. Sin embargo, Host-Only permite la comunicaci√≥n entre la VM infectada y el host**. Es por ello que este modo no es totalmente seguro para an√°lisis de malware si el host contiene datos valiosos o est√° desprotegido.

Aunque **con Host-Only se evita que el malware salga a internet o ataque otros dispositivos de la red corporativa**, la posibilidad de comunicaci√≥n directa con el host representa un riesgo: si el malware logra aprovechar vulnerabilidades presentes en el sistema de virtualizaci√≥n o en el propio host, podr√≠a salir del entorno controlado y comprometer el host f√≠sico. Hist√≥ricamente han existido exploits (vulnerabilidades de escape de VM) que permiten a malware salir de la m√°quina virtual y ejecutar c√≥digo en el host, aunque estos no son triviales ni comunes en entornos bien actualizados.

Por tanto, Host-Only **aporta un nivel de aislamiento, pero no garantiza seguridad absoluta**. En buenas pr√°cticas de an√°lisis de malware, se recomienda adem√°s:
- Usar instant√°neas para restaurar el estado limpio de la VM r√°pidamente.
- Mantener el host lo m√°s aislado posible y sin informaci√≥n sensible.
- Aplicar actualizaciones de seguridad tanto al host como al software de virtualizaci√≥n.
- Considerar el uso de entornos totalmente desconectados (‚Äúair-gapped‚Äù) para an√°lisis de malware de riesgo elevado.
- Cifrar discos duros para que no tengan acceso entre ellos para aislar plenamente el disco que tenga las funciones de lab.

