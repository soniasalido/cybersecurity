
```
‚îî‚îÄ$ pepack Lab_02-2.malware -d db_packer.txt                 
packer:                          Dev-C++ 4.9.9.2 -> Bloodshed Software
```   
  
- El binario fue compilado usando Dev-C++ 4.9.9.2, lo cual es un IDE que utiliza el compilador mingw32 de GCC para Windows.
- No est√° empaquetado con una herramienta tradicional de protecci√≥n de binarios.
- Puede tener ofuscaci√≥n a nivel de c√≥digo fuente o cifrado manual, pero no a nivel de empaquetado PE.
- El malware puede desencriptar datos o strings en tiempo de ejecuci√≥n, o tener sus funciones cifradas, pero no est√° comprimido/oculto con un packer PE.


### An√°lisis DIE

![](capturas/die-lab2.2.png)

üü° Informaci√≥n general:
```
Tipo: PE32 (ejecutable de 32 bits)
Modo: Consola
Compilador: MinGW (GCC)
Linker: GNU Bintutils (ld) v2.56
Lenguaje: C
```

üü• Indicadores sospechosos / heur√≠sticos:
- Heur/Empaquetar: Compressed or packed data (Strange overlay): El motor heur√≠stico de DIE detecta datos empaquetados o comprimidos, especialmente por la presencia de un overlay inusual.
- Overlay: Binary(Desplazamiento=0x2e00, Tama√±o=0x41b6):
  - Hay un overlay PE (datos que est√°n despu√©s del final de la √∫ltima secci√≥n PE).
  - Desplazamiento 0x2e00 (11.264 bytes)
  - Tama√±o 0x41b6 (16.694 bytes)

**Esto puede indicar datos cifrados o un payload embebido manualmente.**

üö© ¬øQu√© es un overlay en un binario PE?: Un overlay es una regi√≥n que no pertenece a ninguna secci√≥n PE leg√≠tima. Puede usarse para:
- Esconder payloads que ser√°n le√≠dos o desencriptados en tiempo de ejecuci√≥n.
- Evitar an√°lisis est√°tico directo, ya que no est√° cargado por el loader PE.
- Implementar un dropper o loader que desempaqueta c√≥digo a memoria.

**Extraer el overlay para analizarlo:**
```
dd if=Lab_02-2.malware of=overlay.bin bs=1 skip=11776 count=16790
(11776 = 0x2e00, 16790 = 0x41b6)
```

**Analizar el overlay extra√≠do:** Extraemos strings del fichero overlay.bin
- Buscamos encabezados (¬øes un archivo PE, ZIP, CAB, etc.?)

**Revisaremos el binario principal en Ghidra o IDA:**
- Buscamos llamadas a fopen, CreateFile, fread, ReadFile, memcpy, etc.
- F√≠jate si el binario lee el final de s√≠ mismo (overlay) ‚Üí eso confirmar√≠a que desencripta su contenido.

**Fichero overlay:**    
[overlay.cim](../muestra/overlay.txt)

El contenido parece una mezcla de:
- S√≠mbolos de depuraci√≥n
- Nombres de funciones y secciones PE
- S√≠mbolos de la CRT (C Runtime)
- Nombres de archivos fuente: main11.cpp, crtstuff.c, CRTfmode.c, etc.
- Funciones de inter√©s como:
  - __Z6MailItPcS_S_S_S_
  - __Z8get_keysv
  - gethostbyname@4
  - WSAStartup@8, socket@12, connect@12, send@16, recv@16, closesocket@4
  - GetAsyncKeyState@4
  - fopen, fread, fwrite, memcpy, malloc, free, etc.

**Conclusiones del overlay:**  
‚úÖ 1. No est√° comprimido ni cifrado: Aunque Detect It Easy marcaba "Compressed or packed data", esto era un falso positivo heur√≠stico. El contenido est√° en texto plano y es legible.  
‚úÖ 2. Contiene s√≠mbolos de depuraci√≥n: Estos s√≠mbolos normalmente se eliminan en malware real. Su presencia sugiere que es un binario de laboratorio educativo, como el que propone RPISEC en sus ejercicios.  
‚úÖ 3. Funciones personalizadas: Esto indica que hay alguna rutina criptogr√°fica personalizada que ser√° importante analizar.  
    - __Z6MailItPcS_S_S_S_: probable funci√≥n ofuscada o en C++ con nombre mangled.  
    - __Z8get_keysv: parece una funci√≥n que devuelve claves (probablemente de cifrado).  
‚úÖ 4. Actividad de red: Con las funciones como:  
    - WSAStartup, socket, connect, send, recv, closesocket  
    - ‚Ä¶es muy probable que el malware establezca una conexi√≥n con un servidor remoto (C2).  
‚úÖ 5. Keylogger potencial: La funci√≥n GetAsyncKeyState@4 sugiere registro de pulsaciones de teclado.  

---------------------------------------

### Conclusi√≥n del an√°lisis de red
| Funci√≥n	| Prop√≥sito |
| -- | -- |
| WSAStartup	| Inicializa stack Winsock |
| gethostbyname	| Resuelve dominio my.inbox.com |
| socket	| Crea socket TCP/IP |
| connect	| Conecta al puerto 25 del servidor SMTP |
| send	| Env√≠a comandos SMTP y el mensaje con informaci√≥n |
| recv	| Lee respuestas del servidor |
| closesocket	| Cierra el canal TCP tras el env√≠o |


-----------------------------------------

### An√°lisis de la muestra (overlay.txt)

| Categor√≠a	| Descripci√≥n |
|  -- | -- |
| Keylogger	| Usa GetAsyncKeyState para capturar teclas presionadas |
| Conexi√≥n a red	| Usa socket y connect (de WS2_32.dll) para comunicarse con C2 |
| Manipulaci√≥n de ventanas	| Usa FindWindowA y ShowWindow para ocultarse |
| Persistencia oculta	| Posible uso de √°tomos de sistema (AddAtomA, FindAtomA, GetAtomNameA) |
| Carga din√°mica	| Funciones jmp a IAT (Import Address Table) en USER32.dll, KERNEL32.dll, MSVCRT.dll |
| Encubrimiento	| Uso de Sleep para retrasar ejecuci√≥n, SetUnhandledExceptionFilter para trampas |


### Indicadores de comportamiento:
| Comportamiento |	Evidencia t√©cnica |
|  -- | -- |
| Keylogging b√°sico |	Llamada a GetAsyncKeyState dentro de get_keys |
| Comunicaci√≥n remota (C2) |	Llamadas a socket, connect |
| Registro persistente |	Uso de funciones relacionadas con √°tomos (AddAtomA, FindAtomA) |
| Antian√°lisis b√°sico |	Sleep, SetUnhandledExceptionFilter |
| Ocultamiento de consola |	ShowWindow(..., SW_HIDE) tras AllocConsole o FindWindowA |


### API Importadas de forma cr√≠tica

WS2_32.dll:

    socket, connect

KERNEL32.dll:

    AddAtomA, FindAtomA, GetAtomNameA

    Sleep, ExitProcess

    AllocConsole, SetUnhandledExceptionFilter

USER32.dll:

    FindWindowA, ShowWindow, GetAsyncKeyState

MSVCRT.dll:

    Funciones est√°ndar: fopen, fputs, fread, strcat, strlen, exit, abort, fprintf, malloc, free

üí£ Conclusi√≥n

Esta muestra es un malware tipo keylogger con capacidades de persistencia y comunicaci√≥n remota. Es altamente probable que tenga funcionalidad para:

    Registrar pulsaciones de teclas de forma continua.

    Guardarlas y enviarlas a un servidor remoto.

    Ocultarse de la vista del usuario.

    Usar Sleep y UnhandledExceptionFilter para evadir entornos de an√°lisis autom√°ticos.

    Emplear √°tomos para mantener estados o identificadores √∫nicos persistentes en el sistema (m√©todo poco com√∫n, pero eficaz para persistencia no convencional).
    
--------------------------------------------------------------------

üß† Funciones cr√≠ticas a analizar en detalle
üü† Inicio y preparaci√≥n

    _main (004012b5)

        Punto de entrada principal. Ejecuta toda la l√≥gica maliciosa.

        Llama a:

            ___main (setup)

            AllocConsole, FindWindowA, ShowWindow

            Funciones propias como get_keys, MailIt.

    ___main (00402330)

        Se asegura de que los constructores globales se ejecuten una sola vez.

        Registra ___do_global_dtors con atexit.

    ___mingw_CRTStartup

        Configura entorno de ejecuci√≥n de MinGW, llama a mainCRTStartup, establece SetUnhandledExceptionFilter.

üü£ Keylogger

    get_keys

        Usa GetAsyncKeyState para capturar pulsaciones.

        Filtra y formatea teclas especiales (ENTER, SHIFT, CTRL, etc.).

        Guarda logs y probablemente llama a funciones para enviarlos.

üîµ Exfiltraci√≥n / Comunicaci√≥n con el atacante

    MailIt

        Llama repetidamente a Sleep, connect, send, recv.

        Posible env√≠o de datos por red (C2, correo falso o conexi√≥n TCP directa).

        Usa strings como unknown-g@hotmail.co.uk, my.inbox.com.

    Funciones relacionadas a sockets:

        WSAStartup, socket, connect, send, recv, closesocket, WSACleanup

        Estas se usan en MailIt u otra funci√≥n C2.

üü° Gesti√≥n de errores y mensajes

    ___eprintf

        Redirige errores a MSVCRT::_iob + 0x40 (stderr).

        Llama a fprintf, fflush, y termina con abort.

        No suele ser clave, pero puede usarse como anti-debug si el malware quiere autodestruirse ante errores.

üü¢ Carga, persistencia o t√©cnicas de evasi√≥n

    __alloca y ___chkstk

        Usados para manipulaci√≥n manual de la pila.

        Puede ser parte de t√©cnicas anti-an√°lisis o para evadir detecci√≥n.

    _SetUnhandledExceptionFilter@4

        Evita que el malware se caiga en caso de errores ‚Äî t√≠pico en malware para ocultar fallos.

‚öôÔ∏è Inicializaci√≥n autom√°tica del binario

    ___do_global_ctors / ___do_global_dtors

        Ejecutan funciones en arrays tipo .ctors y .dtors.

        Suelen usarse para que el c√≥digo malicioso se ejecute antes/despu√©s del main.

‚úÖ Recomendaci√≥n de an√°lisis

Para entender el malware en profundidad, sigue este orden:

    main ‚Üí qu√© hace y a qui√©n llama.

    get_keys ‚Üí qu√© captura, c√≥mo lo guarda o env√≠a.

    MailIt ‚Üí si env√≠a los logs por red, a qu√© IP o dominio.

    ___main / ___do_global_ctors ‚Üí inicializaciones ocultas.

    Todas las llamadas a API de red (Winsock).

    Uso de __alloca, Sleep, SetUnhandledExceptionFilter ‚Üí posibles evasiones.

    Strings relacionadas con logs, rutas de archivos, correo, etc.
    
----------------------------------
![grafo](capturas/grafo.png)

üß† Funciones a analizar en detalle:
1. main

    Punto de entrada del malware.

    Llama a ___main, AllocConsole, FindWindowA, ShowWindow, get_keys, y MailIt.

2. get_keys

    Usa GetAsyncKeyState para capturar teclas.

    Guarda la informaci√≥n en archivo usando funciones como fopen, fputs o fprintf.

    Clave para identificar funcionalidad de keylogger.

3. MailIt

    Encargada de enviar datos capturados:

        Usa WSAStartup, socket, connect, send, recv, closesocket, WSACleanup, Sleep.

        Implementa comunicaci√≥n de red con el atacante (probable C2).

    Muy relevante para detectar exfiltraci√≥n de datos.

4. ___main

    Ejecuta constructores y registra destructores (atexit).

    Necesaria para entender el setup del runtime y ejecuci√≥n de c√≥digo est√°tico.

5. ___eprintf

    Env√≠a errores a stderr y luego ejecuta abort.

    Puede actuar como mecanismo de protecci√≥n o se√±al de fallo deliberado.

6. __alloca / ___chkstk

    Gestionan el stack manualmente.

    Pueden ser usadas para evasi√≥n o protecci√≥n, aunque aqu√≠ parecen parte de runtime est√°ndar MinGW.

üïµÔ∏è‚Äç‚ôÄÔ∏è Sugerencia de orden de an√°lisis:

    main

    get_keys

    MailIt

    ___main

    ___eprintf

    __alloca
    
------------------
