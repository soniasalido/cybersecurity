```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined __stdcall entry(void)
                               assume FS_OFFSET = 0xffdff000
             undefined         <UNASSIGNED>   <RETURN>
             undefined4        Stack[-0x28]:4 local_28                                XREF[2]:     0040b0c1(*),1.
                                                                                                   0040b0d7(*)
             undefined1        Stack[-0x80]:1 local_80                                XREF[1]:     0040b0df(*)
                             entry                                           XREF[2]:     Entry Point(*), 00400118(*)
        0040af60 60              PUSHAD
        0040af61 be 00 80        MOV        ESI,DAT_00408000                                 = FFFFFF6Dh
                 40 00
        0040af66 8d be 00        LEA        EDI,[ESI + 0xffff9000]=>DAT_00401000             = ??
                 90 ff ff
        0040af6c 57              PUSH       EDI=>DAT_00401000                                = ??
        0040af6d eb 0b           JMP        LAB_0040af7a
        0040af6f 90              ??         90h
                             LAB_0040af70                                    XREF[1]:     0040af81(j)
        0040af70 8a 06           MOV        AL,byte ptr [ESI]=>DAT_00408004                  = 55h
        0040af72 46              INC        ESI
        0040af73 88 07           MOV        byte ptr [EDI]=>DAT_00401000,AL                  = ??
        0040af75 47              INC        EDI
                             LAB_0040af76                                    XREF[2]:     0040b00e(j), 0040b025(j)
        0040af76 01 db           ADD        EBX,EBX
        0040af78 75 07           JNZ        LAB_0040af81
                             LAB_0040af7a                                    XREF[1]:     0040af6d(j)
        0040af7a 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_00408000                = FFFFFF6Dh
                                                                                             = F67FB54Dh
        0040af7c 83 ee fc        SUB        ESI,-0x4
        0040af7f 11 db           ADC        EBX,EBX
                             LAB_0040af81                                    XREF[1]:     0040af78(j)
        0040af81 72 ed           JC         LAB_0040af70
        0040af83 b8 01 00        MOV        EAX,0x1
                 00 00
                             LAB_0040af88                                    XREF[2]:     0040af97(j), 0040afa2(j)
        0040af88 01 db           ADD        EBX,EBX
        0040af8a 75 07           JNZ        LAB_0040af93
        0040af8c 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_00408004                = 55h
        0040af8e 83 ee fc        SUB        ESI,-0x4
        0040af91 11 db           ADC        EBX,EBX
                             LAB_0040af93                                    XREF[1]:     0040af8a(j)
        0040af93 11 c0           ADC        EAX,EAX
        0040af95 01 db           ADD        EBX,EBX
        0040af97 73 ef           JNC        LAB_0040af88
        0040af99 75 09           JNZ        LAB_0040afa4
        0040af9b 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_00408008                = 3308458Bh
        0040af9d 83 ee fc        SUB        ESI,-0x4
        0040afa0 11 db           ADC        EBX,EBX
        0040afa2 73 e4           JNC        LAB_0040af88
                             LAB_0040afa4                                    XREF[1]:     0040af99(j)
        0040afa4 31 c9           XOR        ECX,ECX
        0040afa6 83 e8 03        SUB        EAX,0x3
        0040afa9 72 0d           JC         LAB_0040afb8
        0040afab c1 e0 08        SHL        EAX,0x8
        0040afae 8a 06           MOV        AL,byte ptr [ESI]=>DAT_0040800c                  = C9h
        0040afb0 46              INC        ESI
        0040afb1 83 f0 ff        XOR        EAX,0xffffffff
        0040afb4 74 74           JZ         LAB_0040b02a
        0040afb6 89 c5           MOV        EBP,EAX
                             LAB_0040afb8                                    XREF[1]:     0040afa9(j)
        0040afb8 01 db           ADD        EBX,EBX
        0040afba 75 07           JNZ        LAB_0040afc3
        0040afbc 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_0040800d                = F9C1088Ah
        0040afbe 83 ee fc        SUB        ESI,-0x4
        0040afc1 11 db           ADC        EBX,EBX
                             LAB_0040afc3                                    XREF[1]:     0040afba(j)
        0040afc3 11 c9           ADC        ECX,ECX
        0040afc5 01 db           ADD        EBX,EBX
        0040afc7 75 07           JNZ        LAB_0040afd0
        0040afc9 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_00408011                = 0C558B02h
        0040afcb 83 ee fc        SUB        ESI,-0x4
        0040afce 11 db           ADC        EBX,EBX
                             LAB_0040afd0                                    XREF[1]:     0040afc7(j)
        0040afd0 11 c9           ADC        ECX,ECX
        0040afd2 75 20           JNZ        LAB_0040aff4
        0040afd4 41              INC        ECX
                             LAB_0040afd5                                    XREF[2]:     0040afe4(j), 0040afef(j)
        0040afd5 01 db           ADD        EBX,EBX
        0040afd7 75 07           JNZ        LAB_0040afe0
        0040afd9 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_00408015                = 50E8818Ah
        0040afdb 83 ee fc        SUB        ESI,-0x4
        0040afde 11 db           ADC        EBX,EBX
                             LAB_0040afe0                                    XREF[1]:     0040afd7(j)
        0040afe0 11 c9           ADC        ECX,ECX
        0040afe2 01 db           ADD        EBX,EBX
        0040afe4 73 ef           JNC        LAB_0040afd5
        0040afe6 75 09           JNZ        LAB_0040aff1
        0040afe8 8b 1e           MOV        EBX,dword ptr [ESI]=>DAT_00408019                = 0A880040h
        0040afea 83 ee fc        SUB        ESI,-0x4
        0040afed 11 db           ADC        EBX,EBX
        0040afef 73 e4           JNC        LAB_0040afd5
                             LAB_0040aff1                                    XREF[1]:     0040afe6(j)
        0040aff1 83 c1 02        ADD        ECX,0x2
                             LAB_0040aff4                                    XREF[1]:     0040afd2(j)
        0040aff4 81 fd 00        CMP        EBP,0xfffff300
                 f3 ff ff
        0040affa 83 d1 01        ADC        ECX,0x1
        0040affd 8d 14 2f        LEA        EDX,[EDI + EBP*0x1]=>DAT_00401036                = ??
        0040b000 83 fd fc        CMP        EBP,-0x4
        0040b003 76 0f           JBE        LAB_0040b014
                             LAB_0040b005                                    XREF[1]:     0040b00c(j)
        0040b005 8a 02           MOV        AL,byte ptr [EDX]=>DAT_00401036                  = ??
        0040b007 42              INC        EDX
        0040b008 88 07           MOV        byte ptr [EDI]=>DAT_00401000,AL                  = ??
        0040b00a 47              INC        EDI
        0040b00b 49              DEC        ECX
        0040b00c 75 f7           JNZ        LAB_0040b005
        0040b00e e9 63 ff        JMP        LAB_0040af76
                 ff ff
        0040b013 90              ??         90h
                             LAB_0040b014                                    XREF[2]:     0040b003(j), 0040b021(j)
        0040b014 8b 02           MOV        EAX,dword ptr [EDX]=>DAT_00401036                = ??
        0040b016 83 c2 04        ADD        EDX,0x4
        0040b019 89 07           MOV        dword ptr [EDI]=>DAT_00401000,EAX                = ??
        0040b01b 83 c7 04        ADD        EDI,0x4
        0040b01e 83 e9 04        SUB        ECX,0x4
        0040b021 77 f1           JA         LAB_0040b014
        0040b023 01 cf           ADD        EDI,ECX
        0040b025 e9 4c ff        JMP        LAB_0040af76
                 ff ff
                             LAB_0040b02a                                    XREF[1]:     0040afb4(j)
        0040b02a 5e              POP        ESI
        0040b02b 89 f7           MOV        EDI,ESI
        0040b02d b9 d9 00        MOV        ECX,0xd9
                 00 00
                             LAB_0040b032                                    XREF[2]:     0040b039(j), 0040b03e(j)
        0040b032 8a 07           MOV        AL,byte ptr [EDI]=>DAT_00401000                  = ??
        0040b034 47              INC        EDI
        0040b035 2c e8           SUB        AL,0xe8
                             LAB_0040b037                                    XREF[1]:     0040b05c(j)
        0040b037 3c 01           CMP        AL,0x1
        0040b039 77 f7           JA         LAB_0040b032
        0040b03b 80 3f 07        CMP        byte ptr [EDI]=>DAT_00401001,0x7                 = ??
        0040b03e 75 f2           JNZ        LAB_0040b032
        0040b040 8b 07           MOV        EAX,dword ptr [EDI]=>DAT_00401001                = ??
        0040b042 8a 5f 04        MOV        BL,byte ptr [EDI + 0x4]=>DAT_00401005            = ??
        0040b045 66 c1 e8 08     SHR        AX,0x8
        0040b049 c1 c0 10        ROL        EAX,0x10
        0040b04c 86 c4           XCHG       AH,AL
        0040b04e 29 f8           SUB        EAX,EDI
        0040b050 80 eb e8        SUB        BL,0xe8
        0040b053 01 f0           ADD        EAX,ESI
        0040b055 89 07           MOV        dword ptr [EDI]=>DAT_00401001,EAX                = ??
        0040b057 83 c7 05        ADD        EDI,0x5
        0040b05a 88 d8           MOV        AL,BL
        0040b05c e2 d9           LOOP       LAB_0040b037
        0040b05e 8d be 00        LEA        EDI,[ESI + 0x8000]=>DAT_00409000                 = 6D7D3941h
                 80 00 00
                             LAB_0040b064                                    XREF[1]:     0040b086(j)
        0040b064 8b 07           MOV        EAX,dword ptr [EDI]=>DAT_00409000                = 6D7D3941h
                                                                                             = 8D220178h
        0040b066 09 c0           OR         EAX,EAX
        0040b068 74 45           JZ         LAB_0040b0af
        0040b06a 8b 5f 04        MOV        EBX,dword ptr [EDI + 0x4]=>DAT_00409004          = 51BED681h
        0040b06d 8d 84 30        LEA        EAX,[EAX + ESI*0x1 + 0xb058]
                 58 b0 00 00
        0040b074 01 f3           ADD        EBX,ESI
        0040b076 50              PUSH       EAX
        0040b077 83 c7 08        ADD        EDI,0x8
        0040b07a ff 96 a8        CALL       dword ptr [ESI + 0xb0a8]=>KERNEL32.DLL::LoadLi
                 b0 00 00
        0040b080 95              XCHG       EAX,EBP
                             LAB_0040b081                                    XREF[1]:     0040b0a7(j)
        0040b081 8a 07           MOV        AL,byte ptr [EDI]=>DAT_00409008                  = 81h
        0040b083 47              INC        EDI
        0040b084 08 c0           OR         AL,AL
        0040b086 74 dc           JZ         LAB_0040b064
        0040b088 89 f9           MOV        ECX,EDI
        0040b08a 79 07           JNS        LAB_0040b092+1
        0040b08c 0f b7 07        MOVZX      EAX,word ptr [EDI]=>DAT_00409009                 = 8D220178h
        0040b08f 47              INC        EDI
        0040b090 50              PUSH       EAX
        0040b091 47              INC        EDI
                             LAB_0040b092+1                                  XREF[0,1]:   0040b08a(j)
        0040b092 b9 57 48        MOV        ECX,0xaef24857
                 f2 ae
        0040b097 55              PUSH       EBP
        0040b098 ff 96 ac        CALL       dword ptr [ESI + 0xb0ac]=>KERNEL32.DLL::GetPro
                 b0 00 00
        0040b09e 09 c0           OR         EAX,EAX
        0040b0a0 74 07           JZ         LAB_0040b0a9
        0040b0a2 89 03           MOV        dword ptr [EBX]=>DAT_51fee681,EAX
        0040b0a4 83 c3 04        ADD        EBX,0x4
        0040b0a7 eb d8           JMP        LAB_0040b081
                             LAB_0040b0a9                                    XREF[1]:     0040b0a0(j)
        0040b0a9 ff 96 bc        CALL       dword ptr [ESI + 0xb0bc]=>KERNEL32.DLL::ExitPr
                 b0 00 00
                             -- Flow Override: CALL_RETURN (COMPUTED_CALL_TERMINATOR)
                             LAB_0040b0af                                    XREF[1]:     0040b068(j)
        0040b0af 8b ae b0        MOV        EBP,dword ptr [ESI + 0xb0b0]=>->KERNEL32.DLL::   = 0000c116
                 b0 00 00
        0040b0b5 8d be 00        LEA        EDI,[ESI + 0xfffff000]=>IMAGE_DOS_HEADER_00400
                 f0 ff ff
        0040b0bb bb 00 10        MOV        EBX,0x1000
                 00 00
        0040b0c0 50              PUSH       EAX
        0040b0c1 54              PUSH       ESP=>local_28
        0040b0c2 6a 04           PUSH       0x4
        0040b0c4 53              PUSH       EBX
        0040b0c5 57              PUSH       EDI=>IMAGE_DOS_HEADER_00400000
        0040b0c6 ff d5           CALL       EBP=>KERNEL32.DLL::VirtualProtect
        0040b0c8 8d 87 0f        LEA        EAX,[EDI + offset IMAGE_SECTION_HEADER_004001e
                 02 00 00
        0040b0ce 80 20 7f        AND        byte ptr [EAX]=>IMAGE_SECTION_HEADER_004001e8.
        0040b0d1 80 60 28 7f     AND        byte ptr [EAX + 0x28]=>IMAGE_SECTION_HEADER_00
        0040b0d5 58              POP        EAX
        0040b0d6 50              PUSH       EAX
        0040b0d7 54              PUSH       ESP=>local_28
        0040b0d8 50              PUSH       EAX
        0040b0d9 53              PUSH       EBX
        0040b0da 57              PUSH       EDI=>IMAGE_DOS_HEADER_00400000
        0040b0db ff d5           CALL       EBP=>KERNEL32.DLL::VirtualProtect
        0040b0dd 58              POP        EAX
        0040b0de 61              POPAD
        0040b0df 8d 44 24 80     LEA        EAX=>local_80,[ESP + -0x80]
                             LAB_0040b0e3                                    XREF[1]:     0040b0e7(j)
        0040b0e3 6a 00           PUSH       0x0
        0040b0e5 39 c4           CMP        ESP,EAX
        0040b0e7 75 fa           JNZ        LAB_0040b0e3
        0040b0e9 83 ec 80        SUB        ESP,-0x80
        0040b0ec e9 90 65        JMP        LAB_00401681
                 ff ff
        0040b0f1 00 00 00        align      align(3855)
                 00 00 00
                 00 00 00

```

✅ ¿Dónde estás?

Estás en el código desempaquetador justo antes de saltar al código real del binario (el OEP).
🔍 Línea clave:

```
0040b0ec e9 90 65 ff ff     JMP LAB_00401681
```

Esto es un salto incondicional (JMP) a 0x00401681, que será el punto de entrada original (OEP) del programa ya desempaquetado.
🧠 ¿Qué ocurre justo antes de ese salto?
```
0040b0dd 58              POP        EAX
0040b0de 61              POPAD                      ← ← ← ¡Aquí está!
0040b0df 8d 44 24 80     LEA        EAX,[ESP - 0x80]
...
0040b0ec E9 9065FFFF     JMP        0x00401681       ← ← ← SALTO AL OEP
```

El POPAD indica que restaura los registros salvados al principio con PUSHAD, y el JMP transfiere el control al programa real desempaquetado.
✅ Conclusión: ¡Has encontrado el OEP!

    La dirección del OEP es: 0x00401681

    Este es el código ya desempaquetado.

    Aquí es donde debes hacer el dump de memoria.


____________________________

## 🔍 FUNCIÓN entry() — Análisis estructurado
### 🟦 1. Desempaquetado en memoria (decrypted copy)
```
0040af60  PUSHAD
0040af61  MOV ESI, DAT_00408000       ; puntero al bloque de datos comprimido
0040af66  LEA EDI, [ESI - 0x7000]     ; destino donde se va a copiar/expandir
...
0040af70–0040b02a                     ; bucle complejo de descompresión
```
    Esta parte descomprime o copia el código malicioso real desde ESI a EDI, usando un algoritmo tipo LZ o RLE (con muchos ADC, MOV, JNZ, etc.).

    El código se desempaqueta dinámicamente y se coloca en una zona de memoria RWX.

### 🟨 2. Decodificación de punteros y reubicaciones
```
0040b02a  POP ESI
0040b02b  MOV EDI, ESI
...
0040b037–0040b05c ; bucle que manipula punteros en el área desempaquetada
```
    Se corrigen direcciones relativas, posiblemente para funciones API importadas manualmente.

    Usa cálculos complejos sobre punteros y direcciones relativas → indica unloader manual o loader que prepara llamadas a funciones externas.

### 🟩 3. Resolución de APIs (carga de DLLs + funciones)
```
0040b064–0040b0a9
```
→ Lee nombres como "KERNEL32.DLL", "LoadLibraryA", "GetProcAddress"
→ Usa llamadas a funciones ya resueltas (por dirección indirecta)

    Este bloque implementa un "resolver manual": carga dinámicamente DLLs (como KERNEL32.DLL, WININET.DLL) y obtiene punteros a funciones clave.

    Evita usar la IAT tradicional → técnica anti-análisis muy común.

### 🟥 4. Limpieza de memoria, restauración del entorno y salto al payload
```
0040b0af–0040b0ec
```
→ Cambia protecciones con `VirtualProtect`
→ Limpia la stack
→ POPAD (restaura registros)
→ JMP 00401681 ; salto al payload real

Este bloque:
- Restaura permisos de memoria (probablemente para quitar RWX).
- Limpia la pila para evitar rastros.
- Usa JMP para transferir ejecución al código real del malware: FUN_00401681.


### 🎯 CONCLUSIÓN: ¿Qué hace la función entry()?
| Etapa	 | Función |
| -- | -- |
| Desempaquetado	| Copia y/o descomprime el cuerpo real del malware |
| Reubicación interna	| Corrige direcciones y punteros en tiempo de ejecución |
| Resolución API	| Carga dinámicamente DLLs y obtiene funciones con LoadLibrary y GetProcAddress |
| Salto al payload	| Transfiere el control al binario real desempaquetado (00401681) |

Es un stub loader clásico con capacidades anti-análisis.
