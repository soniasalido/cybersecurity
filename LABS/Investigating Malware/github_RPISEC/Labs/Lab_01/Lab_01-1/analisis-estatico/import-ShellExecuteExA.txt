[0x00401431]> ii~ShellExecuteExA
1   0x004020d4 NONE FUNC SHELL32.dll  ShellExecuteExA
[0x00401431]> axt 0x004020d4
fcn.00401b50 0x401c51 [CALL:--x] call dword [sym.imp.SHELL32.dll_ShellExecuteExA]
[0x00401431]> s 0x401c51
[0x00401c51]> pd20
â”‚           0x00401c51      ff15d4204000   call dword [sym.imp.SHELL32.dll_ShellExecuteExA] ; 0x4020d4 ; "\n%" ; BOOL ShellExecuteExA(SHELLEXECUTEINFOA *pExecInfo)
â”‚           0x00401c57      85c0           test eax, eax
â”‚       â”Œâ”€< 0x00401c59      7437           je 0x401c92
â”‚       â”‚   0x00401c5b      8b542448       mov edx, dword [var_48h]
â”‚       â”‚   0x00401c5f      6a40           push 0x40                   ; '@' ; 64
â”‚       â”‚   0x00401c61      52             push edx
â”‚       â”‚   0x00401c62      ffd6           call esi
â”‚       â”‚   0x00401c64      8b442448       mov eax, dword [var_2ch]
â”‚       â”‚   0x00401c68      6a01           push 1                      ; 1 ; BOOL bDisablePriorityBoost
â”‚       â”‚   0x00401c6a      50             push eax                    ; HANDLE hProcess
â”‚       â”‚   0x00401c6b      ff154c204000   call dword [sym.imp.KERNEL32.dll_SetProcessPriorityBoost] ; 0x40204c ; BOOL SetProcessPriorityBoost(HANDLE hProcess, BOOL bDisablePriorityBoost)
â”‚       â”‚   0x00401c71      8d4c244c       lea ecx, [var_28h]
â”‚       â”‚   0x00401c75      6a00           push 0
â”‚       â”‚   0x00401c77      51             push ecx                    ; LPCVOID dwItem1
â”‚       â”‚   0x00401c78      6a01           push 1                      ; 1 ; ChangeNotifyFlags uFlags
â”‚       â”‚   0x00401c7a      6a04           push 4                      ; 4 ; ChangeNotifyEventId wEventId
â”‚       â”‚   0x00401c7c      ff15d8204000   call dword [sym.imp.SHELL32.dll_SHChangeNotify] ; 0x4020d8 ; void SHChangeNotify(ChangeNotifyEventId wEventId, ChangeNotifyFlags uFlags, LPCVOID dwItem1, LPCVOID dwItem2)
â”‚       â”‚   0x00401c82      5f             pop edi
â”‚       â”‚   0x00401c83      5e             pop esi
â”‚       â”‚   0x00401c84      5d             pop ebp
[0x00401c51]>


estÃ¡ utilizando ShellExecuteExA, una funciÃ³n tÃ­pica para lanzar procesos o abrir archivos, lo que suele estar asociado a actividad maliciosa, especialmente cuando:

    Se lanza un archivo descargado.

    Se oculta la consola.

    Se pasa una URL maliciosa o archivo auxiliar.

ðŸ§  Â¿QuÃ© es ShellExecuteExA?

BOOL ShellExecuteExA(SHELLEXECUTEINFOA *pExecInfo);

Lanza un proceso o archivo a travÃ©s de una estructura SHELLEXECUTEINFO. Esta estructura permite especificar el ejecutable, argumentos, si la ventana debe ser oculta, etc.
ðŸ§© Â¿QuÃ© estÃ¡ haciendo este cÃ³digo?

AquÃ­ tienes el desglose del flujo que empieza en 0x00401c51:

0x00401c51      call [ShellExecuteExA]   ; llamada clave
0x00401c57      test eax, eax            ; Â¿la llamada fue exitosa?
0x00401c59      je 0x401c92              ; si falla, salta

âœ… Si la llamada fue exitosa:

0x00401c5b      mov edx, [var_48h]       ; obtiene algo (posible handle)
0x00401c5f      push 0x40
0x00401c61      push edx
0x00401c62      call esi                 ; llamada indirecta sospechosa

    ðŸ§¨ AquÃ­ esi contiene una direcciÃ³n de funciÃ³n configurada previamente. Si el malware cargÃ³ cÃ³digo malicioso, puede estar llamando a su propia rutina.

Luego, cambia propiedades del proceso lanzado:

0x00401c64      mov eax, [var_2ch]       ; posible handle del proceso hijo
0x00401c68      push 1
0x00401c6a      push eax
0x00401c6b      call [SetProcessPriorityBoost]

Y notifica cambios al sistema (esto suele usarse para forzar actualizaciones visuales, ocultar iconos, etc.):

0x00401c75      push 0
0x00401c77      push ecx
0x00401c78      push 1
0x00401c7a      push 4
0x00401c7c      call [SHChangeNotify]

---------------------------------------
ðŸ“ Paso 1: Desensamblar instrucciones anteriores


[0x00401c51]> pd -40 @ 0x00401c51
â”‚           0x00401baa      85c0           test eax, eax
â”‚       â”Œâ”€< 0x00401bac      0f84ee000000   je 0x401ca0
â”‚       â”‚   0x00401bb2      8d8c245001..   lea ecx, [var_150h]
â”‚       â”‚   0x00401bb9      6888304000     push str._c_del             ; 0x403088 ; "/c del "
â”‚       â”‚   0x00401bbe      51             push ecx                    ; LPSTR lpString1
â”‚       â”‚   0x00401bbf      ff1560204000   call dword [sym.imp.KERNEL32.dll_lstrcpyA] ; 0x402060 ; LPSTR lstrcpyA(LPSTR lpString1, LPCSTR lpString2)
â”‚       â”‚   0x00401bc5      8b355c204000   mov esi, dword [sym.imp.KERNEL32.dll_lstrcatA] ; [0x40205c:4]=0x2474 reloc.KERNEL32.dll_lstrcatA ; "t$"
â”‚       â”‚   0x00401bcb      8d54244c       lea edx, [var_4ch_2]
â”‚       â”‚   0x00401bcf      8d84245001..   lea eax, [var_150h_2]
â”‚       â”‚   0x00401bd6      52             push edx
â”‚       â”‚   0x00401bd7      50             push eax
â”‚       â”‚   0x00401bd8      ffd6           call esi
â”‚       â”‚   0x00401bda      8d8c245001..   lea ecx, [var_150h_3]
â”‚       â”‚   0x00401be1      6880304000     push str.___nul             ; 0x403080 ; " > nul"
â”‚       â”‚   0x00401be6      51             push ecx
â”‚       â”‚   0x00401be7      ffd6           call esi
â”‚       â”‚   0x00401be9      897c2418       mov dword [var_18h], edi
â”‚       â”‚   0x00401bed      8d94245402..   lea edx, [var_254h_2]
â”‚       â”‚   0x00401bf4      8d84245001..   lea eax, [var_150h_4]
â”‚       â”‚   0x00401bfb      897c2428       mov dword [var_28h], edi
â”‚       â”‚   0x00401bff      897c242c       mov dword [var_2ch], edi
â”‚       â”‚   0x00401c03      8b3d38204000   mov edi, dword [sym.imp.KERNEL32.dll_GetCurrentProcess] ; [0x402038:4]=0x23d6 reloc.KERNEL32.dll_GetCurrentProcess
â”‚       â”‚   0x00401c09      6800010000     push 0x100                  ; 256
â”‚       â”‚   0x00401c0e      c74424143c..   mov dword [var_14h], 0x3c   ; '<'
â”‚       â”‚                                                              ; [0x3c:4]=-1 ; 60
â”‚       â”‚   0x00401c16      c744242078..   mov dword [var_20h], str.Open ; [0x403078:4]=0x6e65704f ; "Open"
â”‚       â”‚   0x00401c1e      89542424       mov dword [var_24h], edx
â”‚       â”‚   0x00401c22      89442428       mov dword [var_28h_2], eax
â”‚       â”‚   0x00401c26      c744241840..   mov dword [var_18h_2], 0x40 ; '@'
â”‚       â”‚                                                              ; [0x40:4]=-1 ; 64
â”‚       â”‚   0x00401c2e      ffd7           call edi
â”‚       â”‚   0x00401c30      8b3558204000   mov esi, dword [sym.imp.KERNEL32.dll_SetPriorityClass] ; [0x402058:4]=0x2460 reloc.KERNEL32.dll_SetPriorityClass ; "`$"
â”‚       â”‚   0x00401c36      50             push eax
â”‚       â”‚   0x00401c37      ffd6           call esi
â”‚       â”‚   0x00401c39      8b1d54204000   mov ebx, dword [sym.imp.KERNEL32.dll_GetCurrentThread] ; [0x402054:4]=0x244c reloc.KERNEL32.dll_GetCurrentThread ; "L$"
â”‚       â”‚   0x00401c3f      6a0f           push 0xf                    ; 15
â”‚       â”‚   0x00401c41      ffd3           call ebx
â”‚       â”‚   0x00401c43      8b2d50204000   mov ebp, dword [sym.imp.KERNEL32.dll_SetThreadPriority] ; [0x402050:4]=0x2438 reloc.KERNEL32.dll_SetThreadPriority ; "8$"
â”‚       â”‚   0x00401c49      50             push eax
â”‚       â”‚   0x00401c4a      ffd5           call ebp
â”‚       â”‚   0x00401c4c      8d4c2410       lea ecx, [var_10h]
â”‚       â”‚   0x00401c50      51             push ecx                    ; SHELLEXECUTEINFOA *pExecInfo



ðŸ§  Resumen general del bloque de cÃ³digo

Este fragmento estÃ¡ construyendo una cadena con:

/c del [archivo] > nul

Y la pasa a ShellExecuteExA, con el verbo "open". Esto significa que probablemente estÃ¡ usando cmd.exe para eliminar un archivo de forma silenciosa, redirigiendo la salida a nul.
ðŸ” AnÃ¡lisis lÃ­nea a lÃ­nea
1. ComposiciÃ³n de la cadena de comandos

0x00401bb9  push str._c_del         ; "/c del "
0x00401bbe  push ecx                ; destino
call lstrcpyA

â†’ Copia "/c del " a var_150h.

lea edx, [var_4ch_2]                ; probablemente contiene el archivo a borrar
lea eax, [var_150h_2]              ; string destino
call lstrcatA                      ; concatena el nombre del archivo

push str.___nul                    ; " > nul"
push ecx                           ; destino
call lstrcatA                      ; concatena para ocultar salida

âž¡ Resultado final: algo como
/c del C:\ruta\archivo.ext > nul
2. ConstrucciÃ³n de estructura SHELLEXECUTEINFOA

mov [var_14h], 0x3c                ; cbSize = 60
mov [var_20h], str.Open            ; lpVerb = "Open"
mov [var_24h], edx                 ; lpFile = "cmd.exe"
mov [var_28h], eax                 ; lpParameters = "/c del archivo > nul"
mov [var_18h], 0x40                ; nShow = SW_HIDE (64)

Y luego:

lea ecx, [var_10h]   ; puntero a SHELLEXECUTEINFOA
push ecx
call ShellExecuteExA

ðŸ”¥ Â¿QuÃ© estÃ¡ haciendo el malware?

Ejecuta:

cmd.exe /c del [archivo] > nul

Con la API ShellExecuteExA usando los siguientes parÃ¡metros:

    lpVerb: "open"

    lpFile: "cmd.exe"

    lpParameters: "/c del archivo.ext > nul"

    nShow: SW_HIDE â†’ Oculta la consola


-------------------
ðŸ§ª Â¿QuÃ© puedes hacer a continuaciÃ³n?

Inspeccionar var_4ch_2 â†’ Contiene el archivo a eliminar.

[0x00401c51]> px 64 @ esp+0x4c
- offset -  4C4D 4E4F 5051 5253 5455 5657 5859 5A5B  CDEF0123456789AB
0x0017804c  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x0017805c  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x0017806c  0000 0000 0000 0000 0000 0000 0000 0000  ................
0x0017807c  0000 0000 0000 0000 0000 0000 0000 0000  ................
[0x00401c51]>

actualmente la direcciÃ³n donde se espera que estÃ© la ruta del archivo a borrar ([esp+0x4c] â†’ es var_4ch_2) estÃ¡ vacÃ­a, llena de ceros.
ðŸ§  Â¿QuÃ© significa esto?

    El malware construye la cadena /c del [archivo] > nul, pero el nombre del archivo a eliminar no estÃ¡ definido en este momento, al menos en esa ejecuciÃ³n concreta.

    Puede ser que:

        El valor de var_4ch_2 se asigna mÃ¡s adelante, despuÃ©s de este fragmento.

        El valor lo rellena dinÃ¡micamente en tiempo de ejecuciÃ³n (por ejemplo, copiando el path del binario, o descargando un nombre desde la red).

        El binario estÃ¡ corrupto o parcialmente empaquetado, y aÃºn no se ha descomprimido/desempaquetado del todo en memoria.


-----------------------
âœ… PrÃ³ximos pasos sugeridos:

    Buscar asignaciones a var_4ch_2 (offset [esp+0x4c]):
    En Radare2:

agf esp+0x4c

[0x00401c51]> agf esp+0x4c
                                                                                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                                                 â”‚  0x401b50                                                                  â”‚
                                                                                                                 â”‚   ; CALL XREFS from fcn.00401320 @ 0x401421(x), 0x4015d0(x)                â”‚
                                                                                                                 â”‚   ; CALL XREF from fcn.00401600 @ +0x248(x)                                â”‚
                                                                                                                 â”‚ 349: fcn.00401b50 ();                                                      â”‚
                                                                                                                 â”‚ afv: vars(19:sp[0x11c..0x394])                                             â”‚
                                                                                                                 â”‚ sub esp, 0x348                                                             â”‚
                                                                                                                 â”‚ lea eax, [var_3ch]                                                         â”‚
                                                                                                                 â”‚ push ebx                                                                   â”‚
                                                                                                                 â”‚ push ebp                                                                   â”‚
                                                                                                                 â”‚ push esi                                                                   â”‚
                                                                                                                 â”‚ push edi                                                                   â”‚
                                                                                                                 â”‚ ; DWORD nSize                                                              â”‚
                                                                                                                 â”‚ ; 260                                                                      â”‚
                                                                                                                 â”‚ push 0x104                                                                 â”‚
                                                                                                                 â”‚ xor edi, edi                                                               â”‚
                                                                                                                 â”‚ ; LPSTR lpFilename                                                         â”‚
                                                                                                                 â”‚ push eax                                                                   â”‚
                                                                                                                 â”‚ ; HMODULE hModule                                                          â”‚
                                                                                                                 â”‚ push edi                                                                   â”‚
                                                                                                                 â”‚ ; 0x40206c                                                                 â”‚
                                                                                                                 â”‚ ; DWORD GetModuleFileNameA(HMODULE hModule, LPSTR lpFilename, DWORD nSize) â”‚
                                                                                                                 â”‚ call dword [sym.imp.KERNEL32.dll_GetModuleFileNameA];[oa]                  â”‚
                                                                                                                 â”‚ test eax, eax                                                              â”‚
                                                                                                                 â”‚ je 0x401ca0                                                                â”‚
                                                                                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                                                         f t
                                                                                                                         â”‚ â”‚
                                                                                                                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
                                                                                        â”‚                                                                                       â”‚
                                                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                                                                                    â”‚  0x401b75                                                                            â”‚    â”‚
                                                                                    â”‚ lea ecx, [var_4ch]                                                                   â”‚    â”‚
                                                                                    â”‚ ; DWORD cchBuffer                                                                    â”‚    â”‚
                                                                                    â”‚ ; 260                                                                                â”‚    â”‚
                                                                                    â”‚ push 0x104                                                                           â”‚    â”‚
                                                                                    â”‚ lea edx, [var_4ch]                                                                   â”‚    â”‚
                                                                                    â”‚ ; LPSTR lpszShortPath                                                                â”‚    â”‚
                                                                                    â”‚ push ecx                                                                             â”‚    â”‚
                                                                                    â”‚ ; LPCSTR lpszLongPath                                                                â”‚    â”‚
                                                                                    â”‚ push edx                                                                             â”‚    â”‚
                                                                                    â”‚ ; 0x402068                                                                           â”‚    â”‚
                                                                                    â”‚ ; DWORD GetShortPathNameA(LPCSTR lpszLongPath, LPSTR lpszShortPath, DWORD cchBuffer) â”‚    â”‚
                                                                                    â”‚ call dword [sym.imp.KERNEL32.dll_GetShortPathNameA];[ob]                             â”‚    â”‚
                                                                                    â”‚ test eax, eax                                                                        â”‚    â”‚
                                                                                    â”‚ je 0x401ca0                                                                          â”‚    â”‚
                                                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                                                                                            f t                                                                                 â”‚
                                                                                            â”‚ â”‚                                                                                 â”‚
                                                                                            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                                                                            â””â”                                                                              â”‚   â”‚
                                                                                             â”‚                                                                              â”‚   â”‚
                                                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
                                                                                         â”‚  0x401b92                                                                   â”‚    â”‚   â”‚
                                                                                         â”‚ lea eax, [var_254h]                                                         â”‚    â”‚   â”‚
                                                                                         â”‚ ; 260                                                                       â”‚    â”‚   â”‚
                                                                                         â”‚ push 0x104                                                                  â”‚    â”‚   â”‚
                                                                                         â”‚ push eax                                                                    â”‚    â”‚   â”‚
                                                                                         â”‚ ; 0x403090                                                                  â”‚    â”‚   â”‚
                                                                                         â”‚ ; "COMSPEC"                                                                 â”‚    â”‚   â”‚
                                                                                         â”‚ push str.COMSPEC                                                            â”‚    â”‚   â”‚
                                                                                         â”‚ ; 0x402064                                                                  â”‚    â”‚   â”‚
                                                                                         â”‚ ; DWORD GetEnvironmentVariableA(LPCSTR lpName, LPSTR lpBuffer, DWORD nSize) â”‚    â”‚   â”‚
                                                                                         â”‚ call dword [sym.imp.KERNEL32.dll_GetEnvironmentVariableA];[oc]              â”‚    â”‚   â”‚
                                                                                         â”‚ test eax, eax                                                               â”‚    â”‚   â”‚
                                                                                         â”‚ je 0x401ca0                                                                 â”‚    â”‚   â”‚
                                                                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
                                                                                                 f t                                                                        â”‚   â”‚
                                                                                                 â”‚ â”‚                                                                        â”‚   â”‚
                                                                                                 â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
                                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                      â”‚   â”‚   â”‚
                                                                        â”‚                                                                                               â”‚   â”‚   â”‚
                                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚   â”‚   â”‚
                                                                    â”‚  0x401bb2                                                  â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea ecx, [var_150h]                                        â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 0x403088                                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "/c del "                                                â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push str._c_del                                            â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; LPSTR lpString1                                          â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push ecx                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 0x402060                                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; LPSTR lstrcpyA(LPSTR lpString1, LPCSTR lpString2)        â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call dword [sym.imp.KERNEL32.dll_lstrcpyA];[od]            â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x40205c:4]=0x2474 reloc.KERNEL32.dll_lstrcatA          â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "t$"                                                     â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov esi, dword [sym.imp.KERNEL32.dll_lstrcatA]             â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea edx, [var_4ch_2]                                       â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea eax, [var_150h_2]                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push edx                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push eax                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call esi                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea ecx, [var_150h_3]                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 0x403080                                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; " > nul"                                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push str.___nul                                            â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push ecx                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call esi                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_18h], edi                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea edx, [var_254h_2]                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea eax, [var_150h_4]                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_28h], edi                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_2ch], edi                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x402038:4]=0x23d6 reloc.KERNEL32.dll_GetCurrentProcess â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov edi, dword [sym.imp.KERNEL32.dll_GetCurrentProcess]    â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 256                                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push 0x100                                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; '<'                                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x3c:4]=-1                                              â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 60                                                       â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_14h], 0x3c                                  â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x403078:4]=0x6e65704f                                  â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "Open"                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_20h], str.Open                              â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_24h], edx                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_28h_2], eax                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; '@'                                                      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x40:4]=-1                                              â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 64                                                       â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov dword [var_18h_2], 0x40                                â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call edi                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x402058:4]=0x2460 reloc.KERNEL32.dll_SetPriorityClass  â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "`$"                                                     â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov esi, dword [sym.imp.KERNEL32.dll_SetPriorityClass]     â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push eax                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call esi                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x402054:4]=0x244c reloc.KERNEL32.dll_GetCurrentThread  â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "L$"                                                     â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov ebx, dword [sym.imp.KERNEL32.dll_GetCurrentThread]     â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 15                                                       â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push 0xf                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call ebx                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; [0x402050:4]=0x2438 reloc.KERNEL32.dll_SetThreadPriority â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "8$"                                                     â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ mov ebp, dword [sym.imp.KERNEL32.dll_SetThreadPriority]    â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push eax                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call ebp                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ lea ecx, [var_10h]                                         â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; SHELLEXECUTEINFOA *pExecInfo                             â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ push ecx                                                   â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; 0x4020d4                                                 â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; "\n%"                                                    â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ ; BOOL ShellExecuteExA(SHELLEXECUTEINFOA *pExecInfo)       â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ call dword [sym.imp.SHELL32.dll_ShellExecuteExA];[oe]      â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ test eax, eax                                              â”‚                                      â”‚   â”‚   â”‚
                                                                    â”‚ je 0x401c92                                                â”‚                                      â”‚   â”‚   â”‚
                                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚   â”‚   â”‚
                                                                            f t                                                                                         â”‚   â”‚   â”‚
                                                                            â”‚ â”‚                                                                                         â”‚   â”‚   â”‚
                                                                            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚   â”‚   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚                                             â”‚   â”‚   â”‚
    â”‚                                                                                                                     â”‚                                             â”‚   â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚   â”‚
â”‚  0x401c5b                                                                                                       â”‚   â”‚  0x401c92                                   â”‚   â”‚   â”‚   â”‚
â”‚ mov edx, dword [var_48h]                                                                                        â”‚   â”‚ ; CODE XREF from fcn.00401b50 @ 0x401c59(x) â”‚   â”‚   â”‚   â”‚
â”‚ ; '@'                                                                                                           â”‚   â”‚ ; 32                                        â”‚   â”‚   â”‚   â”‚
â”‚ ; 64                                                                                                            â”‚   â”‚ push 0x20                                   â”‚   â”‚   â”‚   â”‚
â”‚ push 0x40                                                                                                       â”‚   â”‚ call edi                                    â”‚   â”‚   â”‚   â”‚
â”‚ push edx                                                                                                        â”‚   â”‚ push eax                                    â”‚   â”‚   â”‚   â”‚
â”‚ call esi                                                                                                        â”‚   â”‚ call esi                                    â”‚   â”‚   â”‚   â”‚
â”‚ mov eax, dword [var_2ch]                                                                                        â”‚   â”‚ push 0                                      â”‚   â”‚   â”‚   â”‚
â”‚ ; BOOL bDisablePriorityBoost                                                                                    â”‚   â”‚ call ebx                                    â”‚   â”‚   â”‚   â”‚
â”‚ ; 1                                                                                                             â”‚   â”‚ push eax                                    â”‚   â”‚   â”‚   â”‚
â”‚ push 1                                                                                                          â”‚   â”‚ call ebp                                    â”‚   â”‚   â”‚   â”‚
â”‚ ; HANDLE hProcess                                                                                               â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚   â”‚
â”‚ push eax                                                                                                        â”‚       v                                             â”‚   â”‚   â”‚
â”‚ ; 0x40204c                                                                                                      â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; BOOL SetProcessPriorityBoost(HANDLE hProcess, BOOL bDisablePriorityBoost)                                     â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ call dword [sym.imp.KERNEL32.dll_SetProcessPriorityBoost];[of]                                                  â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ lea ecx, [var_28h]                                                                                              â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ push 0                                                                                                          â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; LPCVOID dwItem1                                                                                               â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ push ecx                                                                                                        â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; ChangeNotifyFlags uFlags                                                                                      â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; 1                                                                                                             â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ push 1                                                                                                          â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; ChangeNotifyEventId wEventId                                                                                  â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; 4                                                                                                             â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ push 4                                                                                                          â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; 0x4020d8                                                                                                      â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ; void SHChangeNotify(ChangeNotifyEventId wEventId, ChangeNotifyFlags uFlags, LPCVOID dwItem1, LPCVOID dwItem2) â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ call dword [sym.imp.SHELL32.dll_SHChangeNotify];[og]                                                            â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ pop edi                                                                                                         â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ pop esi                                                                                                         â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ pop ebp                                                                                                         â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ mov eax, 1                                                                                                      â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ pop ebx                                                                                                         â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ add esp, 0x348                                                                                                  â”‚       â”‚                                             â”‚   â”‚   â”‚
â”‚ ret                                                                                                             â”‚       â”‚                                             â”‚   â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                                             â”‚   â”‚   â”‚
                                                                                                                          â”‚                                             â”‚   â”‚   â”‚
                                                                                                                          â”‚                                             â”‚   â”‚   â”‚
                                                                                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚   â”‚   â”‚
                                                                                                                                     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
                                                                                                                                     â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                                                                                                                     â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                                                                                     â”‚ â”‚ â”‚ â”‚
                                                                                                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                                                                                               â”‚  0x401ca0                                                              â”‚
                                                                                                                               â”‚ ; CODE XREFS from fcn.00401b50 @ 0x401b6f(x), 0x401b8c(x), 0x401bac(x) â”‚
                                                                                                                               â”‚ pop edi                                                                â”‚
                                                                                                                               â”‚ pop esi                                                                â”‚
                                                                                                                               â”‚ pop ebp                                                                â”‚
                                                                                                                               â”‚ xor eax, eax                                                           â”‚
                                                                                                                               â”‚ pop ebx                                                                â”‚
                                                                                                                               â”‚ add esp, 0x348                                                         â”‚
                                                                                                                               â”‚ ret                                                                    â”‚
                                                                                                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
[0x00401c51]>


ðŸ§  Â¿QuÃ© hemos descubierto?
âœ… Objetivo de la funciÃ³n en 0x401b50:

Construir y ejecutar una orden cmd.exe /c del archivo > nul, donde archivo es el propio binario del malware (o su short path), y luego eliminarlo.
ðŸ“¦ Flujo exacto:

    Obtiene su propia ruta:

call GetModuleFileNameA

Convierte esa ruta larga a ruta corta (8.3):

call GetShortPathNameA

Obtiene COMSPEC del entorno (normalmente C:\Windows\System32\cmd.exe):

call GetEnvironmentVariableA, "COMSPEC"

Construye el comando en var_150h:

/c del C:\...\malware.exe > nul

Lo concatena paso a paso:

    Con /c del

    Luego con la ruta corta del binario

    Luego con > nul para ocultar la salida

Prepara la estructura SHELLEXECUTEINFOA

    lpFile: cmd.exe

    lpParameters: /c del malware.exe > nul

    nShow: SW_HIDE (0x0)

    fMask: incluye SEE_MASK_NOCLOSEPROCESS (0x00000040)

Llama a ShellExecuteExA para ejecutar el comando silenciosamente:

call ShellExecuteExA

(Opcional) Ajusta prioridad del proceso e hilo con:

    SetPriorityClass

    SetThreadPriority

    SetProcessPriorityBoost

Llama a SHChangeNotify para actualizar el explorador (para ocultar rastros):

    call SHChangeNotify

ðŸš© ConclusiÃ³n

Este malware contiene una rutina de autodestrucciÃ³n silenciosa:

    Usa cmd.exe para eliminar su propio archivo ejecutable (del malware.exe > nul).

    Ejecuta este comando sin ventana visible.

    Borra sus rastros del sistema usando SHChangeNotify.

    Todo se hace en un hilo separado con prioridades modificadas.


-----------------------------------
Buscar la cadena /c del en todas sus formas:


[0x00401c51]> iz~del
70  0x00001c88 0x00403088 7   8    .data   ascii   /c del
[0x00401c51]>

ðŸ§© ConstrucciÃ³n total del comando

El malware no guarda el comando completo como una sola cadena, sino que lo ensambla paso a paso en memoria:

    Parte 1 â€“ fija:
    /c del
    â†’ En 0x00403088

    Parte 2 â€“ dinÃ¡mica:
    â†’ Ruta corta del propio ejecutable
    â†’ Obtenida con GetModuleFileNameA + GetShortPathNameA

    Parte 3 â€“ fija:
    > nul
    â†’ En 0x00403080

ðŸ›  Resultado final en tiempo de ejecuciÃ³n:

Supongamos que el malware estÃ¡ en C:\Temp\MALW~1.EXE, entonces el comando serÃ­a:

cmd.exe /c del C:\Temp\MALW~1.EXE > nul

Este comando:

    Elimina el ejecutable a sÃ­ mismo

    Silencia la salida (no se ve nada en consola)

    Se ejecuta en segundo plano sin ventana visible (SW_HIDE)

    Usa ShellExecuteExA para hacerlo
