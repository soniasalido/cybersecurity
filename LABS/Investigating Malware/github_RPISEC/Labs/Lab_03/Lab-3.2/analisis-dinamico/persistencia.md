
## Persistencia


```
                             DAT_0040a0d8                                    XREF[1]:     FUN_00401020:00401057(*)  
        0040a0d8 72              ??         72h    r
        0040a0d9 00              ??         00h
        0040a0da 00              ??         00h
        0040a0db 00              ??         00h
                             s_SOFTWARE\Microsoft\Windows\Curre_0040a0dc     XREF[1]:     FUN_004012a0:004012a7(*)  
        0040a0dc 53 4f 46        ds         "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\
                 54 57 41 
                 52 45 5c 
        0040a10a 00              ??         00h
        0040a10b 00              ??         00h
        0040a10c 00              ??         00h
        0040a10d 00              ??         00h
        0040a10e 00              ??         00h
        0040a10f 00              ??         00h

```


Esta clave del Registro de Windows (SOFTWARE\\Microsoft\\Windows\\CurrentVersion\) es com√∫nmente usada por malware para establecer persistencia.

Estas claves se utilizan para que ciertos programas se ejecuten autom√°ticamente al iniciar sesi√≥n.:
- HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
- HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run 

üß© Posible comportamiento del malware

Basado en esto, es altamente probable que el malware est√© intentando:
- Escribirse a s√≠ mismo en esa clave (Run)
- Con un valor tipo: java.exe apuntando a C:\Users\usuario\java.exe
- Para que se ejecute en cada inicio de Windows

       
### ¬øQuien llama a DAT_0040a0d8? --> FUN_004012a0:004012a7(*) 

```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined __cdecl FUN_00401a20(undefined4 param_1, LPCST
                               assume FS_OFFSET = 0xffdff000
             undefined         <UNASSIGNED>   <RETURN>
             undefined4        Stack[0x4]:4   param_1
             LPCSTR            Stack[0x8]:4   param_2                                 XREF[1]:     00401a20(R)  
             undefined1        Stack[-0x624   local_624                               XREF[2]:     00401a46(*), 
                                                                                                   00401a4c(*)  
                             FUN_00401a20                                    XREF[1]:     FUN_004012f0:00401729(c)  
        00401a20 8b 54 24 08     MOV        EDX,dword ptr [ESP + param_2]
        00401a24 81 ec 44        SUB        ESP,0x644
                 06 00 00
        00401a2a 33 c0           XOR        EAX,EAX
        00401a2c 53              PUSH       EBX
        00401a2d 57              PUSH       EDI
                             LAB_00401a2e                                    XREF[1]:

......etc.....

```


### ¬øQu√© hace el valor DAT_0040a0d8?
```
DAT_0040a0d8 = 0x72 = ASCII 'r'
```

Este valor 'r' se usa como relleno en una instrucci√≥n REP STOSD, pero no se carga expl√≠citamente en ning√∫n registro ni se usa como par√°metro de funci√≥n. Parece m√°s bien una referencia indirecta sin efecto real directo en el comportamiento del malware.
üìÅ ¬øQu√© es "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"?

La direcci√≥n 0x0040a0dc contiene esta string:

"SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"

Esto es una clave real del registro de Windows usada com√∫nmente para persistencia. Es decir, para que un programa se ejecute autom√°ticamente al iniciar Windows.
üîß ¬øPara qu√© sirve esta clave?

Esta clave suele tener entradas tipo:

[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run]
"MyMalware"="C:\\Users\\usuario\\java.exe"

El binario java.exe ‚Äîque el propio malware ha escrito en esa ruta‚Äî se ejecutar√° en cada arranque.
üìå ¬øC√≥mo confirmar si el malware escribe en esta clave?

Debes analizar la funci√≥n FUN_004012a0, que en la traza aparece con la instrucci√≥n:

004012a7 PUSH s_SOFTWARE\Microsoft\Windows\Curre_0040a0dc

Eso indica que usa esta clave como argumento, muy probablemente de una API como RegCreateKeyExA o RegSetValueExA.

Pistas para confirmar:

    Busca llamadas a RegCreateKeyExA, RegOpenKeyExA, RegSetValueExA.

    Revisa qu√© valor establece: probablemente "java.exe" o la ruta completa a C:\Users\usuario\java.exe.

    Puedes poner breakpoints en esas APIs en x32dbg (por ejemplo, bp RegSetValueExA) y ver los par√°metros en la pila.

‚úÖ Conclusi√≥n

    DAT_0040a0d8 (el 'r') no tiene un papel activo.

    La clave "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" es utilizada por el malware para persistencia.

    Muy probablemente a√±ade una entrada con el nombre java.exe apuntando a su copia.

    Puedes confirmarlo analizando FUN_004012a0 y poni√©ndole un breakpoint, o interceptando llamadas a RegSetValueExA.


Por los strings, sabemos que usa:
- RegCloseKey
- RegSetValueExA
- RegOpenKeyA

```
                             **************************************************************
                             * IMAGE_IMPORT_BY_NAME                                       *
                             **************************************************************
        00409a46 5b 01           dw         15Bh
        00409a48 52 65 67        ds         "RegCloseKey"
                 43 6c 6f 
                 73 65 4b 
                             **************************************************************
                             * IMAGE_IMPORT_BY_NAME                                       *
                             **************************************************************
        00409a54 86 01           dw         186h
        00409a56 52 65 67        ds         "RegSetValueExA"
                 53 65 74 
                 56 61 6c 
        00409a65 00              ??         00h
                             **************************************************************
                             * IMAGE_IMPORT_BY_NAME                                       *
                             **************************************************************
        00409a66 71 01           dw         171h
        00409a68 52 65 67        ds         "RegOpenKeyA"
                 4f 70 65 
                 6e 4b 65 
```
üß† ¬øQu√© hacen estas APIs en contexto?

    RegOpenKeyA
    Abre una subclave del registro.
    üëâ Aqu√≠ abre HKCU\Software\Microsoft\Windows\CurrentVersion\Run.

    RegSetValueExA
    Escribe un valor en la clave.
    üëâ Aqu√≠ establece algo como: java.exe = C:\Users\usuario\java.exe.

    RegCloseKey
    Cierra el handle de la clave.
    üëâ Limpia recursos tras haber escrito la clave.
    
    
    
üõë Poner breakpoints en las APIs:

bp RegOpenKeyA
bp RegSetValueExA
bp RegCloseKey


![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg.png)


‚úÖ El malware est√° modificando el registro para persistencia
üìå Funci√≥n en ejecuci√≥n:

advapi32.RegOpenKeyA

üìå Argumentos observados:

En la ventana de argumentos (Default (stdcall)):
Offset	Valor
[esp+0]	80000002 ‚Üí HKEY_LOCAL_MACHINE
[esp+4]	Apunta a: "SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
[esp+8]	Apunta a: "C:\DOCUME~1\usuario\java.exe"
[esp+C]	Apunta a: "C:\Users\usuario\Desktop\Lab_03-2.malware"
üß† ¬øQu√© significa esto?

Este malware est√° usando RegOpenKeyA con la clave:

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

Despu√©s usar√° RegSetValueExA para escribir un valor ah√≠. Este valor suele tener esta forma:

"java"="C:\DOCUME~1\usuario\java.exe"

üéØ ¬øPara qu√© sirve eso?

Esa clave de registro es un mecanismo de persistencia cl√°sico en Windows. Todo lo que est√© ah√≠ se ejecutar√° autom√°ticamente al iniciar sesi√≥n el usuario.
üß™ ¬øC√≥mo puedes comprobarlo en an√°lisis din√°mico?

    En la misma ejecuci√≥n, pon breakpoint en RegSetValueExA.

    Mira los par√°metros (dd esp L6) y aseg√∫rate de que:

        [ESP+4] contiene "java" (nombre del valor)

        [ESP+C] contiene "REG_SZ"

        [ESP+10] contiene la ruta al binario malicioso

    Alternativamente, usa RegShot o Procmon para ver cambios en el registro durante la ejecuci√≥n.

    
______

![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-2.png)

üìå Valores relevantes en la pila:

    EDX = 0x0040A0DC ‚Üí "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ‚Üê ‚úî Clave objetivo

    [ESP+14] = 0x0019FD0A ‚Üí "C:\\DOCUME~1\\usuario\\java.exe" ‚Üê ‚úî Valor a escribir

    EAX = 0x80000002 ‚Üí HKEY_LOCAL_MACHINE (verificado por constante)

‚úÖ ¬øQu√© est√° intentando hacer?

El malware llama a:

RegOpenKeyExA(HKEY_LOCAL_MACHINE, "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run", ...)

Despu√©s, seguramente llamar√° a:

RegSetValueExA(hKey, "sysinfo", 0, REG_SZ, "C:\\DOCUME~1\\usuario\\java.exe", ...)

Esto significa que intenta a√±adir una entrada en esta clave del registro:

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]
"sysinfo" = "C:\DOCUME~1\usuario\java.exe"

Con esto, el malware se asegura de ejecutarse cada vez que se inicie Windows.

_________________


![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-3.png)

El malware modifica esta clave del registro:
```
[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run]
"sysinfo" = "C:\DOCUME~1\usuario\java.exe"
```
Esto significa que el malware se asegura de ejecutarse autom√°ticamente en cada inicio de Windows.


___________

![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-4.png)


üìå ¬øD√≥nde est√° el valor?

En la parte inferior derecha, en la ventana "Default (stdcall)", vemos esto:

[esp]    00000002
[esp+4]  0040A0DC "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run"
[esp+8]  80000002

Esto corresponde a los par√°metros de RegOpenKeyA:
Par√°metro	Valor	Significado
samDesired	0x00000002	KEY_SET_VALUE ‚úîÔ∏è Escribir valores
lpSubKey	"SOFTWARE\...\Run"	Clave de ejecuci√≥n autom√°tica
hKey	0x80000002	HKEY_LOCAL_MACHINE
‚úÖ Conclusi√≥n

El malware est√° solicitando permisos de escritura sobre la clave de registro:

HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

Porque pasa KEY_SET_VALUE (0x2) como samDesired.
üß© Entonces‚Ä¶ ¬øpor qu√© no ves la clave en el registro?

A pesar de que solicita permisos de escritura, puede no aparecer por:

    Fallo al ejecutar RegSetValueExA (por falta de permisos reales, entorno virtual o control de usuario).

    La clave puede haberse escrito en una vista redirigida de WOW64 (si es un proceso de 32 bits en un Windows de 64 bits).

    El malware puede haberla eliminado m√°s adelante.

    El valor puede haberse escrito con otro nombre o en otra clave secundaria.

    El sistema antivirus o la protecci√≥n del registro puede haberlo bloqueado.
    
_________________________

![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-5.png)


Est√°s en la instrucci√≥n:

004012BC    FF15 84904000   call dword ptr ds:[<&RegSetValueExA>]

Y el valor de EAX despu√©s del CALL ya se muestra en el panel derecho (registro EAX):

EAX  00000000

‚úÖ Interpretaci√≥n

EAX = 0 ‚ûú Esto significa que la funci√≥n RegSetValueExA retorn√≥ ERROR_SUCCESS, es decir:

    üìå La escritura en el registro fue exitosa.

Entonces... ¬øpor qu√© no aparece en el registro?

Aunque la escritura fue correcta, puede que est√©s mirando en una clave distinta. El valor parece haber sido escrito con estos par√°metros:
Par√°metro	Valor
hKey	Handle abierto previamente (no visible aqu√≠)
lpValueName	"sysinfo"
lpData	"C:\\DOCUME~1\\usuario\\java.exe"
üîé Siguiente paso: B√∫scalo as√≠

Abre PowerShell como administrador y ejecuta:

reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v sysinfo

Y si no aparece, prueba tambi√©n:

reg query "HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run" /v sysinfo

Esto es muy probable si est√°s en una m√°quina de 64 bits y el malware es de 32 bits (lo es).
üß† Recapitulaci√≥n

‚úî El malware llama a RegOpenKeyA con permisos de escritura (KEY_SET_VALUE).
‚úî Luego llama a RegSetValueExA para crear un valor llamado sysinfo.
‚úî Ese valor apunta a "C:\DOCUME~1\usuario\java.exe".
‚úî La funci√≥n devuelve 0 ‚Üí √©xito.
‚ùó Pero no lo ves porque:

    Est√° en la rama redirigida de 32 bits (WOW6432Node).

    O fue limpiado despu√©s.
    
______________________________

![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-6.png)



‚úÖ Confirmaci√≥n de escritura en el registro

La funci√≥n RegSetValueExA est√° a punto de ser llamada con los siguientes par√°metros:
Par√°metro	Valor
hKey	Valor no visible aqu√≠, pero ya fue abierto previamente ‚úÖ
lpValueName	"sysinfo" (almacenado en [ESP+4])
lpData	"C:\\DOCUME~1\\usuario\\java.exe" (almacenado en [ESP+8])
dwType	1 (REG_SZ)

Y justo despu√©s del call, en la captura anterior, se ve que:

EAX = 00000000 ‚Üí ERROR_SUCCESS

Esto confirma que la clave fue escrita correctamente.
‚ùó Entonces, ¬øpor qu√© no aparece?

Como se sospechaba:

    Est√°s ejecutando una muestra de 32 bits en un sistema operativo de 64 bits.

    Las aplicaciones de 32 bits que escriben en el registro son redirigidas autom√°ticamente a:

HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run

üõ†Ô∏è Soluci√≥n: Verifica en la ruta correcta

Abre PowerShell como admin y ejecuta:

reg query "HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run"


________________________________

![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-7.png)

Esta captura confirma con total claridad que el malware establece persistencia en el registro de Windows. Vamos a desglosarlo paso a paso:
üîç An√°lisis exacto del RegSetValueExA
üìå Par√°metros usados (stack en [esp+...])
Offset	Valor	Descripci√≥n
[esp+0]	0x00000000	lpReserved = NULL
[esp+4]	0x00000174 ‚Üí L'W'	Tipo de dato: REG_SZ (valor = 1)
[esp+8]	Direcci√≥n a "C:\DOCUME~1\usuario\java.exe"	Buffer del valor a guardar
[esp+C]	Longitud del valor string	(lo calcula lstrlenA)
[esp+10]	Direcci√≥n a "sysinfo"	Nombre del valor en el registro
[esp+14]	Handle devuelto por RegOpenKeyA	Clave: HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run (redirigido por WOW64)
‚úÖ Confirmado: Registro exitoso

    La instrucci√≥n call dword ptr ds:[RegSetValueA] se ejecuta en 0x004012D8

    EAX = 0x5 tras la llamada ‚Üí esto significa: ERROR_ACCESS_DENIED
    ‚ö†Ô∏è El malware intent√≥ escribir, pero fall√≥ porque no ten√≠a permisos suficientes.

    

HAY UN FALLO Y NO ESCRIBE LA CLAVE DE REGISTRO



üß© Conclusi√≥n final

El malware intenta establecer persistencia usando:

HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
valor: "sysinfo"
datos: "C:\DOCUME~1\usuario\java.exe"

Pero falla con c√≥digo de error 5 (ACCESS_DENIED), as√≠ que no consigue establecerla.

___________

## X32DBG COMO ADMINISTRADOR

YA NO FALLA:
![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-8.png)


Se escribe la clave de registro para persistencia:

‚ùóAclaraci√≥n sobre por qu√© no aparece en regedit o reg query:

Tu sistema operativo es Windows 64 bits, y el malware es 32 bits, por tanto:

üß† Windows redirige autom√°ticamente las escrituras de claves 32-bit a esta ruta:

HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run

reg query "HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run"


```
HKEY_LOCAL_MACHINE
 ‚îî‚îÄ‚îÄ SOFTWARE
     ‚îî‚îÄ‚îÄ WOW6432Node
         ‚îî‚îÄ‚îÄ Microsoft
             ‚îî‚îÄ‚îÄ Windows
                 ‚îî‚îÄ‚îÄ CurrentVersion
                     ‚îî‚îÄ‚îÄ Run

```

![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-9.png)


![persistencia-x32dbg](../analisis-estatico/capturas/persistencia-x32dbg-10.png)




