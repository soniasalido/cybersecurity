#!/usr/bin/env python3
import socket, binascii, datetime

HOST, PORT = '', 443
DEFAULT_RESPONSE = b'OKOKOKOK'   # 8 bytes; cámbialo tras ver el patrón real
TIMEOUT = 15.0

def hexdump(b): 
    hx=binascii.hexlify(b).decode()
    return ' '.join(hx[i:i+2] for i in range(0,len(hx),2))

def rule_engine(data: bytes) -> bytes:
    # Ajusta reglas según lo que veas en memcmp/strncmp
    if data == b'fxftest':
        return b'OKOKOKOK'      # o la cadena exacta que veas que compara
    if data.endswith(b'\r\n'):
        return b'HTTP/1.1 200 OK\r\nContent-Length: 2\r\n\r\nOK'
    return DEFAULT_RESPONSE

def main():
    s=socket.socket(); s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind((HOST, PORT)); s.listen(5)
    print(f'[*] Listening on 0.0.0.0:{PORT}')
    while True:
        c,addr=s.accept()
        ts=datetime.datetime.now().strftime('%H:%M:%S')
        print(f'\n[+] {ts} Connection from {addr[0]}:{addr[1]}')
        c.settimeout(TIMEOUT)
        try:
            while True:
                data=c.recv(4096)
                if not data:
                    print('    [*] client closed'); break
                print(f'    [*] Received ({len(data)}): {data!r}')
                print(f'        HEX: {hexdump(data)}')
                resp=rule_engine(data)
                if resp:
                    c.sendall(resp)
                    print(f'    [*] Sent ({len(resp)}): {resp!r}')
        except Exception as e:
            print('    [!] error:', e)
        finally:
            try: c.close()
            except: pass

if __name__ == '__main__':
    main()
