# Opcode 6 – Exfiltración remota de archivos (Download)  
**Muestra:** Lab_03-2.malware  
**Curso/Lab:** RPISEC – Investigating Malware – Lab 3.2

---

## 1. Introducción

El **Opcode 6** implementa la funcionalidad de **exfiltración remota de archivos desde el host comprometido hacia el servidor C2**.

A diferencia del Opcode 5 (subida de archivos al host), este opcode permite al operador **leer un archivo local arbitrario y enviarlo íntegramente al C2**, habilitando capacidades de **robo de información** y **exfiltración de datos sensibles**.

---

## 2. Función principal asociada

- **Función:** [FUN_00402210](../decompilado/FUN_00402210-opcode6.md)
- **Opcode:** `0x06`
- **Invocada desde:** dispatcher principal (`FUN_004012F0`)
- **Objetivo:** leer un archivo local y enviarlo al C2

---

## 3. Resumen funcional

Cuando se ejecuta el Opcode 6, el malware realiza las siguientes acciones:

1. Recibe una ruta de archivo ofuscada desde el C2.
2. Descifra la ruta aplicando XOR con clave `0x55`.
3. Abre el archivo en modo lectura.
4. Crea un mapeo de memoria del archivo.
5. Obtiene el tamaño total del archivo.
6. Construye un *header* de 0x204 bytes (ofuscado parcialmente).
7. Envía el *header* al C2.
8. Envía el contenido del archivo en claro.
9. Libera recursos y retorna al bucle principal.

A diferencia del Opcode 5, **no se envía un mensaje explícito de “ok/error”** al finalizar.

---

## 4. Entrada del opcode

El servidor C2 debe enviar un buffer con la siguiente estructura lógica:

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 4     | Opcode `0x06` (little-endian) |
| 0x04 | 256   | Ruta del archivo ofuscada (XOR `0x55`) |

La ruta está **rellenada (padding)** hasta 256 bytes antes de ser ofuscada.

Ejemplo de ruta lógica antes de ofuscación:
```C:\Users\usuario\Desktop\prueba.txt```


---

## 5. Descifrado de la ruta

El malware descifra la ruta mediante un bucle XOR:
```
for i in range(0, 256):
buffer[i] ^= 0x55
```


Tras el bucle:
- La ruta queda en claro en el mismo buffer.
- El puntero se utiliza directamente en `CreateFileA`.

Este mecanismo de ofuscación es consistente con el resto del protocolo C2.

---

## 6. Apertura del archivo

El archivo se abre mediante:
```
CreateFileA(
lpFileName = ruta_descifrada,
dwDesiredAccess = GENERIC_READ,
dwShareMode = FILE_SHARE_READ,
dwCreationDisposition = OPEN_EXISTING,
dwFlagsAndAttributes = FILE_FLAG_SEQUENTIAL_SCAN
)
```


Observaciones:
- El archivo se abre **solo en lectura**.
- No se solicitan permisos de escritura.
- Si `CreateFileA` falla, la función aborta silenciosamente.

---

## 7. Mapeo del archivo en memoria

Para leer el archivo de forma eficiente, el malware utiliza:

1. `CreateFileMappingA`
   - Protección: `PAGE_READONLY`
2. `MapViewOfFile`
   - Acceso: `FILE_MAP_READ`

El resultado es una vista de memoria (`EDI`) que apunta directamente al contenido del archivo.

Este enfoque evita bucles explícitos de `ReadFile` y mejora el rendimiento.

---

## 8. Obtención del tamaño del archivo

El tamaño del archivo se obtiene mediante:
```GetFileSize(hFile)```


- El tamaño (DWORD, little-endian) se almacena en:
```[ESP + 0x20C]```


- Este valor se utilizará posteriormente durante el envío al C2.

---

## 9. Construcción del header (0x204 bytes)

Antes de enviar los datos, el malware construye un *header* en la pila con la siguiente estructura:

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 0x200 | Datos ofuscados (XOR `0x55`) |
| 0x200 | 4     | Tamaño del archivo (DWORD LE, en claro) |

Observaciones importantes:
- El bloque de 0x200 bytes **no contiene el archivo**.
- Se trata de un *header* interno (metadatos / relleno).
- Solo los primeros 0x200 bytes se ofuscan con XOR `0x55`.

---

## 10. Envío de datos al C2

### 10.1 Primer envío: header

El malware envía el *header* mediante:
```send(sock, header, 0x204, 0)```



Este mensaje informa al C2 del tamaño del archivo que se va a exfiltrar.

---

### 10.2 Segundo envío: contenido del archivo

A continuación, el malware envía **el contenido completo del archivo en claro**:
```send(sock, file_map, file_size, 0)```


Características:
- No hay ofuscación ni cifrado del contenido.
- El tamaño enviado coincide exactamente con `GetFileSize`.
- El envío se realiza en una sola llamada a `send`.

---

## 11. Limpieza de recursos

Tras completar el envío, el malware:

1. Desmapea la vista de memoria:
```UnmapViewOfFile```


2. Cierra el mapeo:
```CloseHandle(hMap)```


3. Cierra el handle del archivo:
```CloseHandle(hFile)```


4. Retorna al bucle principal de recepción de opcodes.

No se realizan comprobaciones adicionales del resultado del envío.

---

## 12. Análisis dinámico observado

Durante la ejecución controlada del Opcode 6 se observó que:

- El archivo local es leído correctamente.
- El contenido llega íntegro al servidor C2.
- El tráfico de red contiene:
- Un primer bloque de 0x204 bytes (header)
- Un segundo bloque con el contenido real del archivo
- El contenido se transmite **en texto plano**.

Esto confirma una capacidad clara de **exfiltración de datos**.

---

## 13. Implicaciones para el operador C2

El Opcode 6 permite al atacante:

- Robar archivos locales arbitrarios
- Exfiltrar documentos, configuraciones o credenciales
- Complementar la enumeración realizada por Opcode 2
- Implementar robo de información dirigido

Combinado con:
- **Opcode 1** (enumeración de discos)
- **Opcode 2** (listado de archivos)

el operador puede localizar y exfiltrar datos de interés de forma selectiva.

---

## 14. Conclusiones

El Opcode 6 implementa una funcionalidad completa de **exfiltración remota de archivos**, utilizando:

- Ofuscación simple para rutas
- Mapeo de archivos para lectura eficiente
- Envío directo del contenido en claro

Aunque la implementación es sencilla, es totalmente funcional y refuerza la clasificación de la muestra como un **backdoor interactivo con capacidades de espionaje y robo de información**.

---

## 15. Transición al siguiente opcode

Tras completar la exfiltración del archivo, el malware retorna al bucle principal y queda a la espera de nuevas instrucciones del servidor C2.



## 16. Opcode6 en crudo:
- [FUN_00402210-opcode6](../decompilado/FUN_00402210-opcode6.md)
