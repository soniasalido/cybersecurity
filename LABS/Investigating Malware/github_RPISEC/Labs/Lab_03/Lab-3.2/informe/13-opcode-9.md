# Opcode 9 – Ejecución remota de comandos con captura de salida  
**Muestra:** Lab_03-2.malware  
**Curso/Lab:** RPISEC – Investigating Malware – Lab 3.2

---

## 1. Introducción

El **Opcode 9** implementa una funcionalidad avanzada de **ejecución remota de comandos con captura de la salida estándar**.  
A diferencia del Opcode 3, que únicamente ejecuta comandos y reporta un código de estado, este opcode permite al servidor C2 **recibir la salida generada por el proceso ejecutado**, lo que habilita capacidades completas de **shell remoto interactivo**.

Este opcode representa una de las funcionalidades más potentes del malware.

---

## 2. Función principal asociada

- **Función:** [FUN_00402490](../decompilado/FUN_00402490-opcode9.md)
- **Opcode:** `0x09`
- **Invocada desde:** dispatcher principal (`FUN_004012F0`)
- **Objetivo:** ejecutar un comando, capturar su salida y enviarla al C2

---

## 3. Resumen funcional

Cuando se ejecuta el Opcode 9, el malware realiza las siguientes acciones:

1. Prepara pipes anónimos para redirigir la salida del proceso.
2. Construye el comando `cmd.exe` de forma interna.
3. Lanza el proceso hijo con salida redirigida.
4. Espera brevemente a que el proceso genere salida.
5. Lee la salida estándar del proceso mediante pipes.
6. Ofusca la salida con XOR `0x55`.
7. Envía la salida al servidor C2 en bloques estructurados.
8. Envía un bloque final de terminación.

---

## 4. Construcción del comando

El malware no recibe directamente la ruta de `cmd.exe` desde el C2.  
En su lugar, la construye internamente usando dos constantes en memoria:

| Dirección | Contenido | Interpretación |
|---------|----------|----------------|
| `0x0040A1B0` | `63 6D 64 2E` | `"cmd."` |
| `0x0040A1B4` | `65 78 65 00` | `"exe"` |

Estas dos partes se combinan para formar:
```cmd.exe```

El comando real ejecutado es del tipo:
```cmd.exe /c <comando>```



donde `<comando>` proviene del buffer recibido del C2.

---

## 5. Preparación de pipes

El malware crea dos pipes anónimos mediante:

- `CreatePipe`

Estos pipes se utilizan para:
- Redirigir `STDOUT`
- Redirigir `STDERR`

Los handles se heredan por el proceso hijo, permitiendo al malware leer directamente la salida generada.

---

## 6. Creación del proceso

El proceso se lanza mediante:
```
CreateProcessA(
lpApplicationName = NULL,
lpCommandLine = "cmd.exe /c <cmd>",
bInheritHandles = TRUE,
dwCreationFlags = CREATE_NO_WINDOW,
...
)
```



Características clave:
- No se muestra ninguna ventana.
- Los handles de los pipes son heredados.
- El proceso se ejecuta en segundo plano.

---

## 7. Captura de la salida

Tras lanzar el proceso, el malware:

1. Duerme brevemente (`Sleep(2000)`) para permitir que el proceso genere salida.
2. Entra en un bucle donde:
   - Usa `PeekNamedPipe` para comprobar si hay datos disponibles.
   - Lee los datos con `ReadFile` si existen.

Los datos se almacenan en un buffer interno de hasta **0x1000 bytes**.

---

## 8. Ofuscación de la salida

Antes de enviar la salida al C2, el malware aplica una ofuscación:

- **Algoritmo:** XOR
- **Clave:** `0x55`
- **Longitud:** hasta `0x1000` bytes

Cada byte de la salida es transformado mediante:
```byte ^= 0x55```


Este paso es consistente con el resto del protocolo C2.

---

## 9. Envío de datos al C2

La salida ofuscada se envía mediante:
```send(sock, buffer, 0x1004, 0)```


### Estructura del bloque enviado (0x1004 bytes)

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 0x1000 | Salida del comando (XOR `0x55`) |
| 0x1000 | 4 | Metadato / flag interno |

El malware puede enviar **múltiples bloques** si la salida es extensa.

---

## 10. Bloque final de terminación

Una vez no hay más datos disponibles:

1. El malware construye un último bloque.
2. Aplica nuevamente XOR `0x55`.
3. Envía el bloque final al C2.

Este bloque indica **fin de transmisión de la salida**.

---

## 11. Análisis dinámico observado

Durante la ejecución controlada del Opcode 9 se observó que:

- Comandos como `whoami`, `dir`, `ipconfig` producen salida visible en el C2.
- La salida coincide exactamente con la generada localmente.
- El tráfico viaja en texto ofuscado pero no cifrado.
- El mecanismo es fiable y repetible.

Esto confirma la presencia de un **shell remoto funcional**.

---

## 12. Implicaciones para el operador C2

El Opcode 9 proporciona al atacante:

- Ejecución remota con feedback completo
- Enumeración avanzada del sistema
- Capacidad de scripting remoto
- Control interactivo del host comprometido

Combinado con otros opcodes (5, 6, 7, 8), permite un **control total del sistema**.

---

## 13. Relación con otros opcodes

Comparativa clave:

| Opcode | Funcionalidad |
|------|---------------|
| 3 | Ejecuta comandos sin salida |
| **9** | Ejecuta comandos **con salida** |

El Opcode 9 sustituye funcionalmente al Opcode 3 en escenarios interactivos.

---

## 14. Conclusiones

El Opcode 9 implementa una funcionalidad avanzada de **ejecución remota con captura de salida**, utilizando:

- Pipes anónimos
- Creación de procesos sin ventana
- Ofuscación XOR consistente
- Envío estructurado de datos

Este opcode eleva significativamente las capacidades del malware, consolidándolo como un **backdoor interactivo completo con shell remoto**.

---

## 15. Transición al siguiente opcode

Tras finalizar el envío de la salida del comando, el malware retorna al bucle principal y queda a la espera de nuevas instrucciones del servidor C2.


## 16. Opcode9 en crudo:
- [FUN_00402490-opcode9](../decompilado/FUN_00402490-opcode9.md)
