# Opcode 7 – Enumeración de procesos  
**Muestra:** Lab_03-2.malware  
**Curso/Lab:** RPISEC – Investigating Malware – Lab 3.2

---

## 1. Introducción

El **Opcode 7** implementa la funcionalidad de **enumeración de procesos activos** en el sistema comprometido.  
Permite al servidor C2 obtener una visión completa de los procesos en ejecución, incluyendo procesos del sistema, servicios, aplicaciones de usuario y herramientas de análisis.

Esta capacidad es fundamental para:
- Reconocimiento del entorno
- Detección de software de seguridad
- Identificación de procesos de interés para acciones posteriores

---

## 2. Función principal asociada

- **Función:** [FUN_00402310](../decompilado/FUN_00402310-opcode7.md)
- **Opcode:** `0x07`
- **Invocada desde:** dispatcher principal (`FUN_004012F0`)
- **Objetivo:** enumerar procesos y enviar la información al C2

---

## 3. Resumen funcional

Cuando se ejecuta el Opcode 7, el malware realiza las siguientes acciones:

1. Toma una instantánea de los procesos del sistema.
2. Itera por cada proceso activo.
3. Extrae el nombre del ejecutable del proceso.
4. Ofusca el nombre mediante XOR con clave `0x55`.
5. Envía al C2 un registro estructurado por cada proceso.
6. Espera un ACK del servidor antes de continuar.
7. Envía un registro final de **sentinela** indicando fin de listado.

El diseño incluye **control de flujo explícito**, evitando pérdida de información.

---

## 4. Obtención de la lista de procesos

La enumeración se realiza utilizando la API de Windows:

- `CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0)`
- `Process32First`
- `Process32Next`

La información se obtiene a partir de la estructura `PROCESSENTRY32`, en particular el campo:

- `szExeFile` → nombre del ejecutable

---

## 5. Construcción del registro por proceso

Por cada proceso, el malware construye un **registro de tamaño fijo: 0x108 bytes**.

### Estructura del registro (0x108 bytes)

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 0x100 | Nombre del proceso (XOR `0x55`) |
| 0x100 | 4     | DWORD adicional (metadato interno) |
| 0x104 | 4     | DWORD adicional (metadato interno) |

Observaciones:
- El nombre del proceso se copia inicialmente **en claro** a la pila.
- A continuación se aplica XOR `0x55` sobre los **primeros 256 bytes**.
- Los 8 bytes finales (“cola”) permanecen **en claro**.

---

## 6. Ofuscación del nombre del proceso

El nombre del proceso se ofusca mediante un bucle:
```
for i in range(0, 256):
buffer[i] ^= 0x55
```


Este mecanismo:
- Oculta strings en tránsito
- Es consistente con otros opcodes del protocolo
- No ofrece seguridad criptográfica real

---

## 7. Envío al servidor C2

Cada registro se envía mediante:
```send(sock, buffer, 0x108, 0)```


Tras cada envío, el malware **espera un ACK de 2 bytes** desde el servidor.

---

## 8. Mecanismo de ACK y reintentos

Después de cada `send`, el malware ejecuta:

- `recv(sock, ack_buf, 2, 0)`
- Validación mediante `FUN_0040296D`

Comportamiento:
- **ACK válido** (por ejemplo `"ok"`): continúa con el siguiente proceso.
- **ACK inválido o ausente**: reenvía el mismo registro.
  
Este diseño garantiza la entrega fiable de todos los procesos enumerados.

---

## 9. Registro de fin de listado (sentinela)

Una vez enumerados todos los procesos:

1. El malware construye un último registro de 0x108 bytes.
2. El nombre (0x100 bytes) se rellena con ceros y se ofusca con XOR `0x55`.
3. El **primer DWORD de la cola se establece a 0**, indicando fin de lista.
4. El registro se envía al C2 sin esperar nuevos ACKs.

Este registro actúa como **marcador explícito de finalización**.

---

## 10. Análisis dinámico observado

Durante la ejecución controlada del Opcode 7 se observó que:

- Se enumeran **todos los procesos**, incluyendo:
  - Procesos del sistema (`System`, `csrss.exe`, `svchost.exe`)
  - Servicios
  - Aplicaciones de usuario
  - Herramientas de análisis (por ejemplo `x32dbg.exe`)
- El C2 recibe los registros de forma secuencial y fiable.
- El mecanismo de ACK evita pérdidas incluso en redes inestables.

---

## 11. Implicaciones para el operador C2

El Opcode 7 permite al atacante:

- Identificar procesos de seguridad o análisis
- Detectar entornos virtualizados
- Localizar procesos específicos para:
  - Terminarlos (Opcode 8)
  - Inyectar código (potencial extensión)
- Adaptar el comportamiento del malware al entorno

Combinado con otros opcodes, este módulo completa la fase de **reconocimiento del host**.

---

## 12. Relación con otros opcodes

Flujo típico de uso:

1. Opcode 1 → enumerar discos
2. Opcode 2 → listar archivos
3. **Opcode 7 → enumerar procesos**
4. Opcode 8 → terminar procesos específicos
5. Opcode 3 / 5 / 6 → acciones sobre el sistema

Esto demuestra un **diseño modular y coherente** del protocolo C2.

---

## 13. Conclusiones

El Opcode 7 implementa una funcionalidad completa y fiable de **enumeración de procesos**, utilizando:

- APIs estándar de Windows
- Ofuscación simple y consistente
- Registros de tamaño fijo
- Control de flujo basado en ACKs

Esta implementación refuerza la clasificación del malware como un **backdoor interactivo avanzado**, capaz de adaptar sus acciones al entorno de ejecución.

---

## 14. Transición al siguiente opcode

Tras enviar el registro de fin de listado, el malware retorna al bucle principal y queda a la espera de nuevas instrucciones del servidor C2.





## 15. Opcode7 en crudo:
- [FUN_00402310-opcode7](../decompilado/FUN_00402310-opcode7.md)
