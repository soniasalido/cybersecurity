# Malware Analysis – Lab 3.2 (RPISEC)

## 1. Introducción

El objetivo de este laboratorio es analizar de forma estática y dinámica la muestra **Lab 3.2** del curso de *Malware Analysis* de RPISEC (basado en *Practical Malware Analysis*). El análisis se centra en comprender el comportamiento de red, el protocolo de comunicación con el servidor de mando y control (C2), la lógica interna del malware y el uso de un *overlay* como contenedor de datos adicionales.

Este informe reorganiza y unifica las evidencias obtenidas durante el análisis para presentar una visión coherente y profesional del funcionamiento del malware.

---

## 2. Entorno de análisis

### 2.1 Máquinas virtuales

* **Windows**: sistema víctima utilizado para ejecutar la muestra bajo depuración.
* **REMnux (Linux)**: sistema de análisis de red y simulación de C2.

Ambas máquinas se configuraron en la misma red (Host-Only / Red interna), permitiendo comunicación directa.

### 2.2 Herramientas utilizadas

* x32dbg (depuración dinámica)
* Ghidra (análisis estático y decompilación)
* tcpdump (captura de tráfico)
* Python (listener TCP para simular el C2)

---

## 3. Información básica de la muestra

* **Nombre**: Lab_03-2.malware
* **Tipo**: DLL
* **Arquitectura**: x86 (32 bits)
* **Ejecución**: mediante `rundll32`
* **Características destacadas**:

  * Comunicación de red con C2
  * Protocolo propio
  * Uso de overlay

---

## 4. Análisis estático

### 4.1 Strings relevantes

Durante el análisis estático se identificaron cadenas clave que anticipan el comportamiento de red:

* `us.t28.net`
* `fxftest`

Estas cadenas se correlacionan posteriormente con el análisis dinámico.

### 4.2 APIs relevantes

El binario importa funciones relacionadas con:

* Red: `socket`, `connect`, `send`, `recv`, `gethostbyname`
* Sistema de archivos: `FindFirstFileW`, `FindNextFileW`, `CreateFileW`, `ReadFile`

---

## 5. Análisis dinámico

### 5.1 Ejecución y control de flujo

La muestra se ejecuta y rápidamente entra en un bucle asociado a operaciones de red. Bajo depuración con x32dbg se observó que el bucle depende del resultado de llamadas a `recv`.

El malware no progresa si no recibe una respuesta válida desde el servidor remoto.

### 5.2 Resolución de red

El dominio utilizado por la muestra es:

* **C2**: `us.t28.net`
* **Puerto**: 443/TCP

El puerto 443 se utiliza como camuflaje, pero **no se emplea TLS real**. El protocolo es texto plano.

La resolución del dominio se forzó mediante el archivo `hosts` de Windows para redirigir el tráfico hacia REMnux.

---

## 6. Comunicación C2

### 6.1 Protocolo observado

El flujo de comunicación observado es:

1. El malware conecta a `us.t28.net:443`

2. Envía la cadena:

   `fxftest`

3. Espera una respuesta de **8 bytes**

4. Si la respuesta no es válida, entra en bucle y reintenta

### 6.2 Listener simulado

Se implementó un listener TCP en REMnux (Python) que:

* Escucha en `0.0.0.0:443`
* Registra los datos recibidos
* Responde con 8 bytes (`12345678`)

Esto permitió romper el bucle de espera y avanzar el flujo del malware.

---

## 7. Protocolo interno y opcodes

El string `fxftest` actúa como un **opcode o comando inicial** del protocolo propietario del malware.

El análisis en Ghidra permitió identificar funciones dedicadas al procesamiento de distintos códigos de operación, incluyendo:

* Copia y manipulación de buffers
* Decisiones basadas en la respuesta recibida

El listener simulado funcionó correctamente para el opcode `fxftest`, aunque el malware puede soportar otros comandos.

---

## 8. Uso del overlay

### 8.1 Extracción

La muestra contiene un **overlay** al final del binario, extraído mediante scripts en Python.

### 8.2 Procesamiento

El análisis de las funciones asociadas al overlay muestra que:

* El malware lee datos del overlay
* Los procesa y los escribe a disco
* El overlay actúa como contenedor de datos adicionales (posible payload secundario o configuración)

---

## 9. Enumeración y acceso a archivos

Tras superar la fase de comunicación de red, el malware procede a:

* Enumerar directorios (`FindFirstFileW`, `FindNextFileW`)
* Abrir y leer archivos (`CreateFileW`, `ReadFile`)

Esto sugiere capacidades de descubrimiento y posible exfiltración.

---

## 10. Indicadores de Compromiso (IOCs)

### Red

* Dominio: `us.t28.net`
* Puerto: 443/TCP
* Protocolo: TCP texto plano

### Strings

* `fxftest`

### Comportamiento

* Conexiones TCP persistentes
* Bucle dependiente de respuesta del C2

---

## 11. Conclusiones

La muestra Lab 3.2 implementa un **backdoor sencillo pero bien estructurado**, con:

* Protocolo de red propietario
* Uso de puertos comunes para evasión
* Dependencia directa del C2 para avanzar en su ejecución
* Uso de overlay para ocultar datos adicionales

El análisis demuestra cómo una correcta simulación del servidor C2 es clave para comprender completamente el comportamiento del malware. La combinación de análisis dinámico y estático permitió correlacionar comandos, funciones internas y comportamiento observable en red.

Este laboratorio ilustra técnicas fundamentales utilizadas por malware real y refuerza la importancia de controlar el entorno de ejecución durante el análisis.

