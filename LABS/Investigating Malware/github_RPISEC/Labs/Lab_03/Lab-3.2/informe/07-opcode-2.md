# Opcode 2 – Enumeración y exfiltración de ficheros

## Identificación
- **Función:** `FUN_00401A20`
- **Opcode:** `0x02`
- **Categoría:** Enumeración de sistema de archivos + Exfiltración
- **APIs principales:**  
  `FindFirstFileA`, `FindNextFileA`, `SHGetFileInfoA`,  
  `FileTimeToSystemTime`, `send`, `recv`

---

## Descripción general

El **Opcode 2** permite al servidor C2 **ordenar al malware que enumere archivos y directorios locales** según un patrón recibido (por ejemplo `C:\Users\*\Desktop\*`) y **exfiltrar metadatos de cada entrada encontrada**.

La comunicación se realiza mediante **frames de tamaño fijo (0x204 bytes)** y un **mecanismo explícito de ACK de 2 bytes**, lo que permite control de flujo y reintentos.

---

## Entrada del opcode

El C2 envía un paquete de **0x104 bytes** con la siguiente estructura:

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 4     | Opcode (`0x02`, little-endian) |
| 0x04 | 256   | Patrón de búsqueda ofuscado |

### Ofuscación del patrón
- El patrón está **XOReado con `0x55`**.
- El malware deofusca los **primeros 256 bytes** antes de llamar a `FindFirstFileA`.

Ejemplo de patrón lógico:
```"C:\Users\usuario\Desktop\*"```

(enviado padded a 256 bytes y luego XOR 0x55)

---

## Flujo de ejecución

### 1. Deofuscación
- Bucle XOR `0x55` sobre los 256 bytes del patrón.
- Resultado: cadena ASCII válida para APIs de Windows.

### 2. Primera búsqueda
- Llamada a `FindFirstFileA`.
- Si **no hay coincidencias**:
  - Envía 2 bytes: `0x71 0x00` (`'q'`)
  - Retorna al bucle principal.
- Si **hay coincidencias**:
  - Envía 2 bytes: `0x6F 0x00` (`'o'`)
  - Entra en modo listado.

---

## Formato de los datos exfiltrados

Por cada archivo o directorio encontrado, el malware envía un **frame de 0x204 bytes**:

### Estructura del frame (0x204 bytes)

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x000 | 0x100 | **Zona ofuscada (XOR 0x55)** |
| 0x100 | 0x104 | Metadatos en claro |

### Contenido lógico del frame
- Nombre del archivo o directorio.
- Tipo:
  - `"DIR"` si es directorio.
  - Cadena vacía / alternativa si es fichero.
- Tamaño en KB.
- Timestamp (`YYYY-MM-DD HH:MM:SS`).

Los **primeros 0x100 bytes se XORean con `0x55` antes de enviarse**.

---

## Mecanismo de ACK y control de flujo

Después de **cada frame de 0x204 bytes**, el malware:

1. Llama a `recv()` esperando **2 bytes de ACK**.
2. Pasa el ACK a `FUN_0040296D`:
   - **Retorno ≠ 0:** reenvía el mismo frame.
   - **Retorno = 0:** continúa con el siguiente archivo.

Un ACK típico válido es:
```00 00```


---

## Fin de la enumeración

Cuando `FindNextFileA` devuelve `ERROR_NO_MORE_FILES (0x12)`:

- El malware construye un **último frame**:
  - Flag interno a `0` (fin de lista).
  - Mismo formato (0x204 bytes, XOR incluido).
- Envía el frame final.
- Cierra el handle con `FindClose`.
- Retorna al bucle principal para esperar un nuevo opcode.

---

## Implicaciones para el servidor C2

Para soportar correctamente el **Opcode 2**, el C2 debe:

1. Enviar:
   - `opcode = 2`
   - Patrón de búsqueda XOR `0x55`, padded a 256 bytes.
2. Recibir:
   - 2 bytes de estado inicial (`'o'` o `'q'`).
3. Si recibe `'o'`:
   - Leer frames de 0x204 bytes.
   - Desofuscar los primeros 0x100 bytes con XOR `0x55`.
   - Responder **2 bytes de ACK por cada frame**.
4. Detectar el frame final (flag = 0).

---

## Resumen funcional

- **Opcode 2 = “Listar archivos remotos”**
- El C2 controla:
  - Qué ruta se enumera.
  - El ritmo de exfiltración (ACK).
- El malware:
  - No envía contenido de archivos, solo **metadatos**.
  - Usa ofuscación simple (XOR) y tamaños fijos para el protocolo.

Este opcode confirma que la muestra implementa un **protocolo C2 interactivo, fiable y orientado a reconocimiento del host**.

---





## Opcode2 en crudo:
- [FUN_00401A20-opcode2](../decompilado/FUN_00401A20-opcode2.md)
