# Opcode 4 – Eliminación remota de archivos  
**Muestra:** Lab_03-2.malware  
**Curso/Lab:** RPISEC – Investigating Malware – Lab 3.2

---

## 1. Introducción

El **Opcode 4** implementa la funcionalidad de **eliminación remota de archivos** en el sistema comprometido.  
Permite al servidor C2 ordenar al malware que borre un archivo específico, cuyo nombre es enviado de forma ofuscada, y recibir posteriormente un **código de estado** indicando si la operación se realizó con éxito o falló.

Este opcode representa una capacidad típica de **control destructivo** dentro de un backdoor interactivo.

---

## 2. Función principal asociada

- **Función:** [FUN_004020A0](../decompilado/FUN_004020A0-opcode4.md)
- **Opcode:** `0x04`
- **Invocada desde:** dispatcher principal (`FUN_004012F0`)
- **Objetivo:** eliminar un archivo indicado por el C2

---

## 3. Resumen funcional

Cuando se ejecuta el Opcode 4, el malware realiza las siguientes acciones:

1. Recibe un buffer con la ruta del archivo objetivo, ofuscada.
2. Descifra la ruta aplicando una operación XOR con clave `0x55`.
3. Intenta eliminar el archivo usando la API `DeleteFileA`.
4. Evalúa el resultado de la operación.
5. Reporta al servidor C2 un código de estado indicando éxito o fallo.

---

## 4. Entrada del opcode

El servidor C2 debe enviar un bloque con la siguiente estructura lógica:

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 4     | Opcode `0x04` (little-endian) |
| 0x04 | 256   | Ruta del archivo ofuscada (XOR `0x55`) |

La ruta está **rellenada (padding)** hasta 256 bytes antes de ser ofuscada.

Ejemplo de ruta lógica antes de ofuscación:

```C:\Users\usuario\Desktop\prueba.txt```


---

## 5. Descifrado de la ruta

El malware descifra la ruta mediante un bucle XOR:
```
for i in range(0, 256):
buffer[i] ^= 0x55
``` 


Tras este proceso:
- El buffer contiene una **cadena ASCII válida**
- El puntero se pasa directamente a `DeleteFileA`

Este mecanismo de ofuscación es idéntico al utilizado en otros opcodes, lo que confirma un **diseño coherente del protocolo**.

---

## 6. Eliminación del archivo

La eliminación se realiza mediante la API de Windows:
```DeleteFileA(lpFileName)```



Resultado:
- **EAX ≠ 0** → archivo eliminado correctamente
- **EAX = 0** → fallo (archivo inexistente, permisos insuficientes, etc.)

Durante el análisis dinámico se comprobó que:
- La primera ejecución elimina el archivo con éxito.
- Ejecuciones posteriores fallan si el archivo ya no existe.

---

## 7. Evaluación del resultado

Tras la llamada a `DeleteFileA`, el malware ejecuta:
```test eax, eax```


Dependiendo del resultado, toma una de las dos ramas:

- **Éxito:** construcción de un mensaje de estado “success”
- **Fallo:** construcción de un mensaje de estado “error”

---

## 8. Reporte al servidor C2

El resultado se envía al C2 mediante:

- `WS2_32.DLL::send` (ordinal 19)

Características del reporte:
- **Tamaño:** 2 bytes
- **Contenido:** código de estado

Valores observados:
- `0x30 0x00` → eliminación exitosa
- `0x31 0x00` → fallo en la eliminación

Este mecanismo permite al operador C2 conocer inmediatamente el resultado de la acción solicitada.

---

## 9. Análisis dinámico observado

Durante la ejecución controlada del Opcode 4 se observó:

- El archivo objetivo es eliminado del sistema de archivos.
- No se realizan comprobaciones adicionales (por ejemplo, tipo de archivo).
- El malware no reintenta la eliminación si falla.
- El resultado se comunica inmediatamente al servidor.

Esto confirma que el Opcode 4 es **determinista y directo**, sin lógica de recuperación.

---

## 10. Implicaciones para el operador C2

Desde la perspectiva del atacante, este opcode permite:

- Eliminar evidencias locales
- Borrar archivos específicos del sistema
- Forzar estados de error en aplicaciones de la víctima
- Preparar el entorno para otras acciones (descarga, ejecución, etc.)

Combinado con otros opcodes (2 y 3), permite un **control completo del sistema de archivos**.

---

## 11. Relación con otros opcodes

El Opcode 4 suele utilizarse junto con:

- **Opcode 2:** identificar archivos de interés
- **Opcode 3:** ejecutar comandos que generen archivos temporales
- **Opcode 5:** descargar nuevos archivos

Esto demuestra un diseño modular y encadenable del protocolo C2.

---

## 12. Conclusiones

El Opcode 4 implementa una funcionalidad clara de **eliminación remota de archivos**, utilizando un protocolo simple y consistente con el resto del malware.

Aunque la técnica empleada es básica, su integración dentro de un sistema C2 basado en opcodes refuerza la clasificación de la muestra como un **backdoor interactivo completamente funcional**.

---

## 13. Transición al siguiente opcode

Tras reportar el resultado de la eliminación, el malware retorna al bucle principal y queda a la espera de nuevas instrucciones del servidor C2.

El análisis continúa con:




## 14. Opcode4 en crudo:
- [FUN_004020A0-opcode4](../decompilado/FUN_004020A0-opcode4.md)
