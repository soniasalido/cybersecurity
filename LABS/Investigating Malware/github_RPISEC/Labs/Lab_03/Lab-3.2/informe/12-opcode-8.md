# Opcode 8 – Terminación remota de procesos  
**Muestra:** Lab_03-2.malware  
**Curso/Lab:** RPISEC – Investigating Malware – Lab 3.2

---

## 1. Introducción

El **Opcode 8** implementa la funcionalidad de **terminación remota de procesos** en el sistema comprometido.  
Permite al servidor C2 ordenar al malware que finalice un proceso específico identificado por su **PID (Process ID)**, y recibir una confirmación inmediata del resultado.

Este opcode complementa directamente al **Opcode 7 (enumeración de procesos)** y proporciona al operador capacidades activas de **interrupción y control del entorno de ejecución**.

---

## 2. Función principal asociada

- **Función:** [FUN_00402440](../decompilado/FUN_00402440-opcode8.md)
- **Opcode:** `0x08`
- **Invocada desde:** dispatcher principal (`FUN_004012F0`)
- **Objetivo:** terminar un proceso remoto por PID

---

## 3. Resumen funcional

Cuando se ejecuta el Opcode 8, el malware realiza las siguientes acciones:

1. Recibe un identificador de proceso (PID) en formato ASCII.
2. Convierte el PID a valor entero.
3. Intenta abrir el proceso con permisos de terminación.
4. Llama a `TerminateProcess` sobre el proceso objetivo.
5. Evalúa el resultado de la operación.
6. Envía al C2 un **código de estado de 2 bytes** indicando éxito o fallo.

La función no implementa reintentos ni validaciones adicionales.

---

## 4. Entrada del opcode

El servidor C2 envía un buffer con la siguiente estructura lógica:

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 4     | Opcode `0x08` (little-endian) |
| 0x04 | n     | PID del proceso en ASCII (`"1234"`) |

El PID se recibe como **cadena ASCII**, no como entero binario.

---

## 5. Parseo del PID

El malware llama a una función auxiliar:

- `FUN_0040296D`

Esta función:
- Recibe un puntero a la cadena ASCII con el PID.
- Convierte la cadena a entero (equivalente a `atoi`).
- Devuelve el PID en `EAX`.

Durante el análisis dinámico se confirmó que el PID convertido coincide con el enviado por el C2.

---

## 6. Apertura del proceso

El malware intenta abrir el proceso mediante:
```
OpenProcess(
dwDesiredAccess = PROCESS_TERMINATE (0x1),
bInheritHandle = FALSE,
dwProcessId = PID
)
```


Resultados:
- **Éxito:** `EAX` contiene un handle válido.
- **Fallo:** `EAX = 0`

Durante el análisis dinámico se forzó manualmente el valor de retorno para simular ambos casos.

---

## 7. Terminación del proceso

Si `OpenProcess` devuelve un handle válido, el malware ejecuta:
```
TerminateProcess(
hProcess,
0xFFFFFFFF
)
```



El código de salida (`-1`) no tiene significado funcional adicional.

Resultado:
- **EAX ≠ 0:** proceso terminado con éxito
- **EAX = 0:** fallo en la terminación

---

## 8. Evaluación del resultado

Tras la llamada a `TerminateProcess`, el malware evalúa el valor de retorno con:
```test eax, eax```


Dependiendo del resultado, toma una de dos ramas:

- **Éxito**
- **Fallo**

No se realizan comprobaciones adicionales sobre el estado del proceso tras la llamada.

---

## 9. Reporte al servidor C2

El resultado de la operación se envía al C2 mediante:

- `WS2_32.DLL::Ordinal_19` (equivalente a `send()`)

Características del mensaje:
- **Tamaño:** 2 bytes
- **Contenido:** código de estado ASCII

Valores observados:

| Código | Significado |
|------|------------|
| `0x30 0x00` (`"0"`) | Terminación exitosa |
| `0x31 0x00` (`"1"`) | Fallo al terminar el proceso |

Este esquema es consistente con otros opcodes de control (por ejemplo, Opcode 3 y Opcode 4).

---

## 10. Análisis dinámico observado

Durante la ejecución controlada del Opcode 8 se observó que:

- El malware termina correctamente procesos accesibles.
- Falla silenciosamente en procesos protegidos o inexistentes.
- El resultado se reporta inmediatamente al C2.
- No existe persistencia del estado tras la ejecución.

La capacidad se probó tanto con procesos de usuario como con procesos arbitrarios enviados por el C2.

---

## 11. Implicaciones para el operador C2

El Opcode 8 permite al atacante:

- Terminar herramientas de análisis o depuración.
- Interrumpir aplicaciones específicas.
- Desactivar software de seguridad poco protegido.
- Preparar el entorno para otras acciones (ejecución, exfiltración).

Combinado con **Opcode 7**, permite un ciclo completo de:
> enumerar procesos → seleccionar objetivo → terminar proceso.

---

## 12. Relación con otros opcodes

Flujo típico de uso:

1. Opcode 7 → enumerar procesos
2. Opcode 8 → terminar proceso seleccionado
3. Opcode 3 / 5 / 6 → ejecutar o desplegar payloads adicionales

Este patrón refuerza la arquitectura modular del protocolo C2.

---

## 13. Conclusiones

El Opcode 8 implementa una funcionalidad directa y efectiva de **terminación remota de procesos**, utilizando APIs estándar de Windows y un protocolo simple basado en códigos de estado.

Aunque no incluye mecanismos avanzados de evasión o persistencia, su integración dentro del sistema de opcodes convierte a la muestra en un **backdoor interactivo con capacidad activa de control del entorno**.

---

## 14. Transición al siguiente opcode

Tras reportar el resultado de la terminación del proceso, el malware retorna al bucle principal y queda a la espera de nuevas instrucciones del servidor C2.



## 15. Opcode8 en crudo:
- [FUN_00402440-opcode8](../decompilado/FUN_00402440-opcode8.md)
