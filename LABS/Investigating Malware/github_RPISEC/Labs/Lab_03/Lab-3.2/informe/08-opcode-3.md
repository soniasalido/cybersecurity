# Opcode 3 – Ejecución remota de comandos  
**Muestra:** Lab_03-2.malware  
**Curso/Lab:** RPISEC – Investigating Malware – Lab 3.2

---

## 1. Introducción

El **Opcode 3** implementa la capacidad de **ejecución remota de comandos** en el sistema comprometido.  
Este opcode permite al servidor C2 enviar un comando ofuscado que el malware descifra y ejecuta localmente, reportando únicamente el **estado de la ejecución**, pero **no la salida estándar** del comando.

Funcionalmente, este comportamiento corresponde a un **módulo de ejecución remota simple**, típico en backdoors de primera etapa.

---

## 2. Función principal asociada

- **Función:** [FUN_00402050](../decompilado/FUN_00402050-opcode3.md)
- **Opcode:** `0x03`
- **Invocada desde:** dispatcher principal (`FUN_004012F0`)
- **Objetivo:** ejecutar un comando proporcionado por el C2

---

## 3. Resumen funcional

Cuando el servidor envía el Opcode 3, el malware:

1. Recibe un buffer de **256 bytes** con un comando ofuscado.
2. Descifra el buffer aplicando **XOR con clave `0x55`**.
3. Ejecuta el comando descifrado mediante la API `WinExec`.
4. Evalúa el resultado de la ejecución.
5. Envía al C2 un **código de estado de 2 bytes** indicando éxito o error.

En ningún momento se captura ni se exfiltra la salida del comando ejecutado.

---

## 4. Entrada del opcode

El C2 debe enviar un bloque con la siguiente estructura lógica:

| Offset | Tamaño | Descripción |
|------|-------|------------|
| 0x00 | 4     | Opcode `0x03` (little-endian) |
| 0x04 | 256   | Comando ofuscado (XOR `0x55`) |

El comando está **padded** hasta 256 bytes y posteriormente ofuscado.

Ejemplo de comando lógico antes de ofuscación:
```cmd.exe /c whoami```



---

## 5. Descifrado del comando

El malware ejecuta un bucle de 256 iteraciones donde cada byte del buffer es transformado:
```byte = byte XOR 0x55```


Tras el bucle:
- El buffer contiene una **cadena ASCII válida**
- `ECX` apunta al comando en claro

Este método de ofuscación es trivial, pero suficiente para evitar firmas de strings directas.

---

## 6. Ejecución mediante WinExec

El comando descifrado se ejecuta mediante:
```WinExec(lpCmdLine, SW_HIDE)```


Parámetros observados:
- `lpCmdLine` → comando en claro
- `SW_HIDE (0)` → ejecución sin mostrar ventana

La función `WinExec` devuelve:
- **Valor > 31 (0x1F)** → ejecución exitosa
- **Valor ≤ 31** → error

---

## 7. Evaluación del resultado

El malware compara el valor de retorno:
```cmp eax, 1Fh```


- Si la ejecución es exitosa:
  - Se construye un buffer de estado indicando **éxito**
- Si falla:
  - Se construye un buffer indicando **error**

Este diseño permite al C2 saber si el comando se ejecutó, pero **no conocer su salida**.

---

## 8. Reporte al servidor C2

El resultado se envía mediante:

- `WS2_32.DLL::send` (ordinal 19)

Características del reporte:
- **Tamaño:** 2 bytes
- **Contenido:** código de estado

Ejemplo observado durante el análisis dinámico:
```30 00```


Este valor indica una ejecución correcta del comando enviado.

---

## 9. Análisis dinámico observado

Durante la ejecución controlada del Opcode 3 se observó:

- El comando se ejecuta correctamente en la VM infectada (ej. `whoami`, `calc.exe`)
- El malware **no redirige stdout ni stderr**
- El C2 recibe únicamente el estado binario (éxito / fallo)

Esto confirma que el Opcode 3 está diseñado para **acciones ciegas**, no para obtención directa de resultados.

---

## 10. Implicaciones para el operador C2

Desde el punto de vista del atacante, este opcode permite:

- Lanzar binarios locales
- Ejecutar comandos del sistema
- Iniciar otros payloads
- Establecer persistencia adicional

Sin embargo:
- No permite recuperar la salida de los comandos
- Requiere otros opcodes para enumeración o exfiltración

---

## 11. Relación con otros opcodes

El Opcode 3 suele utilizarse tras:

- Opcode 1 (enumeración de discos)
- Opcode 2 (listado de archivos)

Esto permite al operador:
1. Reconocer el sistema
2. Localizar binarios o rutas de interés
3. Ejecutar acciones específicas

---

## 12. Conclusiones

El Opcode 3 implementa una funcionalidad clara de **ejecución remota de comandos**, usando un protocolo simple y controlado por el servidor C2.

Aunque la implementación es básica, es suficiente para:
- Control remoto del host
- Lanzamiento de acciones arbitrarias
- Coordinación con otros módulos del malware

Este opcode refuerza la clasificación de la muestra como un **backdoor interactivo**, y demuestra cómo el diseño modular basado en opcodes permite extender fácilmente las capacidades del malware.

---

## 13. Transición al siguiente opcode

Tras completar la ejecución del comando y reportar el estado, el malware retorna al bucle principal y queda a la espera de nuevas instrucciones del C2.




## 14. Opcode3 en crudo:
- [FUN_00402050-opcode3](../decompilado/FUN_00402050-opcode3.md)
