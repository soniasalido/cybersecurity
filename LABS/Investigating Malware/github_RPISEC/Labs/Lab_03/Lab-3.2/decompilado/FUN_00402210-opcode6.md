# FUN_00402210

## 1. Par√°metros
```
undefined4 param_1
LPCSTR param_2
```
- param_2 es una cadena (LPCSTR), seguramente el nombre/posici√≥n de un archivo.

- param_1 parece no utilizarse.

## 2. Inicio y obfuscaci√≥n simple de cadena (XOR 0x55, 256 bytes)
```
MOV  ECX, [ESP+param_2]
...
LOOP:
    BL = [ECX + EAX]
    BL ^= 0x55
    [ECX + EAX] = BL
    EAX++
    CMP EAX, 0x100
JL LOOP
```
- Toma los primeros 256 bytes de la cadena apuntada por param_2 y les aplica un XOR con 0x55.

- Esto normalmente se usa como desofuscaci√≥n/cifrado ligero de un buffer o ruta de archivo.

## 3. Apertura de archivo con CreateFileA
```
CreateFileA(param_2, GENERIC_READ | GENERIC_WRITE, ...)
```
- ¬°Accede al archivo cuyo nombre estaba en param_2 (ya transformado por el XOR).

- ACCESOS: 0x80000000 es GENERIC_READ, 0x1 es CREATE_NEW/OPEN_EXISTING ‚Üí parece apertura est√°ndar RW.

## 4. Mapping del archivo en memoria
```
CreateFileMappingA con PAGE_READWRITE.
```
- MapViewOfFile para obtener acceso directo a la memoria del archivo.
- Esto le permite leer o modificar el archivo en memoria f√°cilmente.

## 5. Obtenci√≥n del tama√±o de archivo
```
GetFileSize(hFile) ‚Üí guarda en [ESP+20Ch]
```

## 5. M√°scriptado de un buffer de 0x200 bytes en stack
```
LOOP2:
    CL = [ESP + EAX + 0x0C]
     CL ^= 0x55
    [ESP + EAX + 0x0C] = CL
    ...
    CMP EAX, 0x200
JL LOOP2
```
- Hace otro XOR 0x55 sobre 512 bytes contenidos en el stack (probablemente un bloque recibido o preparado antes de enviar).
- Es l√≥gico pensar que este bloque es el encabezado o payload que se va a transmitir/inyectar.

## 6. Uso de WS2_32.DLL Ordinal_19
- Dos llamadas a WS2_32.DLL::Ordinal_19.
- Esa API (n√∫mero por ordinal, no por nombre) es sospechosa -> fugas de datos, env√≠o de informaci√≥n.  
        Muchos malware lo hacen para evitar detecci√≥n usando nombres como send, recv, connect.
- Probablemente estas llamadas son:
    - send de (MapViewOfFile result ‚Üí EDI) junto con los datos procesados.
    - Podr√≠a ser tambi√©n WSASend o algo que exfiltra el archivo.

## 7. Limpieza
```
UnmapViewOfFile
```
- Cierra handles (CloseHandle de FileMapping y File).
- Restaura pila y hace RET.

## Indicadores claros
- XOR 0x55 ‚Üí m√©todo cl√°sico de cifrado d√©bil (ocultar strings o datos en el binario).
- Manipulaci√≥n de archivo en memoria ‚Üí abre archivo, lo mapea, lo procesa.
- Rutinas con Winsock (WS2_32 Ord19) ‚Üí transmisi√≥n de datos por red.
- Cierra todo cuidadosamente ‚Üí comportamiento de malware que intenta permanecer estable.

## Conclusi√≥n
- Desofusca un string (XOR 0x55, 256 bytes) que probablemente sea un nombre de archivo u objeto incrustado.
- Intenta abrir y mapear ese archivo en memoria.
- Hace otros XOR sobre un buffer de 512 bytes en stack (payload?).
- Usa Winsock (con un ordinal, no con nombres de funci√≥n) para enviar datos/memoria a trav√©s de la red.
- Finalmente limpia y cierra todo.

**üëâ Es una rutina de exfiltraci√≥n o carga remota de un archivo, camuflada con XOR muy simple.**

```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined __cdecl FUN_00402210(undefined4 param_1, LPCST
                               assume FS_OFFSET = 0xffdff000
             undefined         <UNASSIGNED>   <RETURN>
             undefined4        Stack[0x4]:4   param_1
             LPCSTR            Stack[0x8]:4   param_2                                 XREF[1]:     00402210(R)  
                             FUN_00402210                                    XREF[1]:     FUN_004012f0:00401789(c)  
        00402210 8b 4c 24 08     MOV        ECX,dword ptr [ESP + param_2]
        00402214 81 ec 04        SUB        ESP,0x204
                 02 00 00
        0040221a 33 c0           XOR        EAX,EAX
        0040221c 53              PUSH       EBX
        0040221d 56              PUSH       ESI
        0040221e 57              PUSH       EDI
                             LAB_0040221f                                    XREF[1]:     0040222e(j)  
        0040221f 8a 1c 08        MOV        BL,byte ptr [EAX + ECX*0x1]
        00402222 80 f3 55        XOR        BL,0x55
        00402225 88 1c 08        MOV        byte ptr [EAX + ECX*0x1],BL
        00402228 40              INC        EAX
        00402229 3d 00 01        CMP        EAX,0x100
                 00 00
        0040222e 7c ef           JL         LAB_0040221f
        00402230 6a 00           PUSH       0x0
        00402232 68 00 00        PUSH       0x8000000
                 00 08
        00402237 6a 03           PUSH       0x3
        00402239 6a 00           PUSH       0x0
        0040223b 6a 01           PUSH       0x1
        0040223d 68 00 00        PUSH       0x80000000
                 00 80
        00402242 51              PUSH       ECX
        00402243 ff 15 40        CALL       dword ptr [->KERNEL32.DLL::CreateFileA]          = 0000993c
                 90 40 00
        00402249 8b f0           MOV        ESI,EAX
        0040224b 83 fe ff        CMP        ESI,-0x1
        0040224e 0f 84 a9        JZ         LAB_004022fd
                 00 00 00
        00402254 6a 00           PUSH       0x0
        00402256 6a 00           PUSH       0x0
        00402258 6a 00           PUSH       0x0
        0040225a 68 02 00        PUSH       0x8000002
                 00 08
        0040225f 6a 00           PUSH       0x0
        00402261 56              PUSH       ESI
        00402262 ff 15 50        CALL       dword ptr [->KERNEL32.DLL::CreateFileMappingA]   = 0000997a
                 90 40 00
        00402268 8b d8           MOV        EBX,EAX
        0040226a 85 db           TEST       EBX,EBX
        0040226c 75 11           JNZ        LAB_0040227f
        0040226e 56              PUSH       ESI
        0040226f ff 15 38        CALL       dword ptr [->KERNEL32.DLL::CloseHandle]          = 00009922
                 90 40 00
        00402275 5f              POP        EDI
        00402276 5e              POP        ESI
        00402277 5b              POP        EBX
        00402278 81 c4 04        ADD        ESP,0x204
                 02 00 00
        0040227e c3              RET
                             LAB_0040227f                                    XREF[1]:     0040226c(j)  
        0040227f 6a 00           PUSH       0x0
        00402281 6a 00           PUSH       0x0
        00402283 6a 00           PUSH       0x0
        00402285 6a 04           PUSH       0x4
        00402287 53              PUSH       EBX
        00402288 ff 15 4c        CALL       dword ptr [->KERNEL32.DLL::MapViewOfFile]        = 0000996a
                 90 40 00
        0040228e 8b f8           MOV        EDI,EAX
        00402290 85 ff           TEST       EDI,EDI
        00402292 74 5d           JZ         LAB_004022f1
        00402294 6a 00           PUSH       0x0
        00402296 56              PUSH       ESI
        00402297 ff 15 88        CALL       dword ptr [->KERNEL32.DLL::GetFileSize]          = 0000995c
                 90 40 00
        0040229d 89 84 24        MOV        dword ptr [ESP + 0x20c],EAX
                 0c 02 00 00
        004022a4 33 c0           XOR        EAX,EAX
                             LAB_004022a6                                    XREF[1]:     004022b7(j)  
        004022a6 8a 4c 04 0c     MOV        CL,byte ptr [ESP + EAX*0x1 + 0xc]
        004022aa 80 f1 55        XOR        CL,0x55
        004022ad 88 4c 04 0c     MOV        byte ptr [ESP + EAX*0x1 + 0xc],CL
        004022b1 40              INC        EAX
        004022b2 3d 00 02        CMP        EAX,0x200
                 00 00
        004022b7 7c ed           JL         LAB_004022a6
        004022b9 55              PUSH       EBP
        004022ba 8b ac 24        MOV        EBP,dword ptr [ESP + 0x218]
                 18 02 00 00
        004022c1 6a 00           PUSH       0x0
        004022c3 8d 44 24 14     LEA        EAX,[ESP + 0x14]
        004022c7 68 04 02        PUSH       0x204
                 00 00
        004022cc 50              PUSH       EAX
        004022cd 55              PUSH       EBP
        004022ce ff 15 68        CALL       dword ptr [->WS2_32.DLL::Ordinal_19]             = 80000013
                 91 40 00
        004022d4 8b 8c 24        MOV        ECX,dword ptr [ESP + 0x210]
                 10 02 00 00
        004022db 6a 00           PUSH       0x0
        004022dd 51              PUSH       ECX
        004022de 57              PUSH       EDI
        004022df 55              PUSH       EBP
        004022e0 ff 15 68        CALL       dword ptr [->WS2_32.DLL::Ordinal_19]             = 80000013
                 91 40 00
        004022e6 5d              POP        EBP
        004022e7 83 f8 ff        CMP        EAX,-0x1
        004022ea 57              PUSH       EDI
        004022eb ff 15 44        CALL       dword ptr [->KERNEL32.DLL::UnmapViewOfFile]      = 0000994a
                 90 40 00
                             LAB_004022f1                                    XREF[1]:     00402292(j)  
        004022f1 8b 3d 38        MOV        EDI,dword ptr [->KERNEL32.DLL::CloseHandle]      = 00009922
                 90 40 00
        004022f7 53              PUSH       EBX
        004022f8 ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
        004022fa 56              PUSH       ESI
        004022fb ff d7           CALL       EDI=>KERNEL32.DLL::CloseHandle
                             LAB_004022fd                                    XREF[1]:     0040224e(j)  
        004022fd 5f              POP        EDI
        004022fe 5e              POP        ESI
        004022ff 5b              POP        EBX
        00402300 81 c4 04        ADD        ESP,0x204
                 02 00 00
        00402306 c3              RET
        00402307 90              ??         90h
        00402308 90              ??         90h
        00402309 90              ??         90h
        0040230a 90              ??         90h
        0040230b 90              ??         90h
        0040230c 90              ??         90h
        0040230d 90              ??         90h
        0040230e 90              ??         90h
        0040230f 90              ??         90h

``
    
