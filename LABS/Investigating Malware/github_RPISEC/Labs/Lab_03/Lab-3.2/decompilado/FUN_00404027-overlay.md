# FUN_00404027 - Overlay

Esta función FUN_00404027() confirma que el malware utiliza un overlay como una fuente de instrucciones estructuradas, y esta función interpreta y ejecuta una parte de esas instrucciones. Esta función es la rutina que el malware usa para moverse dentro de su propio ejecutable (concretamente en la zona del overlay).


```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             DWORD __cdecl FUN_00404027(uint param_1, LONG param_2, D
                               assume FS_OFFSET = 0xffdff000
             DWORD             EAX:4          <RETURN>
             uint              Stack[0x4]:4   param_1                                 XREF[1]:     00404027(R)  
             LONG              Stack[0x8]:4   param_2                                 XREF[1]:     00404071(R)  
             DWORD             Stack[0xc]:4   param_3                                 XREF[1]:     0040406b(R)  
                             FUN_00404027                                    XREF[13]:    FUN_00402c5c:00402cc3(c), 
                                                                                          FUN_004039f7:00403b99(c), 
                                                                                          FUN_004040c1:004040e1(c), 
                                                                                          FUN_004040c1:004041a3(c), 
                                                                                          FUN_004040c1:004041d5(c), 
                                                                                          FUN_00404df8:00404ec5(c), 
                                                                                          FUN_00406d3b:00406d94(c), 
                                                                                          FUN_00406fe5:00407217(c), 
                                                                                          FUN_00406fe5:00407267(c), 
                                                                                          FUN_00407c1d:00407c5d(c), 
                                                                                          FUN_00407c1d:00407c75(c), 
                                                                                          FUN_00407c1d:00407d07(c), 
                                                                                          FUN_00407c1d:00407d45(c)  
        00404027 8b 44 24 04     MOV        EAX,dword ptr [ESP + param_1]
        0040402b 53              PUSH       EBX
        0040402c 3b 05 00        CMP        EAX,dword ptr [DAT_0040c300]
                 c3 40 00
        00404032 56              PUSH       ESI
        00404033 57              PUSH       EDI
        00404034 73 73           JNC        LAB_004040a9
        00404036 8b c8           MOV        ECX,EAX
        00404038 8b f0           MOV        ESI,EAX
        0040403a c1 f9 05        SAR        ECX,0x5
        0040403d 83 e6 1f        AND        ESI,0x1f
        00404040 8d 3c 8d        LEA        EDI,[ECX*0x4 + DAT_0040c200]
                 00 c2 40 00
        00404047 c1 e6 03        SHL        ESI,0x3
        0040404a 8b 0f           MOV        ECX,dword ptr [EDI]=>DAT_0040c200
        0040404c f6 44 31        TEST       byte ptr [ECX + ESI*0x1 + 0x4],0x1
                 04 01
        00404051 74 56           JZ         LAB_004040a9
        00404053 50              PUSH       EAX
        00404054 e8 4e 2c        CALL       FUN_00406ca7                                     undefined4 FUN_00406ca7(uint par
                 00 00
        00404059 83 f8 ff        CMP        EAX,-0x1
        0040405c 59              POP        ECX
        0040405d 75 0c           JNZ        LAB_0040406b
        0040405f c7 05 c0        MOV        dword ptr [DAT_0040adc0],0x9
                 ad 40 00 
                 09 00 00 00
        00404069 eb 4f           JMP        LAB_004040ba
                             LAB_0040406b                                    XREF[1]:     0040405d(j)  
        0040406b ff 74 24 18     PUSH       dword ptr [ESP + param_3]
        0040406f 6a 00           PUSH       0x0
        00404071 ff 74 24 1c     PUSH       dword ptr [ESP + param_2]
        00404075 50              PUSH       EAX
        00404076 ff 15 e8        CALL       dword ptr [->KERNEL32.DLL::SetFilePointer]       = 00009b16
                 90 40 00
        0040407c 8b d8           MOV        EBX,EAX
        0040407e 83 fb ff        CMP        EBX,-0x1
        00404081 75 08           JNZ        LAB_0040408b
        00404083 ff 15 20        CALL       dword ptr [->KERNEL32.DLL::GetLastError]         = 000098c0
                 90 40 00
        00404089 eb 02           JMP        LAB_0040408d
                             LAB_0040408b                                    XREF[1]:     00404081(j)  
        0040408b 33 c0           XOR        EAX,EAX
                             LAB_0040408d                                    XREF[1]:     00404089(j)  
        0040408d 85 c0           TEST       EAX,EAX
        0040408f 74 09           JZ         LAB_0040409a
        00404091 50              PUSH       EAX
        00404092 e8 23 2a        CALL       FUN_00406aba                                     undefined FUN_00406aba(uint para
                 00 00
        00404097 59              POP        ECX
        00404098 eb 20           JMP        LAB_004040ba
                             LAB_0040409a                                    XREF[1]:     0040408f(j)  
        0040409a 8b 07           MOV        EAX,dword ptr [EDI]=>DAT_0040c200
        0040409c 80 64 30        AND        byte ptr [EAX + ESI*0x1 + 0x4],0xfd
                 04 fd
        004040a1 8d 44 30 04     LEA        EAX,[EAX + ESI*0x1 + 0x4]
        004040a5 8b c3           MOV        EAX,EBX
        004040a7 eb 14           JMP        LAB_004040bd
                             LAB_004040a9                                    XREF[2]:     00404034(j), 00404051(j)  
        004040a9 83 25 c4        AND        dword ptr [DAT_0040adc4],0x0
                 ad 40 00 00
        004040b0 c7 05 c0        MOV        dword ptr [DAT_0040adc0],0x9
                 ad 40 00 
                 09 00 00 00
                             LAB_004040ba                                    XREF[2]:     00404069(j), 00404098(j)  
        004040ba 83 c8 ff        OR         EAX,0xffffffff
                             LAB_004040bd                                    XREF[1]:     004040a7(j)  
        004040bd 5f              POP        EDI
        004040be 5e              POP        ESI
        004040bf 5b              POP        EBX
        004040c0 c3              RET

```
