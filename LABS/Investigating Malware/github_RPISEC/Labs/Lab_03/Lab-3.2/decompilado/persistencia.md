


```
                             DAT_0040a0d8                                    XREF[1]:     FUN_00401020:00401057(*)  
        0040a0d8 72              ??         72h    r
        0040a0d9 00              ??         00h
        0040a0da 00              ??         00h
        0040a0db 00              ??         00h
                             s_SOFTWARE\Microsoft\Windows\Curre_0040a0dc     XREF[1]:     FUN_004012a0:004012a7(*)  
        0040a0dc 53 4f 46        ds         "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\
                 54 57 41 
                 52 45 5c 
        0040a10a 00              ??         00h
        0040a10b 00              ??         00h
        0040a10c 00              ??         00h
        0040a10d 00              ??         00h
        0040a10e 00              ??         00h
        0040a10f 00              ??         00h

```


ðŸŸ¥ Â¿QuÃ© indica esto?

Esta clave del Registro de Windows es muy comÃºnmente usada por malware para establecer persistencia.

En concreto:

    La clave:

HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

o

    HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

    se utiliza para que ciertos programas se ejecuten automÃ¡ticamente al iniciar sesiÃ³n.

ðŸ§© Posible comportamiento del malware

Basado en esto, es altamente probable que el malware estÃ© intentando:

    Escribirse a sÃ­ mismo en esa clave (Run)

    Con un valor tipo: java.exe apuntando a C:\Users\usuario\java.exe

    Para que se ejecute en cada inicio de Windows
    
    
Â¿Quien llama a DAT_0040a0d8?

```
                             **************************************************************
                             *                          FUNCTION                          *
                             **************************************************************
                             undefined4 __stdcall FUN_00401020(void)
                               assume FS_OFFSET = 0xffdff000
             undefined4        EAX:4          <RETURN>
                             FUN_00401020                                    XREF[1]:     FUN_004012f0:00401314(c)  
        00401020 81 ec 0c        SUB        ESP,0x40c
                 04 00 00
        00401026 53              PUSH       EBX
        00401027 56              PUSH       ESI
        00401028 57              PUSH       EDI
        00401029 68 00 01        PUSH       0x100
                 00 00
        0040102e 33 db           XOR        EBX,EBX
        00401030 e8 e6 1c        CALL       operator_new                                     void * operator_new(uint param_1)
                 00 00
        00401035 83 c4 04        ADD        ESP,0x4
        00401038 8b f0           MOV        ESI,EAX
        0040103a a1 a4 ac        MOV        EAX,[DAT_0040aca4]
                 40 00
        0040103f 68 00 01        PUSH       0x100
                 00 00
        00401044 56              PUSH       ESI
        00401045 50              PUSH       EAX
        00401046 ff 15 8c        CALL       dword ptr [->KERNEL32.DLL::GetModuleFileNameA]   = 00009844
                 90 40 00
        0040104c b9 80 00        MOV        ECX,0x80
                 00 00
        00401051 33 c0           XOR        EAX,EAX
        00401053 8d 7c 24 24     LEA        EDI,[ESP + 0x24]
        00401057 68 d8 a0        PUSH       DAT_0040a0d8                                     = 72h    r
                 40 00
        0040105c f3 ab           STOSD.REP  ES:EDI
        0040105e 56              PUSH       ESI
        0040105f e8 a4 1c        CALL       FUN_00402d08                                     undefined FUN_00402d08(LPCSTR pa
                 00 00
        00401064 8b f0           MOV        ESI,EAX
        00401066 83 c4 08        ADD        ESP,0x8
        00401069 85 f6           TEST       ESI,ESI
        0040106b 0f 84 2a        JZ         LAB_0040119b
                 01 00 00
        00401071 6a 02           PUSH       0x2
        00401073 68 00 fe        PUSH       0xfffffe00
                 ff ff
        00401078 56              PUSH       ESI
        00401079 e8 de 1b        CALL       FUN_00402c5c                                     int FUN_00402c5c(int * param_1, 
                 00 00
        0040107e 56              PUSH       ESI
        0040107f 68 00 02        PUSH       0x200
                 00 00
        00401084 8d 4c 24 38     LEA        ECX,[ESP + 0x38]
        00401088 6a 01           PUSH       0x1
        0040108a 51              PUSH       ECX
        0040108b e8 e4 1a        CALL       FUN_00402b74                                     uint FUN_00402b74(char * param_1
                 00 00
        00401090 56              PUSH       ESI
        00401091 e8 88 1a        CALL       FUN_00402b1e                                     undefined4 FUN_00402b1e(FILE * p
                 00 00
        00401096 83 c4 20        ADD        ESP,0x20
        00401099 b9 03 00        MOV        ECX,0x3
                 00 00
        0040109e bf c8 a0        MOV        EDI,s_configserver_0040a0c8                      = "configserver"
                 40 00
        004010a3 8d 74 24 24     LEA        ESI,[ESP + 0x24]
        004010a7 33 d2           XOR        EDX,EDX
        004010a9 f3 a7           CMPSD.REPE ES:EDI=>s_configserver_0040a0c8,ESI              = "configserver"
        004010ab 0f 85 ea        JNZ        LAB_0040119b
                 00 00 00
        004010b1 8d 7c 24 24     LEA        EDI,[ESP + 0x24]
        004010b5 83 c9 ff        OR         ECX,0xffffffff
        004010b8 33 c0           XOR        EAX,EAX
        004010ba f2 ae           SCASB.RE   ES:EDI
        004010bc f7 d1           NOT        ECX
        004010be 83 c1 f3        ADD        ECX,-0xd
        004010c1 8d 44 24 30     LEA        EAX,[ESP + 0x30]
        004010c5 51              PUSH       ECX
        004010c6 8d 4c 24 28     LEA        ECX,[ESP + 0x28]
        004010ca 50              PUSH       EAX
        004010cb 51              PUSH       ECX
        004010cc e8 4f 19        CALL       _strncpy                                         char * _strncpy(char * _Dest, ch
                 00 00
        004010d1 8d 54 24 30     LEA        EDX,[ESP + 0x30]
        004010d5 68 e8 01        PUSH       0x1e8
                 00 00
        004010da 8d 84 24        LEA        EAX,[ESP + 0x234]
                 34 02 00 00
        004010e1 52              PUSH       EDX
        004010e2 50              PUSH       EAX
        004010e3 e8 38 19        CALL       _strncpy                                         char * _strncpy(char * _Dest, ch
                 00 00
        004010e8 8d 8c 24        LEA        ECX,[ESP + 0x23c]
                 3c 02 00 00
        004010ef 51              PUSH       ECX
        004010f0 e8 0b ff        CALL       FUN_00401000                                     undefined FUN_00401000(int param
                 ff ff
        004010f5 8d 94 24        LEA        EDX,[ESP + 0x240]
                 40 02 00 00
        004010fc 68 c4 a0        PUSH       DAT_0040a0c4                                     = 24h    $
                 40 00
        00401101 52              PUSH       EDX
        00401102 e8 71 18        CALL       FUN_00402978                                     uint FUN_00402978(byte * param_1
                 00 00
        00401107 83 c4 24        ADD        ESP,0x24
        0040110a 85 c0           TEST       EAX,EAX
        0040110c 74 26           JZ         LAB_00401134
        0040110e 8d 74 24 0c     LEA        ESI,[ESP + 0xc]
                             LAB_00401112                                    XREF[1]:     00401132(j)  
        00401112 68 c4 a0        PUSH       DAT_0040a0c4                                     = 24h    $
                 40 00
        00401117 6a 00           PUSH       0x0
        00401119 89 06           MOV        dword ptr [ESI],EAX
        0040111b e8 58 18        CALL       FUN_00402978                                     uint FUN_00402978(byte * param_1
                 00 00
        00401120 83 c4 08        ADD        ESP,0x8
        00401123 85 c0           TEST       EAX,EAX
        00401125 74 04           JZ         LAB_0040112b
        00401127 43              INC        EBX
        00401128 83 c6 04        ADD        ESI,0x4
                             LAB_0040112b                                    XREF[1]:     00401125(j)  
        0040112b 83 fb 06        CMP        EBX,0x6
        0040112e 74 04           JZ         LAB_00401134
        00401130 85 c0           TEST       EAX,EAX
        00401132 75 de           JNZ        LAB_00401112
                             LAB_00401134                                    XREF[2]:     0040110c(j), 0040112e(j)  
        00401134 bf a8 ac        MOV        EDI,DAT_0040aca8
                 40 00
        00401139 83 c9 ff        OR         ECX,0xffffffff
        0040113c 33 c0           XOR        EAX,EAX
        0040113e f2 ae           SCASB.RE   ES:EDI
        00401140 f7 d1           NOT        ECX
        00401142 49              DEC        ECX
        00401143 bf a8 ac        MOV        EDI,DAT_0040aca8
                 40 00
        00401148 8b d1           MOV        EDX,ECX
        0040114a c1 e9 02        SHR        ECX,0x2
        0040114d f3 ab           STOSD.REP  ES:EDI=>DAT_0040aca8
        0040114f 8b ca           MOV        ECX,EDX
        00401151 83 e1 03        AND        ECX,0x3
        00401154 f3 aa           STOSB.REP  ES:EDI=>DAT_0040aca8
        00401156 8b 7c 24 0c     MOV        EDI,dword ptr [ESP + 0xc]
        0040115a 83 c9 ff        OR         ECX,0xffffffff
        0040115d 33 c0           XOR        EAX,EAX
        0040115f f2 ae           SCASB.RE   ES:EDI
        00401161 f7 d1           NOT        ECX
        00401163 2b f9           SUB        EDI,ECX
        00401165 8b c1           MOV        EAX,ECX
        00401167 8b f7           MOV        ESI,EDI
        00401169 bf a8 ac        MOV        EDI,DAT_0040aca8
                 40 00
        0040116e c1 e9 02        SHR        ECX,0x2
        00401171 f3 a5           MOVSD.REP  ES:EDI=>DAT_0040aca8,ESI
        00401173 8b c8           MOV        ECX,EAX
        00401175 83 e1 03        AND        ECX,0x3
        00401178 f3 a4           MOVSB.REP  ES:EDI=>DAT_0040aca8,ESI
        0040117a 8b 4c 24 10     MOV        ECX,dword ptr [ESP + 0x10]
        0040117e 51              PUSH       ECX
        0040117f e8 e9 17        CALL       FUN_0040296d                                     undefined FUN_0040296d(void * th
                 00 00
        00401184 83 c4 04        ADD        ESP,0x4
        00401187 a3 98 aa        MOV        [DAT_0040aa98],EAX
                 40 00
        0040118c b8 01 00        MOV        EAX,0x1
                 00 00
        00401191 5f              POP        EDI
        00401192 5e              POP        ESI
        00401193 5b              POP        EBX
        00401194 81 c4 0c        ADD        ESP,0x40c
                 04 00 00
        0040119a c3              RET
                             LAB_0040119b                                    XREF[2]:     0040106b(j), 004010ab(j)  
        0040119b 5f              POP        EDI
        0040119c 5e              POP        ESI
        0040119d 33 c0           XOR        EAX,EAX
        0040119f 5b              POP        EBX
        004011a0 81 c4 0c        ADD        ESP,0x40c
                 04 00 00
        004011a6 c3              RET

```
La funciÃ³n FUN_00401020 es una rutina de inicializaciÃ³n que extrae y decodifica instrucciones embebidas en el propio binario, comparÃ¡ndolas con una firma ("configserver") y luego ejecutando operaciones sobre ellas.


âœ… ConclusiÃ³n clara  
Elemento	FunciÃ³n  
FUN_00401020	Rutina principal que inicializa el anÃ¡lisis del overlay
"configserver"	Firma mÃ¡gica para verificar que hay instrucciones embebidas
FUN_00402b74	Lectura de datos del overlay
FUN_00402978	Posible parser del lenguaje embebido del overlay
DAT_0040aca8	Zona donde se almacenan las cadenas procesadas / ejecutables
FUN_0040296d	FunciÃ³n que utiliza el contenido final (posible ejecuciÃ³n)


