# FUN_00407436 (El Obrero):
Llamada por el Jefe FUN_004094b1. Descifra el código malicioso real usando matemáticas complejas.

Esta función FUN_00407436 es la continuación lógica de lo que has estado viendo: es una Segunda Capa de Desencriptado (Layer 2 Decryption), pero mucho más agresiva y protegida que la anterior.

Aquí tienes el análisis de las trampas que contiene y lo que realmente está haciendo:
1. La Trampa Mortal (Opaque Predicate)

Fíjate en las líneas finales de tu captura, es el detalle más importante:

    Línea 00407553: JBE LAB_004075d2 (Salta si es menor o igual).

    Línea 00407555: CALL SUB_c049986d

¡CUIDADO! Esa llamada (CALL) apunta a la dirección c049986d.

    En Windows, la memoria de usuario suele estar por debajo de 80000000.

    Las direcciones c0...... pertenecen al Kernel (el núcleo del sistema).

    Un programa normal (como este virus) NO puede saltar ahí. Si lo intenta, Windows lanzará una "Violación de Acceso" y el programa morirá.

¿Qué está pasando? Es un truco llamado Predicado Opaco (Opaque Predicate). El creador del malware ha diseñado las matemáticas anteriores para que la condición del salto (JBE) sea SIEMPRE VERDADERA.

    El programa siempre saltará a LAB_004075d2.

    Nunca ejecutará el CALL suicida.

    Pero tu desensamblador (Ghidra/x32dbg) no lo sabe, intenta analizar el CALL, se confunde y te muestra código basura o incorrecto después.

2. El Propósito: Algoritmo de Descompresión/Cifrado

Si ignoras las trampas y miras las instrucciones válidas (IMUL, DIV, XOR, SHL), verás que están operando sobre datos globales (DAT_0040f818, DAT_0040f7f4, etc.).

    Matemáticas de Alta Entropía: El uso constante de multiplicaciones (IMUL) y divisiones (DIV) suele indicar un algoritmo de hash complejo o una rutina de descompresión (similar a aPLib, que es muy común en malware, pero modificado).

    El objetivo: Esta función está leyendo un "blob" de datos cifrados del cuerpo del virus y convirtiéndolos en código ejecutable limpio.

3. Conexión con lo anterior

    Paso 1 (Visto antes): FUN_00407123 consiguió la dirección de kernel32.dll.

    Paso 2 (Este): FUN_00407436 usa matemáticas complejas para descifrar el siguiente bloque.

    Paso 3 (Lo que viene): Una vez descifrado, el malware usará la dirección del Paso 1 para buscar funciones como VirtualAlloc y escribir el código descifrado en el Paso 2 en una nueva memoria.

---------------
TU ESTRATEGIA (No caigas en la trampa)

Pon un Breakpoint en el RET.

Ejecuta (F9).


```
**************************************************************

                             * capa_explorer/lib/contain-loop                             *

                             *                                                            *

                             **************************************************************

                             undefined __stdcall FUN_00407436(void)

                               assume FS_OFFSET = 0xffdff000

             undefined         <UNASSIGNED>   <RETURN>

             undefined4        Stack[-0x8]:4  local_8                                 XREF[31]:    004076bc(W), 

                                                                                                   004076e6(W), 

                                                                                                   00407774(W), 

                                                                                                   00407a8e(W), 

                                                                                                   00407bb0(R), 

                                                                                                   00407c44(W), 

                                                                                                   00407cae(R), 

                                                                                                   00407dd4(W), 

                                                                                                   00407dff(R), 

                                                                                                   00407e4c(W), 

                                                                                                   00407e4f(R), 

                                                                                                   00407e9a(W), 

                                                                                                   00407eaa(R), 

                                                                                                   00407f3d(W), 

                                                                                                   00407f44(R), 

                                                                                                   00407f5d(W), 

                                                                                                   00407fa2(R), 

                                                                                                   0040806a(W), 

                                                                                                   0040809f(R), 

                                                                                                   004080be(W)  

             undefined4        Stack[-0xc]:4  local_c                                 XREF[19,7]:  004074b9(W), 

                                                                                                   0040783a(W), 

                                                                                                   00407883(W), 

                                                                                                   004078ba(R), 

                                                                                                   0040799f(W), 

                                                                                                   004079b5(RW), 

                                                                                                   00407a33(R), 

                                                                                                   00407af4(W), 

                                                                                                   00407b30(R), 

                                                                                                   00407d98(W), 

                                                                                                   00407e1c(W), 

                                                                                                   0040804b(W), 

                                                                                                   0040812e(W), 

                                                                                                   0040816d(RW), 

                                                                                                   00408170(R), 

                                                                                                   00408280(W), 

                                                                                                   00408300(R), 

                                                                                                   00408309(W), 

                                                                                                   00408327(R), 

                                                                                                   004075f7(W)  

             undefined1        Stack[-0xd]:1  local_d                                 XREF[7]:     0040751a(W), 

                                                                                                   0040754e(R), 

                                                                                                   0040762d(W), 

                                                                                                   0040763b(R), 

                                                                                                   00407662(R), 

                                                                                                   0040766f(W), 

                                                                                                   0040767d(R)  

             undefined4        Stack[-0x14]:4 local_14                                XREF[23]:    00407460(W), 

                                                                                                   004074bd(R), 

                                                                                                   0040752f(W), 

                                                                                                   00407532(R), 

                                                                                                   00407605(W), 

                                                                                                   00407615(R), 

                                                                                                   00407719(W), 

                                                                                                   0040772f(R), 

                                                                                                   00407860(W), 

                                                                                                   00407863(R), 

                                                                                                   00407918(W), 

                                                                                                   0040792e(R), 

                                                                                                   00407a2d(W), 

                                                                                                   00407ac7(W), 

                                                                                                   00407ade(R), 

                                                                                                   00407aea(W), 

                                                                                                   00407b08(R), 

                                                                                                   00407c1c(W), 

                                                                                                   00407d4e(R), 

                                                                                                   00407f06(W)  

             undefined4        Stack[-0x18]:4 local_18                                XREF[6,3]:   004074a3(W), 

                                                                                                   004074dc(RW), 

                                                                                                   004074f3(R), 

                                                                                                   00407aed(W), 

                                                                                                   00407b41(R), 

                                                                                                   004082d2(W), 

                                                                                                   00407644(W), 

                                                                                                   00407648(R), 

                                                                                                   0040765b(W)  

             undefined4        Stack[-0x1c]:4 local_1c                                XREF[8]:     00407b05(W), 

                                                                                                   00407b61(R), 

                                                                                                   00407c61(W), 

                                                                                                   00407d2e(R), 

                                                                                                   00407f2f(W), 

                                                                                                   00407ff1(R), 

                                                                                                   004081d8(W), 

                                                                                                   004082d6(R)  

             undefined4        Stack[-0x20]:4 local_20                                XREF[6]:     00407481(W), 

                                                                                                   004074df(R), 

                                                                                                   00407982(W), 

                                                                                                   00407a5c(R), 

                                                                                                   00408227(W), 

                                                                                                   0040830d(R)  

             undefined4        Stack[-0x24]:4 local_24                                XREF[8]:     00407ac4(W), 

                                                                                                   00407b71(R), 

                                                                                                   00407c64(W), 

                                                                                                   00407cd9(R), 

                                                                                                   00407f2c(W), 

                                                                                                   00407f66(R), 

                                                                                                   004081f6(W), 

                                                                                                   00408257(R)  

             undefined4        Stack[-0x28]:4 local_28                                XREF[8]:     00407a8b(W), 

                                                                                                   00407ba5(R), 

                                                                                                   00407c6b(W), 

                                                                                                   00407cd0(R), 

                                                                                                   00407f36(W), 

                                                                                                   00407f47(R), 

                                                                                                   004081f9(W), 

                                                                                                   0040820a(R)  

             undefined4        Stack[-0x30]:4 local_30                                XREF[12]:    00407449(W), 

                                                                                                   0040768b(W), 

                                                                                                   00407699(W), 

                                                                                                   00407957(W), 

                                                                                                   00407985(R), 

                                                                                                   00407bc8(W), 

                                                                                                   00407be5(W), 

                                                                                                   00407c19(W), 

                                                                                                   00407db4(W), 

                                                                                                   004083c6(R), 

                                                                                                   0040840b(W), 

                                                                                                   0040843e(R)  

             undefined4        Stack[-0x34]:4 local_34                                XREF[2]:     00407950(W), 

                                                                                                   00407978(R)  

             undefined4        Stack[-0x38]:4 local_38                                XREF[3]:     00407ebe(*), 

                                                                                                   00407eca(W), 

                                                                                                   00407ecd(R)  

             undefined4        Stack[-0x3c]:4 local_3c                                XREF[3]:     004078a5(W), 

                                                                                                   004078a8(R), 

                                                                                                   004078ab(*)  

             undefined4        Stack[-0x40]:4 local_40                                XREF[3]:     004079cd(W), 

                                                                                                   004079d0(*), 

                                                                                                   00407a30(R)  

             undefined4        Stack[-0x44]:4 local_44                                XREF[2]:     004079d3(W), 

                                                                                                   004079d6(*)  

             undefined4        Stack[-0x48]:4 local_48                                XREF[2]:     004078ae(W), 

                                                                                                   004078b1(*)  

             undefined4        Stack[-0x50]:4 local_50                                XREF[4]:     0040796b(W), 

                                                                                                   00407975(W), 

                                                                                                   00407a3b(R), 

                                                                                                   00407a5f(R)  

             undefined4        Stack[-0x54]:4 local_54                                XREF[4]:     00407964(W), 

                                                                                                   0040796e(W), 

                                                                                                   00407a38(R), 

                                                                                                   00407a59(R)  

             undefined4        Stack[-0x58]:4 local_58                                XREF[2]:     00407ec1(W), 

                                                                                                   00407ed0(*)  

             undefined4        Stack[-0x60]:4 local_60                                XREF[4]:     0040794d(W), 

                                                                                                   00407961(W), 

                                                                                                   00407a6f(R), 

                                                                                                   00407beb(R)  

             undefined4        Stack[-0x64]:4 local_64                                XREF[4]:     00407943(W), 

                                                                                                   0040795a(W), 

                                                                                                   00407a62(R), 

                                                                                                   00407be8(R)  

             undefined2        Stack[-0x68]:2 local_68                                XREF[1]:     00408253(W)  

             undefined2        Stack[-0x6a]:2 local_6a                                XREF[1]:     0040824a(W)  

             undefined2        Stack[-0x6c]:2 local_6c                                XREF[1]:     00408241(W)  

             undefined2        Stack[-0x6e]:2 local_6e                                XREF[1]:     00408238(W)  

             undefined2        Stack[-0x70]:2 local_70                                XREF[1]:     0040822f(W)  

             undefined2        Stack[-0x74]:2 local_74                                XREF[1]:     00407dfb(W)  

             undefined2        Stack[-0x76]:2 local_76                                XREF[1]:     00407df2(W)  

             undefined2        Stack[-0x78]:2 local_78                                XREF[1]:     00407de9(W)  

             undefined2        Stack[-0x7a]:2 local_7a                                XREF[1]:     00407de0(W)  

             undefined2        Stack[-0x7c]:2 local_7c                                XREF[1]:     00407dd7(W)  

             undefined4        Stack[-0x80]:4 local_80                                XREF[2]:     00407767(W), 

                                                                                                   0040776a(R)  

             undefined4        Stack[-0x84]:4 local_84                                XREF[2]:     0040811c(W), 

                                                                                                   0040811f(R)  

             undefined4        Stack[-0x88]:4 local_88                                XREF[2]:     00407ed3(W), 

                                                                                                   0040845e(W)  

             undefined4        Stack[-0x8c]:4 local_8c                                XREF[2]:     004079fe(W), 

                                                                                                   00407a27(R)  

             undefined4        Stack[-0x90]:4 local_90                                XREF[1]:     00408095(W)  

             undefined4        Stack[-0x94]:4 local_94                                XREF[1]:     0040808b(W)  

             undefined4        Stack[-0x98]:4 local_98                                XREF[1]:     00408081(W)  

             undefined4        Stack[-0x9c]:4 local_9c                                XREF[1]:     00408077(W)  

             undefined4        Stack[-0xa0]:4 local_a0                                XREF[1]:     0040806d(W)  

             undefined4        Stack[-0xa4]:4 local_a4                                XREF[1]:     004078b4(W)  

             undefined4        Stack[-0xa8]:4 local_a8                                XREF[1]:     004079d9(W)  

                             capa_explorer::lib::contain-loop::FUN_00407436  XREF[2]:     00407e20(c), 

                             FUN_00407436                                                 FUN_00408469:00409264(c)  

        00407436 55              PUSH       EBP

        00407437 8b ec           MOV        EBP,ESP

        00407439 81 ec a4        SUB        ESP,0xa4

                 00 00 00

        0040743f a1 f4 f7        MOV        EAX,[DAT_0040f7f4]                               = 00006F56h

                 40 00

        00407444 05 87 36        ADD        EAX,0x3687

                 00 00

        00407449 89 45 d4        MOV        dword ptr [EBP + local_30],EAX

        0040744c a1 fc f7        MOV        EAX,[DAT_0040f7fc]                               = 00007E9Ch

                 40 00

        00407451 0d 0f ef        OR         EAX,0xffffef0f

                 ff ff

        00407456 c1 e0 12        SHL        EAX,0x12

        00407459 b9 02 00        MOV        ECX,0xfe7c0002

                 7c fe

        0040745e 2b c8           SUB        ECX,EAX

        00407460 89 4d f0        MOV        dword ptr [EBP + local_14],ECX

        00407463 a1 18 f8        MOV        EAX,[DAT_0040f818]                               = 00007C93h

                 40 00

        00407468 8b 0d 14        MOV        ECX,dword ptr [DAT_0040f814]                     = 0000426Fh

                 f8 40 00

        0040746e 05 58 8d        ADD        EAX,0xffff8d58

                 ff ff

        00407473 33 d2           XOR        EDX,EDX

        00407475 f7 f1           DIV        ECX

        00407477 b8 ed 09        MOV        EAX,0x9ed

                 00 00

        0040747c 53              PUSH       EBX

        0040747d 56              PUSH       ESI

        0040747e 57              PUSH       EDI

        0040747f 2b c2           SUB        EAX,EDX

        00407481 89 45 e4        MOV        dword ptr [EBP + local_20],EAX

        00407484 a1 30 f8        MOV        EAX,[DAT_0040f830]                               = 00004453h

                 40 00

        00407489 8b 0d 2c        MOV        ECX,dword ptr [DAT_0040f82c]                     = 00001617h

                 f8 40 00

        0040748f 69 c0 5d        IMUL       EAX,EAX,0x1d5d

                 1d 00 00

        00407495 33 c8           XOR        ECX,EAX

        00407497 81 e1 4a        AND        ECX,0x7f4a

                 7f 00 00

        0040749d 81 c1 50        ADD        ECX,0x5a9d3a50

                 3a 9d 5a

        004074a3 89 4d ec        MOV        dword ptr [EBP + local_18],ECX

        004074a6 ba 8c 3c        MOV        EDX,0x3c8c

                 00 00

        004074ab eb 32           JMP        LAB_004074df

                             LAB_004074ad                                    XREF[1]:     004074fd(j)  

        004074ad 0f b7 05        MOVZX      EAX,word ptr [DAT_0040f834]                      = 2092h

                 34 f8 40 00

        004074b4 35 e4 10        XOR        EAX,0x10e4

                 00 00

        004074b9 66 89 45 f8     MOV        word ptr [EBP + local_c],AX

        004074bd 8b 45 f0        MOV        EAX,dword ptr [EBP + local_14]

        004074c0 8a 0c 85        MOV        CL,byte ptr [EAX*0x4 + 0x40f800]=>DAT_0040f808   = 02h

                 00 f8 40 00

        004074c7 8b 35 f8        MOV        ESI,dword ptr [DAT_0040f7f8]                     = 00002CA2h

                 f7 40 00

        004074cd d3 ee           SHR        ESI,CL

        004074cf b8 75 35        MOV        EAX,0x3575

                 00 00

        004074d4 81 f6 5c        XOR        ESI,0x3e5c

                 3e 00 00

        004074da 2b c6           SUB        EAX,ESI

        004074dc 01 45 ec        ADD        dword ptr [EBP + local_18],EAX

                             LAB_004074df                                    XREF[1]:     004074ab(j)  

        004074df 8b 45 e4        MOV        EAX,dword ptr [EBP + local_20]

        004074e2 8b 04 85        MOV        EAX,dword ptr [EAX*0x4 + 0x40f81c]=>DAT_0040f824 = 000039ABh

                 1c f8 40 00

        004074e9 8b 0d 10        MOV        ECX,dword ptr [DAT_0040f810]                     = 000079A3h

                 f8 40 00

        004074ef 23 c2           AND        EAX,EDX

        004074f1 2b c1           SUB        EAX,ECX

        004074f3 8b 4d ec        MOV        ECX,dword ptr [EBP + local_18]

        004074f6 05 7d aa        ADD        EAX,0x5a9daa7d

                 9d 5a

        004074fb 3b c8           CMP        ECX,EAX

        004074fd 76 ae           JBE        LAB_004074ad

        004074ff a0 38 f8        MOV        AL,[DAT_0040f838]                                = 06h

                 40 00

        00407504 0f b6 c8        MOVZX      ECX,AL

        00407507 a0 37 f8        MOV        AL,[DAT_0040f837]                                = 43h

                 40 00

        0040750c d2 e0           SHL        AL,CL

        0040750e 0f b6 0d        MOVZX      ECX,byte ptr [DAT_0040f836]                      = 5Fh

                 36 f8 40 00

        00407515 0f b6 c0        MOVZX      EAX,AL

        00407518 2b c1           SUB        EAX,ECX

        0040751a 88 45 f7        MOV        byte ptr [EBP + local_d],AL

        0040751d a1 3c f8        MOV        EAX,[DAT_0040f83c]                               = 00001833h

                 40 00

        00407522 0d e8 3f        OR         EAX,0x3fe8

                 00 00

        00407527 c1 e8 03        SHR        EAX,0x3

        0040752a 2d fe 07        SUB        EAX,0x7fe

                 00 00

        0040752f 89 45 f0        MOV        dword ptr [EBP + local_14],EAX

        00407532 8b 45 f0        MOV        EAX,dword ptr [EBP + local_14]

        00407535 8a 80 44        MOV        AL,byte ptr [EAX + 0x40f844]=>DAT_0040f845       = E1h

                 f8 40 00

        0040753b 8a 0d 40        MOV        CL,byte ptr [DAT_0040f840]                       = 01h

                 f8 40 00

        00407541 0f b6 f0        MOVZX      ESI,AL

        00407544 b0 b9           MOV        AL,0xb9

        00407546 d2 e0           SHL        AL,CL

        00407548 0f b6 c0        MOVZX      EAX,AL

        0040754b 99              CDQ

        0040754c f7 fe           IDIV       ESI

        0040754e 8a 45 f7        MOV        AL,byte ptr [EBP + local_d]

        00407551 3a c2           CMP        AL,DL

        00407553 76 7d           JBE        LAB_004075d2

        00407555 e8 13 23        CALL       SUB_c049986d

                 09 c0 
                 
``` 
