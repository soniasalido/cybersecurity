# An√°lisis del c√≥digo fuente

```
#include <stdio.h>

void call_me() {
	printf("You cannot call me, noob!\n");
}

void parse_file(char* filename){
	char buffer[512];

	printf("Abriendo fichero %s ...\n", filename);

	FILE *f = fopen(filename, "r");
	if(f == NULL){
		printf("Fallo al abrir el fichero :(\n");
		return;
	}
	printf("Leyendo fichero %s ...\n", filename);

	fread(buffer, 1, 1024, f);
	printf("Fichero leido! Contenido: \n");
	printf(buffer);

	fclose(f);
	return;
}

int main(int argc, char** argv) {
	if(argc != 2){
		printf("Uso: %s <fichero>\n", argv[0]);
		return -1;
	}

	parse_file(argv[1]);
	return 0;
}
```
donde:
- El c√≥digo tiene tres funciones:
  - `call_me()` ‚Üí no se llama desde ning√∫n punto del programa. El objetivo es forzar su ejecuci√≥n mediante un exploit (por ejemplo, modificando la direcci√≥n de retorno en la pila).
  - `parse_file(char* filename)` ‚Üí abre y lee un fichero.
  - `main()` ‚Üí comprueba argumentos y llama a parse_file.
- `buffer[512]` ‚Üí reserva 512 bytes en la pila.
- `fread(buffer, 1, 1024, f);` ‚Üí Error de seguridad cr√≠tica: Se est√° leyendo 1024 bytes en un buffer de solo 512 bytes ‚û°Ô∏è Esto provoca un desbordamiento de buffer (stack overflow).
- Un atacante puede escribir m√°s all√° del l√≠mite de buffer y sobrescribir la direcci√≥n de retorno de `parse_file()`, pudiendo hacer que el programa salte a `call_me()`.
- ‚ûü‚ûü‚ûü `buffer [512 bytes] + EBP + RET` ‚ûü‚ûü‚ûü Si el atacante introduce 512 bytes de relleno + direcci√≥n de `call_me()` (en little-endian), al retornar de `parse_file()` se ejecutar√° `call_me()`.
- üß® Vulnerabilidad adicional ‚ûü‚ûü‚ûü Formato de cadena: `printf(buffer);` ‚ûü‚ûü‚ûü Esto abre una vulnerabilidad de formato de cadena (format string vulnerability). `printf()` intentar√° leer del stack como si hubiera par√°metros adicionales, lo que puede filtrar direcciones de memoria o incluso permitir escritura arbitraria (mediante %n).

| Tipo de vulnerabilidad                              | Descripci√≥n                                                          | Consecuencia posible                                         |
| --------------------------------------------------- | -------------------------------------------------------------------- | ------------------------------------------------------------ |
| **Desbordamiento de buffer (stack overflow)**       | `fread(buffer, 1, 1024, f)` escribe m√°s all√° del l√≠mite de 512 bytes | Ejecuci√≥n arbitraria de c√≥digo (p. ej. saltar a `call_me()`) |
| **Formato de cadena (format string vulnerability)** | `printf(buffer);` sin especificar formato                            | Filtraci√≥n o modificaci√≥n de memoria                         |


# An√°lisis con mona.py
```
================================================================================
  Output generated by mona.py v2.0, rev 643 - Immunity Debugger
  Corelan Consulting bv - https://www.corelan.be
================================================================================
  OS : post2008server, release 6.2.9200
  Process being debugged : stack1 (pid 3900)
  Current mona arguments: findmsp
================================================================================
  2025-11-12
================================================================================
----------------------------------------------------------------------------------------------------------------------------------------------
 Module info :
----------------------------------------------------------------------------------------------------------------------------------------------
 Base       | Top        | Size       | Rebase | SafeSEH | ASLR  | CFG   | NXCompat | OS Dll | Version, Modulename & Path, DLLCharacteristics
----------------------------------------------------------------------------------------------------------------------------------------------
 0x773b0000 | 0x775ea000 | 0x0023a000 | True   | True    | True  | True  |  False   | True   | 10.0.19041.2788 [KERNELBASE.dll] (C:\Windows\System32\KERNELBASE.dll) 0x4140
 0x77600000 | 0x777a4000 | 0x001a4000 | True   | True    | True  | True  |  False   | True   | 10.0.19041.2788 [ntdll.dll] (C:\Windows\SYSTEM32\ntdll.dll) 0x4140
 0x75940000 | 0x75a30000 | 0x000f0000 | True   | True    | True  | True  |  False   | True   | 10.0.19041.2788 [KERNEL32.DLL] (C:\Windows\System32\KERNEL32.DLL) 0x4140
 0x75520000 | 0x755df000 | 0x000bf000 | True   | True    | True  | True  |  False   | True   | 7.0.19041.546 [msvcrt.dll] (C:\Windows\System32\msvcrt.dll) 0x4140
 0x00400000 | 0x0045b000 | 0x0005b000 | False  | False   | True  | False |  False   | False  | -1.0- [stack1.exe] (C:\Users\usuario\Desktop\M4-tarea1\stack1.exe) 0x140
-----------------------------------------------------------------------------------------------------------------------------------------
[+] Looking for cyclic pattern in memory
    Cyclic pattern (normal) found at 0x0065e0dc (length 540 bytes)
    Cyclic pattern (normal) found at 0x0065fc7c (length 540 bytes)
    -  Stack pivot between 80 & 620 bytes needed to land in this pattern
    Cyclic pattern (normal) found at 0x00ce24b0 (length 540 bytes)
    Cyclic pattern (normal) found at 0x00ce3528 (length 540 bytes)

[+] Examining registers
    ESI contains normal pattern : 0x31724130 (offset 512)

[+] Examining SEH chain

[+] Examining stack (entire stack) - looking for cyclic pattern
    Walking stack from 0x0065d000 to 0x0065fffc (0x00002ffc bytes)
    0x0065e0dc : Contains normal cyclic pattern at ESP-0x1b50 (-6992) : offset 0, length 540 (-> 0x0065e2f7 : ESP-0x1934)
    0x0065fc7d : Contains normal cyclic pattern at ESP+0x51 (+81) : offset 1, length 539 (-> 0x0065fe97 : ESP+0x26c)

[+] Examining stack (entire stack) - looking for pointers to cyclic pattern
    Walking stack from 0x0065d000 to 0x0065fffc (0x00002ffc bytes)
    0x0065e034 : Pointer into normal cyclic pattern at ESP-0x1bf8 (-7160) : 0x0065e0dc : offset 0, length 540
    0x0065e088 : Pointer into normal cyclic pattern at ESP-0x1ba4 (-7076) : 0x0065e0dc : offset 0, length 540
    0x0065e0bc : Pointer into normal cyclic pattern at ESP-0x1b70 (-7024) : 0x00ce24cb : offset 27, length 513
    0x0065e0d8 : Pointer into normal cyclic pattern at ESP-0x1b54 (-6996) : 0x00ce24b0 : offset 0, length 540
    0x0065e378 : Pointer into normal cyclic pattern at ESP-0x18b4 (-6324) : 0x0065fc9c : offset 32, length 508
    0x0065f3a0 : Pointer into normal cyclic pattern at ESP-0x88c (-2188) : 0x00ce24b0 : offset 0, length 540
    0x0065f4f8 : Pointer into normal cyclic pattern at ESP-0x734 (-1844) : 0x00ce3528 : offset 0, length 540
    0x0065f610 : Pointer into normal cyclic pattern at ESP-0x61c (-1564) : 0x00ce3528 : offset 0, length 540
    0x0065f6a0 : Pointer into normal cyclic pattern at ESP-0x58c (-1420) : 0x00ce3528 : offset 0, length 540
    0x0065f768 : Pointer into normal cyclic pattern at ESP-0x4c4 (-1220) : 0x00ce3528 : offset 0, length 540
    0x0065f86c : Pointer into normal cyclic pattern at ESP-0x3c0 (-960) : 0x00ce3528 : offset 0, length 540
    0x0065f8bc : Pointer into normal cyclic pattern at ESP-0x370 (-880) : 0x00ce3528 : offset 0, length 540
    0x0065fac4 : Pointer into normal cyclic pattern at ESP-0x168 (-360) : 0x00ce3528 : offset 0, length 540
    0x0065fb18 : Pointer into normal cyclic pattern at ESP-0x114 (-276) : 0x00ce3528 : offset 0, length 540
    0x0065fb40 : Pointer into normal cyclic pattern at ESP-0xec (-236) : 0x00ce3528 : offset 0, length 540
    0x0065fb54 : Pointer into normal cyclic pattern at ESP-0xd8 (-216) : 0x00ce3528 : offset 0, length 540
    0x0065fc44 : Pointer into normal cyclic pattern at ESP+0x18 (+24) : 0x0065fc7c : offset 0, length 540
    0x0065fc58 : Pointer into normal cyclic pattern at ESP+0x2c (+44) : 0x0065fe88 : offset 524, length 16
```

![stack1-mona](capturas/stack1-mona.png)
